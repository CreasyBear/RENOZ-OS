# Quick Fix: Eliminate N+1 Query Pattern in bulkUpdatePrices
Generated: 2026-01-17 21:15:07

## Change Made
- File: `src/lib/server/functions/product-pricing.ts`
- Lines: 624-648
- Change: Replaced individual DB queries inside loop with batched fetch upfront + Map lookups

## Verification
- Syntax check: PASS (TypeScript compiles, unrelated dependency warnings only)
- Pattern followed: Batch fetch + Map pattern for O(1) lookups

## Performance Impact

### Before (N+1 Pattern)
```typescript
for (const update of data.updates) {
  const [product] = await db.select(...).where(eq(products.id, update.productId))...
  // N queries for N updates
}
```

### After (Batched Fetch)
```typescript
// 1 query upfront
const productIds = data.updates.map(u => u.productId);
const allProducts = await db.select(...).where(inArray(products.id, productIds))...
const productMap = new Map(allProducts.map(p => [p.id, p]));

for (const update of data.updates) {
  const product = productMap.get(update.productId); // O(1) lookup
}
```

**Query Reduction:**
- Before: N queries (1 per product)
- After: 1 query total
- Example: 100 products = 100 queries â†’ 1 query (99% reduction)

## Files Modified
1. `src/lib/server/functions/product-pricing.ts` - Fixed N+1 query pattern in bulkUpdatePrices handler

## Implementation Details

### Changes Applied
1. Added batch fetch before the loop:
   - Collected all `productIds` from `data.updates`
   - Used `inArray(products.id, productIds)` to fetch all products in one query
   - Applied same filters: organizationId + deletedAt

2. Created Map for efficient lookups:
   - `Map<string, Product>` with productId as key
   - O(1) lookup time vs O(N) for array.find()

3. Replaced individual query with Map lookup:
   - Changed from `await db.select()` in loop
   - To `productMap.get(update.productId)`

### No Behavior Changes
- Same validation (product existence check)
- Same error handling (failed array for missing products)
- Same price change recording logic
- Same update logic

## Notes
- The `inArray` import was already present in the file (line 11)
- No additional dependencies required
- This pattern should be applied to other bulk operations if similar N+1 patterns exist
- Consider adding similar optimization to other bulk update functions in the codebase
