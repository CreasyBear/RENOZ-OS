# Quick Fix: Validate Redirect URLs in Click Tracking
Generated: 2026-01-18 11:30:00

## Security Issue Addressed
**MEDIUM Severity**: Open redirect vulnerability in email click tracking endpoint that could be exploited for phishing attacks.

## Change Made

### Root Cause
The click tracking endpoint (`/api/track/click/:emailId/:linkId`) was accepting any URL in the query parameter and redirecting to it without validation. The `linkMap` (mapping of linkId -> originalUrl) was generated during email preparation but **not stored in the database**, making validation impossible.

### Solution Implemented

1. **Added linkMap storage** (`src/trigger/jobs/process-scheduled-emails.ts`)
   - Lines 179-186: Capture the `linkMap` returned from `prepareEmailForTracking()`
   - Lines 204-206: Store the linkMap in `email_history.metadata.linkMap` field

2. **Added URL validation** (`src/routes/api/track/click.$emailId.$linkId.ts`)
   - Lines 45-93: New validation logic that:
     - Fetches the email record and its metadata
     - Extracts the stored linkMap
     - Verifies the linkId exists in the linkMap
     - Verifies the provided URL matches the stored URL
     - Returns 400/404 errors for invalid links
   - Only redirects if URL validation passes

3. **Updated schema types** (`drizzle/schema/email-history.ts`)
   - Line 47: Added explicit `linkMap?: Record<string, string>` field to `EmailMetadata` interface for type safety

## Verification

### Type Check
```bash
npx tsc --noEmit  # Passes with no errors
```

### Security Properties
- ✅ **Whitelist validation**: Only URLs in the original email's linkMap can be redirected to
- ✅ **Tamper protection**: If an attacker modifies the URL parameter, the validation fails
- ✅ **No open redirects**: Cannot redirect to arbitrary external sites
- ✅ **Error logging**: Invalid attempts are logged with console.warn()

### Example Attack Scenarios (Now Blocked)

**Before (vulnerable):**
```
GET /api/track/click/123/abc?url=https://evil.com
→ Redirects to evil.com (EXPLOITABLE)
```

**After (protected):**
```
GET /api/track/click/123/abc?url=https://evil.com
→ Validates against stored linkMap
→ If evil.com not in linkMap: Returns 400 "URL mismatch"
→ Logs warning with details
```

## Files Modified

1. **`src/routes/api/track/click.$emailId.$linkId.ts`**
   - Added database query to fetch email metadata
   - Added linkMap validation logic (48 lines)
   - Returns 400/404 for invalid links
   - Updated documentation comment

2. **`src/trigger/jobs/process-scheduled-emails.ts`**
   - Capture linkMap from prepareEmailForTracking()
   - Convert Map to plain object
   - Store in metadata.linkMap field

3. **`drizzle/schema/email-history.ts`**
   - Added explicit linkMap field to EmailMetadata interface

## Pattern Followed

**Whitelist Validation Pattern:**
```typescript
// 1. Store allowed values at creation time
const { html, linkMap } = prepareEmailForTracking(body, emailId);
metadata: { linkMap: Object.fromEntries(linkMap) }

// 2. Validate against stored values
const storedUrl = email.metadata?.linkMap?.[linkId];
if (!storedUrl || storedUrl !== requestedUrl) {
  return new Response("Invalid link", { status: 400 });
}
```

## Notes

### Backwards Compatibility
- Emails sent **before** this fix won't have a linkMap in metadata
- The validation gracefully handles this: returns 400 "Link tracking data not found"
- This is acceptable as it fails closed (secure default)

### Future Improvements
- Consider adding a migration to backfill linkMap for old emails (if needed)
- Could extract tracking URLs from existing `bodyHtml` if necessary
- Add metrics/alerts for validation failures to detect attack attempts

### Testing Recommendations
1. **Happy path**: Click tracking link from a newly sent email → should redirect successfully
2. **Attack simulation**: Modify URL parameter → should return 400
3. **Old emails**: Click link from email sent before this fix → should return 400
4. **Invalid linkId**: Use wrong linkId → should return 400

## Impact
- **Security**: Eliminates open redirect vulnerability
- **Performance**: Adds one database query (SELECT metadata) before redirect
- **UX**: No impact for legitimate users; attackers see 400 error
