# Quick Fix: Batch Operations for setProductAttributes N+1 Query
Generated: 2026-01-17 21:14:54

## Change Made
- File: `src/lib/server/functions/product-attributes.ts`
- Line(s): 675-723
- Change: Refactored from N+1 individual queries to batch operations with transaction

## Problem Identified
The original implementation had an N+1 query pattern:
- Loop over each attribute value (lines 676-710)
- Execute individual DELETE or INSERT/UPSERT for each iteration
- No transaction wrapper, risking partial updates

## Solution Applied

### 1. Added `sql` import (line 11)
```typescript
import { eq, and, asc, inArray, isNull, sql } from "drizzle-orm";
```

### 2. Refactored to batch operations with transaction (lines 675-723)

**Key improvements:**
- Wrapped all operations in `db.transaction()` for atomicity
- Separated null vs non-null values into two batches
- **Batch DELETE**: Used `inArray()` to delete all null attribute values in one query
- **Batch UPSERT**: Used array of values with single `insert().values()` call
- Used `sql\`EXCLUDED.value\`` for conflict resolution to reference the new values

**Before:**
```typescript
for (const item of validValues) {
  if (item.value === null) {
    await db.delete(...);  // N queries
  } else {
    await db.insert(...);  // M queries
  }
}
// Total: N + M queries (no transaction)
```

**After:**
```typescript
await db.transaction(async (tx) => {
  // 1 query for all deletes
  if (nullAttributeIds.length > 0) {
    await tx.delete(...).where(inArray(...));
  }

  // 1 query for all upserts
  if (nonNullValues.length > 0) {
    await tx.insert(...).values([...]);
  }
});
// Total: 2 queries max (atomic)
```

## Performance Impact

For N attributes to update:
- **Before**: N individual queries (could be 10, 20, 50+)
- **After**: 2 queries max (1 delete batch + 1 upsert batch)
- **Speedup**: ~N/2x faster, plus guaranteed atomicity

Example: Updating 20 attributes
- Before: 20 separate queries
- After: 2 queries
- ~10x reduction in database round trips

## Verification
- Syntax: TypeScript compilation tested (no new errors introduced)
- Pattern: Follows Drizzle batch operation patterns
- Transaction: Ensures all-or-nothing semantics

## Files Modified
1. `src/lib/server/functions/product-attributes.ts` - Refactored setProductAttributes to use batch operations with transaction

## Notes
- The `sql\`EXCLUDED.value\`` syntax references the excluded (new) values in the conflict resolution
- Empty arrays are handled gracefully with conditional checks
- Transaction ensures partial updates cannot occur
- This pattern should be applied to similar loops in other functions
