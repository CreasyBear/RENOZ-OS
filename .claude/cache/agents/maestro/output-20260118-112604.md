# Orchestration Report: Activity UI Fixes
Generated: 2026-01-18
Orchestrator: maestro-agent

## Task Decomposition

### Original Task
Fix 10 Activity UI issues across 4 phases:
- Phase 1 (Security): Admin RBAC, CSV injection
- Phase 2 (Critical UX): URL filter sync, cache invalidation
- Phase 3 (Performance): TooltipProvider, memoization, virtualization
- Phase 4 (Polish): IntersectionObserver deps, skeleton dimensions, ARIA

### Issues Analysis (VERIFIED via code inspection)

| # | Issue | File(s) | Severity | Complexity |
|---|-------|---------|----------|------------|
| 1 | Admin RBAC missing | `admin/activities/index.tsx` | SECURITY | Low |
| 2 | CSV injection vulnerable | `activity-timeline.tsx`, `activity-dashboard.tsx` | SECURITY | Medium |
| 3 | URL filter sync stub | `activity-filters.tsx:371-376` | Critical UX | Medium |
| 4 | Cache invalidation missing | `use-activities.ts` | Critical UX | Medium |
| 5 | TooltipProvider per-cell | `activity-heatmap.tsx:112-133` | Performance | Low |
| 6 | Missing memoization | Multiple components | Performance | Medium |
| 7 | Virtualization threshold | `activity-feed.tsx` | Performance | Low |
| 8 | IntersectionObserver deps | `activity-feed.tsx:340` | Polish | Low |
| 9 | Skeleton dimensions | `activity-timeline.tsx:143-148` | Polish | Low |
| 10 | ARIA improvements | Multiple components | Polish | Low |

### Subtasks Identified

| Subtask | Agent | Dependencies | Status | Estimated Time |
|---------|-------|--------------|--------|----------------|
| Create shared CSV sanitizer | spark | none | Pending | 15 min |
| Add RBAC guard to admin route | spark | none | Pending | 10 min |
| Implement URL sync hook | spark | none | Pending | 20 min |
| Add cache invalidation | spark | URL sync | Pending | 15 min |
| Hoist TooltipProvider | spark | none | Pending | 10 min |
| Add memoization | spark | none | Pending | 25 min |
| Fix IntersectionObserver deps | spark | none | Pending | 5 min |
| Fix skeleton dimensions | spark | none | Pending | 5 min |
| ARIA enhancements | spark | none | Pending | 15 min |
| Validation & tests | arbiter | All fixes | Pending | 30 min |

## Orchestration Pattern

**Pattern:** Pipeline with Parallel Batches
**Rationale:** 
1. Phase 1 (Security) MUST complete first - blocking issues
2. Within each phase, independent fixes can run in parallel
3. Phase 4 can partially overlap with Phase 3
4. Final validation requires all fixes complete

```
Phase 1 (Sequential - Security)
  ├── spark: RBAC guard
  └── spark: CSV sanitizer (creates shared utility first)

Phase 2 (Sequential - dependencies)
  ├── spark: URL sync hook (independent)
  └── spark: Cache invalidation (needs URL sync pattern)

Phase 3 (Parallel - Performance)
  ├── spark: TooltipProvider hoist
  ├── spark: Memoization batch
  └── spark: Virtualization review

Phase 4 (Parallel - Polish)
  ├── spark: IntersectionObserver fix
  ├── spark: Skeleton dimensions
  └── spark: ARIA improvements

Phase 5 (Validation)
  └── arbiter: Full test suite + regression check
```

## Execution Plan

### Phase 1: Security Fixes (BLOCKING)

**Order:** Sequential - CSV sanitizer first (creates reusable utility)

#### 1.1 CSV Injection Protection
**Agent:** spark
**Files:** 
- NEW: `src/lib/utils/csv-sanitizer.ts`
- UPDATE: `src/components/activity/activity-timeline.tsx`
- UPDATE: `src/components/activity/activity-dashboard.tsx`

**Implementation Notes:**
- Existing `escapeCSV` in `product-bulk-ops.ts` only handles quotes/commas
- Need to handle formula injection: `=`, `+`, `-`, `@`, `\t`, `\r`
- Create shared utility in `src/lib/utils/csv-sanitizer.ts`

**Pattern to implement:**
```typescript
export function sanitizeCSVValue(value: string): string {
  if (!value) return "";
  // Prevent formula injection
  const formulaChars = ["=", "+", "-", "@", "\t", "\r"];
  let sanitized = value;
  if (formulaChars.some(char => sanitized.startsWith(char))) {
    sanitized = `'${sanitized}`;
  }
  // Escape quotes and wrap if needed
  if (sanitized.includes(",") || sanitized.includes('"') || sanitized.includes("\n")) {
    return `"${sanitized.replace(/"/g, '""')}"`;
  }
  return sanitized;
}
```

#### 1.2 Admin RBAC Guard
**Agent:** spark
**Files:** `src/routes/_authenticated/admin/activities/index.tsx`

**Implementation Notes:**
- Route currently has NO permission check (VERIFIED)
- Other admin routes use `PermissionGuard` component (pattern found in `settings.tsx`)
- Need to add `activity.read` or `admin` permission check

**Pattern to implement:**
```typescript
import { PermissionGuard } from "@/components/shared/permission-guard";

// Wrap ActivityDashboard with:
<PermissionGuard permission="activity.read" fallback={<AccessDenied />}>
  <ActivityDashboard />
</PermissionGuard>
```

### Phase 2: Critical UX Fixes

**Order:** URL sync first, then cache invalidation

#### 2.1 URL Filter Sync
**Agent:** spark
**Files:** `src/components/activity/activity-filters.tsx`

**Implementation Notes:**
- Current `useActivityFiltersFromUrl` is a stub returning `{}` (VERIFIED line 375)
- Need to integrate with TanStack Router's `useSearch` hook
- Pattern exists in route files for search params

**Pattern to implement:**
```typescript
export function useActivityFiltersFromUrl(): ActivityFiltersValue {
  const search = useSearch({ strict: false });
  return {
    action: search.action ?? undefined,
    userId: search.userId ?? undefined,
    entityType: search.entityType ?? undefined,
    from: search.from ? new Date(search.from) : undefined,
    to: search.to ? new Date(search.to) : undefined,
    search: search.q ?? undefined,
  };
}

export function useActivityFiltersToUrl() {
  const navigate = useNavigate();
  return useCallback((filters: ActivityFiltersValue) => {
    navigate({ search: (prev) => ({ ...prev, ...filters }) });
  }, [navigate]);
}
```

#### 2.2 Cache Invalidation
**Agent:** spark  
**Files:** `src/hooks/use-activities.ts`

**Implementation Notes:**
- No invalidation helpers found in current hook (VERIFIED)
- Need mutation hooks that invalidate relevant queries
- Follow pattern from other hooks (e.g., customers)

**Pattern to implement:**
```typescript
export function useInvalidateActivityQueries() {
  const queryClient = useQueryClient();
  return useCallback(() => {
    queryClient.invalidateQueries({ queryKey: queryKeys.activities.all });
  }, [queryClient]);
}
```

### Phase 3: Performance Fixes (Parallel)

#### 3.1 TooltipProvider Optimization
**Agent:** spark
**Files:** `src/components/activity/activity-heatmap.tsx`

**Implementation Notes:**
- TooltipProvider wraps each HeatmapCell (VERIFIED lines 112-133)
- Should be hoisted to parent level
- Single provider for entire heatmap grid

#### 3.2 Memoization
**Agent:** spark
**Files:** 
- `src/components/activity/activity-feed.tsx`
- `src/components/activity/activity-item.tsx`
- `src/components/activity/activity-heatmap.tsx`

**Implementation Notes:**
- `items` useMemo exists (line 180) - VERIFIED
- Need to check: callback memoization, component memoization
- Add `React.memo` to sub-components: `DateGroupHeader`, `HeatmapCell`, `ActivityItem`

#### 3.3 Virtualization Review
**Agent:** spark
**Files:** `src/components/activity/activity-feed.tsx`

**Implementation Notes:**
- `VirtualizedFeed` component exists (VERIFIED)
- Check threshold value is appropriate (currently `virtualizationThreshold`)
- Ensure virtualizer config is optimal

### Phase 4: Polish Fixes (Parallel)

#### 4.1 IntersectionObserver Dependencies
**Agent:** spark
**Files:** `src/components/activity/activity-feed.tsx`

**Implementation Notes:**
- Line 340: `[canLoadMore, feedQuery.fetchNextPage]`
- `fetchNextPage` is a stable function, but pattern should use callback ref
- Consider using `useCallback` wrapper for observer setup

**Pattern to implement:**
```typescript
React.useEffect(() => {
  const element = loadMoreRef.current;
  if (!element || !canLoadMore) return;
  // ... observer setup
}, [canLoadMore]); // Remove fetchNextPage, call via ref
```

#### 4.2 Skeleton Dimensions
**Agent:** spark
**Files:** `src/components/activity/activity-timeline.tsx`

**Implementation Notes:**
- Current: Fixed dimensions (`w-8 h-8`, `w-0.5 h-16`)
- Should match actual content dimensions for reduced layout shift
- Check actual avatar/content sizes and match

#### 4.3 ARIA Improvements
**Agent:** spark
**Files:** Multiple activity components

**Implementation Notes:**
- Good existing ARIA usage (VERIFIED via search)
- Add `aria-describedby` for complex interactions
- Ensure all interactive elements have accessible names
- Add `aria-live="polite"` for dynamic content updates

## Agent Assignment Matrix

| Fix | Agent | Model | Rationale |
|-----|-------|-------|-----------|
| CSV sanitizer utility | spark | inherit | Simple utility creation |
| RBAC guard | spark | inherit | Pattern exists, straightforward |
| URL sync hook | spark | inherit | Medium complexity, clear pattern |
| Cache invalidation | spark | inherit | Pattern exists in codebase |
| TooltipProvider | spark | inherit | Simple refactor |
| Memoization | spark | inherit | Multiple small changes |
| IntersectionObserver | spark | inherit | Minor fix |
| Skeleton dimensions | spark | inherit | CSS adjustment |
| ARIA improvements | spark | inherit | Accessibility patterns |
| Final validation | arbiter | inherit | Requires test execution |

## Execution Order with Parallelization

```
T0 ─────────────────────────────────────────────────────────────────────→

Phase 1 (BLOCKING):
├─ spark[1.1]: CSV sanitizer ──────────────────┐
└─ spark[1.2]: RBAC guard ─────────────────────┤
                                               ↓
Phase 2 (Sequential):                    [Gate: Security Complete]
├─ spark[2.1]: URL sync ───────────────────────┐
└─ spark[2.2]: Cache invalidation ─────────────┤ (can start after 2.1)
                                               ↓
Phase 3 (Parallel):                      [Gate: UX Complete]
├─ spark[3.1]: TooltipProvider ────────┐
├─ spark[3.2]: Memoization ────────────┼───────┐
└─ spark[3.3]: Virtualization ─────────┘       │
                                               │
Phase 4 (Parallel, can overlap Phase 3):       │
├─ spark[4.1]: IntersectionObserver ───────────┤
├─ spark[4.2]: Skeleton dimensions ────────────┤
└─ spark[4.3]: ARIA improvements ──────────────┤
                                               ↓
Phase 5:                                 [Gate: All Fixes Complete]
└─ arbiter: Validation ────────────────────────→ [DONE]
```

## Verification Checkpoints

### After Phase 1 (Security)
- [ ] CSV export does not execute formulas in Excel/Sheets
- [ ] Non-admin users cannot access `/admin/activities`
- [ ] Test: Export with `=SUM()` in description field

### After Phase 2 (UX)
- [ ] URL reflects current filter state
- [ ] Page refresh maintains filters
- [ ] Activity mutations trigger list refresh

### After Phase 3 (Performance)
- [ ] No TooltipProvider warnings in console
- [ ] React DevTools shows memoized components
- [ ] Large lists virtualize correctly

### After Phase 4 (Polish)
- [ ] No React warnings about effect dependencies
- [ ] Skeleton matches final content dimensions
- [ ] Screen reader announces activity updates

### Final Validation (arbiter)
- [ ] All existing tests pass
- [ ] No TypeScript errors
- [ ] No ESLint errors
- [ ] Manual smoke test of activity dashboard

## Rollback Strategy

### Per-Fix Rollback
Each fix is isolated to specific files. Git enables per-commit rollback:
```bash
# Identify commit
git log --oneline -- src/components/activity/

# Revert specific fix
git revert <commit-hash>
```

### Phase Rollback
If entire phase causes issues:
```bash
# Tag before each phase
git tag pre-phase-2-activity-fixes

# Rollback entire phase
git reset --hard pre-phase-2-activity-fixes
```

### Emergency Rollback
If production issues occur:
1. Revert all activity UI commits
2. Deploy previous stable version
3. Investigate in staging environment

## Optimal Batch Size Recommendation

**Recommendation:** 2-3 related fixes per agent session

**Rationale:**
- Keeps context focused
- Reduces risk of cross-contamination
- Enables faster validation cycles

**Suggested Batches:**
1. Security batch: CSV + RBAC (2 fixes)
2. UX batch: URL sync + cache (2 fixes)
3. Performance batch: TooltipProvider + memoization + virtualization (3 fixes)
4. Polish batch: All polish items (3 fixes)

## Files Summary

### Files to Create
- `src/lib/utils/csv-sanitizer.ts` - Shared CSV sanitization utility

### Files to Modify
| File | Fixes |
|------|-------|
| `src/routes/_authenticated/admin/activities/index.tsx` | RBAC guard |
| `src/components/activity/activity-timeline.tsx` | CSV sanitizer, skeleton |
| `src/components/activity/activity-dashboard.tsx` | CSV sanitizer |
| `src/components/activity/activity-filters.tsx` | URL sync |
| `src/components/activity/activity-feed.tsx` | IntersectionObserver, memoization |
| `src/components/activity/activity-heatmap.tsx` | TooltipProvider, memoization |
| `src/components/activity/activity-item.tsx` | memoization |
| `src/hooks/use-activities.ts` | Cache invalidation |

## Recommendations

### Shared Utilities First
Create the CSV sanitizer utility before fixing timeline/dashboard - enables code reuse and single source of truth.

### Test Coverage
Consider adding unit tests for:
- `sanitizeCSVValue` utility
- `useActivityFiltersFromUrl` hook
- Cache invalidation behavior

### Follow-up Work
- Consider extracting common ARIA patterns to shared components
- Performance monitoring for virtualization effectiveness
- E2E tests for filter URL persistence
