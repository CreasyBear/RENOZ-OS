# Architect Output: Activity UI Fixes Plan

**Date:** 2026-01-18
**Task:** Create implementation plan for Activity UI issues
**Full Plan:** `/thoughts/shared/plans/activity-ui-fixes-plan.md`

## Summary

Created comprehensive 4-phase implementation plan for 10 Activity UI issues.

## Key Findings

### Existing Patterns Identified
- **Authorization**: `beforeLoad` with redirect in route definitions
- **Permissions**: `useHasPermission` hook with role-based matrix
- **URL Params**: Zod schema + `validateSearch` in TanStack Router
- **Cache Invalidation**: `useQueryClient().invalidateQueries()` pattern
- **CSV Escaping**: Basic exists, but lacks security sanitization
- **Virtualization**: Already using `@tanstack/react-virtual` in ActivityFeed

### Files Requiring Changes

| File | Phase | Changes |
|------|-------|---------|
| `src/routes/_authenticated/admin/activities/index.tsx` | 1 | Add role-based beforeLoad |
| `src/lib/utils/csv-sanitize.ts` | 1 | NEW - CSV injection prevention |
| `src/lib/auth/route-guards.ts` | 1 | NEW - Reusable route guards |
| `src/components/activity/activity-timeline.tsx` | 1,3 | Safe CSV, virtualization |
| `src/components/activity/activity-feed.tsx` | 2,4 | URL sync, deps fix, skeletons |
| `src/components/activity/activity-heatmap.tsx` | 3,4 | TooltipProvider hoist, skeletons |
| `src/hooks/use-activities.ts` | 2,3 | Cache invalidation, memo fix |
| `src/routes/_authenticated/activities/index.tsx` | 2 | onFiltersChange callback |

## Implementation Order

### Phase 1: Security (BLOCKING)
1. Admin route RBAC - `requireAdmin()` beforeLoad
2. CSV sanitization - prefix `=+@-` with single quote

### Phase 2: Critical UX  
3. URL filter sync - bidirectional filter/URL sync
4. Cache invalidation - `useInvalidateActivities()` hook

### Phase 3: Performance
5. TooltipProvider hoisting (168 -> 1 provider)
6. useMemo fix for `useFlattenedActivities`
7. Timeline virtualization for 50+ items

### Phase 4: Polish
8. IntersectionObserver dependencies
9. Skeleton dimension matching
10. aria-expanded on collapsibles

## Effort Estimates

- Phase 1: ~2 hours (Small x2)
- Phase 2: ~3 hours (Medium + Small)
- Phase 3: ~4 hours (Small x2 + Medium)
- Phase 4: ~2 hours (Small x3)
- **Total: ~11 hours**

## Blockers

None identified. All dependencies already in project.

## Open Questions

1. Redirect destination for unauthorized admin access?
2. Include CSV sanitization warning header?
3. Virtualization threshold (proposed: 50)?
