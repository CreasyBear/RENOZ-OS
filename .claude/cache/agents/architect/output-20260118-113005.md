# Architect Agent Output: Communications Domain Pre-Mortem
Date: 2026-01-18
Mode: DEEP

## Summary

Analyzed Communications Domain (DOM-COMMS) implementation covering activity bridge, source tracking, and quick log UI.

**Findings:**
- 5 Tigers (real risks)
- 1 Elephant (unspoken concern)  
- 2 Paper Tigers (looks scary but OK)

## Critical Issues

### TIGER 1: Missing activity.create permission
- **Location:** `src/lib/server/quick-log.ts:42`
- **Severity:** Medium
- **Fix:** Add `activity.create` to PERMISSIONS and role matrix

### TIGER 2: No transaction for quick-log
- **Location:** `src/lib/server/quick-log.ts:59-100`
- **Severity:** Medium
- **Fix:** Wrap activity + scheduledCalls inserts in db.transaction()

### TIGER 3: No rate limiting on tracking endpoints
- **Location:** `src/routes/api/track/open.$emailId.ts`
- **Severity:** Medium
- **Fix:** Add IP-based rate limiting middleware

### TIGER 4-5: Zero test coverage
- **Locations:** `src/lib/server/activity-bridge.ts`, `src/lib/server/quick-log.ts`
- **Severity:** High/Medium
- **Fix:** Create unit tests for bridge functions and quick-log

### ELEPHANT: Privacy compliance gap
- `isTrackingAllowed()` always returns true
- Activity created regardless of consent
- GDPR risk

## Paper Tigers (OK)
- Fire-and-forget tracking: Intentional, prioritizes UX
- sourceRef without FK: Intentional, preserves audit integrity

## Full Report
See: `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/thoughts/shared/plans/comms-domain-premortem.md`
