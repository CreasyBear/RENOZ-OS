# Pre-Mortem Analysis: Products Domain Implementation
Generated: 2026-01-17

## Erotetic Framework
- **X (Symptom)**: Pre-implementation risk assessment for Products domain (18 stories)
- **Q (Questions to resolve)**:
  1. Are there N+1 query patterns?
  2. Missing pagination limits?
  3. Security/authorization gaps?
  4. Data integrity issues (FK constraints, orphan handling)?
  5. Race conditions in stock updates?
  6. Missing error handling?
  7. Performance bottlenecks (missing indexes)?

---

## Investigation Summary

| Step | Action | Finding |
|------|--------|---------|
| 1 | Read all schema files | 8 product-related tables with relations |
| 2 | Read server functions | 8 server function files (~3500 lines) |
| 3 | Check FK constraints | Only inventory table has explicit FK with onDelete |
| 4 | Check N+1 patterns | Found 5 for-loop DB query patterns |
| 5 | Check auth | withAuth + RLS context properly implemented |
| 6 | Check indexes | Comprehensive indexing in schemas |

---

```yaml
premortem:
  mode: deep

  tigers:  # Real verified risks

    # ========== SCALABILITY RISKS ==========
    
    - risk: "N+1 query pattern in bulkUpdatePrices - individual DB queries per product"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-pricing.ts:625-680"
      severity: medium
      category: scalability
      mitigation_checked: "No batch SELECT/UPDATE - each product queried individually in loop"
      suggested_fix: |
        Use batch SELECT with inArray(), then batch UPDATE.
        Example:
        ```typescript
        const currentProducts = await db.select().from(products)
          .where(inArray(products.id, data.updates.map(u => u.productId)));
        // Then batch update
        ```

    - risk: "N+1 query pattern in applyPriceAdjustment - queries each product individually"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-pricing.ts:726-800"
      severity: medium
      category: scalability
      mitigation_checked: "Same loop pattern as bulkUpdatePrices"
      suggested_fix: "Batch fetch all products first, then apply updates in single query"

    - risk: "N+1 in bulkReceiveStock - calls receiveStock per item in loop"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-inventory.ts:1283-1303"
      severity: medium
      category: scalability
      mitigation_checked: "Calls receiveStock() in for-loop, no transaction wrapping entire batch"
      suggested_fix: |
        Wrap in single transaction, batch the inventory upserts.
        Consider db.transaction() around entire loop.

    - risk: "N+1 in setProductAttributes - individual upserts per attribute"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-attributes.ts:646-700"
      severity: low
      category: scalability
      mitigation_checked: "Sequential await in for-loop for each attribute value"
      suggested_fix: "Use batch insert/update with onConflictDoUpdate array"

    - risk: "Search analytics stored in-memory Map - lost on restart, unbounded growth"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-search.ts:31"
      severity: medium
      category: scalability
      mitigation_checked: "const searchAnalytics = new Map<string, SearchAnalyticsEntry>() - no persistence, no size limit"
      suggested_fix: |
        Move to database table with periodic cleanup.
        Add max size limit: if (searchAnalytics.size > 10000) prune oldest entries

    # ========== DATA INTEGRITY RISKS ==========

    - risk: "Missing FK constraints on product_bundles table - orphan components possible"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-bundles.ts:26-31"
      severity: high
      category: data
      mitigation_checked: |
        bundleProductId and componentProductId are uuid() columns without .references()
        Only inventory.ts has proper FK constraints with onDelete behavior
      suggested_fix: |
        Add FK constraints:
        bundleProductId: uuid("bundle_product_id")
          .notNull()
          .references(() => products.id, { onDelete: "cascade" })

    - risk: "Missing FK constraints on product_images table"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-images.ts:48"
      severity: high
      category: data
      mitigation_checked: "productId: uuid('product_id').notNull() - no .references()"
      suggested_fix: "Add .references(() => products.id, { onDelete: 'cascade' })"

    - risk: "Missing FK constraints on product_relations table"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-relations.ts:36-39"
      severity: high
      category: data
      mitigation_checked: "productId and relatedProductId have no FK constraints"
      suggested_fix: "Add references with onDelete cascade to both columns"

    - risk: "Missing FK constraints on product_price_tiers and customer_product_prices"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-pricing.ts:30,84"
      severity: high
      category: data
      mitigation_checked: "productId columns have no .references()"
      suggested_fix: "Add FK constraints with onDelete cascade"

    - risk: "Missing FK constraints on product_attribute_values"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-attributes.ts:117-118"
      severity: high
      category: data
      mitigation_checked: "productId and attributeId have no references"
      suggested_fix: "Add FK constraints - productId cascade, attributeId cascade"

    - risk: "Categories table allows orphaned products - no product.categoryId FK"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/products.ts:84"
      severity: medium
      category: data
      mitigation_checked: "categoryId: uuid('category_id') - no .references() to categories"
      suggested_fix: "Add .references(() => categories.id, { onDelete: 'set null' })"

    - risk: "No transaction in stock transfer - partial failure leaves inconsistent state"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-inventory.ts:850-994"
      severity: low
      category: data
      mitigation_checked: "Actually VERIFIED: db.transaction() IS used at line 850"
      suggested_fix: "N/A - transaction is properly used"

    # ========== SECURITY RISKS ==========

    - risk: "ILIKE search patterns susceptible to regex injection"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/products.ts:68-73"
      severity: low
      category: security
      mitigation_checked: |
        Search uses: ${products.name} ILIKE ${`%${search}%`}
        User input directly interpolated. Drizzle parameterizes but % wildcards not escaped.
      suggested_fix: |
        Escape LIKE special characters: _ and %
        const escapedSearch = search.replace(/[%_]/g, '\\$&')

    - risk: "CSV import accepts user content without sanitization"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-bulk-ops.ts:83-140"
      severity: low
      category: security
      mitigation_checked: "parseCSV uses simple split, values inserted via Drizzle (parameterized)"
      suggested_fix: "Consider HTML/script tag stripping for name/description fields"

    # ========== ERROR HANDLING RISKS ==========

    - risk: "recordPriceChange helper has no try-catch - could fail silently"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-pricing.ts:448-470"
      severity: low
      category: error-handling
      mitigation_checked: "Internal function called from bulkUpdatePrices - error would propagate but pricing update could succeed while history fails"
      suggested_fix: "Wrap in transaction with the price update, or add try-catch with logging"

    - risk: "bulkDeleteImages - no transaction, partial deletes possible"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-images.ts:480-510"
      severity: low
      category: error-handling
      mitigation_checked: "Multiple await calls without transaction wrapper"
      suggested_fix: "Wrap in db.transaction()"

    # ========== PERFORMANCE RISKS ==========

    - risk: "getCategoryTree loads ALL categories then builds tree in memory"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/products.ts:338-367"
      severity: low
      category: performance
      mitigation_checked: "Fetches all active categories for org, builds tree client-side"
      suggested_fix: |
        For large category trees (100+), consider:
        - Recursive CTE in PostgreSQL
        - Caching with invalidation
        - Lazy loading of subtrees

    - risk: "searchProducts filterByAttributes performs in-memory filtering after DB query"
      location: "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-search.ts:160-200"
      severity: medium
      category: performance
      mitigation_checked: "Queries products first, then filters by attributes in JS"
      suggested_fix: |
        Push attribute filtering to SQL with JSON operators:
        WHERE value->>'attributeId' = '...'

  paper_tigers:  # Looks bad but actually ok

    - risk: "No pagination limit enforcement on listProducts"
      reason: |
        VERIFIED OK: productListQuerySchema enforces pageSize via z.number().int().min(1).max(100)
        Default is 20, max is 100. Proper pagination implemented.

    - risk: "Multiple parallel queries in getProduct might cause N+1"
      reason: |
        VERIFIED OK: Uses Promise.all() for parallel fetches of related data.
        This is efficient - 6 parallel queries vs 6 sequential.

    - risk: "Stock adjustments might have race conditions"
      reason: |
        VERIFIED OK: recordMovement, allocateStock, transferStock all use db.transaction()
        with proper SELECT ... FOR UPDATE pattern (implicit via single transaction).

    - risk: "Missing organizationId filter could leak data"
      reason: |
        VERIFIED OK: All queries include eq(table.organizationId, ctx.organizationId).
        Additionally, withAuth sets RLS context: set_config('app.organization_id', ...)

    - risk: "Category delete could orphan products"
      reason: |
        VERIFIED OK: deleteCategory checks for products before deletion:
        "Cannot delete category with products. Move products to another category first."

    - risk: "Bundle validation might miss circular references"
      reason: |
        VERIFIED OK: validateBundle checks for nested bundles and warns.
        setBundleComponents checks for self-reference.
        Note: Does not detect A->B->A cycles (multi-level), but warns about nested bundles.

  elephants:  # Unspoken concerns

    - risk: "No soft delete cascade - deleting product leaves orphaned related records"
      description: |
        Products use soft delete (deletedAt). Related tables (images, pricing, attributes, relations, bundles)
        are not automatically cleaned up when product is soft-deleted. Over time this creates data bloat.
        Server functions don't filter by product.deletedAt when querying related records.

    - risk: "No audit trail for inventory movements beyond the movements table"
      description: |
        While inventoryMovements provides history, there's no user-facing audit log
        integration (e.g., activities table linkage). For compliance, may need to track WHO made changes.

    - risk: "Supabase Storage integration for images is client-side only"
      description: |
        addProductImage assumes client uploads to Supabase Storage first, then records metadata.
        No server-side validation that the URL actually belongs to Supabase Storage.
        A user could insert arbitrary URLs (potential SSRF/content issues).

    - risk: "Price history recording is inconsistent"
      description: |
        recordPriceChange is called in bulkUpdatePrices but not in individual updateProduct.
        If basePrice is changed via updateProduct, no price history is recorded.

    - risk: "No rate limiting on search or bulk operations"
      description: |
        searchProducts, importProducts, bulkUpdatePrices have no rate limits.
        A malicious user could DOS the system with repeated bulk imports.
```

---

## Recommended Fixes by Priority

### P0 - High (Data Integrity)
1. **Add FK constraints to all product-related tables** - Migration required
   - `product_bundles.bundleProductId -> products.id`
   - `product_bundles.componentProductId -> products.id`
   - `product_images.productId -> products.id`
   - `product_relations.productId -> products.id`
   - `product_relations.relatedProductId -> products.id`
   - `product_price_tiers.productId -> products.id`
   - `customer_product_prices.productId -> products.id`
   - `product_attribute_values.productId -> products.id`
   - `product_attribute_values.attributeId -> product_attributes.id`
   - `products.categoryId -> categories.id`

### P1 - Medium (Scalability)
2. **Batch the N+1 patterns in bulk operations**
   - `bulkUpdatePrices`: Batch SELECT, then single UPDATE
   - `applyPriceAdjustment`: Same pattern
   - `bulkReceiveStock`: Wrap in single transaction

3. **Persist search analytics to database**
   - Create `search_analytics` table
   - Add size limit to in-memory cache

### P2 - Low (Error Handling / Performance)
4. **Add transaction wrappers to bulk operations**
   - `bulkDeleteImages`
   - `bulkUpdateAltText`

5. **Record price history consistently**
   - Call `recordPriceChange` from `updateProduct` when price changes

6. **Validate Supabase Storage URLs**
   - Server-side check that `imageUrl` matches expected Supabase pattern

---

## Confidence Assessment

| Finding Category | Confidence | Evidence |
|------------------|------------|----------|
| Missing FKs | HIGH | Read all schema files, verified no .references() calls |
| N+1 Patterns | HIGH | Found explicit for-loops with DB queries inside |
| Auth/Security | HIGH | Verified withAuth + RLS properly implemented |
| Transaction Usage | HIGH | Verified db.transaction() used in stock operations |
| Error Handling | MEDIUM | Some functions lack try-catch but errors propagate |

---

## Files Analyzed

**Schema Files (8):**
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/products.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/categories.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-bundles.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-images.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-relations.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-attributes.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/product-pricing.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/inventory.ts`

**Server Function Files (8):**
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/products.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-pricing.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-bundles.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-images.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-attributes.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-inventory.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-bulk-ops.ts`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/functions/product-search.ts`

**Route Files (2):**
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/routes/_authenticated/products/index.tsx`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/routes/_authenticated/products/$productId.tsx`

**Auth (1):**
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/protected.ts`
