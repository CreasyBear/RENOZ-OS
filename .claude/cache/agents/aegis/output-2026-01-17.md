# Security Assessment: Schema Foundation Implementation
Generated: 2026-01-17

## Executive Summary
- **Risk Level:** HIGH
- **Findings:** 2 critical, 3 high, 4 medium, 2 low
- **Immediate Actions Required:** Yes

## Threat Model
- **Assets:** Customer PII, order data, financial records, API credentials
- **Attackers:** Unauthenticated external actors, authenticated users attempting privilege escalation, malicious tenants attempting cross-tenant data access
- **Vectors:** SQL injection, multi-tenant isolation bypass, cursor tampering, JSONB manipulation, credential exposure

---

## Findings

### CRITICAL: Missing organizationId Filtering in Customer Routes

**Location:** `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/server/customers.ts:41-42, 107-108`

**Vulnerability:** Multi-tenant Data Leakage

**Risk:** Any authenticated user can access ALL customers across ALL organizations. The TODO comments indicate this is known but unfixed:

**Evidence:**
```typescript
// src/server/customers.ts:41-42
// TODO: Add organizationId filter from session context
// conditions.push(eq(customers.organizationId, ctx.organizationId));

// src/server/customers.ts:197-198
// TODO: Get organizationId from session context
const organizationId = "00000000-0000-0000-0000-000000000000"; // Placeholder
```

**Impact:** Complete multi-tenant isolation failure. User from Organization A can read/modify Organization B's customers.

**Remediation:**
1. Immediately add `withAuth()` pattern to all customer server functions (like `users.ts` does)
2. Add `eq(customers.organizationId, ctx.organizationId)` to all queries
3. Replace hardcoded `organizationId` with `ctx.organizationId` in create operations
4. Add integration tests verifying tenant isolation

---

### CRITICAL: RLS Policies Not Enabled on Most Tables

**Location:** 
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/users.ts:116-135` (HAS RLS - good)
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/api-tokens.ts:111-138` (HAS RLS - good)
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/customers.ts` (NO RLS)
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/orders.ts` (NO RLS)
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/products.ts` (NO RLS)
- All other business tables (NO RLS)

**Vulnerability:** Supabase RLS Bypass

**Risk:** Only `users` and `api_tokens` tables have RLS policies. All business-critical tables (customers, orders, products, pipeline, inventory, etc.) lack RLS protection.

**Evidence:**
```typescript
// users.ts has RLS:
selectPolicy: pgPolicy("users_select_policy", {
  for: "select",
  to: "authenticated",
  using: sql`organization_id = current_setting('app.organization_id', true)::uuid`,
}),

// customers.ts - NO RLS POLICIES DEFINED
// orders.ts - NO RLS POLICIES DEFINED
// products.ts - NO RLS POLICIES DEFINED
```

**Impact:** If RLS is enabled on the database but policies are missing, direct database access (Supabase client, direct SQL) bypasses application-level tenant filtering.

**Remediation:**
1. Add `pgPolicy` definitions to ALL business tables following the pattern in `users.ts`
2. Ensure `app.organization_id` session variable is set on all database connections
3. Verify RLS is enabled (`ALTER TABLE ... ENABLE ROW LEVEL SECURITY`) in migrations
4. Test RLS enforcement with Supabase client-side calls

---

### HIGH: Cursor Pagination Lacks Input Validation

**Location:** `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/db/pagination.ts:89-102`

**Vulnerability:** Cursor Tampering / Information Disclosure

**Risk:** Cursor decoding has minimal validation. An attacker could craft malicious base64 cursors.

**Evidence:**
```typescript
export function decodeCursor(cursor: string): CursorPosition | null {
  try {
    const decoded = JSON.parse(atob(cursor));
    if (
      typeof decoded.createdAt === "string" &&
      typeof decoded.id === "string"
    ) {
      return decoded as CursorPosition;
    }
    return null;
  } catch {
    return null;
  }
}
```

**Issues:**
1. No UUID format validation on `id` field - could cause SQL errors or unexpected behavior
2. No ISO date validation on `createdAt` - `new Date(cursor.createdAt)` at line 135 could produce invalid dates
3. No length limits - oversized cursors could cause memory issues

**Remediation:**
1. Add UUID validation: `z.string().uuid().safeParse(decoded.id)`
2. Add ISO date validation: `z.string().datetime().safeParse(decoded.createdAt)`
3. Add cursor length limit (e.g., max 500 chars before decoding)
4. Consider signing cursors with HMAC to prevent tampering

---

### HIGH: API Token Uses SHA-256 Instead of bcrypt

**Location:** `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/api-tokens.ts:61-66`

**Vulnerability:** Weak Token Hashing

**Risk:** SHA-256 is fast and vulnerable to brute-force attacks. API tokens should use bcrypt/scrypt/argon2.

**Evidence:**
```typescript
/**
 * Hash a token using SHA-256 for storage.
 * Note: For production, consider bcrypt for additional security.
 */
async function hashToken(token: string): Promise<string> {
  const encoder = new TextEncoder();
  const data = encoder.encode(token);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  // ...
}
```

**Impact:** If database is compromised, attacker can brute-force SHA-256 hashes at billions of attempts per second vs thousands with bcrypt.

**Remediation:**
1. Replace SHA-256 with bcrypt: `import bcrypt from 'bcryptjs'`
2. Use cost factor of 12+: `bcrypt.hash(token, 12)`
3. Update validation to use `bcrypt.compare()`
4. Consider token migration strategy for existing tokens

---

### HIGH: Admin Supabase Client Warning Not Enforced

**Location:** `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/supabase/server.ts:72-88`

**Vulnerability:** RLS Bypass via Admin Client Misuse

**Risk:** `createAdminSupabase()` bypasses all RLS policies. The warning is in comments only.

**Evidence:**
```typescript
/**
 * WARNING: This client has full database access. Never expose to client-side
 * or use for user-initiated operations without proper authorization checks.
 */
export function createAdminSupabase(): SupabaseClient {
  // ...
  return createClient(supabaseUrl!, supabaseServiceRoleKey, {
    // ...
  })
}
```

**Impact:** Accidental use of admin client in user-facing code bypasses all RLS protections.

**Remediation:**
1. Add runtime warnings: `console.warn('[SECURITY] Admin Supabase client used - ensure proper authorization')`
2. Consider requiring explicit context parameter documenting the authorization reason
3. Add linting rule to flag `createAdminSupabase` usage
4. Audit all uses of admin client in codebase

---

### MEDIUM: JSONB Fields Lack Schema Validation on Storage

**Location:** Multiple schema files
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/customers.ts:78-84`
- `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/orders.ts:93-96`

**Vulnerability:** JSONB Injection / Data Corruption

**Risk:** JSONB fields use TypeScript interfaces for type hints but no runtime validation on insert/update.

**Evidence:**
```typescript
// Schema defines type hint only
addresses: jsonb("addresses").$type<CustomerAddress[]>().default([]),
preferences: jsonb("preferences").$type<CustomerPreferences>().default({}),
```

**Issues:**
1. Database accepts any valid JSON regardless of schema
2. Could store XSS payloads in preference notes
3. Could inject oversized arrays causing performance issues

**Remediation:**
1. Add Zod validation in server functions before database writes
2. Consider PostgreSQL JSONB constraints or check constraints
3. Sanitize string fields for XSS (especially `notes`, `description` fields)
4. Add array length limits in Zod schemas

---

### MEDIUM: Contacts Table Has UUID Type for Boolean Fields

**Location:** `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/customers.ts:150-151`

**Vulnerability:** Schema Design Error / Potential Data Corruption

**Risk:** Boolean flags incorrectly use `uuid` type instead of `boolean`.

**Evidence:**
```typescript
// Flags
isPrimary: uuid("is_primary").default(sql`false`),
isDecisionMaker: uuid("is_decision_maker").default(sql`false`),
```

**Impact:** 
1. `sql`false`` in uuid context is semantically incorrect
2. Could cause query issues or data corruption
3. Application logic expecting boolean may fail

**Remediation:**
1. Change to: `isPrimary: boolean("is_primary").default(false),`
2. Create migration to fix existing data
3. Update any queries depending on these fields

---

### MEDIUM: Password Validation Missing Special Character Requirement

**Location:** `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/schemas/auth.ts:32-36`

**Vulnerability:** Weak Password Policy

**Risk:** Password requirements miss special characters, increasing susceptibility to dictionary attacks.

**Evidence:**
```typescript
password: z
  .string()
  .min(8, "Password must be at least 8 characters")
  .regex(/[A-Z]/, "Password must contain at least one uppercase letter")
  .regex(/[a-z]/, "Password must contain at least one lowercase letter")
  .regex(/[0-9]/, "Password must contain at least one number"),
```

**Remediation:**
1. Add: `.regex(/[!@#$%^&*(),.?":{}|<>]/, "Password must contain a special character")`
2. Consider password length minimum of 12 characters per NIST guidelines
3. Consider integrating with HaveIBeenPwned API for breached password checking

---

### MEDIUM: Error Messages May Leak User Existence

**Location:** `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/protected.ts:91-93`

**Vulnerability:** User Enumeration

**Risk:** Different error messages for "user not found" vs "account suspended" enable user enumeration.

**Evidence:**
```typescript
if (!appUser) {
  throw new AuthError('User not found in application database')
}

if (appUser.status !== 'active') {
  throw new AuthError(`Account is ${appUser.status}. Please contact your administrator.`)
}
```

**Remediation:**
1. Use generic message: `throw new AuthError('Authentication failed')`
2. Log detailed reason server-side for debugging
3. Apply same pattern to login failures

---

### LOW: Environment Variable Error Messages Reveal File Structure

**Location:** `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/db/index.ts:28-30`

**Vulnerability:** Information Disclosure

**Evidence:**
```typescript
throw new Error(
  "DATABASE_URL environment variable is required. " +
    "Use the Supabase connection pooler URL (port 6543) for Transaction mode."
)
```

**Remediation:**
1. Use generic message in production
2. Log detailed message only in development

---

### LOW: `.env` File Present in Project Root

**Location:** `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/.env`

**Vulnerability:** Potential Secrets Exposure

**Evidence:**
- `.env` file exists with 3211 bytes
- `.gitignore` contains `.env` (VERIFIED - good)

**Status:** Mitigated by .gitignore, but verify `.env` never committed to git history.

**Remediation:**
1. Run: `git log --all --full-history -- .env` to verify never committed
2. Consider using `.env.local` pattern for extra safety

---

## Dependency Vulnerabilities

| Package | Version | CVE | Severity | Fixed In |
|---------|---------|-----|----------|----------|
| N/A | - | - | - | Run `npm audit` for full scan |

**Note:** Run `npm audit` in project directory for current vulnerability report.

---

## Secrets Exposure Check

- `.env` files: In .gitignore? **YES** (VERIFIED)
- `.env.example` present: **YES** - contains placeholder values only (VERIFIED)
- Hardcoded secrets: **NO** - all credentials via env vars (VERIFIED)
- Service role key exposure: Properly guarded in `createAdminSupabase()` (VERIFIED)
- VITE_ prefix vars: Appropriately limited to public keys only (VERIFIED)

---

## Recommendations

### Immediate (Critical/High)
1. **Add organizationId filtering to ALL customer server functions** - Use `withAuth()` pattern from `users.ts`
2. **Add RLS policies to ALL business tables** - Follow pattern from `users.ts` and `api-tokens.ts`
3. **Replace SHA-256 with bcrypt for API token hashing** - Security standard for secrets storage
4. **Add UUID/date validation to cursor decoder** - Prevent malformed input attacks

### Short-term (Medium)
5. **Fix contacts table boolean field types** - Change `uuid` to `boolean`
6. **Add runtime JSONB validation** - Validate before insert/update operations
7. **Strengthen password requirements** - Add special character and length requirements
8. **Genericize authentication error messages** - Prevent user enumeration

### Long-term (Hardening)
9. **Implement cursor signing with HMAC** - Prevent cursor tampering
10. **Add linting rules for admin client usage** - Prevent accidental RLS bypass
11. **Implement rate limiting** - `RateLimitError` class exists but rate limiting not implemented
12. **Add security headers middleware** - CSP, HSTS, X-Frame-Options etc.
13. **Implement audit logging for sensitive operations** - Activities table exists, wire it up
14. **Add integration tests for tenant isolation** - Verify RLS and app-level filtering

---

## Files Reviewed

| File | Status |
|------|--------|
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/db/index.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/db/pagination.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/patterns.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/customers.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/organizations.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/users.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/orders.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/products.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/pipeline.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/activities.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/api-tokens.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/inventory.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/notifications.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/drizzle/schema/email-history.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/schemas/patterns.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/schemas/customers.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/schemas/auth.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/schemas/orders.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/schemas/products.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/server/customers.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/server/users.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/protected.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/errors.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/server/api-tokens.ts` | VERIFIED |
| `/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/continuous-claude/renoz-v3/src/lib/supabase/server.ts` | VERIFIED |
