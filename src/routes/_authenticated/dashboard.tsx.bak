/**
 * Dashboard Route
 *
 * The landing page after authentication.
 * Shows key metrics, quick actions, and summary widgets.
 *
 * Features:
 * - Full-width PageLayout
 * - Pipeline summary widget (real data)
 * - Recent orders widget (real data)
 * - Low stock alerts widget (real data)
 * - Quick action buttons
 * - Loading skeleton during data fetch
 */
import { createFileRoute, useNavigate, Link } from '@tanstack/react-router'
import {
  TrendingUp,
  Users,
  ShoppingCart,
  AlertTriangle,
  Plus,
  FileText,
  ArrowRight,
  Loader2,
} from 'lucide-react'
import { cn } from '@/lib/utils'
import { formatCurrency } from '@/lib/formatters'
import { PageLayout } from '@/components/layout'

import {
  useRealtimeOrders,
  useRealtimePipeline,
  getStatusColor,
  getStatusLabel,
} from '@/hooks/realtime'
import { useDashboardMetrics } from '@/hooks/dashboard'
import { useOrders } from '@/hooks/orders/use-orders'
import { useInventoryLowStock } from '@/hooks/inventory/use-inventory'
import { WelcomeChecklist } from '@/components/domain/dashboard/welcome-checklist'
import { UpcomingCallsWidget } from '@/components/domain/communications'

export const Route = createFileRoute('/_authenticated/dashboard')({
  component: Dashboard,
})

// ============================================================================
// COMPONENT
// ============================================================================

function Dashboard() {
  // Subscribe to realtime updates for live data indicators
  const { status: ordersStatus } = useRealtimeOrders({ notifyOnNew: true })
  const { status: pipelineStatus } = useRealtimePipeline({ notifyOnStageChange: true })

  // Use the most relevant status (prefer connected, then connecting, then error)
  const combinedStatus = ordersStatus === 'connected' && pipelineStatus === 'connected'
    ? 'connected'
    : ordersStatus === 'connecting' || pipelineStatus === 'connecting'
      ? 'connecting'
      : ordersStatus === 'error' || pipelineStatus === 'error'
        ? 'error'
        : 'disconnected'

  // Fetch real dashboard metrics
  const { data: metricsData, isLoading: isMetricsLoading } = useDashboardMetrics({
    dateFrom: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
    dateTo: new Date().toISOString().split('T')[0],
  })

  // Fetch real recent orders
  const { data: ordersData, isLoading: isOrdersLoading } = useOrders({
    page: 1,
    pageSize: 5,
    sortBy: 'createdAt',
    sortOrder: 'desc',
  })

  // Fetch real low stock alerts
  const { data: lowStockData, isLoading: isLowStockLoading } = useInventoryLowStock()

  const isLoading = isMetricsLoading || isOrdersLoading || isLowStockLoading

  // Extract real data
  const pipelineValue = metricsData?.summary?.pipelineValue?.current ?? 0
  const pipelineChange = metricsData?.summary?.pipelineValue?.change ?? 0
  const hotLeads = 0 // TODO: Add hot leads query when available
  const ordersCount = metricsData?.summary?.ordersCount?.current ?? 0

  const recentOrders = ordersData?.orders?.slice(0, 5) ?? []
  const lowStockItems = lowStockData?.items?.slice(0, 5) ?? []

  return (
    <PageLayout variant="full-width">
      <PageLayout.Header
        title="Dashboard"
        description={
          <span className="flex items-center gap-2">
            Welcome back! Here&apos;s what&apos;s happening today.
            <span className="inline-flex items-center gap-1.5 text-xs">
              <span className={cn('h-2 w-2 rounded-full', getStatusColor(combinedStatus))} />
              {getStatusLabel(combinedStatus)}
            </span>
          </span>
        }
        actions={<QuickActions />}
      />
      <PageLayout.Content>
        {/* Welcome Checklist - shown for new users */}
        <WelcomeChecklist className="mb-6" />

        <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
          {/* Pipeline Summary */}
          <MetricCard
            title="Pipeline Value"
            value={isLoading ? '-' : formatCurrency(pipelineValue)}
            subtitle={`${hotLeads} hot leads`}
            icon={<TrendingUp className="h-5 w-5" />}
            trend={pipelineChange !== 0 ? `${pipelineChange > 0 ? '+' : ''}${pipelineChange.toFixed(1)}%` : undefined}
            trendUp={pipelineChange > 0}
            isLoading={isMetricsLoading}
          />

          {/* Hot Leads Count */}
          <MetricCard
            title="Hot Leads"
            value={isLoading ? '-' : hotLeads.toString()}
            subtitle="Leads requiring attention"
            icon={<Users className="h-5 w-5" />}
            isLoading={isMetricsLoading}
          />

          {/* Recent Orders Count */}
          <MetricCard
            title="Recent Orders"
            value={isLoading ? '-' : ordersCount.toString()}
            subtitle="Orders this period"
            icon={<ShoppingCart className="h-5 w-5" />}
            trend={metricsData?.summary?.ordersCount?.change !== undefined && metricsData.summary.ordersCount.change !== 0
              ? `${metricsData.summary.ordersCount.change > 0 ? '+' : ''}${metricsData.summary.ordersCount.change.toFixed(1)}%`
              : undefined}
            trendUp={(metricsData?.summary?.ordersCount?.change ?? 0) > 0}
            isLoading={isMetricsLoading}
          />
        </div>

        <div className="mt-8 grid gap-6 lg:grid-cols-3">
          {/* Upcoming Calls Widget - self-contained component that fetches its own data */}
          <UpcomingCallsWidget limit={5} />

          {/* Recent Orders Widget */}
          <WidgetCard
            title="Recent Orders"
            href="/orders"
            isLoading={isOrdersLoading}
          >
            {recentOrders.length > 0 ? (
              <div className="divide-y divide-gray-100">
                {recentOrders.map((order) => (
                  <Link
                    key={order.id}
                    to="/orders/$orderId"
                    params={{ orderId: order.id }}
                    className="flex items-center justify-between py-3 hover:bg-gray-50 -mx-2 px-2 rounded transition-colors"
                  >
                    <div>
                      <p className="text-sm font-medium text-gray-900">
                        {order.customer?.name || 'Unknown Customer'}
                      </p>
                      <p className="text-sm text-gray-500">
                        {formatCurrency(order.total ?? 0)}
                      </p>
                    </div>
                    <OrderStatusBadge status={order.status} />
                  </Link>
                ))}
              </div>
            ) : (
              <p className="py-6 text-center text-sm text-gray-500">
                No recent orders
              </p>
            )}
          </WidgetCard>

          {/* Low Stock Alerts Widget */}
          <WidgetCard
            title="Low Stock Alerts"
            href="/inventory/alerts"
            isLoading={isLowStockLoading}
          >
            {lowStockItems.length > 0 ? (
              <div className="space-y-3">
                {lowStockItems.map((item) => (
                  <Link
                    key={item.id}
                    to="/inventory/$itemId"
                    params={{ itemId: item.id }}
                    className="flex items-center gap-3 rounded-lg bg-amber-50 p-3 hover:bg-amber-100 transition-colors"
                  >
                    <AlertTriangle className="h-5 w-5 text-amber-500 shrink-0" />
                    <div className="flex-1 min-w-0">
                      <p className="text-sm font-medium text-gray-900 truncate">
                        {item.product?.name || 'Unknown Product'}
                      </p>
                      <p className="text-xs text-gray-500">
                        {item.quantityOnHand} in stock
                        
                      </p>
                    </div>
                  </Link>
                ))}
              </div>
            ) : (
              <p className="py-6 text-center text-sm text-gray-500">
                No low stock alerts
              </p>
            )}
          </WidgetCard>
        </div>
      </PageLayout.Content>
    </PageLayout>
  )
}

// ============================================================================
// SUB-COMPONENTS
// ============================================================================

function QuickActions() {
  const navigate = useNavigate()

  const handleNewCustomer = () => {
    navigate({ to: '/customers/new' })
  }

  const handleNewQuote = () => {
    navigate({ to: '/pipeline/new', search: { stage: 'new' } })
  }

  return (
    <div className="flex flex-wrap gap-2">
      <button
        type="button"
        onClick={handleNewCustomer}
        className={cn(
          'inline-flex items-center gap-2 rounded-lg px-4 py-2',
          'bg-gray-900 text-white text-sm font-medium',
          'hover:bg-gray-800 transition-colors'
        )}
      >
        <Plus className="h-4 w-4" />
        New Customer
      </button>
      <button
        type="button"
        onClick={handleNewQuote}
        className={cn(
          'inline-flex items-center gap-2 rounded-lg px-4 py-2',
          'border border-gray-300 text-gray-700 text-sm font-medium',
          'hover:bg-gray-50 transition-colors'
        )}
      >
        <FileText className="h-4 w-4" />
        New Quote
      </button>
    </div>
  )
}

interface MetricCardProps {
  title: string
  value: string
  subtitle: string
  icon: React.ReactNode
  trend?: string
  trendUp?: boolean
  isLoading?: boolean
}

function MetricCard({ title, value, subtitle, icon, trend, trendUp, isLoading }: MetricCardProps) {
  if (isLoading) {
    return (
      <div className="rounded-xl border border-gray-200 bg-white p-6">
        <div className="flex items-center justify-between">
          <span className="text-sm font-medium text-gray-500">{title}</span>
          <span className="text-gray-400">{icon}</span>
        </div>
        <div className="mt-4 flex items-center gap-2">
          <Loader2 className="h-5 w-5 animate-spin text-gray-400" />
          <span className="text-sm text-gray-400">Loading...</span>
        </div>
      </div>
    )
  }

  return (
    <div className="rounded-xl border border-gray-200 bg-white p-6">
      <div className="flex items-center justify-between">
        <span className="text-sm font-medium text-gray-500">{title}</span>
        <span className="text-gray-400">{icon}</span>
      </div>
      <div className="mt-2 flex items-baseline gap-2">
        <span className="text-3xl font-semibold text-gray-900">{value}</span>
        {trend && (
          <span
            className={cn(
              'text-sm font-medium',
              trendUp ? 'text-green-600' : 'text-red-600'
            )}
          >
            {trend}
          </span>
        )}
      </div>
      <p className="mt-1 text-sm text-gray-500">{subtitle}</p>
    </div>
  )
}

interface WidgetCardProps {
  title: string
  children: React.ReactNode
  href?: string
  isLoading?: boolean
}

function WidgetCard({ title, children, href, isLoading }: WidgetCardProps) {
  return (
    <div className="rounded-xl border border-gray-200 bg-white">
      <div className="flex items-center justify-between border-b border-gray-100 px-6 py-4">
        <h3 className="font-medium text-gray-900">{title}</h3>
        {href && !isLoading && (
          <Link
            to={href}
            className="inline-flex items-center gap-1 text-sm text-gray-500 hover:text-gray-700"
          >
            View all
            <ArrowRight className="h-4 w-4" />
          </Link>
        )}
      </div>
      <div className="px-6 py-4">
        {isLoading ? (
          <div className="flex items-center justify-center py-8">
            <Loader2 className="h-6 w-6 animate-spin text-gray-400" />
          </div>
        ) : (
          children
        )}
      </div>
    </div>
  )
}

function OrderStatusBadge({ status }: { status: string }) {
  const styles: Record<string, string> = {
    pending: 'bg-yellow-100 text-yellow-800',
    processing: 'bg-blue-100 text-blue-800',
    completed: 'bg-green-100 text-green-800',
    confirmed: 'bg-blue-100 text-blue-800',
    shipped: 'bg-green-100 text-green-800',
    draft: 'bg-gray-100 text-gray-800',
    cancelled: 'bg-red-100 text-red-800',
  }

  return (
    <span
      className={cn(
        'inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium capitalize',
        styles[status] || 'bg-gray-100 text-gray-800'
      )}
    >
      {status}
    </span>
  )
}
