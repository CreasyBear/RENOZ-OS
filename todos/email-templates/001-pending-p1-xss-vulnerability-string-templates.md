---
status: pending
priority: p1
issue_id: EMAIL-TPL-001
tags: [code-review, security, email-templates]
dependencies: []
---

# XSS Vulnerability in String Template Substitution

## Problem Statement

The `substituteTemplateVariables()` function in string-based templates performs raw variable substitution without HTML sanitization. While `email-preview.ts` sanitizes output, the send jobs (`send-campaign.ts`, `process-scheduled-emails.ts`) use raw substitution, creating XSS risk when user-controlled data (customer names, order references) is injected into HTML templates.

**Impact**: HIGH - Malicious data could inject scripts into emails, though email client protections mitigate this somewhat.

## Findings

### Evidence

1. **Location**: `src/trigger/jobs/send-campaign.ts`, `src/trigger/jobs/process-scheduled-emails.ts`
2. **Pattern**: `html.replace(/\{\{(\w+)\}\}/g, (_, key) => variables[key] || '')`
3. **Missing**: No HTML entity encoding (`<`, `>`, `&`, `"`, `'`)
4. **Contrast**: `email-preview.ts` has `sanitizeHtml()` helper but it's not shared

### Agent Source
- security-sentinel: "XSS risk in string template substitution"

## Proposed Solutions

### Option A: Centralized Sanitization Helper (Recommended)
Create shared `sanitizeForEmail()` utility used by ALL template rendering.

**Pros**: Single source of truth, easy to audit
**Cons**: Requires updating all call sites
**Effort**: Small
**Risk**: Low

### Option B: Move All Templates to React Email
React Email auto-escapes by default, eliminating string interpolation.

**Pros**: Structural solution, better long-term
**Cons**: Requires full template migration first
**Effort**: Large (depends on template migration)
**Risk**: Medium - big change

### Option C: Sanitize at Database Write Time
Sanitize variables when stored, not rendered.

**Pros**: One-time sanitization
**Cons**: Data loss (can't show raw data elsewhere), complicates debugging
**Effort**: Medium
**Risk**: High - data integrity concerns

## Recommended Action

Option A - Create centralized sanitizer immediately.

## Technical Details

### Affected Files
- `src/trigger/jobs/send-campaign.ts`
- `src/trigger/jobs/process-scheduled-emails.ts`
- `src/server/functions/communications/email-preview.ts` (has local sanitizer to extract)

### Implementation
```typescript
// src/lib/email/sanitize.ts
export function sanitizeForHtml(value: string): string {
  return value
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;')
    .replace(/'/g, '&#x27;');
}

export function substituteTemplateVariables(
  html: string,
  variables: Record<string, string>
): string {
  return html.replace(/\{\{(\w+)\}\}/g, (_, key) =>
    sanitizeForHtml(variables[key] || '')
  );
}
```

## Acceptance Criteria

- [ ] All string template substitutions use sanitization
- [ ] Shared helper exists in `src/lib/email/`
- [ ] Unit tests verify XSS payloads are escaped
- [ ] Email preview uses same sanitizer as send jobs

## Work Log

| Date | Action | Notes |
|------|--------|-------|
| 2025-01-25 | Created | From security-sentinel review |

## Resources

- OWASP XSS Prevention: https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html
