{
  "id": "CROSS-TIMELINE",
  "name": "Unified Activity Timeline",
  "description": "Cross-domain activity timeline aggregating emails, calls, notes, status changes, support tickets across all domains into a single customer-centric view.",
  "created": "2026-01-17",
  "updated": "2026-01-17",
  "priority": 3,
  "phase": "cross-domain",
  "version": "1.0",
  "business_value": {
    "customer_experience": true,
    "operational_efficiency": true,
    "sales_enablement": true,
    "support_quality": true,
    "description": "Provides 360-degree customer view by consolidating all touchpoints, enabling faster context-switching and reducing time-to-resolution"
  },
  "dependencies": {
    "phase": "Cross-Domain",
    "executionOrder": 1,
    "schemaRequired": [
      {
        "table": "customers",
        "status": "EXISTS",
        "createdBy": "DOM-CUST"
      },
      {
        "table": "contacts",
        "status": "EXISTS",
        "createdBy": "DOM-CUST"
      },
      {
        "table": "opportunities",
        "status": "EXISTS",
        "createdBy": "DOM-PIPE"
      },
      {
        "table": "orders",
        "status": "EXISTS",
        "createdBy": "DOM-ORDERS"
      },
      {
        "table": "jobs",
        "status": "EXISTS",
        "createdBy": "DOM-JOBS"
      },
      {
        "table": "support_tickets",
        "status": "EXISTS",
        "createdBy": "DOM-SUP"
      },
      {
        "table": "email_history",
        "status": "EXISTS",
        "createdBy": "DOM-COMMS"
      },
      {
        "table": "activities",
        "status": "EXISTS",
        "createdBy": "DOM-ACTIVITIES"
      }
    ],
    "schemaCreates": [
      {
        "table": "unified_activities",
        "story": "CROSS-TIMELINE-001"
      }
    ],
    "serverFunctionsRequired": [
      {
        "function": "sendEmail",
        "source": "INT-RES"
      },
      {
        "function": "getCustomerActivities",
        "source": "DOM-ACTIVITIES"
      }
    ],
    "serverFunctionsCreates": [
      {
        "function": "getCustomerTimeline",
        "story": "CROSS-TIMELINE-002"
      },
      {
        "function": "logActivity",
        "story": "CROSS-TIMELINE-005"
      }
    ],
    "prdDependencies": [
      {
        "prdId": "DOM-CUST",
        "status": "REQUIRED",
        "reason": "Customer and contact data for timeline aggregation"
      },
      {
        "prdId": "DOM-COMMS",
        "status": "REQUIRED",
        "reason": "Email history and communication tracking"
      },
      {
        "prdId": "DOM-PIPE",
        "status": "REQUIRED",
        "reason": "Opportunity and quote data for sales touchpoints"
      },
      {
        "prdId": "DOM-SUP",
        "status": "REQUIRED",
        "reason": "Support ticket data for service interactions"
      },
      {
        "prdId": "INT-RES",
        "status": "REQUIRED",
        "reason": "Resend webhooks for email event capture"
      }
    ],
    "enables": [
      {
        "prdId": "ROLE-SALES",
        "reason": "Sales role uses timeline for customer intelligence"
      },
      {
        "prdId": "ROLE-SUPPORT",
        "reason": "Support role uses timeline for case context"
      },
      {
        "prdId": "ROLE-OPS",
        "reason": "Operations uses timeline for job coordination"
      }
    ]
  },
  "references": {
    "internal": [
      "src/lib/schema/activities.ts - Base activities schema",
      "src/lib/schema/email-history.ts - Email tracking",
      "src/server/functions/activities.ts - Activity server functions",
      "src/components/activity/activity-timeline.tsx - Existing timeline component"
    ],
    "external": [
      "Resend webhooks documentation - Email event tracking"
    ]
  },
  "current_state": {
    "implemented": [
      "Basic activities table exists",
      "Email history tracking exists",
      "Activity timeline component (per-entity)",
      "Customer activities list"
    ],
    "gaps": [
      "No unified view across all entity types",
      "No auto-capture of email events to timeline",
      "No quick action for logging calls/notes",
      "No timeline on customer hover card",
      "No last contact indicator on customer list",
      "Timeline not easily reusable across views"
    ]
  },
  "stories": [
    {
      "id": "CROSS-TIMELINE-001",
      "name": "Activity Aggregation Schema",
      "description": "Create unified activities view or table that aggregates activities from all domains with polymorphic entity references",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "layers": ["schema"],
      "acceptance_criteria": [
        "unified_activities table or view created with columns: id, organizationId, customerId, entityType, entityId, activityType, title, description, metadata, createdAt, createdBy",
        "activityType enum includes: email_sent, email_received, email_opened, email_clicked, call_logged, call_scheduled, note_added, status_change, quote_created, quote_sent, order_placed, order_confirmed, job_scheduled, job_completed, ticket_created, ticket_resolved, warranty_registered",
        "entityType enum includes: customer, contact, opportunity, order, job, support_ticket, warranty_claim",
        "Polymorphic reference via entityType + entityId pattern",
        "customerId column for quick customer-centric queries (denormalized)",
        "Indexes on: (organizationId, customerId, createdAt DESC), (organizationId, entityType, entityId), (organizationId, activityType, createdAt DESC)",
        "Migration runs successfully with proper indexes",
        "Types exported from lib/schema/index.ts",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_TIMELINE_001_COMPLETE"
    },
    {
      "id": "CROSS-TIMELINE-002",
      "name": "Activity Feed API",
      "description": "Create server function for fetching customer timeline with pagination and filtering",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "layers": ["server"],
      "acceptance_criteria": [
        "getCustomerTimeline(customerId, filters?, cursor?) server function implemented",
        "Supports cursor-based pagination (most recent first)",
        "Filter by activityType (array of types)",
        "Filter by dateRange (from, to)",
        "Filter by entityType to scope to specific domain",
        "Returns activities with related entity data (preloaded via Drizzle relations)",
        "Rate limited to prevent abuse (100 requests per minute per user)",
        "Proper error handling with typed errors",
        "TypeScript compiles without errors"
      ],
      "dependencies": ["CROSS-TIMELINE-001"],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_TIMELINE_002_COMPLETE"
    },
    {
      "id": "CROSS-TIMELINE-003",
      "name": "Auto-Capture Email Events",
      "description": "Automatically create timeline activities when emails are sent via Resend integration",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "layers": ["server"],
      "acceptance_criteria": [
        "Resend webhook handler creates unified_activities record on email.sent event",
        "Activity links to customer if email recipient matches customer/contact email",
        "Activity links to opportunity if email context includes opportunityId",
        "Activity links to order if email template is order-related",
        "email_opened activity created on Resend email.opened webhook",
        "email_clicked activity created on Resend email.clicked webhook",
        "Idempotent handling (same webhook delivered twice does not create duplicates)",
        "Proper error handling with retry for failed activity creation",
        "TypeScript compiles without errors"
      ],
      "dependencies": ["CROSS-TIMELINE-001", "INT-RES"],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_TIMELINE_003_COMPLETE"
    },
    {
      "id": "CROSS-TIMELINE-004",
      "name": "Timeline UI Component",
      "description": "Create reusable timeline component for displaying unified customer activity feed",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "layers": ["ui"],
      "type": "ui-component",
      "acceptance_criteria": [
        "UnifiedTimeline component accepts customerId and optional filters",
        "Activities grouped by date with date separator headers",
        "Each activity shows: icon (by type), title, description preview, relative timestamp",
        "Expandable detail view for each activity with full metadata",
        "Click activity to navigate to source entity (opportunity, order, ticket, etc.)",
        "Filter bar with activity type multi-select and date range picker",
        "Infinite scroll pagination with loading indicator",
        "Loading skeleton (TimelineSkeleton) during initial fetch",
        "Empty state: 'No activity yet' with contextual message",
        "Error boundary with retry for timeline loading",
        "Keyboard navigation: Tab through activities, Enter to expand, Escape to collapse",
        "ARIA timeline role with proper activity labeling",
        "Responsive: Compact view on mobile, full view on desktop",
        "TypeScript compiles without errors"
      ],
      "uiPatterns": {
        "baseComponents": [
          {
            "name": "Card",
            "source": "RE-UI",
            "usage": "Activity item container",
            "reference": "_reference/.reui-reference/public/docs/card.md"
          },
          {
            "name": "Badge",
            "source": "RE-UI",
            "usage": "Activity type indicator",
            "reference": "_reference/.reui-reference/public/docs/badge.md"
          },
          {
            "name": "Separator",
            "source": "RE-UI",
            "usage": "Date group separator",
            "reference": "_reference/.reui-reference/public/docs/separator.md"
          },
          {
            "name": "Collapsible",
            "source": "RE-UI",
            "usage": "Expandable activity details",
            "reference": "_reference/.reui-reference/public/docs/collapsible.md"
          },
          {
            "name": "Filters",
            "source": "RE-UI",
            "usage": "Activity type and date range filtering",
            "reference": "_reference/.reui-reference/public/docs/filters.md"
          },
          {
            "name": "Skeleton",
            "source": "Midday UI",
            "usage": "Loading state",
            "reference": "_reference/.midday-reference/packages/ui/src/components/skeleton.tsx"
          }
        ],
        "compositePatterns": [
          {
            "name": "TimelineItem",
            "description": "Individual activity card with icon, content, and actions",
            "composition": "Card > flex row (icon + content + timestamp) + Collapsible (details)"
          },
          {
            "name": "DateGroup",
            "description": "Group of activities under a date header",
            "composition": "Separator (date label) + Stack of TimelineItem components"
          },
          {
            "name": "TimelineSkeleton",
            "description": "Loading skeleton for timeline",
            "composition": "Stack of Card skeletons with shimmer effect"
          }
        ],
        "layoutStrategy": "Vertical stack with sticky date headers, infinite scroll, filter bar at top (collapsible on mobile)"
      },
      "ui_spec": {
        "component_type": "UnifiedTimeline with TimelineItem and DateGroup",
        "layout": {
          "mobile": "Full-width vertical timeline, collapsible filter drawer, compact activity cards",
          "tablet": "Timeline with sidebar filter panel toggle",
          "desktop": "Full timeline with persistent filter sidebar"
        },
        "accessibility": {
          "aria_labels": [
            "customer-timeline",
            "activity-item-{id}",
            "date-group-{date}",
            "filter-panel",
            "load-more-button"
          ],
          "keyboard_nav": "Tab through activities, Enter to expand/navigate, Arrow keys for date groups",
          "screen_reader": "Activity type, title, and timestamp announced",
          "focus_management": "Focus first new activity after load more, maintain focus on expand/collapse"
        }
      },
      "dependencies": ["CROSS-TIMELINE-002"],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_TIMELINE_004_COMPLETE"
    },
    {
      "id": "CROSS-TIMELINE-005",
      "name": "Activity Logging Quick Action",
      "description": "Add quick action buttons for logging calls and notes directly from timeline",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "layers": ["ui"],
      "type": "ui-component",
      "acceptance_criteria": [
        "Quick action bar at top of timeline with 'Log Call' and 'Add Note' buttons",
        "Log Call opens minimal dialog: type (inbound/outbound), duration (optional), brief note, outcome (reached/voicemail/no-answer)",
        "Add Note opens minimal dialog: note text only with optional category tag",
        "Form submits create unified_activity via server function",
        "Activity appears at top of timeline immediately (optimistic update)",
        "Keyboard shortcut support: Ctrl+L for Log Call, Ctrl+N for Add Note",
        "Toast notification on successful log",
        "Loading state on submit button",
        "Error handling with inline error message",
        "Dialog closes on successful submit",
        "Keyboard navigation: Tab through form fields, Enter to submit, Escape to cancel",
        "ARIA labels for all form controls",
        "Responsive: Full-width dialog on mobile, centered modal on desktop",
        "TypeScript compiles without errors"
      ],
      "uiPatterns": {
        "baseComponents": [
          {
            "name": "Button",
            "source": "RE-UI",
            "usage": "Quick action buttons",
            "reference": "_reference/.reui-reference/public/docs/button.md"
          },
          {
            "name": "Dialog",
            "source": "RE-UI",
            "usage": "Log call and add note dialogs",
            "reference": "_reference/.reui-reference/public/docs/dialog.md"
          },
          {
            "name": "Form",
            "source": "RE-UI",
            "usage": "Activity logging form with validation",
            "reference": "_reference/.reui-reference/public/docs/form.md"
          },
          {
            "name": "Select",
            "source": "RE-UI",
            "usage": "Call type and outcome selectors",
            "reference": "_reference/.reui-reference/public/docs/select.md"
          },
          {
            "name": "Textarea",
            "source": "RE-UI",
            "usage": "Note content input",
            "reference": "_reference/.reui-reference/public/docs/textarea.md"
          },
          {
            "name": "Input",
            "source": "RE-UI",
            "usage": "Call duration input",
            "reference": "_reference/.reui-reference/public/docs/input.md"
          }
        ],
        "compositePatterns": [
          {
            "name": "QuickActionBar",
            "description": "Horizontal button group for quick actions",
            "composition": "Flex row with Button (icon + label) for each action"
          },
          {
            "name": "LogCallDialog",
            "description": "Minimal call logging form",
            "composition": "Dialog > Form (Select call type + Input duration + Textarea note + Select outcome)"
          },
          {
            "name": "AddNoteDialog",
            "description": "Minimal note adding form",
            "composition": "Dialog > Form (Textarea note + optional Select category)"
          }
        ],
        "layoutStrategy": "Sticky action bar at top of timeline, dialogs centered with backdrop"
      },
      "ui_spec": {
        "component_type": "QuickActionBar with LogCallDialog and AddNoteDialog",
        "layout": {
          "mobile": "Floating action button (FAB) with speed dial menu, full-screen dialogs",
          "tablet": "Inline action bar, modal dialogs",
          "desktop": "Inline action bar above timeline, compact modal dialogs"
        },
        "accessibility": {
          "aria_labels": [
            "quick-actions",
            "log-call-button",
            "add-note-button",
            "log-call-dialog",
            "add-note-dialog",
            "call-type-select",
            "call-outcome-select",
            "note-textarea"
          ],
          "keyboard_nav": "Ctrl+L opens call dialog, Ctrl+N opens note dialog, Tab through form, Enter submit, Escape cancel",
          "screen_reader": "Dialog title and form field labels announced",
          "focus_management": "Focus first form field on dialog open, return to trigger on close"
        }
      },
      "dependencies": ["CROSS-TIMELINE-004"],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_TIMELINE_005_COMPLETE"
    },
    {
      "id": "CROSS-TIMELINE-006",
      "name": "Customer 360 Integration",
      "description": "Integrate unified timeline into customer detail page and add quick indicators",
      "priority": 6,
      "status": "pending",
      "passes": false,
      "layers": ["ui"],
      "type": "ui-component",
      "acceptance_criteria": [
        "Add 'Activity' tab to customer detail page with UnifiedTimeline component",
        "Customer hover card (on customer list) shows mini-timeline with last 3 activities",
        "Mini-timeline shows activity type icon + title + relative time",
        "Customer list displays 'Last Contact' column with relative time (e.g., '2 days ago')",
        "Last Contact indicator color-coded: green (< 7 days), yellow (7-30 days), red (> 30 days)",
        "'Last Contact' shows tooltip with activity type on hover",
        "Timeline tab lazy loads on first view",
        "Mini-timeline and Last Contact data fetched efficiently (single query)",
        "Loading skeleton for mini-timeline",
        "Empty state for customers with no activities",
        "Keyboard navigation: Tab to hover card, Tab through activities",
        "ARIA labels for all indicators and timeline items",
        "Responsive: Last Contact column hidden on mobile, shown in card view instead",
        "TypeScript compiles without errors"
      ],
      "uiPatterns": {
        "baseComponents": [
          {
            "name": "Tabs",
            "source": "RE-UI",
            "usage": "Customer detail page tabs including Activity tab",
            "reference": "_reference/.reui-reference/public/docs/tabs.md"
          },
          {
            "name": "HoverCard",
            "source": "RE-UI",
            "usage": "Customer hover card with mini-timeline",
            "reference": "_reference/.reui-reference/public/docs/hover-card.md"
          },
          {
            "name": "Badge",
            "source": "RE-UI",
            "usage": "Last Contact indicator with color coding",
            "reference": "_reference/.reui-reference/public/docs/badge.md"
          },
          {
            "name": "Tooltip",
            "source": "RE-UI",
            "usage": "Last Contact activity type tooltip",
            "reference": "_reference/.reui-reference/public/docs/tooltip.md"
          },
          {
            "name": "DataGrid",
            "source": "RE-UI",
            "usage": "Customer list with Last Contact column",
            "reference": "_reference/.reui-reference/public/docs/data-grid.md"
          }
        ],
        "compositePatterns": [
          {
            "name": "MiniTimeline",
            "description": "Compact 3-item activity preview for hover card",
            "composition": "Stack of compact TimelineItem (icon + title + time) without expand"
          },
          {
            "name": "LastContactBadge",
            "description": "Color-coded relative time badge",
            "composition": "Badge (variant by recency) + Tooltip (activity type)"
          },
          {
            "name": "ActivityTab",
            "description": "Full timeline in tab panel",
            "composition": "TabsContent > UnifiedTimeline (lazy loaded)"
          }
        ],
        "layoutStrategy": "Tab panel for full timeline, hover card trigger on customer name, inline badge in table cell"
      },
      "ui_spec": {
        "component_type": "ActivityTab with MiniTimeline and LastContactBadge",
        "layout": {
          "mobile": "Activity tab in customer detail, Last Contact in card header, no hover cards",
          "tablet": "Same as mobile with hover card support",
          "desktop": "Full hover cards, Last Contact column in table, Activity tab"
        },
        "accessibility": {
          "aria_labels": [
            "activity-tab",
            "mini-timeline",
            "last-contact-indicator",
            "customer-hover-card"
          ],
          "keyboard_nav": "Tab to customer name triggers hover card, Tab through mini-timeline items",
          "screen_reader": "Last contact date and activity type announced",
          "focus_management": "Focus trap in hover card, return focus on dismiss"
        }
      },
      "dependencies": ["CROSS-TIMELINE-004"],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_TIMELINE_006_COMPLETE"
    }
  ],
  "success_criteria": [
    "All customer touchpoints visible in single timeline",
    "Email events auto-captured without manual logging",
    "Quick actions enable sub-30-second activity logging",
    "Customer 360 view provides instant context",
    "Last Contact indicator improves follow-up prioritization",
    "Timeline loads in < 500ms with pagination",
    "npm run typecheck passes",
    "No regressions in existing activity tracking"
  ],
  "out_of_scope": [
    "Real-time timeline updates via WebSocket (polling only for v1)",
    "AI-generated activity summaries",
    "Activity-based workflow automation",
    "Cross-organization timeline sharing",
    "Mobile app push notifications for activities"
  ],
  "pattern_references": [
    {
      "file": "_Initiation/_meta/patterns/testing-standards.md",
      "applies_to": "all stories",
      "reason": "All stories must follow testing standards including TDD flow, coverage expectations (80% server functions, 90% utilities), and story-level testing requirements"
    },
    {
      "file": "_Initiation/_meta/patterns/error-recovery.md",
      "applies_to": "CROSS-TIMELINE-002 (Email Event Capture)",
      "reason": "Pattern 4 (Email Send Failure) for Resend webhook handling. Ensure idempotent processing of email events"
    },
    {
      "file": "_Initiation/_meta/patterns/performance-benchmarks.md",
      "applies_to": "CROSS-TIMELINE-001 (Schema), CROSS-TIMELINE-003 (Timeline API), CROSS-TIMELINE-004 (UI)",
      "reason": "Timeline must load <500ms with pagination (specified in success_criteria). Handle Year 5 activity volume (500,000 activities)"
    },
    {
      "file": "_Initiation/_meta/patterns/ux-3-click-rule.md",
      "applies_to": "CROSS-TIMELINE-003 (Quick Actions), CROSS-TIMELINE-005 (Customer 360), CROSS-TIMELINE-006 (Last Contact)",
      "reason": "Quick actions enable <30 second logging. Sales uses Cmd+L for call logging (2 clicks). Last contact visible on hover (1 action)"
    }
  ]
}
