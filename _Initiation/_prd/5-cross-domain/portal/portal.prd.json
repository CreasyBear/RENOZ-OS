{
  "id": "CROSS-PORTAL",
  "name": "Customer Self-Service Portal",
  "description": "External customer-facing portal for viewing quotes, tracking orders/jobs, viewing invoices, and submitting support tickets. Reduces office calls for status updates.",
  "created": "2026-01-17",
  "priority": 1,
  "phase": "cross-domain",
  "persona": "Customer / End User",
  "dependencies": {
    "phase": "Cross-Domain",
    "executionOrder": 8,
    "schemaRequired": [
      {
        "table": "customers",
        "status": "EXISTS"
      },
      {
        "table": "contacts",
        "status": "EXISTS"
      },
      {
        "table": "opportunities",
        "status": "EXISTS"
      },
      {
        "table": "orders",
        "status": "EXISTS"
      },
      {
        "table": "jobs",
        "status": "EXISTS"
      },
      {
        "table": "invoices",
        "status": "EXISTS"
      },
      {
        "table": "support_tickets",
        "status": "EXISTS"
      }
    ],
    "prdDependencies": [
      {
        "prdId": "DOM-CUST",
        "status": "REQUIRED",
        "reason": "Portal needs customer data for authentication and profile display"
      },
      {
        "prdId": "DOM-PIPE",
        "status": "REQUIRED",
        "reason": "Portal displays quotes from pipeline domain"
      },
      {
        "prdId": "DOM-ORD",
        "status": "REQUIRED",
        "reason": "Portal shows order tracking and status"
      },
      {
        "prdId": "DOM-JOBS",
        "status": "REQUIRED",
        "reason": "Portal displays job progress and scheduling"
      },
      {
        "prdId": "DOM-FIN",
        "status": "REQUIRED",
        "reason": "Portal shows invoices and payment status"
      },
      {
        "prdId": "DOM-SUP",
        "status": "REQUIRED",
        "reason": "Portal allows support ticket submission and tracking"
      }
    ],
    "enables": []
  },
  "security": {
    "authentication": {
      "method": "magic-link",
      "description": "Passwordless login via email magic link",
      "token_expiry": "30 days",
      "rate_limiting": "5 attempts per 15 minutes"
    },
    "authorization": {
      "scope": "own-data-only",
      "description": "Customers can only access records linked to their customer_id",
      "row_level_security": true
    },
    "data_exposure": {
      "internal_user_data": false,
      "internal_notes": false,
      "cost_data": false,
      "margin_data": false
    }
  },
  "ui_spec": {
    "target_role": "customer",
    "primary_device": "mobile-first",
    "priority_actions": [
      "View Quote",
      "Track Order",
      "Check Job Status",
      "Submit Ticket"
    ],
    "accessibility": {
      "keyboard_navigation": true,
      "screen_reader_support": true,
      "color_contrast": "WCAG AA",
      "focus_indicators": "visible ring on all interactive elements",
      "mobile_touch_targets": "minimum 44x44px"
    },
    "branding": {
      "customizable_logo": true,
      "customizable_colors": true,
      "white_label_subdomain": true,
      "custom_welcome_message": true
    },
    "navigation": {
      "type": "bottom-tabs-mobile",
      "desktop_sidebar": true,
      "tabs": [
        "Dashboard",
        "Quotes",
        "Orders",
        "Jobs",
        "Invoices",
        "Support"
      ]
    }
  },
  "references": {
    "internal": [
      "memory-bank/VISION.md - Customer portal vision",
      "memory-bank/_meta/assumptions.md - Portal requirements"
    ],
    "external": []
  },
  "current_state": {
    "implemented": [],
    "gaps": [
      "No customer-facing portal exists",
      "No magic link authentication for customers",
      "No customer quote viewing",
      "No order/job tracking for customers",
      "No customer invoice viewing",
      "No customer support ticket submission",
      "No portal branding customization"
    ]
  },
  "stories": [
    {
      "id": "CROSS-PORTAL-001",
      "name": "Portal Authentication",
      "description": "Magic link login system for customer portal access without passwords",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Login page with email input only (no password)",
        "Magic link sent via email with secure token",
        "Token expires after 15 minutes for security",
        "Session token created on successful authentication",
        "Session expires after 30 days of inactivity",
        "Customer can only see data linked to their customer_id",
        "Rate limiting: 5 login attempts per 15 minutes per email",
        "TypeScript compiles without errors"
      ],
      "layers": [
        "schema",
        "server",
        "ui"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "CROSS_PORTAL_001_COMPLETE",
      "ui_spec": {
        "target_role": "customer",
        "primary_device": "mobile-first",
        "priority_actions": [
          "Enter Email",
          "Request Link",
          "Check Email"
        ],
        "accessibility": {
          "keyboard_navigation": "Tab to email input and submit button",
          "screen_reader_support": "Clear labels and error announcements",
          "focus_management": "Auto-focus email input on page load"
        },
        "layout": {
          "type": "centered-card",
          "branding": "Organization logo at top",
          "form": "Email input with submit button",
          "success_state": "Check your email message with resend option"
        },
        "error_handling": {
          "invalid_email": "Inline validation message",
          "rate_limited": "Clear countdown timer",
          "expired_token": "Request new link button"
        }
      }
    },
    {
      "id": "CROSS-PORTAL-002",
      "name": "Customer Dashboard",
      "description": "Overview page showing customer's active quotes, orders, jobs, and invoices at a glance",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Dashboard shows summary cards: Active Quotes, Open Orders, Active Jobs, Unpaid Invoices",
        "Each card shows count and clickable to view list",
        "Recent activity timeline showing last 10 events",
        "Activity includes: quote sent, order placed, job scheduled, invoice created",
        "Welcome message with customer name",
        "Quick action buttons for common tasks",
        "TypeScript compiles without errors"
      ],
      "layers": [
        "server",
        "ui"
      ],
      "dependencies": [
        "CROSS-PORTAL-001"
      ],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_PORTAL_002_COMPLETE",
      "ui_spec": {
        "target_role": "customer",
        "primary_device": "mobile-first",
        "priority_actions": [
          "View Quotes",
          "Track Orders",
          "Contact Support"
        ],
        "accessibility": {
          "keyboard_navigation": "Tab through summary cards and activity items",
          "screen_reader_support": "Card counts and labels announced clearly",
          "landmarks": "Main content, activity timeline as separate regions"
        },
        "layout": {
          "type": "card-grid",
          "mobile": "2x2 card grid, vertical activity timeline below",
          "desktop": "4-column cards, sidebar activity timeline",
          "welcome_section": "Top of page with customer name and last login"
        },
        "empty_states": {
          "no_activity": "Welcome message with getting started tips",
          "no_quotes": "Contact us to request a quote prompt"
        }
      }
    },
    {
      "id": "CROSS-PORTAL-003",
      "name": "Quote Viewing & Acceptance",
      "description": "Customer can view quote details, line items, totals, and accept quotes to create orders",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Quote list showing all quotes for customer",
        "Quote status badges: Draft, Sent, Accepted, Expired",
        "Quote detail view with line items, quantities, prices",
        "Subtotal, tax, and grand total clearly displayed",
        "Accept Quote button creates order and/or job",
        "Confirmation dialog before accepting",
        "PDF download button for quote document",
        "TypeScript compiles without errors"
      ],
      "layers": [
        "server",
        "ui"
      ],
      "dependencies": [
        "CROSS-PORTAL-001"
      ],
      "estimated_iterations": 3,
      "completion_promise": "CROSS_PORTAL_003_COMPLETE",
      "ui_spec": {
        "target_role": "customer",
        "primary_device": "mobile-first",
        "priority_actions": [
          "View Details",
          "Accept Quote",
          "Download PDF"
        ],
        "accessibility": {
          "keyboard_navigation": "Navigate quote list, line items, and actions",
          "screen_reader_support": "Quote totals and status announced",
          "data_tables": "Line items in accessible table with headers"
        },
        "layout": {
          "type": "list-detail",
          "list_view": "Quote cards with status badge, date, total",
          "detail_view": "Full quote with line item table and actions",
          "pdf_button": "Secondary action in header"
        },
        "confirmation": {
          "accept_dialog": "Modal with quote summary and confirm button",
          "success_feedback": "Toast notification and redirect to order"
        }
      }
    },
    {
      "id": "CROSS-PORTAL-004",
      "name": "Order Tracking",
      "description": "Customer can track order status with timeline and delivery information",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Order list showing all orders for customer",
        "Order status badges: Pending, Processing, Shipped, Delivered",
        "Order detail view with items and quantities",
        "Status timeline showing order progression",
        "Shipment tracking links when available",
        "Expected delivery date displayed prominently",
        "Order history with past orders",
        "TypeScript compiles without errors"
      ],
      "layers": [
        "server",
        "ui"
      ],
      "dependencies": [
        "CROSS-PORTAL-001"
      ],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_PORTAL_004_COMPLETE",
      "ui_spec": {
        "target_role": "customer",
        "primary_device": "mobile-first",
        "priority_actions": [
          "View Order",
          "Track Shipment",
          "Contact Support"
        ],
        "accessibility": {
          "keyboard_navigation": "Navigate order list and timeline steps",
          "screen_reader_support": "Timeline progress announced with current step",
          "status_colors": "Icons accompany status colors for color-blind users"
        },
        "layout": {
          "type": "list-detail",
          "list_view": "Order cards with status, date, item count",
          "detail_view": "Order summary with vertical timeline",
          "timeline": "Vertical stepper showing completed and pending steps"
        },
        "tracking": {
          "external_link": "Opens carrier tracking in new tab",
          "delivery_estimate": "Prominent card with date and countdown"
        }
      }
    },
    {
      "id": "CROSS-PORTAL-005",
      "name": "Job Status Tracking",
      "description": "Customer can view job progress, scheduled dates, and assigned technician name",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Job list showing all jobs for customer",
        "Job status badges: Scheduled, In Progress, Completed",
        "Job detail view with description and scope",
        "Progress indicator by phase/task if applicable",
        "Scheduled date and time window displayed",
        "Assigned technician name only (no phone for privacy)",
        "Completion notes visible when job is done",
        "TypeScript compiles without errors"
      ],
      "layers": [
        "server",
        "ui"
      ],
      "dependencies": [
        "CROSS-PORTAL-001"
      ],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_PORTAL_005_COMPLETE",
      "ui_spec": {
        "target_role": "customer",
        "primary_device": "mobile-first",
        "priority_actions": [
          "View Job",
          "See Schedule",
          "Contact Support"
        ],
        "accessibility": {
          "keyboard_navigation": "Navigate job list and progress steps",
          "screen_reader_support": "Progress percentage and status announced",
          "date_formatting": "Dates in customer's locale format"
        },
        "layout": {
          "type": "list-detail",
          "list_view": "Job cards with status, scheduled date, progress bar",
          "detail_view": "Job info with phase progress and technician",
          "progress": "Segmented progress bar or checklist for phases"
        },
        "privacy": {
          "technician_display": "First name and last initial only",
          "no_contact_info": "No phone or email shown"
        }
      }
    },
    {
      "id": "CROSS-PORTAL-006",
      "name": "Invoice Viewing",
      "description": "Customer can view invoices, amounts, payment status, and access payment links",
      "priority": 6,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Invoice list showing all invoices for customer",
        "Invoice status badges: Draft, Sent, Paid, Overdue",
        "Invoice detail view with line items and totals",
        "Amount due and due date prominently displayed",
        "PDF download button for invoice document",
        "Pay Now button linking to payment provider",
        "Payment history for paid invoices",
        "TypeScript compiles without errors"
      ],
      "layers": [
        "server",
        "ui"
      ],
      "dependencies": [
        "CROSS-PORTAL-001"
      ],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_PORTAL_006_COMPLETE",
      "ui_spec": {
        "target_role": "customer",
        "primary_device": "mobile-first",
        "priority_actions": [
          "View Invoice",
          "Pay Now",
          "Download PDF"
        ],
        "accessibility": {
          "keyboard_navigation": "Navigate invoice list and payment button",
          "screen_reader_support": "Amount due and status clearly announced",
          "urgency_indicators": "Overdue invoices have warning icon, not just color"
        },
        "layout": {
          "type": "list-detail",
          "list_view": "Invoice cards with amount, status badge, due date",
          "detail_view": "Full invoice with line items and payment button",
          "overdue_styling": "Red accent, warning icon, days overdue count"
        },
        "payment": {
          "button_position": "Prominent at top of detail view",
          "external_redirect": "Opens payment provider in same tab with return URL"
        }
      }
    },
    {
      "id": "CROSS-PORTAL-007",
      "name": "Support Ticket Submission",
      "description": "Customer can create support tickets, view history, and attach files",
      "priority": 7,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Support ticket list showing customer's tickets",
        "Ticket status badges: Open, In Progress, Resolved, Closed",
        "Create New Ticket button with form",
        "Form fields: Subject, Description, Category dropdown",
        "File/photo attachment support (up to 5 files, 10MB each)",
        "Ticket detail view with conversation thread",
        "Customer can add replies to open tickets",
        "TypeScript compiles without errors"
      ],
      "layers": [
        "schema",
        "server",
        "ui"
      ],
      "dependencies": [
        "CROSS-PORTAL-001"
      ],
      "estimated_iterations": 3,
      "completion_promise": "CROSS_PORTAL_007_COMPLETE",
      "ui_spec": {
        "target_role": "customer",
        "primary_device": "mobile-first",
        "priority_actions": [
          "Create Ticket",
          "View Ticket",
          "Add Reply"
        ],
        "accessibility": {
          "keyboard_navigation": "Full form navigation and file upload",
          "screen_reader_support": "Ticket status and reply count announced",
          "file_upload": "Drag-drop with keyboard alternative"
        },
        "layout": {
          "type": "list-detail",
          "list_view": "Ticket cards with subject, status, last update",
          "detail_view": "Conversation thread with reply input at bottom",
          "create_form": "Modal or dedicated page with subject, description, attachments"
        },
        "attachments": {
          "allowed_types": "Images, PDF, common document formats",
          "max_files": 5,
          "max_size": "10MB per file",
          "preview": "Thumbnail preview for images"
        }
      }
    },
    {
      "id": "CROSS-PORTAL-008",
      "name": "Portal Branding",
      "description": "Organization can customize portal appearance with logo, colors, and messaging",
      "priority": 8,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Admin can upload organization logo for portal",
        "Admin can set primary and secondary brand colors",
        "Custom welcome message configurable",
        "White-label subdomain support (company.portal.app)",
        "Branding settings stored per organization",
        "Portal dynamically applies branding on load",
        "Fallback to default branding if not configured",
        "TypeScript compiles without errors"
      ],
      "layers": [
        "server",
        "ui"
      ],
      "dependencies": [
        "CROSS-PORTAL-001"
      ],
      "estimated_iterations": 2,
      "completion_promise": "CROSS_PORTAL_008_COMPLETE",
      "ui_spec": {
        "target_role": "admin",
        "primary_device": "desktop",
        "priority_actions": [
          "Upload Logo",
          "Set Colors",
          "Preview Portal"
        ],
        "accessibility": {
          "keyboard_navigation": "Color picker and file upload accessible",
          "screen_reader_support": "Color values announced when selected",
          "contrast_validation": "Warning if colors don't meet WCAG AA"
        },
        "layout": {
          "type": "settings-form",
          "sections": [
            "Logo Upload",
            "Color Scheme",
            "Welcome Message",
            "Subdomain"
          ],
          "preview_panel": "Live preview of portal with current settings"
        },
        "color_picker": {
          "type": "preset-with-custom",
          "presets": "Common brand color palettes",
          "custom": "Hex input for exact colors"
        }
      }
    }
  ],
  "success_criteria": [
    "Customers can log in via magic link without password",
    "Customers can only see their own data",
    "Quote acceptance creates orders/jobs automatically",
    "Order and job tracking reduces support calls",
    "Invoice viewing with payment links improves collections",
    "Support tickets reduce phone call volume",
    "Portal reflects organization branding",
    "npm run typecheck passes"
  ],
  "out_of_scope": [
    "Customer account creation (admin-initiated only)",
    "Multi-customer accounts (one login per customer)",
    "Real-time chat support",
    "Customer payment processing (links to external provider)",
    "Customer-to-customer communication",
    "Mobile native apps (web-based responsive only)"
  ],
  "pattern_references": [
    {
      "file": "_Initiation/_meta/patterns/testing-standards.md",
      "applies_to": "all stories",
      "reason": "All stories must follow testing standards including TDD flow, coverage expectations (80% server functions, 90% utilities), and story-level testing requirements"
    },
    {
      "file": "_Initiation/_meta/patterns/error-recovery.md",
      "applies_to": "CROSS-PORTAL-001 (Magic Link Auth), CROSS-PORTAL-003 (Quote Acceptance)",
      "reason": "Pattern 4 (Email Send Failure) for magic link delivery. Pattern 3 (Saga) for quote acceptance creating orders/jobs"
    },
    {
      "file": "_Initiation/_meta/patterns/performance-benchmarks.md",
      "applies_to": "CROSS-PORTAL-004 (Order Tracking), CROSS-PORTAL-005 (Job Progress), all UI stories",
      "reason": "Portal pages must load <1s. Customer-facing experience must be responsive on mobile"
    },
    {
      "file": "_Initiation/_meta/patterns/ux-3-click-rule.md",
      "applies_to": "CROSS-PORTAL-002 (Dashboard), CROSS-PORTAL-003 (Quote Acceptance), all UI stories",
      "reason": "Customer self-service must be intuitive. Quote acceptance should be 2 clicks (view quote -> accept). Track order in 1 click from dashboard"
    }
  ]
}
