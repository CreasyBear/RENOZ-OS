{
  "id": "INT-RESEND",
  "name": "Resend Email Integration",
  "description": "Email sending infrastructure using Resend for transactional and marketing emails with tracking and analytics.",
  "created": "2026-01-09",
  "atomized": "2026-01-09",
  "priority": 2,
  "phase": "integration",
  "service": "Resend",
  "dependencies": {
    "phase": "Integration",
    "executionOrder": 2,
    "schemaRequired": [
      {
        "table": "organizations",
        "status": "EXISTS",
        "createdBy": "schema-foundation"
      },
      {
        "table": "users",
        "status": "EXISTS",
        "createdBy": "schema-foundation"
      },
      {
        "table": "contacts",
        "status": "EXISTS",
        "createdBy": "schema-foundation"
      },
      {
        "table": "customers",
        "status": "EXISTS",
        "createdBy": "schema-foundation"
      },
      {
        "table": "email-history",
        "status": "EXISTS",
        "createdBy": "schema-foundation"
      }
    ],
    "schemaCreates": [
      {
        "table": "email_webhook_log",
        "story": "INT-RES-001-A",
        "description": "Webhook event logging for Resend delivery tracking"
      },
      {
        "table": "email_suppression",
        "story": "INT-RES-002-A",
        "description": "Email suppression list for bounces, complaints, unsubscribes"
      },
      {
        "table": "email_batch",
        "story": "INT-RES-005-A",
        "description": "Batch email tracking and queue management"
      }
    ],
    "schemaModifies": [
      {
        "table": "email-history",
        "story": "INT-RES-001-A",
        "changes": "Add openedAt, clickedAt, bounceType, complaintType columns"
      }
    ],
    "serverFunctionsRequired": [
      {
        "function": "sendEmail",
        "status": "EXISTS",
        "reason": "Base email sending functionality"
      },
      {
        "function": "getEmailHistory",
        "status": "EXISTS",
        "reason": "Query sent emails for analytics"
      },
      {
        "function": "getContacts",
        "status": "EXISTS",
        "reason": "Contact lookup for email sending"
      },
      {
        "function": "getCustomerById",
        "status": "EXISTS",
        "reason": "Customer data for email personalization"
      }
    ],
    "serverFunctionsCreates": [
      {
        "function": "processResendWebhook",
        "story": "INT-RES-001-A",
        "description": "Handle incoming Resend webhooks"
      },
      {
        "function": "createEmailWebhookLog",
        "story": "INT-RES-001-A",
        "description": "Log webhook events"
      },
      {
        "function": "updateEmailDeliveryStatus",
        "story": "INT-RES-001-B",
        "description": "Update email_history with delivery status"
      },
      {
        "function": "createEmailSuppression",
        "story": "INT-RES-002-A",
        "description": "Add email to suppression list"
      },
      {
        "function": "getEmailSuppressions",
        "story": "INT-RES-002-A",
        "description": "Query suppression list"
      },
      {
        "function": "checkEmailSuppression",
        "story": "INT-RES-002-B",
        "description": "Check if email is suppressed before sending"
      },
      {
        "function": "removeEmailSuppression",
        "story": "INT-RES-002-C",
        "description": "Remove email from suppression"
      },
      {
        "function": "getEmailAnalytics",
        "story": "INT-RES-003-A",
        "description": "Aggregate email metrics with period filter"
      },
      {
        "function": "getEmailAnalyticsByTemplate",
        "story": "INT-RES-003-A",
        "description": "Breakdown by template type"
      },
      {
        "function": "getEmailTrendData",
        "story": "INT-RES-003-A",
        "description": "Time series data for charts"
      },
      {
        "function": "getDomainVerificationStatus",
        "story": "INT-RES-004",
        "description": "Check domain SPF/DKIM/DMARC status"
      },
      {
        "function": "createEmailBatch",
        "story": "INT-RES-005-A",
        "description": "Create batch email job"
      },
      {
        "function": "getEmailBatches",
        "story": "INT-RES-005-A",
        "description": "Query batch status"
      },
      {
        "function": "cancelEmailBatch",
        "story": "INT-RES-005-B",
        "description": "Cancel batch in progress"
      },
      {
        "function": "previewEmailTemplate",
        "story": "INT-RES-006-A",
        "description": "Render template with sample data"
      },
      {
        "function": "sendTestEmail",
        "story": "INT-RES-006-B",
        "description": "Send test email to self"
      },
      {
        "function": "importSuppressionList",
        "story": "INT-RES-007",
        "description": "CSV import suppression list"
      },
      {
        "function": "exportSuppressionList",
        "story": "INT-RES-007",
        "description": "CSV export suppression list"
      },
      {
        "function": "getEmailStatusWidgetData",
        "story": "INT-RES-008",
        "description": "Dashboard widget metrics"
      }
    ],
    "prdDependencies": [
      {
        "prdId": "DOM-COM",
        "status": "REQUIRED",
        "reason": "Communications domain provides email_history and base email templates"
      },
      {
        "prdId": "DOM-CUS",
        "status": "REQUIRED",
        "reason": "Customer data for email personalization and contact lookup"
      }
    ],
    "enables": [
      {
        "prdId": "WF-LEAD",
        "reason": "Lead-to-order workflow uses email for follow-ups and notifications"
      },
      {
        "prdId": "WF-INV",
        "reason": "Invoicing workflow sends invoice emails via Resend"
      },
      {
        "prdId": "INT-XERO",
        "reason": "Xero integration may trigger invoice email notifications"
      }
    ]
  },
  "references": {
    "internal": [
      "memory-bank/prd/domain/communications.prd.json",
      "memory-bank/prd/workflow/lead-to-order.prd.json"
    ],
    "external": [
      "Resend API docs: https://resend.com/docs/",
      "Resend webhooks for delivery tracking",
      "React Email for template rendering"
    ]
  },
  "current_state": {
    "implemented": [
      "Basic email sending via Resend",
      "Email templates (React Email)",
      "Email history tracking"
    ],
    "gaps": [
      "No delivery status webhooks",
      "No bounce/complaint handling",
      "No email analytics dashboard",
      "No domain verification status",
      "No rate limit monitoring",
      "No batch email support (partial - sendBulk exists but no queuing)",
      "No email testing/preview",
      "No suppression list management"
    ]
  },
  "stories": [
    {
      "id": "INT-RES-001-A",
      "name": "Resend Webhook Endpoint and Schema",
      "description": "Create webhook endpoint and logging table for Resend events",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "email_webhook_log table (id, organizationId, eventType, payload, processedAt, errorMessage, createdAt)",
        "Add openedAt, clickedAt, bounceType, complaintType columns to email_history",
        "/api/webhooks/resend endpoint created",
        "Verify webhook signature from Resend",
        "Log all incoming webhooks before processing",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "layers": [
        "schema",
        "server"
      ],
      "completion_promise": "INT_RES_001_A_COMPLETE"
    },
    {
      "id": "INT-RES-001-B",
      "name": "Resend Webhook Event Processing",
      "description": "Process webhook events and update email status",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Handle events: email.delivered, email.opened, email.clicked, email.bounced, email.complained",
        "Update email_history with delivery status and timestamps",
        "Trigger.dev task for async webhook processing",
        "Webhook log for debugging",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "INT-RES-001-A"
      ],
      "estimated_iterations": 3,
      "layers": [
        "server"
      ],
      "completion_promise": "INT_RES_001_B_COMPLETE"
    },
    {
      "id": "INT-RES-002-A",
      "name": "Email Suppression Schema",
      "description": "Create suppression list table and schema",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "email_suppression table (id, organizationId, email, reason, bounceCount, originalBounceType, suppressedAt, removedAt, removedReason, createdAt)",
        "Suppression reasons: bounce, complaint, unsubscribe, manual",
        "Index on email for fast lookup",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "layers": [
        "schema"
      ],
      "completion_promise": "INT_RES_002_A_COMPLETE"
    },
    {
      "id": "INT-RES-002-B",
      "name": "Bounce and Complaint Handling Logic",
      "description": "Auto-suppress on bounces and track complaints",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Track hard bounces per contact email",
        "Auto-add to suppression after X bounces (configurable)",
        "Complaint (spam) immediately marks as do-not-email",
        "Check suppression list before sending emails",
        "Server functions for suppression CRUD",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "INT-RES-001-B",
        "INT-RES-002-A"
      ],
      "estimated_iterations": 3,
      "layers": [
        "server"
      ],
      "completion_promise": "INT_RES_002_B_COMPLETE"
    },
    {
      "id": "INT-RES-002-C",
      "name": "Bounce Report UI and Admin Notifications",
      "description": "View bounce report and receive high bounce rate alerts",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Bounce report page in /settings/email/bounces",
        "List bounced emails with type and timestamp",
        "Notification to admin on high bounce rate",
        "Manual remove from suppression option",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "INT-RES-002-B"
      ],
      "estimated_iterations": 3,
      "layers": [
        "ui"
      ],
      "completion_promise": "INT_RES_002_C_COMPLETE"
    },
    {
      "id": "INT-RES-003-A",
      "name": "Email Analytics Server Functions",
      "description": "Aggregate email metrics from email_history",
      "priority": 6,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Server function getEmailAnalytics with period filter",
        "Metrics: sent count, delivered rate, open rate, click rate, bounce rate",
        "Breakdown by template type",
        "Time series data for trend charts",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "INT-RES-001-B"
      ],
      "estimated_iterations": 3,
      "layers": [
        "server"
      ],
      "completion_promise": "INT_RES_003_A_COMPLETE"
    },
    {
      "id": "INT-RES-003-B",
      "name": "Email Analytics Dashboard Page",
      "description": "Visual dashboard for email performance",
      "priority": 7,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Route /communications/analytics",
        "Charts: delivery rate over time, opens/clicks",
        "Filter by time period (7d, 30d, 90d)",
        "Top performing templates",
        "Comparison to industry benchmarks (optional)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "INT-RES-003-A"
      ],
      "estimated_iterations": 3,
      "layers": [
        "ui"
      ],
      "completion_promise": "INT_RES_003_B_COMPLETE"
    },
    {
      "id": "INT-RES-004",
      "name": "Domain Verification Status",
      "description": "Monitor sending domain health",
      "priority": 8,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Domain verification status in settings",
        "Call Resend domains.get API to check verification",
        "SPF, DKIM, DMARC status indicators",
        "Alert if domain becomes unverified",
        "Re-verification action button",
        "Troubleshooting guidance with DNS record instructions",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "layers": [
        "server",
        "ui"
      ],
      "completion_promise": "INT_RES_004_COMPLETE"
    },
    {
      "id": "INT-RES-005-A",
      "name": "Batch Email Schema and Queue",
      "description": "Create batch email tracking table and queue system",
      "priority": 9,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "email_batch table (id, organizationId, name, totalCount, sentCount, failedCount, status, priority, startedAt, completedAt, cancelledAt, createdAt)",
        "Trigger.dev task for batch email processing",
        "Rate limit tracking (per hour/day limits)",
        "Priority queue for transactional vs marketing",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "layers": [
        "schema",
        "server"
      ],
      "completion_promise": "INT_RES_005_A_COMPLETE"
    },
    {
      "id": "INT-RES-005-B",
      "name": "Batch Email Progress UI",
      "description": "View batch email progress and controls",
      "priority": 10,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Progress tracking for batch sends (sent/pending/failed)",
        "Batch status dashboard component",
        "Cancel batch in progress capability",
        "Batch limits per hour/day visible",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "INT-RES-005-A"
      ],
      "estimated_iterations": 3,
      "layers": [
        "ui"
      ],
      "completion_promise": "INT_RES_005_B_COMPLETE"
    },
    {
      "id": "INT-RES-006-A",
      "name": "Email Preview API",
      "description": "Preview endpoint that renders template with data",
      "priority": 11,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Preview endpoint that renders template with sample/provided data",
        "Variable validation (highlight missing variables)",
        "Subject line and preheader preview",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "layers": [
        "server"
      ],
      "completion_promise": "INT_RES_006_A_COMPLETE"
    },
    {
      "id": "INT-RES-006-B",
      "name": "Email Testing and Preview UI",
      "description": "Preview emails and send test emails",
      "priority": 12,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Email preview with sample data",
        "Send test email to self functionality",
        "Desktop/mobile viewport toggle using iframe resize",
        "Spam score check (optional)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "INT-RES-006-A"
      ],
      "estimated_iterations": 3,
      "layers": [
        "ui"
      ],
      "completion_promise": "INT_RES_006_B_COMPLETE"
    },
    {
      "id": "INT-RES-007",
      "name": "Suppression List Management UI",
      "description": "View and manage email suppression list",
      "priority": 13,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Suppression list page in /settings/email/suppression",
        "Add email to suppression manually",
        "Remove from suppression with reason",
        "Filter by suppression reason",
        "CSV import suppression list with validation",
        "CSV export suppression list",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "INT-RES-002-B"
      ],
      "estimated_iterations": 3,
      "layers": [
        "ui"
      ],
      "completion_promise": "INT_RES_007_COMPLETE"
    },
    {
      "id": "INT-RES-008",
      "name": "Email Status Dashboard Widget",
      "description": "Email health overview on dashboard",
      "priority": 14,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "EmailStatusWidget component",
        "Metrics: emails sent today, delivery rate, bounces",
        "Health indicator based on delivery rate thresholds",
        "Quick link to analytics and errors",
        "Trend vs previous period",
        "Alert badge on delivery issues",
        "Add to dashboard widget grid",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "INT-RES-003-A"
      ],
      "estimated_iterations": 3,
      "layers": [
        "ui"
      ],
      "completion_promise": "INT_RES_008_COMPLETE"
    },
    {
      "id": "INT-RES-009",
      "name": "Unsubscribe Management Flow",
      "description": "Implement CAN-SPAM and GDPR compliant unsubscribe flow with one-click unsubscribe links in all marketing emails.",
      "priority": 15,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Add {{unsubscribe_url}} variable to all marketing email templates",
        "Create /unsubscribe/:token endpoint for one-click unsubscribe",
        "Token contains encrypted email address and org context",
        "Unsubscribe landing page with confirmation message",
        "Auto-add to suppression list with reason: 'unsubscribe'",
        "Send confirmation email acknowledging unsubscribe",
        "List-Unsubscribe header added to all marketing emails",
        "List-Unsubscribe-Post header for one-click mail client support",
        "Suppression list UI shows unsubscribed users distinctly",
        "Re-subscribe option with explicit opt-in confirmation",
        "TypeScript compiles without errors"
      ],
      "dependencies": ["INT-RES-002-B"],
      "estimated_iterations": 3,
      "layers": ["server", "ui"],
      "completion_promise": "INT_RES_009_COMPLETE",
      "blindspot_source": "CAN-SPAM and GDPR require unsubscribe links - legal compliance"
    }
  ],
  "success_criteria": [
    "Delivery status tracked via webhooks",
    "Bounces handled automatically",
    "Email analytics provide insights",
    "Domain health monitored",
    "Batch emails sent efficiently",
    "Testing prevents send errors"
  ],
  "out_of_scope": [
    "Marketing automation platform",
    "A/B testing",
    "Dynamic content personalization",
    "Email builder UI"
  ]
}
