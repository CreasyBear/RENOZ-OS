{
  "id": "INT-OAUTH",
  "name": "OAuth Integration Suite",
  "description": "Comprehensive OAuth 2.0 integration suite providing secure access to Google Workspace and Microsoft 365 services including Calendar, Email, and Contacts for enhanced productivity and automation",
  "created": "2026-01-19",
  "updated": "2026-01-19",
  "priority": 5,
  "phase": "integrations-v1",
  "version": "v1",
  "dependencies": {
    "phase": "integrations-v1",
    "executionOrder": 1,
    "schemaRequired": [
      {
        "table": "organizations",
        "status": "EXISTS"
      },
      {
        "table": "users",
        "status": "EXISTS"
      }
    ],
    "schemaCreates": [
      {
        "table": "oauth_connections",
        "story": "INT-OAUTH-001a"
      },
      {
        "table": "oauth_sync_logs",
        "story": "INT-OAUTH-001a"
      },
      {
        "table": "oauth_service_permissions",
        "story": "INT-OAUTH-001a"
      }
    ],
    "serverFunctionsRequired": [],
    "serverFunctionsCreates": [
      {
        "function": "initiateOAuthFlow",
        "file": "oauth-flow.ts",
        "story": "INT-OAUTH-002a"
      },
      {
        "function": "handleOAuthCallback",
        "file": "oauth-callback.ts",
        "story": "INT-OAUTH-002a"
      },
      {
        "function": "createOAuthConnection",
        "file": "oauth-connections.ts",
        "story": "INT-OAUTH-003a"
      },
      {
        "function": "getOAuthConnection",
        "file": "oauth-connections.ts",
        "story": "INT-OAUTH-003a"
      },
      {
        "function": "listOAuthConnections",
        "file": "oauth-connections.ts",
        "story": "INT-OAUTH-003a"
      },
      {
        "function": "deleteOAuthConnection",
        "file": "oauth-connections.ts",
        "story": "INT-OAUTH-003a"
      },
      {
        "function": "validateOAuthConnection",
        "file": "oauth-health.ts",
        "story": "INT-OAUTH-003b"
      },
      {
        "function": "refreshOAuthTokens",
        "file": "oauth-tokens.ts",
        "story": "INT-OAUTH-003c"
      },
      {
        "function": "syncCalendarEvents",
        "file": "calendar-sync.ts",
        "story": "INT-OAUTH-004a"
      },
      {
        "function": "syncEmailMessages",
        "file": "email-sync.ts",
        "story": "INT-OAUTH-005a"
      },
      {
        "function": "syncContacts",
        "file": "contacts-sync.ts",
        "story": "INT-OAUTH-006a"
      }
    ],
    "prdDependencies": [
      "schema-foundation",
      "auth-foundation"
    ],
    "enables": [
      "enhanced-productivity",
      "automated-communications"
    ]
  },
  "stories": [
    {
      "id": "INT-OAUTH-001a",
      "name": "OAuth Database Schema",
      "description": "Create OAuth connections, sync logs, and service permissions tables with proper indexing and RLS policies",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "type": "schema",
      "acceptance_criteria": [
        "File src/lib/schema/oauth-connections.ts created with oauthConnections table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, userId uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE, provider VARCHAR(50) NOT NULL CHECK (provider IN ('google_workspace', 'microsoft_365')), serviceType VARCHAR(50) NOT NULL CHECK (serviceType IN ('calendar', 'email', 'contacts')), externalAccountId VARCHAR(255), accessToken TEXT NOT NULL, refreshToken TEXT, tokenExpiresAt TIMESTAMPTZ, scopes JSONB NOT NULL DEFAULT '[]', isActive BOOLEAN NOT NULL DEFAULT true, lastSyncedAt TIMESTAMPTZ, createdAt TIMESTAMPTZ NOT NULL DEFAULT NOW(), updatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW(), version INTEGER NOT NULL DEFAULT 1",
        "File src/lib/schema/oauth-sync-logs.ts created with oauthSyncLogs table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, connectionId uuid NOT NULL REFERENCES oauth_connections(id) ON DELETE CASCADE, serviceType VARCHAR(50) NOT NULL, operation VARCHAR(100) NOT NULL, status VARCHAR(50) NOT NULL, recordCount INTEGER, errorMessage TEXT, metadata JSONB, startedAt TIMESTAMPTZ NOT NULL DEFAULT NOW(), completedAt TIMESTAMPTZ, createdAt TIMESTAMPTZ NOT NULL DEFAULT NOW()",
        "File src/lib/schema/oauth-service-permissions.ts created with oauthServicePermissions table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, connectionId uuid NOT NULL REFERENCES oauth_connections(id) ON DELETE CASCADE, serviceType VARCHAR(50) NOT NULL, scope VARCHAR(255) NOT NULL, isGranted BOOLEAN NOT NULL DEFAULT false, grantedAt TIMESTAMPTZ, revokedAt TIMESTAMPTZ, createdAt TIMESTAMPTZ NOT NULL DEFAULT NOW(), updatedAt TIMESTAMPTZ NOT NULL DEFAULT NOW()",
        "Indexes created: oauth_connections(organization_id, user_id, provider, service_type), oauth_sync_logs(organization_id, connection_id, started_at), oauth_service_permissions(organization_id, connection_id, service_type)",
        "RLS policies implemented for organization isolation",
        "Types exported from src/lib/schema/index.ts",
        "Migration file created and tested",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/lib/schema/oauth-connections.ts (create)",
        "src/lib/schema/oauth-sync-logs.ts (create)",
        "src/lib/schema/oauth-service-permissions.ts (create)",
        "src/lib/schema/index.ts (export)",
        "drizzle/migrations/*.sql (generated)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "INT_OAUTH_001A_COMPLETE"
    },
    {
      "id": "INT-OAUTH-001b",
      "name": "OAuth Token Encryption Utilities",
      "description": "Implement AES-256 encryption for OAuth tokens with organization-specific keys",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "type": "utility",
      "acceptance_criteria": [
        "File src/lib/oauth/token-encryption.ts created with encryptToken() and decryptToken() functions",
        "AES-256-GCM encryption implementation using organization-specific keys derived from org secrets",
        "Token integrity verification with HMAC signatures",
        "Secure key management that prevents key exposure in logs/memory",
        "Performance benchmarks: <50ms encryption/decryption",
        "Security audit: passes basic crypto review (no hardcoded keys, proper IV generation)",
        "Unit tests for encryption/decryption round-trips",
        "Error handling for corrupted/expired tokens"
      ],
      "files_to_modify": [
        "src/lib/oauth/token-encryption.ts (create)",
        "src/lib/oauth/index.ts (export)"
      ],
      "dependencies": [
        "INT-OAUTH-001a"
      ],
      "estimated_iterations": 2,
      "completion_promise": "INT_OAUTH_001B_COMPLETE"
    },
    {
      "id": "INT-OAUTH-002a",
      "name": "OAuth Flow Implementation",
      "description": "Implement OAuth initiation and callback handling for Google Workspace and Microsoft 365",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/oauth/oauth-flow.ts created with initiateOAuthFlow() function",
        "File src/server/functions/oauth/oauth-callback.ts created with handleOAuthCallback() function",
        "Support for service selection: user can choose calendar, email, contacts individually",
        "Dynamic scope generation based on selected services",
        "Secure state parameter generation and validation using HMAC",
        "PKCE (Proof Key for Code Exchange) implementation for enhanced security",
        "Proper redirect URI validation against allowlist",
        "Error handling for invalid state, expired codes, denied permissions",
        "Environment variable validation for client IDs and secrets",
        "Zod validation schemas for all inputs and responses"
      ],
      "files_to_modify": [
        "src/server/functions/oauth/oauth-flow.ts (create)",
        "src/server/functions/oauth/oauth-callback.ts (create)",
        "src/lib/schemas/oauth.ts (create)"
      ],
      "dependencies": [
        "INT-OAUTH-001b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "INT_OAUTH_002A_COMPLETE"
    },
    {
      "id": "INT-OAUTH-002b",
      "name": "OAuth State Management",
      "description": "Implement secure state encryption and verification for OAuth flows",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "type": "utility",
      "acceptance_criteria": [
        "File src/lib/oauth/state-management.ts created",
        "HMAC-SHA256 state signing and verification functions",
        "State includes: organizationId, userId, selectedServices, timestamp, nonce",
        "State expiration (15 minutes) with automatic cleanup",
        "State tampering detection and rejection",
        "Organization-scoped state isolation",
        "Memory-efficient state storage (no unbounded growth)",
        "Integration with Supabase session for user context",
        "Comprehensive error messages for debugging"
      ],
      "files_to_modify": [
        "src/lib/oauth/state-management.ts (create)",
        "src/lib/oauth/index.ts (update exports)"
      ],
      "dependencies": [
        "INT-OAUTH-002a"
      ],
      "estimated_iterations": 2,
      "completion_promise": "INT_OAUTH_002B_COMPLETE"
    },
    {
      "id": "INT-OAUTH-003a",
      "name": "OAuth Connection CRUD",
      "description": "Implement full CRUD operations for OAuth connections with service granularity",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/oauth/connections.ts created",
        "createOAuthConnection(): stores new connection with encrypted tokens and service permissions",
        "getOAuthConnection(): retrieves connection by ID with organization isolation",
        "listOAuthConnections(): returns all connections for organization with service breakdown",
        "deleteOAuthConnection(): removes connection and cleans up related data",
        "updateOAuthConnection(): modifies connection settings and permissions",
        "Token encryption/decryption integration",
        "Service permission validation",
        "Audit logging for all operations",
        "Zod validation schemas for all inputs/outputs",
        "Organization-scoped data access with RLS"
      ],
      "files_to_modify": [
        "src/server/functions/oauth/connections.ts (create)",
        "src/lib/schemas/oauth-connections.ts (create)"
      ],
      "dependencies": [
        "INT-OAUTH-002b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "INT_OAUTH_003A_COMPLETE"
    },
    {
      "id": "INT-OAUTH-003b",
      "name": "OAuth Connection Health Monitoring",
      "description": "Implement connection validation and health checking for all services",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/oauth/health.ts created",
        "validateOAuthConnection(): tests connection viability for each service",
        "Connection health status: healthy, token_expired, api_error, rate_limited, inactive",
        "Service-specific health checks (calendar list, email access, contacts read)",
        "Automated health monitoring background job",
        "Health status caching with TTL",
        "Health metrics collection for monitoring dashboard",
        "User-friendly error messages for different failure modes",
        "Integration with alerting system for critical failures"
      ],
      "files_to_modify": [
        "src/server/functions/oauth/health.ts (create)",
        "src/lib/oauth/health-types.ts (create)"
      ],
      "dependencies": [
        "INT-OAUTH-003a"
      ],
      "estimated_iterations": 2,
      "completion_promise": "INT_OAUTH_003B_COMPLETE"
    },
    {
      "id": "INT-OAUTH-003c",
      "name": "OAuth Token Refresh Automation",
      "description": "Implement automatic token refresh for all providers and services",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/oauth/tokens.ts created",
        "refreshOAuthTokens(): automatic refresh 30 minutes before expiry",
        "Background job for token refresh monitoring",
        "Provider-specific refresh logic (Google vs Microsoft)",
        "Token rotation with zero-downtime",
        "Failed refresh handling with exponential backoff",
        "Audit logging of refresh operations",
        "User notification for refresh failures requiring manual intervention",
        "Integration with health monitoring system"
      ],
      "files_to_modify": [
        "src/server/functions/oauth/tokens.ts (create)",
        "src/lib/oauth/token-refresh.ts (create)"
      ],
      "dependencies": [
        "INT-OAUTH-003b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "INT_OAUTH_003C_COMPLETE"
    },
    {
      "id": "INT-OAUTH-004a",
      "name": "Calendar Sync Engine",
      "description": "Implement bidirectional calendar synchronization with conflict resolution",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/oauth/calendar-sync.ts created",
        "Google Calendar API v3 client implementation",
        "Microsoft Graph Calendar API client implementation",
        "Bidirectional event sync (job → calendar, calendar → job)",
        "Conflict resolution: last-modified-wins policy",
        "Event mapping: job assignments to calendar events",
        "Real-time sync triggers on job changes",
        "Batch processing for large calendar syncs",
        "Error recovery with retry logic",
        "Rate limiting awareness",
        "Audit logging of all sync operations"
      ],
      "files_to_modify": [
        "src/server/functions/oauth/calendar-sync.ts (create)",
        "src/lib/oauth/calendar-client.ts (create)",
        "src/lib/oauth/calendar-mapping.ts (create)"
      ],
      "dependencies": [
        "INT-OAUTH-003c"
      ],
      "estimated_iterations": 4,
      "completion_promise": "INT_OAUTH_004A_COMPLETE"
    },
    {
      "id": "INT-OAUTH-005a",
      "name": "Email Sync Implementation",
      "description": "Implement email synchronization with Gmail and Outlook Mail APIs",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/oauth/email-sync.ts created",
        "Gmail API client for message fetching and sending",
        "Outlook Mail API client for message operations",
        "Email filtering and search capabilities",
        "Attachment download and processing",
        "Communication log integration",
        "Email threading and conversation grouping",
        "Rate limiting and quota management",
        "Privacy-compliant data handling",
        "Error recovery for failed syncs"
      ],
      "files_to_modify": [
        "src/server/functions/oauth/email-sync.ts (create)",
        "src/lib/oauth/email-client.ts (create)",
        "src/lib/oauth/email-processing.ts (create)"
      ],
      "dependencies": [
        "INT-OAUTH-004a"
      ],
      "estimated_iterations": 4,
      "completion_promise": "INT_OAUTH_005A_COMPLETE"
    },
    {
      "id": "INT-OAUTH-006a",
      "name": "Contacts Sync Implementation",
      "description": "Implement contact synchronization with deduplication and field mapping",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/oauth/contacts-sync.ts created",
        "Google Contacts API client implementation",
        "Microsoft Contacts API client implementation",
        "Contact deduplication algorithms",
        "Field mapping and transformation utilities",
        "Customer record enrichment from contacts",
        "Conflict resolution for contact merges",
        "Bulk contact processing capabilities",
        "Data validation and sanitization",
        "Audit logging of contact operations"
      ],
      "files_to_modify": [
        "src/server/functions/oauth/contacts-sync.ts (create)",
        "src/lib/oauth/contacts-client.ts (create)",
        "src/lib/oauth/contacts-deduplication.ts (create)"
      ],
      "dependencies": [
        "INT-OAUTH-005a"
      ],
      "estimated_iterations": 4,
      "completion_promise": "INT_OAUTH_006A_COMPLETE"
    },
    {
      "id": "INT-OAUTH-007a",
      "name": "OAuth Integration UI",
      "description": "Create comprehensive OAuth management interface with service dashboards",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "OAuth connections management page with service selection",
        "Service-specific configuration panels",
        "Connection status dashboard with health indicators",
        "Sync status displays for each service",
        "OAuth authorization flow components",
        "Permission management interface",
        "Error handling and recovery UI",
        "Mobile-responsive design",
        "Accessibility compliance (WCAG 2.1 AA)",
        "Integration with existing UI patterns"
      ],
      "ui_spec": {
        "component_type": "Multi-service Integration Dashboard",
        "layout": {
          "desktop": "Sidebar navigation with main content area, floating action buttons",
          "tablet": "Collapsible sidebar, stacked service cards",
          "mobile": "Bottom tab navigation, full-screen modals"
        },
        "accessibility": {
          "aria_labels": [
            "oauth-connections-list",
            "service-connection-status",
            "sync-status-indicator",
            "oauth-authorization-button"
          ],
          "keyboard_nav": "Tab navigation through connections, Enter to configure, Escape to close modals",
          "screen_reader": "Announce connection status changes, sync progress updates",
          "focus_management": "Focus on primary action after modal open, return to trigger after close"
        }
      },
      "uiPatterns": {
        "primaryComponents": [
          {
            "name": "Connection Card",
            "component": "connection-card.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/connection-card.tsx",
            "usage": "Display OAuth connection status with service indicators",
            "features": [
              "Provider logo and name",
              "Service status badges",
              "Last sync timestamp",
              "Quick actions menu"
            ]
          },
          {
            "name": "Service Dashboard",
            "component": "service-dashboard.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/service-dashboard.tsx",
            "usage": "Service-specific status and configuration",
            "features": [
              "Sync statistics",
              "Error notifications",
              "Configuration options",
              "Manual sync triggers"
            ]
          }
        ]
      },
      "files_to_modify": [
        "src/components/integrations/oauth/connection-manager.tsx (create)",
        "src/components/integrations/oauth/service-dashboard.tsx (create)",
        "src/components/integrations/oauth/oauth-flow-modal.tsx (create)",
        "src/routes/integrations/oauth.tsx (create)",
        "src/routes/integrations/oauth/callback.tsx (create)"
      ],
      "dependencies": [
        "INT-OAUTH-006a"
      ],
      "estimated_iterations": 5,
      "completion_promise": "INT_OAUTH_007A_COMPLETE"
    }
  ],
  "audit": {
    "date": "2026-01-19",
    "audit_file": "memory-bank/prd/_audits/oauth-integration-audit.json"
  },
  "references": {
    "internal": [
      "memory-bank/_meta/glossary.md - OAuth terminology",
      "_Initiation/_meta/patterns/testing-standards.md - Testing requirements",
      "_Initiation/_meta/patterns/error-recovery.md - Error handling patterns",
      "_Initiation/_meta/patterns/oauth-security.md - Security requirements"
    ],
    "external": [
      "https://developers.google.com/identity/protocols/oauth2 - Google OAuth 2.0",
      "https://docs.microsoft.com/en-us/graph/auth-overview - Microsoft Graph Auth",
      "https://tools.ietf.org/html/rfc6749 - OAuth 2.0 RFC"
    ]
  }
}