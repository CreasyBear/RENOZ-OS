{
  "id": "INT-GDPR",
  "name": "GDPR & Privacy Compliance",
  "description": "Privacy compliance features including data export, account deletion requests, consent management, and audit logging for GDPR/Australian Privacy Act compliance.",
  "created": "2026-01-13",
  "updated": "2026-01-13",
  "priority": 1,
  "phase": "integration",
  "version": "1.0",
  "business_value": {
    "legal_compliance": true,
    "customer_trust": true,
    "data_governance": true,
    "description": "Enables compliance with privacy regulations and builds customer trust through transparent data handling"
  },
  "system_requirements": {
    "database": {
      "dataExportRequests": {
        "description": "Track data export requests from users",
        "fields": {
          "id": "uuid PRIMARY KEY DEFAULT gen_random_uuid()",
          "userId": "uuid NOT NULL REFERENCES users(id)",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id)",
          "status": "text NOT NULL DEFAULT 'pending'",
          "requestedAt": "timestamp NOT NULL DEFAULT NOW()",
          "completedAt": "timestamp",
          "downloadUrl": "text",
          "expiresAt": "timestamp",
          "metadata": "jsonb DEFAULT '{}'::jsonb"
        },
        "indexes": ["userId", "organizationId", "status"],
        "rls": "users can only see own requests"
      },
      "deletionRequests": {
        "description": "Track account deletion requests",
        "fields": {
          "id": "uuid PRIMARY KEY DEFAULT gen_random_uuid()",
          "userId": "uuid NOT NULL REFERENCES users(id)",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id)",
          "status": "text NOT NULL DEFAULT 'pending'",
          "reason": "text",
          "requestedAt": "timestamp NOT NULL DEFAULT NOW()",
          "scheduledFor": "timestamp NOT NULL",
          "completedAt": "timestamp",
          "cancelledAt": "timestamp"
        },
        "indexes": ["userId", "status", "scheduledFor"],
        "rls": "users can only see own requests"
      }
    },
    "api_endpoints": {
      "dataExport": {
        "request": {
          "method": "POST",
          "path": "/api/privacy/export",
          "response": { "requestId": "string", "estimatedCompletion": "string" },
          "description": "Request data export"
        },
        "status": {
          "method": "GET",
          "path": "/api/privacy/export/:requestId",
          "response": { "status": "string", "downloadUrl": "string?" },
          "description": "Check export status"
        }
      },
      "deletion": {
        "request": {
          "method": "POST",
          "path": "/api/privacy/deletion",
          "body": { "reason": "string?" },
          "response": { "requestId": "string", "scheduledFor": "string" },
          "description": "Request account deletion"
        },
        "cancel": {
          "method": "DELETE",
          "path": "/api/privacy/deletion/:requestId",
          "response": { "success": "boolean" },
          "description": "Cancel deletion request"
        }
      }
    },
    "ui_components": {
      "privacySettings": {
        "description": "Privacy settings page with export/deletion options",
        "location": "src/routes/_authenticated/settings/privacy.tsx"
      }
    }
  },
  "stories": [
    {
      "id": "GDPR-001",
      "name": "Privacy Request Schemas",
      "description": "Create database schemas for data export and deletion requests",
      "type": "schema",
      "acceptance_criteria": [
        "Table data_export_requests exists in drizzle/schema/privacy/data-export-requests.ts",
        "Fields: id (uuid PK), userId (uuid FK users NOT NULL), organizationId (uuid FK organizations NOT NULL), status (text NOT NULL DEFAULT 'pending': 'pending', 'processing', 'completed', 'failed'), requestedAt (timestamp NOT NULL DEFAULT NOW()), completedAt (timestamp), downloadUrl (text), expiresAt (timestamp), metadata (jsonb)",
        "Table deletion_requests exists in drizzle/schema/privacy/deletion-requests.ts",
        "Deletion fields: id, userId (FK), organizationId (FK), status ('pending', 'scheduled', 'completed', 'cancelled'), reason (text), requestedAt, scheduledFor (timestamp NOT NULL), completedAt, cancelledAt",
        "Index on userId and status for both tables",
        "RLS policy: users can only see own requests",
        "TypeScript types DataExportRequest and DeletionRequest exported",
        "Migration file exists",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "drizzle/schema/privacy/data-export-requests.ts",
        "drizzle/schema/privacy/deletion-requests.ts",
        "drizzle/schema/privacy/index.ts",
        "drizzle/schema/index.ts"
      ],
      "dependencies": [],
      "completion_promise": "GDPR_001_COMPLETE",
      "estimated_iterations": 2,
      "status": "pending"
    },
    {
      "id": "GDPR-002",
      "name": "Data Export API and Job",
      "description": "Implement data export request API and background processing",
      "type": "server",
      "acceptance_criteria": [
        "File src/routes/api/privacy/export/index.ts exports POST handler",
        "POST creates data_export_requests record with status='pending'",
        "POST triggers Trigger.dev job 'export-user-data' with requestId",
        "Returns { requestId, estimatedCompletion: '24 hours' }",
        "File src/routes/api/privacy/export/$requestId.ts exports GET handler",
        "GET returns { status, downloadUrl (if completed), expiresAt }",
        "File src/trigger/jobs/export-user-data.ts defines export job",
        "Job collects: user profile, conversations, activities, orders, invoices, attachments metadata",
        "Job generates JSON file with all user data",
        "Job uploads to R2 with presigned download URL (expires in 7 days)",
        "Job updates request: status='completed', downloadUrl, expiresAt",
        "On failure: status='failed', logs error",
        "Both routes wrapped with createProtectedFn",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "src/routes/api/privacy/export/index.ts",
        "src/routes/api/privacy/export/$requestId.ts",
        "src/trigger/jobs/export-user-data.ts",
        "src/trigger/index.ts"
      ],
      "dependencies": ["GDPR-001"],
      "completion_promise": "GDPR_002_COMPLETE",
      "estimated_iterations": 4,
      "status": "pending"
    },
    {
      "id": "GDPR-003",
      "name": "Account Deletion API and Job",
      "description": "Implement account deletion request with grace period",
      "type": "server",
      "acceptance_criteria": [
        "File src/routes/api/privacy/deletion/index.ts exports POST handler",
        "POST creates deletion_requests record with scheduledFor = NOW() + 30 days (grace period)",
        "POST sends confirmation email to user with cancellation instructions",
        "Returns { requestId, scheduledFor }",
        "File src/routes/api/privacy/deletion/$requestId.ts exports DELETE handler for cancellation",
        "DELETE sets cancelledAt = NOW() if status is 'pending' or 'scheduled'",
        "Returns 400 if already completed",
        "File src/trigger/jobs/process-deletion.ts defines scheduled deletion job",
        "Job runs daily, finds requests WHERE scheduledFor <= NOW() AND status = 'scheduled'",
        "Job anonymizes user data: replaces PII with '[DELETED]', sets email to deleted-{uuid}@deleted.local",
        "Job soft-deletes related records (orders, invoices retain for legal, anonymized)",
        "Job deletes attachments from R2",
        "Job updates request: status='completed', completedAt=NOW()",
        "Job sends final confirmation email before deletion",
        "All routes wrapped with createProtectedFn",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "src/routes/api/privacy/deletion/index.ts",
        "src/routes/api/privacy/deletion/$requestId.ts",
        "src/trigger/jobs/process-deletion.ts",
        "src/trigger/index.ts"
      ],
      "dependencies": ["GDPR-001"],
      "completion_promise": "GDPR_003_COMPLETE",
      "estimated_iterations": 5,
      "status": "pending"
    },
    {
      "id": "GDPR-004",
      "name": "Privacy Settings UI",
      "description": "Create privacy settings page with export and deletion options",
      "type": "ui",
      "acceptance_criteria": [
        "Route src/routes/_authenticated/settings/privacy.tsx created",
        "Page title: 'Privacy & Data'",
        "Section 'Export Your Data': description of what's included, 'Request Export' button",
        "Request Export button calls POST /api/privacy/export, shows toast with requestId",
        "Shows pending/completed export requests with download links",
        "Section 'Delete Account': warning about 30-day grace period, 'Request Deletion' button",
        "Request Deletion opens AlertDialog with confirmation input (type 'DELETE' to confirm)",
        "After confirmation, calls POST /api/privacy/deletion with optional reason",
        "Shows pending deletion request with 'Cancel Deletion' button",
        "Cancel button calls DELETE /api/privacy/deletion/:id",
        "Uses Card components for sections",
        "Warning styling (yellow/red borders) for deletion section",
        "Loading states with Skeleton",
        "ARIA: aria-describedby for warning text",
        "Exported from settings navigation",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "src/routes/_authenticated/settings/privacy.tsx",
        "src/routes/_authenticated/settings/index.tsx"
      ],
      "dependencies": ["GDPR-002", "GDPR-003"],
      "completion_promise": "GDPR_004_COMPLETE",
      "estimated_iterations": 4,
      "status": "pending"
    }
  ],
  "cross_prd_dependencies": {
    "note": "Requires file storage for export uploads and Trigger.dev for background jobs",
    "required_prds": ["FOUND-AUTH", "FOUND-SCHEMA", "FOUND-SHARED", "FOUND-FILE-STORAGE", "FOUND-REALTIME"],
    "rationale": "FOUND-AUTH for protected routes; FOUND-FILE-STORAGE for export file uploads; FOUND-REALTIME (Trigger.dev) for background jobs"
  },
  "success_criteria": [
    "Data export request creates background job",
    "Export job collects all user data into JSON",
    "Export download available for 7 days",
    "Deletion request has 30-day grace period",
    "Deletion can be cancelled during grace period",
    "Deletion anonymizes rather than hard-deletes",
    "Privacy settings page functional",
    "TypeScript compiles with no errors",
    "All 4 stories have testable acceptance criteria"
  ],
  "out_of_scope": [
    "Consent management UI (future enhancement)",
    "Cookie consent banner",
    "Data retention policies configuration",
    "Right to rectification UI",
    "Data portability to other systems"
  ],
  "migration_notes": {
    "existing_users": "No migration needed - features are additive",
    "legal_review": "Deletion process should be reviewed by legal for compliance"
  }
}
