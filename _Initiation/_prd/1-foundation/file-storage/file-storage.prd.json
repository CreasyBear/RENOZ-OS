{
  "id": "FOUND-FILE-STORAGE",
  "name": "File Storage Foundation",
  "description": "Foundation file storage infrastructure using Cloudflare R2 (S3-compatible). Provides upload/download APIs, attachment schema, and reusable UI components for file management across all domains.",
  "created": "2026-01-13",
  "updated": "2026-01-13",
  "priority": 1,
  "phase": "foundation",
  "version": "1.0",
  "business_value": {
    "document_management": true,
    "product_images": true,
    "customer_attachments": true,
    "description": "Enables file attachments throughout the CRM - product photos, customer documents, order PDFs, warranty photos"
  },
  "system_requirements": {
    "infrastructure": {
      "cloudflare_r2": {
        "description": "S3-compatible object storage via Cloudflare R2",
        "sdk": "@aws-sdk/client-s3 with R2 endpoint",
        "buckets": {
          "attachments": "renoz-attachments (private, signed URLs)",
          "public": "renoz-public (public assets, CDN)"
        },
        "required": true
      }
    },
    "database": {
      "attachments": {
        "description": "Metadata for all uploaded files",
        "fields": {
          "id": "uuid PRIMARY KEY DEFAULT gen_random_uuid()",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id)",
          "uploadedBy": "uuid NOT NULL REFERENCES users(id)",
          "filename": "text NOT NULL",
          "originalFilename": "text NOT NULL",
          "mimeType": "text NOT NULL",
          "sizeBytes": "integer NOT NULL",
          "storageKey": "text NOT NULL UNIQUE",
          "bucket": "text NOT NULL DEFAULT 'attachments'",
          "entityType": "text",
          "entityId": "uuid",
          "metadata": "jsonb DEFAULT '{}'::jsonb",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "deletedAt": "timestamp"
        },
        "indexes": [
          "organizationId",
          "entityType,entityId",
          "storageKey",
          "uploadedBy"
        ],
        "rls": "users can only access own org's attachments"
      }
    },
    "api_endpoints": {
      "upload": {
        "presigned": {
          "method": "POST",
          "path": "/api/files/upload/presigned",
          "body": {
            "filename": "string",
            "mimeType": "string",
            "sizeBytes": "number",
            "entityType": "string?",
            "entityId": "string?"
          },
          "response": {
            "uploadUrl": "string (presigned PUT URL)",
            "attachmentId": "string",
            "expiresAt": "string (ISO date)"
          },
          "description": "Get presigned URL for direct upload to R2"
        },
        "confirm": {
          "method": "POST",
          "path": "/api/files/upload/confirm",
          "body": {
            "attachmentId": "string"
          },
          "response": {
            "attachment": "Attachment"
          },
          "description": "Confirm upload completed, verify file exists"
        }
      },
      "download": {
        "presigned": {
          "method": "GET",
          "path": "/api/files/:attachmentId/download",
          "response": {
            "downloadUrl": "string (presigned GET URL)",
            "expiresAt": "string"
          },
          "description": "Get presigned URL for secure download"
        }
      },
      "delete": {
        "method": "DELETE",
        "path": "/api/files/:attachmentId",
        "response": {
          "success": "boolean"
        },
        "description": "Soft delete attachment (sets deletedAt)"
      },
      "list": {
        "method": "GET",
        "path": "/api/files",
        "query_params": [
          "entityType",
          "entityId",
          "limit",
          "offset"
        ],
        "response": {
          "attachments": "Attachment[]",
          "total": "number"
        },
        "description": "List attachments for an entity"
      }
    },
    "ui_components": {
      "fileUploader": {
        "description": "Drag-and-drop file upload component with progress",
        "features": [
          "Drag zone",
          "Progress bar",
          "Multiple files",
          "Type validation"
        ],
        "location": "src/components/files/file-uploader.tsx"
      },
      "filePreview": {
        "description": "Preview component for images and documents",
        "features": [
          "Image preview",
          "PDF thumbnail",
          "File icon fallback"
        ],
        "location": "src/components/files/file-preview.tsx"
      },
      "attachmentList": {
        "description": "List of attachments with download/delete actions",
        "location": "src/components/files/attachment-list.tsx"
      }
    },
    "environment_variables": {
      "required": [
        "R2_ACCOUNT_ID",
        "R2_ACCESS_KEY_ID",
        "R2_SECRET_ACCESS_KEY",
        "R2_BUCKET_NAME"
      ],
      "optional": [
        "R2_PUBLIC_BUCKET_NAME",
        "R2_ENDPOINT (defaults to Cloudflare R2)"
      ]
    }
  },
  "stories": [
    {
      "id": "FILE-001",
      "name": "Attachments Schema",
      "description": "Create database schema for file attachment metadata",
      "type": "schema",
      "acceptance_criteria": [
        "Table attachments exists in drizzle/schema/files/attachments.ts",
        "Fields: id (uuid PK), organizationId (uuid FK NOT NULL), uploadedBy (uuid FK users NOT NULL), filename (text NOT NULL), originalFilename (text NOT NULL), mimeType (text NOT NULL), sizeBytes (integer NOT NULL), storageKey (text UNIQUE NOT NULL), bucket (text NOT NULL DEFAULT 'attachments'), entityType (text nullable), entityId (uuid nullable), metadata (jsonb DEFAULT '{}'), createdAt (timestamp NOT NULL DEFAULT NOW()), deletedAt (timestamp nullable)",
        "Index on organizationId for RLS filtering",
        "Index on (entityType, entityId) for entity attachment lookups",
        "Index on storageKey for storage operations",
        "RLS policy: SELECT/INSERT/UPDATE/DELETE restricted to rows where organizationId matches user's org",
        "TypeScript types Attachment and NewAttachment exported from drizzle/schema/files/index.ts",
        "Migration file exists in drizzle/migrations/",
        "bun run db:generate succeeds",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "drizzle/schema/files/attachments.ts",
        "drizzle/schema/files/index.ts",
        "drizzle/schema/index.ts"
      ],
      "dependencies": [],
      "completion_promise": "FILE_001_COMPLETE",
      "estimated_iterations": 2,
      "status": "pending"
    },
    {
      "id": "FILE-002",
      "name": "R2 Storage Provider",
      "description": "Configure Cloudflare R2 client and storage utilities",
      "type": "server",
      "acceptance_criteria": [
        "File src/lib/storage/r2-client.ts creates S3Client configured for Cloudflare R2",
        "S3Client uses endpoint: https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com",
        "Credentials from R2_ACCESS_KEY_ID and R2_SECRET_ACCESS_KEY env vars",
        "File src/lib/storage/upload.ts exports generatePresignedUploadUrl(key, mimeType, expiresIn)",
        "generatePresignedUploadUrl uses PutObjectCommand with getSignedUrl from @aws-sdk/s3-request-presigner",
        "Default expiresIn is 3600 seconds (1 hour)",
        "File src/lib/storage/download.ts exports generatePresignedDownloadUrl(key, expiresIn)",
        "generatePresignedDownloadUrl uses GetObjectCommand with getSignedUrl",
        "File src/lib/storage/delete.ts exports deleteObject(key) using DeleteObjectCommand",
        "File src/lib/storage/head.ts exports headObject(key) using HeadObjectCommand, returns { contentLength, contentType } or null if not exists",
        "File src/lib/storage/index.ts re-exports all storage functions",
        "Graceful error handling: wraps AWS errors with StorageError class",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "src/lib/storage/r2-client.ts",
        "src/lib/storage/upload.ts",
        "src/lib/storage/download.ts",
        "src/lib/storage/delete.ts",
        "src/lib/storage/head.ts",
        "src/lib/storage/index.ts",
        "src/lib/storage/errors.ts"
      ],
      "dependencies": [],
      "completion_promise": "FILE_002_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "FILE-003",
      "name": "File Upload API Routes",
      "description": "Implement API routes for presigned upload and confirmation",
      "type": "server",
      "acceptance_criteria": [
        "File src/routes/api/files/upload/presigned.ts exports POST handler",
        "POST validates request body with Zod: filename (string), mimeType (string), sizeBytes (number max 50MB), entityType (string optional), entityId (uuid optional)",
        "Generates unique storageKey: {orgId}/{entityType || 'general'}/{uuid}-{sanitized-filename}",
        "Creates attachment record in database with status pending (deletedAt = NOW() as placeholder)",
        "Calls generatePresignedUploadUrl with storageKey and mimeType",
        "Returns { uploadUrl, attachmentId, expiresAt }",
        "File src/routes/api/files/upload/confirm.ts exports POST handler",
        "POST validates attachmentId exists and belongs to current user's org",
        "Verifies file exists in R2 via HeadObjectCommand",
        "Updates attachment: sets deletedAt = NULL to confirm",
        "Returns full attachment object",
        "Rate limit: 10 uploads per minute per user via Upstash",
        "File size limit: reject if sizeBytes > 50MB (50 * 1024 * 1024)",
        "MIME type allowlist: image/*, application/pdf, text/*, application/msword, application/vnd.openxmlformats-*",
        "All routes wrapped with createProtectedFn",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "src/routes/api/files/upload/presigned.ts",
        "src/routes/api/files/upload/confirm.ts",
        "src/lib/schemas/files.ts"
      ],
      "dependencies": [
        "FILE-001",
        "FILE-002"
      ],
      "completion_promise": "FILE_003_COMPLETE",
      "estimated_iterations": 4,
      "status": "pending"
    },
    {
      "id": "FILE-004",
      "name": "File Download and Delete API Routes",
      "description": "Implement API routes for download and soft delete",
      "type": "server",
      "acceptance_criteria": [
        "File src/routes/api/files/$attachmentId/download.ts exports GET handler",
        "GET validates attachmentId belongs to current user's org",
        "GET rejects if attachment.deletedAt is not null (file was deleted)",
        "Calls generatePresignedDownloadUrl with attachment.storageKey",
        "Returns { downloadUrl, filename: attachment.originalFilename, expiresAt }",
        "File src/routes/api/files/$attachmentId/index.ts exports DELETE handler",
        "DELETE validates attachmentId belongs to current user's org",
        "DELETE sets deletedAt = NOW() (soft delete, preserves file in R2)",
        "Returns { success: true }",
        "File src/routes/api/files/index.ts exports GET handler for listing",
        "GET accepts query params: entityType, entityId, limit (default 50), offset (default 0)",
        "GET returns { attachments: Attachment[], total: number }",
        "All routes wrapped with createProtectedFn",
        "Error responses: 404 for not found, 403 for wrong org, 410 for deleted file",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "src/routes/api/files/$attachmentId/download.ts",
        "src/routes/api/files/$attachmentId/index.ts",
        "src/routes/api/files/index.ts"
      ],
      "dependencies": [
        "FILE-001",
        "FILE-002"
      ],
      "completion_promise": "FILE_004_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "FILE-005",
      "name": "File Uploader UI Component",
      "description": "Create reusable drag-and-drop file upload component",
      "type": "ui",
      "acceptance_criteria": [
        "FileUploader component in src/components/files/file-uploader.tsx",
        "Props: { onUploadComplete: (attachment: Attachment) => void, entityType?: string, entityId?: string, accept?: string, maxSizeMB?: number, multiple?: boolean }",
        "Drag zone with dashed border, changes to solid blue on dragover",
        "Click to open file picker via hidden input type='file'",
        "Shows file icon and name after selection, before upload",
        "Upload flow: (1) POST /api/files/upload/presigned, (2) PUT to uploadUrl, (3) POST /api/files/upload/confirm",
        "Progress bar using Progress from @/components/ui/progress during PUT upload",
        "Uses XMLHttpRequest for upload to track progress via xhr.upload.onprogress",
        "Error state shows inline error with AlertTriangle icon and retry button",
        "Success state shows CheckCircle icon and filename",
        "Validates file size client-side before upload attempt",
        "Validates MIME type against accept prop if provided",
        "Uses react-dropzone package for drag-and-drop handling",
        "ARIA: role='button' on drop zone, aria-label='Upload files', aria-live on status",
        "Exported from src/components/files/index.ts",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/files/file-uploader.tsx",
        "src/components/files/index.ts"
      ],
      "dependencies": [
        "FILE-003"
      ],
      "completion_promise": "FILE_005_COMPLETE",
      "estimated_iterations": 4,
      "status": "pending"
    },
    {
      "id": "FILE-006",
      "name": "File Preview and Attachment List UI",
      "description": "Create file preview and attachment list components",
      "type": "ui",
      "acceptance_criteria": [
        "FilePreview component in src/components/files/file-preview.tsx",
        "Props: { attachment: Attachment, size?: 'sm' | 'md' | 'lg' }",
        "For image/* mimeTypes: renders img tag with src from presigned download URL",
        "For application/pdf: renders PDF icon (FileText from lucide-react) with filename",
        "For other types: renders generic File icon with filename and extension",
        "Size variants: sm (32x32), md (64x64), lg (128x128)",
        "Lazy loads images with loading='lazy' attribute",
        "Error fallback shows broken image icon if load fails",
        "AttachmentList component in src/components/files/attachment-list.tsx",
        "Props: { entityType: string, entityId: string, editable?: boolean }",
        "Fetches attachments via GET /api/files?entityType=X&entityId=Y using TanStack Query",
        "Displays list of FilePreview components with filename and size",
        "Each item has download button (Download icon) that opens presigned URL in new tab",
        "If editable=true, shows delete button (Trash2 icon) with AlertDialog confirmation",
        "Delete calls DELETE /api/files/:id and invalidates query",
        "Empty state: 'No attachments' with Upload icon",
        "Loading state: Skeleton cards",
        "Both components exported from src/components/files/index.ts",
        "ARIA: aria-label on action buttons",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/files/file-preview.tsx",
        "src/components/files/attachment-list.tsx",
        "src/components/files/index.ts"
      ],
      "dependencies": [
        "FILE-004"
      ],
      "completion_promise": "FILE_006_COMPLETE",
      "estimated_iterations": 4,
      "status": "pending"
    },
    {
      "id": "FILE-007",
      "name": "File Query Hooks",
      "description": "Create TanStack Query hooks for file operations",
      "type": "ui",
      "acceptance_criteria": [
        "File src/hooks/use-files.ts exports useAttachments, useDownloadUrl, useUploadFile, useDeleteFile hooks",
        "useAttachments(entityType, entityId) returns TanStack Query result for GET /api/files?entityType=X&entityId=Y",
        "useAttachments queryKey: ['files', entityType, entityId]",
        "useDownloadUrl(attachmentId) returns { downloadUrl, isLoading } from GET /api/files/:id/download",
        "useDownloadUrl has staleTime: 5 * 60 * 1000 (5 minutes) to cache presigned URLs",
        "useUploadFile() returns useMutation for upload flow (presigned -> PUT -> confirm)",
        "useUploadFile onSuccess invalidates ['files'] queries",
        "useDeleteFile() returns useMutation for DELETE /api/files/:id",
        "useDeleteFile onSuccess invalidates ['files'] queries",
        "All hooks use queryClient from @tanstack/react-query",
        "TypeScript types exported: UseAttachmentsResult, UseUploadFileOptions",
        "Exported from src/hooks/index.ts",
        "bun run typecheck passes"
      ],
      "files_to_modify": [
        "src/hooks/use-files.ts",
        "src/hooks/index.ts"
      ],
      "dependencies": [
        "FILE-003",
        "FILE-004"
      ],
      "completion_promise": "FILE_007_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    }
  ],
  "cross_prd_dependencies": {
    "note": "This PRD provides file storage foundation for all domain PRDs",
    "required_prds": [
      "FOUND-AUTH",
      "FOUND-SCHEMA",
      "FOUND-SHARED"
    ],
    "rationale": "FOUND-AUTH for protected routes and user context; FOUND-SCHEMA for Drizzle setup; FOUND-SHARED for UI primitives"
  },
  "success_criteria": [
    "Attachments table created with proper RLS",
    "R2 client configured with presigned URL generation",
    "Upload flow: presigned URL -> direct upload -> confirmation",
    "Download flow: presigned URL for secure access",
    "Soft delete preserves files but hides from queries",
    "FileUploader component handles drag-drop and progress",
    "FilePreview component renders images and file icons",
    "AttachmentList component lists files with actions",
    "File size limit enforced (50MB)",
    "MIME type validation on upload",
    "TypeScript compiles with no errors",
    "All 7 stories have testable acceptance criteria"
  ],
  "out_of_scope": [
    "Image processing/resizing (future enhancement)",
    "Video transcoding",
    "Virus scanning (consider in security PRD)",
    "Public file sharing links",
    "Folder/directory structure",
    "File versioning"
  ],
  "pattern_references": [
    {
      "file": "_Initiation/_meta/patterns/testing-standards.md",
      "applies_to": "all stories",
      "reason": "Foundation code requires comprehensive testing"
    },
    {
      "file": "_Initiation/_meta/patterns/error-recovery.md",
      "applies_to": "FILE-002, FILE-003, FILE-004",
      "reason": "R2 uploads/downloads must handle network failures with retry logic"
    },
    {
      "file": "_Initiation/_meta/patterns/performance-benchmarks.md",
      "applies_to": "FILE-003, FILE-005",
      "reason": "Upload timeouts and progress tracking per performance targets"
    }
  ],
  "migration_notes": {
    "r2_setup": "Create R2 bucket via Cloudflare dashboard before deployment",
    "cors_config": "R2 bucket needs CORS policy allowing PUT from app domain"
  },
  "domain_completion_promise": "FOUND_FILE_STORAGE_COMPLETE"
}
