{
  "id": "FOUND-SCHEMA",
  "name": "Schema Foundation Enhancement",
  "description": "Fill gaps in database schema, enhance existing tables, and document patterns for domain PRD implementation. Foundation is solid; this addresses identified gaps.",
  "created": "2026-01-09",
  "updated": "2026-01-10",
  "priority": 1,
  "phase": "foundation",
  "version": "MVP",
  "stack": {
    "orm": "Drizzle ORM",
    "database": "PostgreSQL",
    "validation": "Zod",
    "runtime": "Bun"
  },
  "references": {
    "internal": [
      "_Initiation/_prd/_meta/conventions.md - Schema patterns",
      "_Initiation/_prd/_meta/glossary.md - Domain terminology",
      "_Initiation/_ralph/backend-patterns/schema-patterns.md - Drizzle schema conventions",
      "_Initiation/_ralph/backend-patterns/query-patterns.md - Query organization patterns",
      "_Initiation/_ralph/backend-patterns/sql-performance.md - Indexing and optimization",
      "drizzle/schema/ - Drizzle table definitions",
      "src/lib/schemas/ - Zod validation schemas"
    ],
    "external": [
      "https://orm.drizzle.team/docs/overview - Drizzle ORM",
      "https://orm.drizzle.team/docs/connect-supabase - Supabase integration",
      "https://zod.dev/ - Zod validation",
      "https://tanstack.com/form/latest - TanStack Form integration"
    ]
  },
  "current_state": {
    "implemented": [
      "Core entity tables (customers, orders, products, etc.)",
      "RLS enabled via Drizzle policies",
      "User preferences with JSONB fields",
      "Suppliers with full contact/address/payment terms",
      "Email history with status tracking"
    ],
    "gaps": [
      "email_history: Missing campaign tracking (campaignId, templateId, openedAt, clickedAt)",
      "notifications: No delivery status lifecycle tracking",
      "No schema README documenting patterns",
      "No Zod schemas README documenting conventions",
      "No reusable schema patterns module"
    ]
  },
  "stories": [
    {
      "id": "FOUND-SCHEMA-000",
      "name": "Configure Database Client with Pooler Compatibility",
      "description": "Setup Drizzle client with Supabase connection pooler compatibility. Critical for production.",
      "priority": 0,
      "status": "pending",
      "type": "foundation",
      "estimated_iterations": 2,
      "acceptance_criteria": [
        "File src/lib/db/index.ts created with Drizzle client",
        "postgres client uses { prepare: false } for Supabase pooler Transaction mode",
        "Connection pool configured: max: 10, idle_timeout: 20",
        "drizzle client uses casing: 'snake_case' to match PostgreSQL conventions",
        "DATABASE_URL uses Supabase connection pooler URL (port 6543)",
        "Environment variable documented in .env.example",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "src/lib/db/index.ts"
      ],
      "files_to_modify": [
        ".env.example"
      ],
      "dependencies": [],
      "completion_promise": "FOUND_SCHEMA_000_COMPLETE",
      "blindspot_source": "backend-patterns/query-patterns.md - Connection pooling critical for Supabase"
    },
    {
      "id": "FOUND-SCHEMA-001",
      "name": "Create Schema Documentation README",
      "description": "Document Drizzle schema patterns, conventions, and relationships",
      "priority": 1,
      "status": "pending",
      "type": "documentation",
      "acceptance_criteria": [
        "File drizzle/schema/README.md created",
        "Documents: table naming conventions (snake_case in DB, camelCase in code)",
        "Documents: column conventions (id, organizationId, timestamps, audit)",
        "Documents: index patterns and naming",
        "Explains: organization_id pattern for multi-tenancy",
        "Shows: type inference pattern ($inferSelect, $inferInsert)",
        "Lists all schema files with brief descriptions",
        "References drizzle.config.ts and migration workflow",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "drizzle/schema/README.md"
      ],
      "files_to_modify": [],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "FOUND_SCHEMA_001_COMPLETE"
    },
    {
      "id": "FOUND-SCHEMA-002",
      "name": "Create Zod Schemas Documentation README",
      "description": "Document validation schema patterns and naming conventions",
      "priority": 2,
      "status": "pending",
      "type": "documentation",
      "acceptance_criteria": [
        "File src/lib/schemas/README.md created",
        "Documents: schema naming (Create*, Update*, *Params, *Schema)",
        "Explains: input vs output schemas, partial patterns",
        "Shows: common patterns (pagination, filters, id params)",
        "Lists all schema files with coverage",
        "Shows integration with TanStack Form validators",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "src/lib/schemas/README.md"
      ],
      "files_to_modify": [],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "FOUND_SCHEMA_002_COMPLETE"
    },
    {
      "id": "FOUND-SCHEMA-003",
      "name": "Enhance Notifications with Delivery Tracking",
      "description": "Add delivery status fields to notifications table for tracking notification lifecycle",
      "priority": 3,
      "status": "pending",
      "type": "schema",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File drizzle/schema/notifications.ts updated with new columns:",
        "  - deliveryStatus: 'pending' | 'sent' | 'read' | 'dismissed' | 'failed'",
        "  - sentAt: timestamp nullable",
        "  - readAt: timestamp nullable",
        "  - dismissedAt: timestamp nullable",
        "  - failureReason: text nullable",
        "Table category: 'userScoped' per column-patterns.json",
        "RLS policy type: 'userScoped' per rls-policies.json#/policyTemplates/userScoped",
        "Migration file created via bun run db:generate",
        "Zod schema src/lib/schemas/notifications.ts updated",
        "Unit test in tests/unit/schemas/notifications.spec.ts passes",
        "bun run typecheck passes",
        "bun run test passes"
      ],
      "files_to_modify": [
        "drizzle/schema/notifications.ts",
        "src/lib/schemas/notifications.ts"
      ],
      "files_to_create": [
        "drizzle/migrations/*.sql (generated)",
        "tests/unit/schemas/notifications.spec.ts"
      ],
      "dependencies": [
        "FOUND-SCHEMA-001"
      ],
      "completion_promise": "FOUND_SCHEMA_003_COMPLETE"
    },
    {
      "id": "FOUND-SCHEMA-004",
      "name": "Add Campaign Tracking to Email History",
      "description": "Add campaign and template tracking fields to email_history for email analytics",
      "priority": 4,
      "status": "pending",
      "type": "schema",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File drizzle/schema/email-history.ts updated with new columns:",
        "  - campaignId: uuid nullable (for bulk sends)",
        "  - templateId: text nullable (for template tracking)",
        "  - openedAt: timestamp nullable",
        "  - clickedAt: timestamp nullable",
        "Table category: 'appendOnly' per column-patterns.json",
        "RLS policy type: 'appendOnly' per rls-policies.json#/policyTemplates/appendOnly",
        "Index added on campaignId for efficient queries",
        "Migration file created via bun run db:generate",
        "Zod schema src/lib/schemas/email-history.ts updated",
        "Unit test in tests/unit/schemas/email-history.spec.ts passes",
        "bun run typecheck passes",
        "bun run test passes"
      ],
      "files_to_modify": [
        "drizzle/schema/email-history.ts",
        "src/lib/schemas/email-history.ts"
      ],
      "files_to_create": [
        "drizzle/migrations/*.sql (generated)",
        "tests/unit/schemas/email-history.spec.ts"
      ],
      "dependencies": [
        "FOUND-SCHEMA-001"
      ],
      "completion_promise": "FOUND_SCHEMA_004_COMPLETE"
    },
    {
      "id": "FOUND-SCHEMA-005",
      "name": "Create Common Schema Patterns Module",
      "description": "Extract reusable schema patterns for domain PRDs to use consistently",
      "priority": 5,
      "status": "pending",
      "type": "foundation",
      "acceptance_criteria": [
        "File drizzle/schema/patterns.ts created with Drizzle helpers:",
        "  - timestampColumns() returns { createdAt, updatedAt }",
        "  - auditColumns() returns { createdBy, updatedBy }",
        "  - softDeleteColumn() returns { deletedAt }",
        "  - organizationColumn() returns { organizationId }",
        "  - numericCasted custom type for currency precision (12,2) - avoids floating point issues",
        "File drizzle/schema/enums.ts consolidates all pgEnum definitions",
        "File src/lib/schemas/patterns.ts created with Zod helpers:",
        "  - paginationSchema (page, pageSize, sortBy, sortOrder)",
        "  - filterSchema (search, dateFrom, dateTo)",
        "  - idParamSchema (id: z.string().uuid())",
        "At least 2 existing schemas refactored to use patterns",
        "Patterns documented in README files",
        "Unit tests for pattern helpers pass",
        "bun run typecheck passes",
        "bun run test passes"
      ],
      "files_to_create": [
        "drizzle/schema/patterns.ts",
        "drizzle/schema/enums.ts",
        "src/lib/schemas/patterns.ts",
        "tests/unit/schemas/patterns.spec.ts"
      ],
      "files_to_modify": [
        "drizzle/schema/README.md",
        "src/lib/schemas/README.md"
      ],
      "dependencies": [
        "FOUND-SCHEMA-001",
        "FOUND-SCHEMA-002"
      ],
      "estimated_iterations": 5,
      "completion_promise": "FOUND_SCHEMA_005_COMPLETE"
    },
    {
      "id": "FOUND-SCHEMA-006",
      "name": "Create Core Entity Schemas for renoz-v3",
      "description": "Define initial Drizzle schemas for customers, orders, products tables",
      "priority": 6,
      "status": "pending",
      "type": "schema",
      "acceptance_criteria": [
        "drizzle/schema/customers.ts created with full customer entity",
        "drizzle/schema/orders.ts created with order/line items",
        "drizzle/schema/products.ts created with product catalog",
        "Table category: 'business' per column-patterns.json",
        "All tables use pattern helpers from FOUND-SCHEMA-005",
        "Audit columns per column-patterns.json#/patterns/auditColumns",
        "organizationId with ON DELETE CASCADE per column-patterns.json#/patterns/tenantColumns",
        "RLS policy type: 'standard' per rls-policies.json#/policyTemplates/standard",
        "Relations defined between tables",
        "Indexes created for common queries:",
        "  - Composite indexes with organizationId first for multi-tenant queries",
        "  - GIN index on customers.name for full-text search using to_tsvector()",
        "  - GIN index on products.name and products.sku for search",
        "JSONB columns use $type<Interface>() for type safety",
        "Currency columns use numericCasted(12,2) from patterns",
        "Migration file generated and tested",
        "Zod schemas created for each entity",
        "bun run db:push succeeds (dev)",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "drizzle/schema/customers.ts",
        "drizzle/schema/orders.ts",
        "drizzle/schema/products.ts",
        "src/lib/schemas/customers.ts",
        "src/lib/schemas/orders.ts",
        "src/lib/schemas/products.ts"
      ],
      "files_to_modify": [
        "drizzle/schema/index.ts"
      ],
      "dependencies": [
        "FOUND-SCHEMA-005"
      ],
      "estimated_iterations": 2,
      "completion_promise": "FOUND_SCHEMA_006_COMPLETE"
    },
    {
      "id": "FOUND-SCHEMA-007",
      "name": "Create Pipeline and Inventory Schemas",
      "description": "Define Drizzle schemas for pipeline (quotes, stages) and inventory tables",
      "priority": 7,
      "status": "pending",
      "type": "schema",
      "acceptance_criteria": [
        "drizzle/schema/pipeline.ts created with quotes, stages, forecasts",
        "drizzle/schema/inventory.ts created with stock, locations, movements",
        "Table category: 'business' per column-patterns.json (pipeline tables)",
        "Table category: 'appendOnly' per column-patterns.json (inventory_movements)",
        "All tables use pattern helpers",
        "Audit columns per column-patterns.json#/patterns/auditColumns",
        "organizationId with ON DELETE CASCADE per column-patterns.json#/patterns/tenantColumns",
        "RLS policy type: 'standard' per rls-policies.json#/policyTemplates/standard (pipeline tables)",
        "RLS policy type: 'appendOnly' per rls-policies.json#/policyTemplates/appendOnly (inventory_movements)",
        "Relations to customers, products defined",
        "Indexes created for common queries",
        "Migration file generated and tested",
        "Zod schemas created for each entity",
        "bun run db:push succeeds (dev)",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "drizzle/schema/pipeline.ts",
        "drizzle/schema/inventory.ts",
        "src/lib/schemas/pipeline.ts",
        "src/lib/schemas/inventory.ts"
      ],
      "files_to_modify": [
        "drizzle/schema/index.ts"
      ],
      "dependencies": [
        "FOUND-SCHEMA-006"
      ],
      "estimated_iterations": 2,
      "completion_promise": "FOUND_SCHEMA_007_COMPLETE"
    },
    {
      "id": "FOUND-SCHEMA-008",
      "name": "Create Users and Organizations Schemas",
      "description": "Define Drizzle schemas for multi-tenant auth and user management",
      "priority": 8,
      "status": "pending",
      "type": "schema",
      "acceptance_criteria": [
        "drizzle/schema/organizations.ts created for multi-tenancy",
        "drizzle/schema/users.ts created with profile, preferences",
        "drizzle/schema/sessions.ts created for Supabase Auth",
        "drizzle/schema/roles.ts created for RBAC",
        "Table category: 'system' per column-patterns.json (organizations)",
        "Table category: 'userScoped' per column-patterns.json (sessions)",
        "Table category: 'business' per column-patterns.json (users, roles)",
        "Audit columns per column-patterns.json#/patterns/auditColumns",
        "RLS policy type: 'adminOnly' per rls-policies.json#/policyTemplates/adminOnly (users)",
        "RLS policy type: 'userScoped' per rls-policies.json#/policyTemplates/userScoped (sessions)",
        "Organization ID column pattern enforced on all business tables",
        "RLS helper functions defined per rls-policies.json#/helperFunctions",
        "Migration file generated and tested",
        "Zod schemas created for auth flows",
        "bun run db:push succeeds (dev)",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "drizzle/schema/organizations.ts",
        "drizzle/schema/users.ts",
        "drizzle/schema/sessions.ts",
        "drizzle/schema/roles.ts",
        "src/lib/schemas/auth.ts"
      ],
      "files_to_modify": [
        "drizzle/schema/index.ts"
      ],
      "dependencies": [
        "FOUND-SCHEMA-005"
      ],
      "estimated_iterations": 2,
      "completion_promise": "FOUND_SCHEMA_008_COMPLETE"
    },
    {
      "id": "FOUND-SCHEMA-009",
      "name": "Create Query Layer Organization",
      "description": "Setup server function organization pattern for database queries",
      "priority": 9,
      "status": "pending",
      "type": "foundation",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "Directory src/server/ created for server functions",
        "File src/server/customers.ts with getCustomers, getCustomerById, createCustomer",
        "File src/server/orders.ts with getOrders, getOrderById, createOrder",
        "File src/server/products.ts with getProducts, getProductById",
        "All server functions use createServerFn with Zod validators",
        "Prepared statements used for hot paths (getById queries)",
        "Pagination pattern implemented (cursor-based for lists)",
        "Filter pattern implemented (search, status, dateRange)",
        "Server functions documented in src/server/README.md",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "src/server/customers.ts",
        "src/server/orders.ts",
        "src/server/products.ts",
        "src/server/README.md"
      ],
      "files_to_modify": [],
      "dependencies": [
        "FOUND-SCHEMA-006",
        "FOUND-SCHEMA-000"
      ],
      "completion_promise": "FOUND_SCHEMA_009_COMPLETE",
      "blindspot_source": "backend-patterns/query-patterns.md - Query organization pattern"
    },
    {
      "id": "FOUND-SCHEMA-010",
      "name": "Cursor Pagination Pattern",
      "description": "Implement cursor-based pagination for scalable list queries. Offset pagination doesn't scale for large datasets. Based on Midday cursor pagination pattern.",
      "priority": 10,
      "status": "pending",
      "type": "foundation",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File src/lib/db/pagination.ts created with cursor pagination helpers",
        "Use createdAt + id composite cursor for deterministic ordering",
        "Cursor encoded as base64 JSON: btoa(JSON.stringify({ createdAt, id }))",
        "Zod schema for cursor params: cursor (optional string), pageSize (1-100, default 20), sortBy",
        "Query pattern: WHERE (createdAt > cursor.createdAt OR (createdAt = cursor.createdAt AND id > cursor.id))",
        "Limit set to pageSize + 1 to detect hasNextPage",
        "Response shape: { items, nextCursor, hasNextPage }",
        "Refactor getCustomers to use cursor pagination",
        "Refactor getOrders to use cursor pagination",
        "Document pattern in src/server/README.md",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "src/lib/db/pagination.ts"
      ],
      "files_to_modify": [
        "src/server/customers.ts",
        "src/server/orders.ts",
        "src/server/README.md"
      ],
      "dependencies": [
        "FOUND-SCHEMA-009"
      ],
      "completion_promise": "FOUND_SCHEMA_010_COMPLETE",
      "blindspot_source": "Midday cursor pagination pattern for scalable lists"
    },
    {
      "id": "FOUND-SCHEMA-011",
      "name": "Create Activities Audit Table",
      "description": "Central audit trail for all entity changes with polymorphic references",
      "priority": 11,
      "status": "pending",
      "type": "schema",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "drizzle/schema/activities.ts created",
        "Table category: 'appendOnly' per column-patterns.json",
        "activityAction enum matches canonical-enums.json#/enums/activityAction",
        "activityEntityType enum matches canonical-enums.json#/enums/activityEntityType",
        "Polymorphic references (entityType + entityId) for flexible audit tracking",
        "organizationId with ON DELETE CASCADE per column-patterns.json#/patterns/tenantColumns",
        "Audit columns per column-patterns.json#/patterns/auditColumns (createdBy for actor tracking)",
        "RLS policy type: 'appendOnly' per rls-policies.json#/policyTemplates/appendOnly",
        "Composite indexes: (organization_id, entity_type, entity_id), (organization_id, created_at DESC)",
        "Additional index on (organization_id, created_by) for user activity history",
        "Migration file created via bun run db:generate",
        "Zod schema src/lib/schemas/activities.ts created",
        "Unit test in tests/unit/schemas/activities.spec.ts passes",
        "bun run db:push succeeds (dev)",
        "bun run typecheck passes",
        "bun run test passes"
      ],
      "files_to_create": [
        "drizzle/schema/activities.ts",
        "src/lib/schemas/activities.ts",
        "drizzle/migrations/*.sql (generated)",
        "tests/unit/schemas/activities.spec.ts"
      ],
      "files_to_modify": [
        "drizzle/schema/index.ts",
        "drizzle/schema/enums.ts"
      ],
      "dependencies": [
        "FOUND-SCHEMA-005",
        "FOUND-SCHEMA-008"
      ],
      "completion_promise": "FOUND_SCHEMA_011_COMPLETE"
    }
  ],
  "success_criteria": [
    "README documentation exists for drizzle/schema/ and src/lib/schemas/",
    "Reusable patterns extracted and documented",
    "Core entity schemas (customers, orders, products, pipeline, inventory) created",
    "Auth schemas (users, organizations, sessions, roles) created",
    "All migrations run successfully",
    "All unit tests pass",
    "bun run typecheck passes",
    "bun run test passes"
  ],
  "out_of_scope": [
    "V1/V2 domain tables (those PRDs will add them)",
    "Major schema restructuring of existing tables",
    "(greenfield - no migration needed)"
  ],
  "security_requirements": {
    "description": "Security patterns that MUST be maintained across all schema implementations",
    "cursor_pagination": [
      "decodeCursor() MUST validate UUID format with regex before use",
      "decodeCursor() MUST validate ISO date format before parsing",
      "decodeCursor() MUST enforce max cursor length (500 chars) to prevent DoS",
      "decodeCursor() MUST return null for any invalid/tampered cursor (fail-safe)",
      "Never use raw cursor values in SQL - always validate first"
    ],
    "multi_tenant_isolation": [
      "All business tables MUST have organizationId column (not nullable)",
      "Server functions MUST filter by organizationId from session context",
      "TODOs for organizationId filtering are placeholders until auth layer is implemented",
      "RLS policies provide defense-in-depth but application-level filtering is required"
    ],
    "input_validation": [
      "All server function inputs MUST use Zod validation",
      "UUID parameters MUST use z.string().uuid() validation",
      "String inputs MUST have reasonable max length limits"
    ]
  },
  "performance_requirements": {
    "description": "Performance patterns that MUST be maintained across all schema implementations",
    "cursor_pagination_indexes": [
      "All tables supporting cursor pagination MUST have composite index: (organizationId, createdAt, id)",
      "Index naming convention: idx_{table}_org_created_id",
      "This enables efficient WHERE (org = X AND (createdAt, id) > cursor) queries"
    ],
    "jsonb_indexes": [
      "JSONB array columns (like 'tags') MUST have GIN index for containment queries",
      "Index naming convention: idx_{table}_{column}_gin",
      "Use .using('gin', table.column) in Drizzle"
    ],
    "full_text_search": [
      "Name/SKU search columns MUST have GIN index on to_tsvector()",
      "Index naming convention: idx_{table}_{column}_search"
    ],
    "general": [
      "Always include organizationId FIRST in composite indexes for multi-tenant queries",
      "Avoid offset pagination for large datasets - use cursor pagination"
    ]
  },
  "schema_patterns": {
    "description": "Schema patterns that MUST be followed consistently",
    "boolean_columns": [
      "Boolean columns MUST use boolean() type, NOT uuid() or other types",
      "Example: isPrimary: boolean('is_primary').notNull().default(false)"
    ],
    "timestamp_columns": [
      "Use timestampColumns spread for createdAt/updatedAt",
      "Append-only tables should only have createdAt (no updatedAt)"
    ],
    "soft_delete": [
      "Business tables should use softDeleteColumn spread for deletedAt",
      "Queries should include WHERE deletedAt IS NULL filter"
    ]
  },
  "pattern_references": [
    {
      "file": "_Initiation/_meta/patterns/testing-standards.md",
      "applies_to": "all stories",
      "reason": "Foundation schemas require migration tests and TypeScript type verification"
    },
    {
      "file": "_Initiation/_meta/patterns/error-recovery.md",
      "applies_to": "FOUND-SCHEMA-009, FOUND-SCHEMA-010",
      "reason": "Server functions must handle database errors gracefully with retry logic"
    },
    {
      "file": "_Initiation/_meta/patterns/performance-benchmarks.md",
      "applies_to": "FOUND-SCHEMA-009, FOUND-SCHEMA-010, all schema stories with indexes",
      "reason": "Query performance targets drive index design decisions"
    }
  ],
  "domain_completion_promise": "FOUND_SCHEMA_COMPLETE"
}
