{
  "id": "CC-NOTIFY",
  "name": "Notifications",
  "description": "Notification system for the Renoz application. Implements toast notifications for immediate feedback, in-app alerts for important messages, and user notification preferences.",
  "created": "2026-01-09",
  "priority": 1,
  "phase": "cross-cutting",
  "dependencies": {
    "phase": "Cross-cutting",
    "executionOrder": 4,
    "schemaRequired": [
      {
        "table": "notifications",
        "status": "EXISTS",
        "reason": "Core notification storage and retrieval"
      },
      {
        "table": "user-preferences",
        "status": "EXISTS",
        "reason": "Notification preferences per user"
      }
    ],
    "schemaCreates": [],
    "serverFunctionsRequired": [
      {
        "function": "createNotification",
        "reason": "Create new notifications"
      },
      {
        "function": "markNotificationRead",
        "reason": "Mark notifications as read"
      },
      {
        "function": "getUserNotificationPreferences",
        "reason": "Read user notification settings"
      }
    ],
    "serverFunctionsCreates": [
      {
        "function": "ConfirmationToast",
        "story": "CC-NOTIFY-007"
      },
      {
        "function": "useUndoableAction",
        "story": "CC-NOTIFY-007"
      },
      {
        "function": "trackJobProgress",
        "story": "CC-NOTIFY-008a"
      },
      {
        "function": "getJobStatus",
        "story": "CC-NOTIFY-008a"
      },
      {
        "function": "JobProgressNotification",
        "story": "CC-NOTIFY-008b"
      }
    ],
    "prdDependencies": [
      {
        "prdId": "CC-A11Y",
        "status": "REQUIRED",
        "reason": "Notifications require accessible aria-live announcements and focus management"
      },
      {
        "prdId": "CC-LOADING",
        "status": "RECOMMENDED",
        "reason": "Job progress notifications use loading/progress patterns"
      }
    ],
    "enables": [
      {
        "prdId": "all",
        "reason": "All domain PRDs use notifications for action feedback, success/error messages, and background job updates"
      }
    ]
  },
  "references": {
    "internal": [
      "memory-bank/_meta/assumptions.md#stack",
      "memory-bank/_meta/conventions.md#color-usage"
    ],
    "external": [
      "https://ui.shadcn.com/docs/components/toast",
      "https://www.radix-ui.com/primitives/docs/components/toast"
    ]
  },
  "current_state": {
    "implemented": [
      "Toast notification system using Sonner at src/components/ui/sonner.tsx",
      "Toast variants: success, error, warning, info with themed styling",
      "NotificationBell component in header with unread badge",
      "NotificationCenter with inbox/archive, mark as read, navigation",
      "Full notifications page with filtering, search, date grouping",
      "NotificationType enum matches canonical-enums.json#/enums/notificationType: [quote, order, issue, warranty, shipment, payment, customer, product, inventory, user, system]",
      "NotificationStatus enum matches canonical-enums.json#/enums/notificationStatus: [pending, sent, read, dismissed, failed]",
      "Notification handlers for major business events",
      "Real-time notifications via Supabase Realtime",
      "NotificationPreferences with per-category toggles, digest settings",
      "RLS policy type: 'standard' per rls-policies.json",
      "Audit columns per column-patterns.json#/patterns/auditColumns"
    ],
    "gaps": [
      "No confirmation toast with undo capability for destructive actions",
      "No job progress notifications for long-running Trigger.dev tasks"
    ]
  },
  "stories": [
    {
      "id": "CC-NOTIFY-007",
      "name": "Action Confirmation Notifications",
      "description": "Create specialized notifications for important actions with confirmation or undo capability. Use for deletions and bulk operations.",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "ConfirmationToast shows for destructive actions with undo option",
        "Undo window is 5 seconds with countdown indicator",
        "Toast shows affected item count for bulk operations",
        "Successful undo triggers success toast confirmation",
        "Toast remains visible during undo window (doesn't auto-dismiss)",
        "Keyboard accessible - Enter to confirm, Escape to undo",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "CC_NOTIFY_007_COMPLETE",
      "layer": "ui",
      "ui_spec": {
        "reusable": true,
        "component_type": "ConfirmationToast",
        "component_structure": {
          "container": {
            "element": "Sonner toast with custom content",
            "layout": "Flex row with gap-3, items-center",
            "position": "bottom-right (default) or configurable"
          },
          "icon": {
            "element": "Status icon (Trash2 for delete, etc.)",
            "size": "20px"
          },
          "content": {
            "message": "Action description text",
            "countdown": "Visual countdown indicator"
          },
          "actions": {
            "undo_button": "Primary action button",
            "dismiss_button": "Optional close X"
          },
          "countdown_indicator": {
            "type": "Progress bar shrinking from full to empty",
            "position": "Bottom edge of toast"
          }
        },
        "animations": {
          "enter": "slide-in-right 200ms ease-out with slight bounce",
          "countdown_bar": "linear shrink from 100% to 0% over duration",
          "exit": "slide-out-right 150ms ease-in",
          "undo_success": "brief green flash before exit",
          "reduced_motion": {
            "enter": "fade-in only",
            "countdown_bar": "opacity change instead of width",
            "exit": "fade-out only"
          }
        },
        "theme_compatibility": {
          "destructive_action": {
            "light": {
              "bg": "bg-card",
              "border": "border-destructive/30",
              "icon": "text-destructive",
              "countdown_bar": "bg-destructive"
            },
            "dark": {
              "bg": "bg-card",
              "border": "border-destructive/40",
              "icon": "text-destructive",
              "countdown_bar": "bg-destructive"
            }
          },
          "warning_action": {
            "light": {
              "bg": "bg-card",
              "border": "border-warning/30",
              "icon": "text-warning",
              "countdown_bar": "bg-warning"
            },
            "dark": {
              "bg": "bg-card",
              "border": "border-warning/40",
              "icon": "text-warning",
              "countdown_bar": "bg-warning"
            }
          }
        },
        "accessibility": {
          "role": "alertdialog",
          "aria_live": "assertive",
          "aria_atomic": true,
          "aria_labelledby": "toast-title",
          "aria_describedby": "toast-description",
          "announcements": {
            "on_show": "{n} items will be deleted. Press Escape or click Undo within 5 seconds to cancel.",
            "countdown_warning": "3 seconds remaining to undo.",
            "action_completed": "Action completed. Items deleted.",
            "action_undone": "Action undone. Items restored."
          },
          "focus_management": {
            "on_show": "Move focus to undo button",
            "on_dismiss": "Return focus to trigger element or page",
            "trap_focus": false
          },
          "keyboard": {
            "escape": "Trigger undo action",
            "enter": "Confirm action (when focused on confirm button)",
            "tab": "Navigate between undo and dismiss"
          }
        },
        "touch_targets": {
          "undo_button": "min-h-11 min-w-20 (44px height, adequate width)",
          "dismiss_button": "min-w-11 min-h-11"
        },
        "responsive": {
          "mobile": {
            "position": "bottom-center, full-width with margin",
            "layout": "Stack content vertically if needed"
          },
          "tablet_up": {
            "position": "bottom-right",
            "layout": "Horizontal inline"
          }
        },
        "timing": {
          "default_duration": "5000ms",
          "countdown_start": "immediate on show",
          "hover_pause": "Pause countdown on hover",
          "focus_pause": "Pause countdown when focused"
        }
      }
    },
    {
      "id": "CC-NOTIFY-008a",
      "name": "Job Status Tracking API",
      "description": "Create server-side infrastructure to track job progress and completion status from Trigger.dev tasks.",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Job status enum includes: pending, running, completed, failed",
        "Job progress percentage stored and queryable",
        "Job completion triggers notification creation",
        "API endpoint to query job status by ID",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "CC_NOTIFY_008a_COMPLETE",
      "layer": "server"
    },
    {
      "id": "CC-NOTIFY-008b",
      "name": "Job Progress Notification Component",
      "description": "Create UI component to display progress for long-running background jobs.",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "JobProgressNotification component shows for active jobs",
        "Progress bar or percentage indicator updates in real-time",
        "Notification persists until job completes",
        "Completion shows success/error toast based on outcome",
        "Failed jobs show retry action button",
        "Clicking shows job details or navigates to result",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "CC-NOTIFY-008a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "CC_NOTIFY_008b_COMPLETE",
      "layer": "ui",
      "ui_spec": {
        "reusable": true,
        "component_type": "JobProgressNotification",
        "component_structure": {
          "container": {
            "element": "Persistent notification card or toast",
            "layout": "Flex column with gap-2",
            "position": "Notification center or fixed corner widget"
          },
          "header": {
            "job_icon": "Icon representing job type (Import, Export, etc.)",
            "job_title": "Job name/description",
            "close_button": "X button (cancels job or hides notification)"
          },
          "progress_section": {
            "progress_bar": "Full-width progress bar",
            "percentage_text": "e.g., '67%' or 'Processing 67 of 100'",
            "status_text": "Current step description"
          },
          "actions": {
            "view_details": "Link to job details page",
            "cancel_button": "Cancel job (if cancellable)",
            "retry_button": "Retry (shown on failure)"
          },
          "completion_state": {
            "success": "Check icon, success message, view results link",
            "error": "X icon, error message, retry button"
          }
        },
        "animations": {
          "enter": "slide-in-up 200ms ease-out",
          "progress_bar": "smooth width transition 300ms ease-out",
          "pulse_active": "subtle pulse on progress bar while running",
          "complete_success": {
            "checkmark": "scale-in with bounce 300ms",
            "bar_fill": "fill to 100% then flash green"
          },
          "complete_error": {
            "shake": "horizontal shake 300ms",
            "bar": "fill red"
          },
          "exit": "slide-out-down 150ms ease-in",
          "reduced_motion": {
            "enter": "fade-in only",
            "progress_bar": "instant width change",
            "complete": "no bounce or shake, color change only",
            "exit": "fade-out only"
          }
        },
        "theme_compatibility": {
          "running": {
            "light": {
              "bg": "bg-card",
              "progress_bar_track": "bg-muted",
              "progress_bar_fill": "bg-primary"
            },
            "dark": {
              "bg": "bg-card",
              "progress_bar_track": "bg-muted",
              "progress_bar_fill": "bg-primary"
            }
          },
          "success": {
            "light": {
              "icon": "text-success",
              "progress_bar_fill": "bg-success"
            },
            "dark": {
              "icon": "text-success",
              "progress_bar_fill": "bg-success"
            }
          },
          "error": {
            "light": {
              "icon": "text-destructive",
              "progress_bar_fill": "bg-destructive"
            },
            "dark": {
              "icon": "text-destructive",
              "progress_bar_fill": "bg-destructive"
            }
          }
        },
        "accessibility": {
          "role": "status",
          "aria_live": "polite",
          "progress_bar": {
            "role": "progressbar",
            "aria_valuenow": "current percentage",
            "aria_valuemin": "0",
            "aria_valuemax": "100",
            "aria_label": "{job name} progress"
          },
          "announcements": {
            "job_started": "{Job name} started. Progress will be shown here.",
            "progress_update": "{Job name} {percentage}% complete. {current step}.",
            "job_complete": "{Job name} completed successfully.",
            "job_failed": "{Job name} failed. {error message}. Retry available."
          },
          "focus_management": {
            "on_show": "Do not steal focus",
            "on_complete": "Announce completion, optionally focus notification",
            "on_error": "Announce error, focus retry button if critical"
          },
          "keyboard": {
            "enter": "Activate focused button",
            "escape": "Dismiss notification (if dismissible)"
          }
        },
        "touch_targets": {
          "close_button": "min-w-12 min-h-12",
          "view_details": "min-h-11",
          "cancel_button": "min-h-11",
          "retry_button": "min-h-11"
        },
        "responsive": {
          "mobile": {
            "position": "Bottom of screen, above navigation",
            "layout": "Full-width card"
          },
          "tablet_up": {
            "position": "Fixed bottom-right or in notification center",
            "layout": "Card with max-width 320px"
          }
        },
        "real_time": {
          "update_source": "Supabase Realtime subscription on job_progress table",
          "polling_fallback": "Poll every 2s if Realtime unavailable",
          "debounce": "Debounce UI updates to max 500ms intervals"
        }
      }
    }
  ],
  "success_criteria": [
    "Users receive immediate feedback for all actions via toasts",
    "Important notifications persist and are accessible in notification center",
    "Users can customize notification preferences by category",
    "Background job progress is visible without blocking the UI",
    "Undo capability prevents accidental destructive actions"
  ],
  "out_of_scope": [
    "Push notifications to mobile devices",
    "Email notification delivery",
    "SMS notification delivery",
    "Notification analytics and engagement tracking"
  ],
  "pattern_references": [
    {
      "file": "_Initiation/_meta/patterns/testing-standards.md",
      "applies_to": "all stories",
      "reason": "Notification components need render tests and accessibility verification"
    },
    {
      "file": "_Initiation/_meta/patterns/error-recovery.md",
      "applies_to": "CC-NOTIFY-008a, CC-NOTIFY-008b",
      "reason": "Job progress tracking must handle failures gracefully - apply Pattern 1 (retry with dead letter)"
    },
    {
      "file": "_Initiation/_meta/patterns/performance-benchmarks.md",
      "applies_to": "all UI stories",
      "reason": "Notification UI must not block main thread - toast render within response time targets"
    }
  ],
  "domain_completion_promise": "CC_NOTIFY_COMPLETE"
}
