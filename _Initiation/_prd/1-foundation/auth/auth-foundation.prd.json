{
  "id": "FOUND-AUTH",
  "name": "Auth Foundation Enhancement",
  "description": "Implement authentication and authorization for renoz-v3 using Supabase Auth with role-based access control. Includes permission matrix, session management, and API token support.",
  "created": "2026-01-09",
  "updated": "2026-01-10",
  "priority": 2,
  "phase": "foundation",
  "version": "MVP",
  "stack": {
    "auth": "Supabase Auth",
    "database": "Supabase PostgreSQL + Drizzle ORM",
    "session": "Supabase JWT sessions",
    "runtime": "Bun"
  },
  "references": {
    "internal": [
      "_Initiation/_prd/_meta/conventions.md - Auth patterns",
      "_Initiation/_ralph/backend-patterns/server-functions.md - Server function auth patterns",
      "_Initiation/_ralph/backend-patterns/webhooks-patterns.md - Webhook auth verification",
      "drizzle/schema/users.ts - User table with role",
      "src/lib/auth/ - Auth utilities"
    ],
    "external": [
      "https://supabase.com/docs/guides/auth - Supabase Auth docs",
      "https://supabase.com/docs/guides/auth/server-side-rendering - SSR auth",
      "https://orm.drizzle.team/docs/rls - Drizzle RLS policies",
      "https://supabase.com/docs/guides/database/postgres/row-level-security - Supabase RLS"
    ]
  },
  "current_state": {
    "implemented": [],
    "gaps": [
      "No auth system - greenfield implementation",
      "Need Supabase client setup",
      "Need permission matrix for RBAC",
      "Need server-side auth validation",
      "Need protected route patterns",
      "Need API token support for integrations"
    ]
  },
  "stories": [
    {
      "id": "FOUND-AUTH-001",
      "name": "Setup Supabase Auth Client",
      "description": "Initialize Supabase client with auth configuration for browser and server",
      "priority": 1,
      "status": "pending",
      "type": "foundation",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "Supabase JS client installed (@supabase/supabase-js)",
        "File src/lib/supabase/client.ts - browser client",
        "File src/lib/supabase/server.ts - server client for server functions",
        "Environment variables: SUPABASE_URL, SUPABASE_ANON_KEY",
        "Server client uses service role key for admin operations",
        "Auth state synced with TanStack Query",
        "bun run typecheck passes",
        "bun run test passes"
      ],
      "files_to_create": [
        "src/lib/supabase/client.ts",
        "src/lib/supabase/server.ts",
        "src/lib/supabase/index.ts"
      ],
      "files_to_modify": [
        ".env.example"
      ],
      "dependencies": [],
      "completion_promise": "FOUND_AUTH_001_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-002",
      "name": "Create Users Table with Roles",
      "description": "Extend Supabase auth.users with application user data and roles",
      "priority": 2,
      "status": "pending",
      "type": "schema",
      "estimated_iterations": 2,
      "acceptance_criteria": [
        "File drizzle/schema/users.ts created",
        "users table with: id (links to auth.users), role, organizationId, name, email, createdAt, updatedAt",
        "Role enum matches canonical-enums.json#/enums/userRole: 'owner', 'admin', 'manager', 'sales', 'operations', 'support', 'viewer'",
        "users table includes status column using userStatus enum: 'active', 'invited', 'suspended', 'deactivated'",
        "users table includes userType column: 'staff', 'installer' (nullable for MVP)",
        "RLS policies: users can only see/edit within their organization",
        "Trigger: auto-create user row on auth.users insert",
        "Migration file created via bun run db:generate",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "drizzle/schema/users.ts"
      ],
      "files_to_modify": [
        "drizzle/schema/index.ts"
      ],
      "dependencies": [
        "FOUND-AUTH-001"
      ],
      "completion_promise": "FOUND_AUTH_002_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-003",
      "name": "Create Centralized Permission Matrix",
      "description": "Define all role to action mappings in single source of truth",
      "priority": 3,
      "status": "pending",
      "type": "foundation",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File src/lib/auth/permissions.ts created",
        "Defines: PERMISSIONS constant with all actions organized by domain",
        "Actions format: 'customer.create', 'customer.update', 'order.fulfill', etc.",
        "Defines: ROLE_PERMISSIONS mapping roles to allowed actions array",
        "Defines: hasPermission(role: Role, action: string): boolean helper",
        "Defines: getPermittedActions(role: Role): string[] helper",
        "Types exported: Permission, RolePermissions, PermissionAction",
        "At least 20 permissions defined covering core domains",
        "Unit test in tests/unit/auth/permissions.spec.ts passes",
        "bun run typecheck passes",
        "bun run test passes"
      ],
      "files_to_create": [
        "src/lib/auth/permissions.ts",
        "tests/unit/auth/permissions.spec.ts"
      ],
      "files_to_modify": [
        "src/lib/auth/index.ts"
      ],
      "dependencies": [
        "FOUND-AUTH-002"
      ],
      "completion_promise": "FOUND_AUTH_003_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-004",
      "name": "Create Login/Logout Routes",
      "description": "Implement email/password authentication flow with Supabase",
      "priority": 4,
      "status": "pending",
      "type": "route",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "Route src/routes/login.tsx created with login form",
        "Route src/routes/logout.tsx handles session destruction",
        "Uses supabase.auth.signInWithPassword for login",
        "Uses supabase.auth.signUp for registration",
        "Uses supabase.auth.signOut for logout",
        "Redirect to dashboard after login",
        "Displays inline error message for invalid email/password; shows 'Account locked' after 5 failed attempts",
        "Zod schema src/lib/schemas/auth.ts for validation",
        "bun run typecheck passes",
        "bun run test passes"
      ],
      "files_to_create": [
        "src/routes/login.tsx",
        "src/routes/logout.tsx",
        "src/lib/schemas/auth.ts"
      ],
      "files_to_modify": [],
      "dependencies": [
        "FOUND-AUTH-001"
      ],
      "completion_promise": "FOUND_AUTH_004_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-005",
      "name": "Create Protected Server Function Pattern",
      "description": "Add permission-aware server function wrapper with Supabase auth validation",
      "priority": 5,
      "status": "pending",
      "type": "foundation",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File src/lib/server/protected.ts created",
        "createProtectedFn wraps createServerFn with Supabase auth check",
        "Validates JWT from request headers/cookies",
        "Fetches user role from users table",
        "Option: requiredPermission: 'customer.create' checks role via hasPermission",
        "Throws AuthError on unauthenticated access",
        "Throws PermissionDeniedError on unauthorized access",
        "Session user/role/organizationId available in function context",
        "At least 3 server functions use createProtectedFn pattern",
        "Pattern documented in README",
        "Unit test passes",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "src/lib/server/protected.ts",
        "src/lib/server/errors.ts",
        "tests/unit/auth/protected.spec.ts"
      ],
      "files_to_modify": [
        "_Initiation/_prd/_meta/conventions.md"
      ],
      "dependencies": [
        "FOUND-AUTH-003"
      ],
      "completion_promise": "FOUND_AUTH_005_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-006",
      "name": "Create Role-Based UI Guard Component",
      "description": "Generic RBAC wrapper for UI components using permission matrix",
      "priority": 6,
      "status": "pending",
      "type": "ui-component",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File src/components/shared/permission-guard.tsx created",
        "Props: permission (string), fallback (optional ReactNode), children",
        "Uses hasPermission from permissions.ts to check current user role",
        "Renders children if permitted, fallback (or null) otherwise",
        "Hook: useHasPermission(permission: string): boolean exported",
        "Hook: useCurrentUser() returns authenticated user from Supabase",
        "Replaces role checks in at least 3 places",
        "bun run typecheck passes",
        "bun run test passes"
      ],
      "files_to_create": [
        "src/components/shared/permission-guard.tsx",
        "src/hooks/use-has-permission.ts",
        "src/hooks/use-current-user.ts"
      ],
      "files_to_modify": [],
      "dependencies": [
        "FOUND-AUTH-003"
      ],
      "completion_promise": "FOUND_AUTH_006_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-007a",
      "name": "API Token: Schema",
      "description": "Create database schema for API tokens",
      "priority": 7,
      "status": "pending",
      "type": "schema",
      "estimated_iterations": 2,
      "acceptance_criteria": [
        "File drizzle/schema/api-tokens.ts created with apiTokens table:",
        "  - id uuid primary key",
        "  - name text (user-provided token name)",
        "  - hashedToken text (hashed token)",
        "  - userId uuid FK to users",
        "  - organizationId uuid FK to organizations",
        "  - scopes jsonb (array of permitted scopes)",
        "  - expiresAt timestamp nullable",
        "  - lastUsedAt timestamp nullable",
        "  - createdAt timestamp",
        "  - revokedAt timestamp nullable",
        "Indexes on hashedToken, userId, organizationId",
        "RLS policies created",
        "Migration file created via bun run db:generate",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "drizzle/schema/api-tokens.ts"
      ],
      "files_to_modify": [
        "drizzle/schema/index.ts"
      ],
      "dependencies": [
        "FOUND-AUTH-002"
      ],
      "completion_promise": "FOUND_AUTH_007A_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-007b",
      "name": "API Token: Server Functions",
      "description": "Create server functions for API token management",
      "priority": 7,
      "status": "pending",
      "type": "server-function",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File src/lib/server/api-tokens.ts created",
        "createApiToken: creates token, returns plain token ONCE (format: renoz_<base64>)",
        "validateApiToken: validates token, returns user/org context if valid",
        "revokeApiToken: sets revokedAt, removes from active tokens",
        "listApiTokens: lists all tokens for current user (masked)",
        "Scopes enum matches canonical-enums.json#/enums/apiTokenScope: 'read', 'write', 'admin'",
        "Zod schema src/lib/schemas/api-tokens.ts for validation",
        "API token auth integrates with protected.ts middleware",
        "Unit tests pass",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "src/lib/server/api-tokens.ts",
        "src/lib/schemas/api-tokens.ts",
        "tests/unit/auth/api-tokens.spec.ts"
      ],
      "files_to_modify": [
        "src/lib/server/protected.ts"
      ],
      "dependencies": [
        "FOUND-AUTH-007a",
        "FOUND-AUTH-005"
      ],
      "completion_promise": "FOUND_AUTH_007B_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-007c",
      "name": "API Token: Settings UI",
      "description": "Create settings UI for API token management",
      "priority": 7,
      "status": "pending",
      "type": "ui-component",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File src/routes/_authenticated/settings/api-tokens.tsx created",
        "Shows list of user's API tokens (name, created, last used, scopes, revoked status)",
        "Create token dialog: name, scopes selection, optional expiry",
        "Shows generated token ONCE with copy button and warning",
        "Revoke token action with confirmation",
        "Route added to settings navigation",
        "Only visible to admin/sales roles via PermissionGuard",
        "bun run typecheck passes",
        "bun run test passes"
      ],
      "files_to_create": [
        "src/routes/_authenticated/settings/api-tokens.tsx",
        "src/components/settings/api-token-card.tsx",
        "src/components/settings/create-api-token-dialog.tsx"
      ],
      "files_to_modify": [
        "src/routes/_authenticated/settings/index.tsx"
      ],
      "dependencies": [
        "FOUND-AUTH-007b",
        "FOUND-AUTH-006"
      ],
      "completion_promise": "FOUND_AUTH_007C_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-008",
      "name": "Add Auth Integration Tests",
      "description": "Test organization isolation and permission enforcement",
      "priority": 8,
      "status": "pending",
      "type": "test",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "Directory tests/integration/auth/ created",
        "Test: user in org A cannot access org B data via server function",
        "Test: viewer role cannot perform mutation server functions",
        "Test: warehouse role cannot access financial data",
        "Test: admin role has full access to org data",
        "Test: API token with 'read' scope cannot perform writes",
        "Test: expired API token is rejected",
        "Test: unauthenticated requests are rejected",
        "All tests pass with bun run test"
      ],
      "files_to_create": [
        "tests/integration/auth/permission.spec.ts",
        "tests/integration/auth/org-isolation.spec.ts",
        "tests/integration/auth/api-token.spec.ts"
      ],
      "files_to_modify": [],
      "dependencies": [
        "FOUND-AUTH-005",
        "FOUND-AUTH-007b"
      ],
      "completion_promise": "FOUND_AUTH_008_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-009",
      "name": "Create Auth README Documentation",
      "description": "Document auth architecture and patterns",
      "priority": 9,
      "status": "pending",
      "type": "documentation",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File src/lib/auth/README.md created",
        "Documents: Supabase Auth setup and configuration",
        "Documents: Role definitions and permission matrix",
        "Documents: Protected server function pattern",
        "Documents: Permission guard component usage",
        "Documents: API token format and scopes",
        "Documents: RLS policy patterns",
        "Includes code examples for common patterns",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "src/lib/auth/README.md"
      ],
      "files_to_modify": [],
      "dependencies": [
        "FOUND-AUTH-005"
      ],
      "completion_promise": "FOUND_AUTH_009_COMPLETE"
    },
    {
      "id": "FOUND-AUTH-010",
      "name": "Redis Rate Limiting with Tiered Limits",
      "description": "Protect auth endpoints and API tokens from abuse with Redis-based rate limiting. Uses hono-rate-limiter pattern from Midday (60 calls/min base).",
      "priority": 10,
      "status": "pending",
      "type": "foundation",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File src/lib/server/middleware/rate-limit.ts created",
        "REDIS_URL environment variable configured",
        "Uses hono-rate-limiter package with Redis store",
        "Tiered rate limits by endpoint type:",
        "  - login: 10/min (brute force protection, key: IP)",
        "  - mutations: 100/min (write operations, key: userId)",
        "  - reads: 1000/min (read operations, key: userId)",
        "withRateLimit middleware using sliding window algorithm",
        "Falls back to in-memory store in development (no Redis required)",
        "429 Too Many Requests response with Retry-After header",
        "Rate limit headers: X-RateLimit-Limit, X-RateLimit-Remaining, X-RateLimit-Reset",
        "Proactive throttling: delay requests when approaching 90% of limit",
        "Login endpoint protected against brute force",
        "API token endpoint protected against enumeration",
        "Unit tests pass",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "src/lib/server/middleware/rate-limit.ts",
        "tests/unit/auth/rate-limit.spec.ts"
      ],
      "files_to_modify": [
        "src/lib/server/protected.ts",
        ".env.example"
      ],
      "env_vars": [
        "REDIS_URL"
      ],
      "dependencies": [
        "FOUND-AUTH-005"
      ],
      "completion_promise": "FOUND_AUTH_010_COMPLETE",
      "blindspot_source": "Midday hono-rate-limiter with Redis pattern",
      "reference": "_reference/.midday-reference/apps/api/src/middleware/rate-limit.ts"
    },
    {
      "id": "FOUND-AUTH-011",
      "name": "Add Middleware Composition Pattern",
      "description": "Create composable middleware for auth, logging, and rate limiting",
      "priority": 11,
      "status": "pending",
      "type": "foundation",
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "File src/lib/server/middleware/index.ts exports all middleware",
        "withAuth middleware validates Supabase JWT",
        "withRole middleware checks user role",
        "withOrg middleware validates organization membership",
        "withLogging middleware logs request/response",
        "Middleware composable: withAuth(withRole('admin', handler))",
        "Type-safe context passed between middleware",
        "Example server function using composed middleware",
        "Unit tests pass",
        "bun run typecheck passes"
      ],
      "files_to_create": [
        "src/lib/server/middleware/index.ts",
        "src/lib/server/middleware/auth.ts",
        "src/lib/server/middleware/role.ts",
        "src/lib/server/middleware/logging.ts"
      ],
      "files_to_modify": [],
      "dependencies": [
        "FOUND-AUTH-005"
      ],
      "completion_promise": "FOUND_AUTH_011_COMPLETE",
      "blindspot_source": "backend-patterns/server-functions.md - Middleware composition"
    }
  ],
  "success_criteria": [
    "Supabase Auth configured with email/password",
    "7 roles defined matching canonical-enums.json: owner, admin, manager, sales, operations, support, viewer",
    "Centralized permission matrix defines all role capabilities",
    "Server functions use createProtectedFn consistently",
    "RLS policies enforce organization isolation",
    "Permission guard component simplifies UI RBAC",
    "API tokens enable third-party integrations",
    "Auth integration tests pass",
    "README documents architecture",
    "bun run typecheck passes",
    "bun run test passes"
  ],
  "out_of_scope": [
    "OAuth/SAML providers (can add via Supabase later)",
    "Multi-factor authentication (can enable in Supabase later)",
    "Fine-grained field-level permissions",
    "Customer portal authentication",
    "Password reset flow (Supabase handles)",
    "Email verification (Supabase handles)"
  ],
  "pattern_references": [
    {
      "file": "_Initiation/_meta/patterns/testing-standards.md",
      "applies_to": "all stories",
      "reason": "Foundation code requires comprehensive testing - auth is critical path"
    },
    {
      "file": "_Initiation/_meta/patterns/error-recovery.md",
      "applies_to": "server layer stories (FOUND-AUTH-005, FOUND-AUTH-007b, FOUND-AUTH-010)",
      "reason": "Auth services must implement retry patterns for rate limiting and token validation failures"
    },
    {
      "file": "_Initiation/_meta/patterns/performance-benchmarks.md",
      "applies_to": "FOUND-AUTH-005, FOUND-AUTH-010",
      "reason": "Auth operations are on critical path - must meet response time targets"
    }
  ],
  "domain_completion_promise": "FOUND_AUTH_COMPLETE"
}
