{
  "prd_id": "DOM-PRODUCTS",
  "audit_date": "2026-01-09",
  "auditor": "Claude Opus 4.5",
  "summary": {
    "total_stories": 8,
    "verified_gaps": 6,
    "invalidated_gaps": 1,
    "needs_atomization": 5,
    "implementation_status": "MVP implemented - CRUD, categories, basic pricing, filtering, bulk import exist. Advanced features (price tiers, bundles, images, attributes, related products) are genuine gaps."
  },
  "codebase_findings": {
    "schema_files": [
      "renoz-v2/lib/schema/products.ts - products, categories, inventoryItems, inventoryMovements tables"
    ],
    "validation_schemas": [
      "renoz-v2/lib/schemas/products.ts - CreateProductSchema, UpdateProductSchema, ListProductsSchema, BulkImportProductsSchema"
    ],
    "server_functions": [
      "renoz-v2/src/server/functions/products.ts - getProductListMetrics, listProducts, getProduct, createProduct, createProductWithInventory, updateProduct, deleteProduct, checkSkuAvailability, getProductUsage, previewBulkImport, bulkImportProducts"
    ],
    "components": [
      "renoz-v2/src/components/domain/products/product-columns.tsx",
      "renoz-v2/src/components/domain/products/product-form.tsx",
      "renoz-v2/src/components/domain/products/bulk-import-dialog.tsx",
      "renoz-v2/src/components/domain/products/stock-adjustment-dialog.tsx",
      "renoz-v2/src/components/domain/products/movement-history.tsx",
      "renoz-v2/src/components/domain/products/xero-sync-status.tsx",
      "renoz-v2/src/components/domain/products/category-dialog.tsx"
    ],
    "routes": [
      "renoz-v2/src/routes/catalog/index.tsx - Product list with search, filters, metrics",
      "renoz-v2/src/routes/catalog/$productId.tsx - Product detail with tabs (Overview, Inventory, History)"
    ],
    "existing_schema_columns": {
      "products": ["id", "organizationId", "sku", "name", "description", "categoryId", "basePrice", "costPrice", "reorderPoint", "isSerialized", "isActive", "taxType", "xeroItemId", "createdByUserId", "updatedByUserId", "createdAt", "updatedAt", "deletedAt", "version"],
      "categories": ["id", "organizationId", "name", "parentId", "sortOrder", "createdAt", "updatedAt"],
      "inventoryItems": ["id", "organizationId", "productId", "serialNumber", "batchId", "quantity", "status", "costPrice", "receivedAt", "receivedFromPoId", "allocatedToOrderId", "allocatedToOrderItemId", "soldAt", "binLocation", "createdAt", "updatedAt", "version"],
      "inventoryMovements": ["id", "organizationId", "inventoryItemId", "productId", "type", "quantity", "orderId", "purchaseOrderId", "adjustmentReason", "createdByUserId", "createdAt"]
    },
    "missing_tables": [
      "product_price_tiers - for volume-based pricing",
      "customer_product_prices - for customer-specific pricing",
      "product_bundle_items - for product bundles/kits",
      "product_images - for multiple product images",
      "product_attributes - for attribute definitions",
      "product_attribute_values - for product attribute values",
      "product_relations - for related/complementary products"
    ],
    "missing_columns": [
      "products.imageUrl - for primary image",
      "products.isBundle - for bundle flag",
      "products.status - for discontinued status (currently uses isActive boolean)"
    ]
  },
  "prd_claims_verified": [
    "Product CRUD with SKU - VERIFIED (createProduct, updateProduct, deleteProduct)",
    "Category hierarchy - VERIFIED (categories table with parentId)",
    "Basic pricing (base price, cost) - VERIFIED (basePrice, costPrice columns)",
    "Serialized vs non-serialized flag - VERIFIED (isSerialized column)",
    "Product list with filters - VERIFIED (listProducts with search, categoryId, stockStatus, isActive, isSerialized)",
    "Product detail view - VERIFIED (/catalog/$productId with tabs)"
  ],
  "prd_claims_invalid": [
    "DOM-PROD-005: Product Import - ALREADY EXISTS. previewBulkImport and bulkImportProducts server functions implemented with full CSV parsing, field mapping, validation, and duplicate detection. BulkImportDialog component provides complete UI."
  ],
  "actual_features_not_in_prd": [
    "Xero integration (xeroItemId, sync triggers)",
    "Stock adjustment dialog",
    "Movement history tracking",
    "Product metrics with sparklines",
    "CSV export functionality",
    "Floating action button for quick add",
    "SKU duplicate detection with suggestions",
    "Product usage stats before delete",
    "Optimistic updates on delete with undo"
  ],
  "stories_status": {
    "DOM-PROD-001": {
      "name": "Add Price Tiers",
      "status": "valid",
      "change": "atomize",
      "reason": "Story spans schema + server + UI layers. Should be split into 3 stories for Ralph execution.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": {
        "original": 4,
        "recommended_total": 12,
        "breakdown": {
          "schema": 3,
          "server": 4,
          "ui": 5
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "missing_files": ["lib/schema/product-pricing.ts", "lib/schemas/product-pricing.ts", "src/server/functions/product-pricing.ts", "src/components/domain/products/price-tier-editor.tsx"]
      }
    },
    "DOM-PROD-002": {
      "name": "Add Product Bundles",
      "status": "valid",
      "change": "atomize",
      "reason": "Complex story spanning schema + server + UI + inventory logic. Inventory deduction adds complexity.",
      "layers": ["schema", "server", "UI", "inventory-integration"],
      "estimated_iterations": {
        "original": 5,
        "recommended_total": 16,
        "breakdown": {
          "schema": 3,
          "server": 5,
          "ui": 5,
          "inventory_integration": 3
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "missing_files": ["lib/schema/product-bundles.ts", "src/server/functions/product-bundles.ts", "src/components/domain/products/bundle-editor.tsx"]
      }
    },
    "DOM-PROD-003": {
      "name": "Add Product Images",
      "status": "valid",
      "change": "atomize",
      "reason": "Requires schema + Supabase storage integration + UI gallery. Storage integration adds external dependency complexity.",
      "layers": ["schema", "server", "storage", "UI"],
      "estimated_iterations": {
        "original": 4,
        "recommended_total": 14,
        "breakdown": {
          "schema": 2,
          "storage_integration": 4,
          "server": 3,
          "ui": 5
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "missing_files": ["lib/schema/product-images.ts", "src/server/functions/product-images.ts", "src/components/domain/products/image-gallery.tsx", "src/components/domain/products/image-uploader.tsx"]
      }
    },
    "DOM-PROD-004": {
      "name": "Add Product Attributes",
      "status": "valid",
      "change": "atomize",
      "reason": "Complex feature with two tables, multiple attribute types, category templates, and filtering. Highest complexity story.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": {
        "original": 5,
        "recommended_total": 18,
        "breakdown": {
          "schema": 4,
          "server": 6,
          "ui": 8
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "missing_files": ["lib/schema/product-attributes.ts", "src/server/functions/product-attributes.ts", "src/components/domain/products/attribute-editor.tsx", "src/components/domain/products/attribute-filter.tsx"]
      }
    },
    "DOM-PROD-005": {
      "name": "Add Product Import",
      "status": "invalid",
      "change": "remove",
      "reason": "ALREADY IMPLEMENTED. Server functions previewBulkImport and bulkImportProducts exist with full CSV parsing, field mapping, validation, duplicate detection. BulkImportDialog provides complete UI with upload, mapping, preview, and import steps.",
      "layers": [],
      "estimated_iterations": {
        "original": 5,
        "recommended_total": 0,
        "breakdown": {}
      },
      "existing_implementation": {
        "server_functions": ["previewBulkImport", "bulkImportProducts"],
        "components": ["BulkImportDialog"],
        "features": ["CSV file upload", "Column mapping UI", "Preview with validation", "SKU duplicate detection", "Import progress tracking", "Error reporting"]
      }
    },
    "DOM-PROD-006": {
      "name": "Add Discontinued Product Handling",
      "status": "valid",
      "change": "adjust_scope",
      "reason": "Schema change from boolean isActive to status enum requires migration. Story is feasible but needs migration handling.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": {
        "original": 3,
        "recommended_total": 10,
        "breakdown": {
          "schema_migration": 3,
          "server": 3,
          "ui": 4
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "notes": "Current isActive boolean would need migration to status enum. Replacement product suggestion adds complexity."
      }
    },
    "DOM-PROD-007": {
      "name": "Add Related Products",
      "status": "valid",
      "change": "atomize",
      "reason": "Schema + server + UI story. AI suggestion is optional but adds significant complexity if included.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": {
        "original": 3,
        "recommended_total": 9,
        "breakdown": {
          "schema": 2,
          "server": 3,
          "ui": 4
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "notes": "AI suggestion marked optional - recommend deferring to separate story"
      }
    },
    "DOM-PROD-008": {
      "name": "Optimize Product Search",
      "status": "valid",
      "change": "adjust_scope",
      "reason": "Requires PostgreSQL full-text search setup. Performance requirement (< 200ms) needs benchmarking. Recent searches per user requires new table.",
      "layers": ["database", "server", "UI"],
      "estimated_iterations": {
        "original": 4,
        "recommended_total": 12,
        "breakdown": {
          "database_fts_setup": 4,
          "server": 4,
          "ui": 4
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "notes": "Full-text search index, fuzzy matching, and search highlights require specific PostgreSQL features. Performance requirement needs benchmarking infrastructure."
      }
    }
  },
  "recommended_stories": [
    {
      "id": "DOM-PROD-001a",
      "name": "Price Tiers Schema",
      "description": "Create product_price_tiers and customer_product_prices tables",
      "layers": ["schema"],
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "product_price_tiers table created with (id, productId, minQty, price, organizationId)",
        "customer_product_prices table created with (id, customerId, productId, price, organizationId)",
        "Proper indexes and foreign keys defined",
        "Types exported from lib/schema/index.ts",
        "Migration file created"
      ]
    },
    {
      "id": "DOM-PROD-001b",
      "name": "Price Tiers Server Functions",
      "description": "Implement price tier CRUD and price resolution logic",
      "dependencies": ["DOM-PROD-001a"],
      "layers": ["server"],
      "estimated_iterations": 4,
      "acceptance_criteria": [
        "createPriceTier, updatePriceTier, deletePriceTier functions",
        "listPriceTiers function with productId filter",
        "setCustomerPrice, getCustomerPrice functions",
        "resolveProductPrice(productId, customerId, quantity) returns correct price",
        "Price resolution order: customer > tier > base"
      ]
    },
    {
      "id": "DOM-PROD-001c",
      "name": "Price Tiers UI",
      "description": "Add price tier editor to product detail and customer price display",
      "dependencies": ["DOM-PROD-001b"],
      "layers": ["UI"],
      "estimated_iterations": 5,
      "acceptance_criteria": [
        "Price tier editor component on product detail page",
        "Add/edit/delete tiers with quantity thresholds",
        "Customer price display on customer detail page",
        "Quote/order line item shows resolved price"
      ]
    }
  ],
  "atomization_notes": {
    "DOM-PROD-001": "Split into 3 stories: schema (3 iterations), server (4), UI (5)",
    "DOM-PROD-002": "Split into 4 stories: schema (3), server (5), UI (5), inventory integration (3)",
    "DOM-PROD-003": "Split into 4 stories: schema (2), storage integration (4), server (3), UI (5)",
    "DOM-PROD-004": "Split into 3 stories: schema (4), server (6), UI (8) - most complex feature",
    "DOM-PROD-005": "REMOVE - Already implemented",
    "DOM-PROD-006": "Keep as single story but account for migration complexity (10 iterations total)",
    "DOM-PROD-007": "Split into 3 stories: schema (2), server (3), UI (4). Defer AI suggestion to separate story.",
    "DOM-PROD-008": "Split into 3 stories: database FTS setup (4), server (4), UI (4)"
  },
  "priority_recommendation": [
    {
      "priority": 1,
      "story": "DOM-PROD-006",
      "reason": "Discontinued handling prevents errors in orders/quotes. Foundation for other features."
    },
    {
      "priority": 2,
      "story": "DOM-PROD-001",
      "reason": "Price tiers enable volume discounts - high business value for B2B."
    },
    {
      "priority": 3,
      "story": "DOM-PROD-003",
      "reason": "Images make catalog visual - improves UX significantly."
    },
    {
      "priority": 4,
      "story": "DOM-PROD-007",
      "reason": "Related products increases sales opportunities."
    },
    {
      "priority": 5,
      "story": "DOM-PROD-002",
      "reason": "Bundles useful but complex - defer until core features stable."
    },
    {
      "priority": 6,
      "story": "DOM-PROD-004",
      "reason": "Attributes are complex and MVP can work without them."
    },
    {
      "priority": 7,
      "story": "DOM-PROD-008",
      "reason": "Search optimization is enhancement - current search works."
    }
  ]
}
