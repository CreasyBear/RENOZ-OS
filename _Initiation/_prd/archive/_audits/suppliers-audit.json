{
  "prd_id": "DOM-SUPPLIERS",
  "audit_date": "2026-01-09",
  "auditor": "Claude Opus 4.5",
  "summary": {
    "total_stories": 8,
    "verified_gaps": 5,
    "invalidated_gaps": 3,
    "implementation_status": "Strong foundation exists. Supplier CRUD complete, PO CRUD complete, goods receipt with partial support exists, supplier performance tracking partially implemented. Stories DOM-SUPP-001 and DOM-SUPP-004 are largely implemented. DOM-SUPP-003 has partial implementation via getSuggestedOrderItems."
  },
  "codebase_findings": {
    "schema_files": [
      {
        "path": "renoz-v2/lib/schema/suppliers.ts",
        "contains": [
          "suppliers table with full CRUD columns",
          "companyName, contactName, email, phone",
          "street, city, state, postalCode, country address fields",
          "paymentTerms text field",
          "xeroContactId for Xero integration",
          "isActive boolean, category text",
          "notes, audit fields (createdByUserId, updatedByUserId)",
          "version for OCC, deletedAt for soft delete"
        ],
        "notes": "Supplier schema is complete. No performance tracking columns exist in schema (calculated from PO history)."
      },
      {
        "path": "renoz-v2/lib/schema/purchase-orders.ts",
        "contains": [
          "purchaseOrders table with poNumber (generated), supplierId FK",
          "status: draft, sent, in_transit, partially_received, received, cancelled",
          "orderDate, expectedDate, receivedDate dates",
          "shippingCarrier, trackingNumber for shipping",
          "subtotalAmount, taxAmount, totalAmount decimals",
          "xeroPoId for Xero integration",
          "purchaseOrderItems table with ordered, received, rejected quantities",
          "quantityReceived and quantityRejected already support partial receipt tracking"
        ],
        "notes": "PO schema supports partial receipts via quantityReceived/quantityRejected. No approval workflow fields (pending_approval status, approvedBy, approvedAt). No amendments table. No supplier_prices table. No po_costs table for landed costs."
      }
    ],
    "server_functions": [
      {
        "path": "renoz-v2/src/server/functions/suppliers.ts",
        "functions": [
          "listSuppliers - Paginated list with search, isActive filter",
          "getSupplier - Single supplier by ID",
          "createSupplier - Create with audit logging",
          "updateSupplier - Update with OCC and audit logging",
          "deleteSupplier - Soft delete with audit logging"
        ],
        "notes": "Full CRUD implemented with RLS context, audit logging, and Xero sync stubs."
      },
      {
        "path": "renoz-v2/src/server/functions/supplier-performance.ts",
        "functions": [
          "getSupplierPerformanceMetrics - On-time delivery %, avg lead time, total orders for period",
          "getSupplierPortfolioOverview - Aggregate metrics across all suppliers",
          "listSuppliersWithPerformance - List suppliers with calculated performance metrics",
          "getSupplierAlerts - Performance alerts (mock implementation, checks company name)",
          "bulkSupplierEmail - Bulk email to suppliers (audit logged, no actual email)",
          "bulkUpdateSupplierStatus - Bulk status update",
          "bulkExportSuppliers - Export with optional performance/orders data",
          "calculatePerformanceRating - Helper function for 1-5 star rating"
        ],
        "notes": "Performance tracking IS implemented but getSupplierAlerts uses mock logic (checks company name instead of real metrics). Performance metrics calculated from PO history - no persistent schema needed."
      },
      {
        "path": "renoz-v2/src/server/functions/purchase-orders.ts",
        "functions": [
          "listPurchaseOrders - Paginated with search, status, supplier filters",
          "getPurchaseOrder - Get PO with items and supplier",
          "createPurchaseOrder - Create with PO number generation",
          "addPOItem - Add item to draft PO with line total calc",
          "updatePOItem - Update quantity/price on draft PO",
          "removePOItem - Remove item from draft PO",
          "updatePOStatus - Validated status transitions",
          "sendPO - Send PO (triggers email via Trigger.dev)",
          "markPOShipped - Mark as in_transit with carrier/tracking",
          "getSuggestedOrderItems - Get low stock products for PO suggestions"
        ],
        "notes": "Full PO lifecycle implemented. getSuggestedOrderItems provides reorder alert suggestions. No approval workflow - status goes draft -> sent directly. No amendments tracking."
      }
    ],
    "components": [
      {
        "path": "renoz-v2/src/components/domain/suppliers/supplier-form.tsx",
        "contains": "Create/edit supplier form with all fields"
      },
      {
        "path": "renoz-v2/src/components/domain/suppliers/supplier-detail-sidebar.tsx",
        "contains": "Supplier detail sidebar for quick view"
      },
      {
        "path": "renoz-v2/src/components/domain/suppliers/supplier-management-columns.tsx",
        "contains": "Table columns for supplier list"
      },
      {
        "path": "renoz-v2/src/components/domain/suppliers/purchase-orders-tab.tsx",
        "contains": "PO list tab on supplier detail page"
      },
      {
        "path": "renoz-v2/src/components/domain/procurement/supplier-columns.tsx",
        "contains": "DataTable columns for suppliers"
      },
      {
        "path": "renoz-v2/src/components/domain/procurement/purchase-order-columns.tsx",
        "contains": "DataTable columns for POs"
      },
      {
        "path": "renoz-v2/src/components/domain/procurement/po-builder.tsx",
        "contains": "PO creation builder component"
      },
      {
        "path": "renoz-v2/src/components/domain/procurement/receive-goods.tsx",
        "contains": "Goods receipt UI with partial quantity support, serial number entry, bin location"
      },
      {
        "path": "renoz-v2/src/components/domain/procurement/suggest-items-dialog.tsx",
        "contains": "Dialog for suggested reorder items"
      },
      {
        "path": "renoz-v2/src/components/domain/procurement/po-pdf.tsx",
        "contains": "PO PDF generation"
      },
      {
        "path": "renoz-v2/src/components/shared/supplier-alerts-banner.tsx",
        "contains": "Banner for supplier performance alerts"
      }
    ],
    "routes": [
      {
        "path": "renoz-v2/src/routes/procurement/suppliers/index.tsx",
        "contains": [
          "Supplier list page with search, active/inactive tabs",
          "DataTable with bulk selection",
          "CSV export for selected suppliers",
          "Add supplier form dialog"
        ]
      },
      {
        "path": "renoz-v2/src/routes/procurement/suppliers/$supplierId.tsx",
        "contains": [
          "Supplier detail page with Overview, Purchase Orders, Stats tabs",
          "Company info, address, payment terms cards",
          "PurchaseOrdersTab showing supplier's PO history",
          "Edit supplier dialog"
        ]
      },
      {
        "path": "renoz-v2/src/routes/procurement/purchase-orders/index.tsx",
        "contains": "PO list page"
      },
      {
        "path": "renoz-v2/src/routes/procurement/purchase-orders/$poId.tsx",
        "contains": "PO detail page with items, receive goods"
      },
      {
        "path": "renoz-v2/src/routes/procurement/purchase-orders/new.tsx",
        "contains": "New PO creation page"
      }
    ]
  },
  "stories_status": {
    "DOM-SUPP-001": {
      "name": "Add Supplier Performance Tracking",
      "status": "mostly_implemented",
      "change": "reduce_scope",
      "layers": ["server", "UI"],
      "estimated_iterations": 2,
      "existing_implementation": {
        "on_time_delivery_pct": "EXISTS - getSupplierPerformanceMetrics calculates from PO history",
        "quality_issues": "PARTIAL - quantityRejected tracked but no quality issue categorization",
        "avg_lead_time": "EXISTS - calculated as actual - expected delivery",
        "performance_from_po_history": "EXISTS - calculated dynamically, no schema needed",
        "performance_on_supplier_detail": "PARTIAL - Stats tab exists but needs widget integration",
        "performance_comparison_report": "MISSING - no comparison across suppliers",
        "alert_on_declining": "PARTIAL - getSupplierAlerts exists but uses mock logic",
        "performance_in_supplier_selection": "MISSING - no UI to show performance during PO creation"
      },
      "remaining_work": [
        "Fix getSupplierAlerts to use real performance thresholds",
        "Add performance comparison report page",
        "Show performance metrics widget on supplier detail Stats tab",
        "Show supplier performance indicator during PO supplier selection"
      ],
      "atomization_needed": false,
      "atomization_reason": "Core implementation exists. Only UI polish and alert fix needed."
    },
    "DOM-SUPP-002": {
      "name": "Add PO Approval Workflow",
      "status": "valid",
      "change": "atomize",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": 8,
      "existing_implementation": {
        "approval_rules": "MISSING - no threshold configuration",
        "approval_levels": "MISSING - no multi-level approval",
        "po_status_pending_approval": "MISSING - status enum has draft->sent, no pending_approval",
        "approval_notification": "MISSING - no notification system for approvers",
        "approve_reject_actions": "MISSING - no server functions",
        "approval_history": "MISSING - no po_approvals table"
      },
      "remaining_work": [
        "Add pending_approval to PURCHASE_ORDER_STATUSES enum",
        "Create po_approval_rules table (orgId, minAmount, maxAmount, approverRole)",
        "Create po_approvals table (poId, approverId, status, comment, createdAt)",
        "Create submitForApproval server function",
        "Create approvePO and rejectPO server functions",
        "Update status transition logic for approval workflow",
        "Create notification trigger for pending approvals",
        "Add approval UI on PO detail page"
      ],
      "atomization_needed": true,
      "atomization_reason": "New workflow spanning schema changes, server logic, notifications, and UI"
    },
    "DOM-SUPP-003": {
      "name": "Add Auto-PO from Reorder Alerts",
      "status": "mostly_implemented",
      "change": "reduce_scope",
      "layers": ["UI"],
      "estimated_iterations": 2,
      "existing_implementation": {
        "below_reorder_suggest": "EXISTS - getSuggestedOrderItems returns products below reorder point",
        "suggested_qty_calc": "EXISTS - suggestedQty = reorderPoint * 2 - currentStock",
        "group_by_supplier": "MISSING - suggestions not grouped by supplier",
        "one_click_po_create": "PARTIAL - suggest-items-dialog.tsx exists but needs PO creation",
        "review_before_create": "PARTIAL - dialog shows suggestions but no create action",
        "suggestions_on_dashboard": "MISSING - no dashboard widget for reorder suggestions"
      },
      "remaining_work": [
        "Add supplier grouping to getSuggestedOrderItems",
        "Add 'Create PO' action to suggest-items-dialog.tsx",
        "Add reorder suggestions widget to procurement dashboard"
      ],
      "atomization_needed": false,
      "atomization_reason": "Core logic exists. Only UI integration needed."
    },
    "DOM-SUPP-004": {
      "name": "Add Partial Receipt Handling",
      "status": "mostly_implemented",
      "change": "reduce_scope",
      "layers": ["UI"],
      "estimated_iterations": 2,
      "existing_implementation": {
        "receive_partial_qty": "EXISTS - receive-goods.tsx allows partial quantity entry",
        "track_ordered_received_outstanding": "EXISTS - purchaseOrderItems has quantity, quantityReceived, quantityRejected",
        "multiple_receipts_per_po": "PARTIAL - status partially_received exists, but no receipt_records table",
        "po_complete_when_all_received": "EXISTS - status transition to received when fully received",
        "back_ordered_highlight": "PARTIAL - remaining qty shown but not explicitly back-ordered status",
        "receipt_history_on_po": "MISSING - no discrete receipt events, only cumulative totals"
      },
      "remaining_work": [
        "Add receipt_records table for discrete receipt events (optional for audit)",
        "Add back-ordered badge/highlight for items with outstanding qty",
        "Add receipt history section on PO detail showing each receive event"
      ],
      "atomization_needed": false,
      "atomization_reason": "Core functionality works. Only history tracking and UI polish needed."
    },
    "DOM-SUPP-005": {
      "name": "Add Supplier Price Lists",
      "status": "valid",
      "change": "atomize",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": 6,
      "existing_implementation": {
        "supplier_prices_table": "MISSING - no table exists",
        "multiple_suppliers_per_product": "MISSING - no relationship table",
        "price_history": "MISSING - no tracking",
        "auto_populate_po_price": "MISSING - PO item price manually entered",
        "compare_prices_across_suppliers": "MISSING - no comparison UI",
        "preferred_supplier_per_product": "MISSING - no preferredSupplierId on products"
      },
      "remaining_work": [
        "Create supplier_prices table (supplierId, productId, price, minQty, effectiveDate)",
        "Create supplier_price_history table for trend tracking",
        "Add products.preferredSupplierId FK column",
        "Create CRUD server functions for supplier prices",
        "Auto-populate unitCost when adding PO item from price list",
        "Create supplier price comparison UI",
        "Add preferred supplier indicator on product detail"
      ],
      "atomization_needed": true,
      "atomization_reason": "New feature requiring schema, server functions, and multiple UI components"
    },
    "DOM-SUPP-006": {
      "name": "Add PO Amendments",
      "status": "valid",
      "change": "atomize",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": 6,
      "existing_implementation": {
        "po_amendments_table": "MISSING - no amendments tracking",
        "amend_items_quantities": "MISSING - no server function",
        "re_approval_on_threshold": "MISSING - depends on DOM-SUPP-002",
        "amendment_notification": "MISSING - no notification",
        "amendment_history": "MISSING - no tracking",
        "original_vs_current_comparison": "MISSING - no diff view"
      },
      "remaining_work": [
        "Create po_amendments table (poId, changes JSON, reason, amendedByUserId, createdAt)",
        "Create amendPO server function with change tracking",
        "Integrate with approval workflow if amendment exceeds threshold",
        "Send amendment notification to supplier",
        "Create amendment history section on PO detail",
        "Create original vs current comparison view"
      ],
      "atomization_needed": true,
      "atomization_reason": "Depends on DOM-SUPP-002 for re-approval. Requires schema, server, and UI work.",
      "dependencies": ["DOM-SUPP-002"]
    },
    "DOM-SUPP-007": {
      "name": "Add Landed Cost Tracking",
      "status": "valid",
      "change": "atomize",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": 7,
      "existing_implementation": {
        "po_costs_table": "MISSING - no table for additional costs",
        "add_costs_after_receipt": "MISSING - no server function",
        "allocate_to_items": "MISSING - no allocation logic",
        "landed_cost_inventory_valuation": "MISSING - inventory costPrice not updated with landed costs",
        "cost_breakdown_on_po": "MISSING - no UI",
        "landed_cost_report": "MISSING - no report"
      },
      "remaining_work": [
        "Create po_costs table (poId, type: freight/duty/insurance, amount, description)",
        "Create addPOCost server function",
        "Create cost allocation logic (by value/qty/weight)",
        "Update inventory item costPrice with allocated landed cost",
        "Add cost breakdown section on PO detail",
        "Create landed cost report by supplier/product"
      ],
      "atomization_needed": true,
      "atomization_reason": "Complex feature with inventory valuation impact. Requires schema, allocation algorithm, and reporting.",
      "dependencies": ["DOM-SUPP-004"]
    },
    "DOM-SUPP-008": {
      "name": "Create Procurement Dashboard",
      "status": "valid",
      "change": "none",
      "layers": ["UI"],
      "estimated_iterations": 5,
      "existing_implementation": {
        "procurement_dashboard_page": "MISSING - no /procurement/dashboard route",
        "open_pos_widget": "MISSING",
        "pending_receipts_widget": "MISSING",
        "spend_mtd_widget": "MISSING",
        "pos_by_status_breakdown": "MISSING",
        "top_suppliers_by_volume": "PARTIAL - getSupplierPortfolioOverview has aggregate data",
        "expected_receipts_calendar": "MISSING",
        "quick_actions": "PARTIAL - /procurement/purchase-orders/new exists"
      },
      "remaining_work": [
        "Create /procurement/dashboard route",
        "Add open POs widget with count and value",
        "Add pending receipts widget",
        "Add spend MTD widget",
        "Add POs by status breakdown chart",
        "Add top suppliers by volume widget",
        "Add expected receipts calendar view",
        "Add quick action buttons"
      ],
      "atomization_needed": false,
      "atomization_reason": "Pure UI work with existing server data. Could be done in single sprint.",
      "dependencies": ["DOM-SUPP-001"]
    }
  },
  "recommended_stories": [
    {
      "priority": 1,
      "story_id": "DOM-SUPP-001",
      "reason": "90% implemented. Only needs alert fix, comparison report, and UI polish. Quick win for supplier visibility."
    },
    {
      "priority": 2,
      "story_id": "DOM-SUPP-004",
      "reason": "Partial receipt functionality works. Only needs receipt history table and UI polish."
    },
    {
      "priority": 3,
      "story_id": "DOM-SUPP-003",
      "reason": "getSuggestedOrderItems exists. Just needs supplier grouping and Create PO action wiring."
    },
    {
      "priority": 4,
      "story_id": "DOM-SUPP-008",
      "reason": "Pure UI dashboard. No schema changes. Good consolidation of existing functionality."
    }
  ],
  "atomization_notes": {
    "DOM-SUPP-002": {
      "suggested_split": [
        {
          "id": "DOM-SUPP-002-A",
          "name": "Add pending_approval status and approval tables schema",
          "layers": ["schema"],
          "iterations": 2
        },
        {
          "id": "DOM-SUPP-002-B",
          "name": "Create approval server functions (submit, approve, reject)",
          "layers": ["server"],
          "iterations": 2
        },
        {
          "id": "DOM-SUPP-002-C",
          "name": "Update PO status transitions for approval workflow",
          "layers": ["server"],
          "iterations": 1
        },
        {
          "id": "DOM-SUPP-002-D",
          "name": "Add approval notification trigger",
          "layers": ["server"],
          "iterations": 1
        },
        {
          "id": "DOM-SUPP-002-E",
          "name": "Add approval UI on PO detail page",
          "layers": ["UI"],
          "iterations": 2
        }
      ]
    },
    "DOM-SUPP-005": {
      "suggested_split": [
        {
          "id": "DOM-SUPP-005-A",
          "name": "Create supplier_prices and history schema",
          "layers": ["schema"],
          "iterations": 2
        },
        {
          "id": "DOM-SUPP-005-B",
          "name": "Add preferredSupplierId to products schema",
          "layers": ["schema"],
          "iterations": 1
        },
        {
          "id": "DOM-SUPP-005-C",
          "name": "Create supplier price CRUD server functions",
          "layers": ["server"],
          "iterations": 2
        },
        {
          "id": "DOM-SUPP-005-D",
          "name": "Auto-populate PO item price from supplier price list",
          "layers": ["server", "UI"],
          "iterations": 1
        },
        {
          "id": "DOM-SUPP-005-E",
          "name": "Create supplier price comparison UI",
          "layers": ["UI"],
          "iterations": 2
        }
      ]
    },
    "DOM-SUPP-006": {
      "suggested_split": [
        {
          "id": "DOM-SUPP-006-A",
          "name": "Create po_amendments schema",
          "layers": ["schema"],
          "iterations": 1
        },
        {
          "id": "DOM-SUPP-006-B",
          "name": "Create amendPO server function with change tracking",
          "layers": ["server"],
          "iterations": 2
        },
        {
          "id": "DOM-SUPP-006-C",
          "name": "Integrate amendment re-approval with approval workflow",
          "layers": ["server"],
          "iterations": 1,
          "depends_on": "DOM-SUPP-002"
        },
        {
          "id": "DOM-SUPP-006-D",
          "name": "Add amendment history and comparison UI",
          "layers": ["UI"],
          "iterations": 2
        }
      ]
    },
    "DOM-SUPP-007": {
      "suggested_split": [
        {
          "id": "DOM-SUPP-007-A",
          "name": "Create po_costs schema",
          "layers": ["schema"],
          "iterations": 1
        },
        {
          "id": "DOM-SUPP-007-B",
          "name": "Create addPOCost server function",
          "layers": ["server"],
          "iterations": 1
        },
        {
          "id": "DOM-SUPP-007-C",
          "name": "Create cost allocation algorithm (by value/qty/weight)",
          "layers": ["server"],
          "iterations": 2
        },
        {
          "id": "DOM-SUPP-007-D",
          "name": "Update inventory item costPrice with landed cost",
          "layers": ["server"],
          "iterations": 1,
          "depends_on": "DOM-SUPP-004"
        },
        {
          "id": "DOM-SUPP-007-E",
          "name": "Add cost breakdown UI and landed cost report",
          "layers": ["UI"],
          "iterations": 2
        }
      ]
    }
  },
  "warnings": [
    {
      "type": "gap_invalidated",
      "story": "DOM-SUPP-001",
      "message": "PRD claims no supplier performance tracking but getSupplierPerformanceMetrics exists and calculates on-time delivery %, avg lead time from PO history"
    },
    {
      "type": "gap_invalidated",
      "story": "DOM-SUPP-004",
      "message": "PRD claims no partial receipt handling but receive-goods.tsx already supports partial quantities with quantityReceived/quantityRejected tracking"
    },
    {
      "type": "gap_invalidated",
      "story": "DOM-SUPP-003",
      "message": "PRD claims no PO from reorder alerts but getSuggestedOrderItems already returns below-reorder products with suggested quantities"
    },
    {
      "type": "dependency_missing",
      "story": "DOM-SUPP-006",
      "message": "PO Amendments depends on DOM-SUPP-002 (Approval Workflow) for re-approval feature but PRD only partially reflects this"
    },
    {
      "type": "dependency_missing",
      "story": "DOM-SUPP-007",
      "message": "Landed Cost depends on DOM-SUPP-004 (Partial Receipt) for accurate per-receipt cost allocation"
    },
    {
      "type": "iteration_underestimate",
      "story": "DOM-SUPP-002",
      "message": "Estimated 5 iterations but full approval workflow with rules, notifications, and UI likely needs 8 iterations"
    }
  ],
  "critical_findings": [
    {
      "finding": "getSupplierAlerts uses mock logic (checks company name contains 'DEF' or 'Review')",
      "impact": "Users won't get real performance alerts based on actual metrics",
      "recommendation": "High priority fix in DOM-SUPP-001. Replace mock logic with threshold-based checks against calculated metrics."
    },
    {
      "finding": "No discrete receipt_records table - only cumulative quantityReceived",
      "impact": "Cannot show receipt history timeline, cannot track who received what when",
      "recommendation": "Consider adding receipt_records table in DOM-SUPP-004 for full audit trail."
    },
    {
      "finding": "PO status transitions allow draft->sent without approval",
      "impact": "No spend controls for high-value POs",
      "recommendation": "DOM-SUPP-002 is important for financial controls but is a larger effort."
    },
    {
      "finding": "PRD current_state.implemented claims more than actually exists",
      "impact": "Audit found 3 features listed as gaps that are actually mostly implemented",
      "recommendation": "Update PRD to reflect true state - performance tracking, partial receipts, and reorder suggestions have foundation in place."
    }
  ]
}
