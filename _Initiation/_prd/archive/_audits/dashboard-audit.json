{
  "prd_id": "DOM-DASHBOARD",
  "audit_date": "2026-01-09",
  "auditor": "Claude Opus 4.5",
  "summary": {
    "total_stories": 8,
    "verified_gaps": 5,
    "invalidated_gaps": 2,
    "partially_implemented": 1,
    "implementation_status": "Mature dashboard with comprehensive widget system, drag-drop layout, role-based defaults, and advanced filtering. Key gaps: user-level customization persistence partial, no targets/goals tracking, no scheduled reports, no dedicated drill-down views, no AI insights widget, no true mobile-optimized view."
  },
  "codebase_findings": {
    "schema_files": [
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/user-preferences.ts - dashboardLayout stored per user",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/types/dashboard.ts - WidgetConfig, DashboardFilters, DashboardLayout types"
    ],
    "server_functions": [
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/dashboard.ts - getDashboardMetrics, getTimeSeriesData, getAggregateData, getRecentOrders, getLowStockProducts, getEnhancedTimeSeriesData, getEnhancedTableData, exportDashboardData",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/user-preferences.ts - saveDashboardLayout, getDashboardLayout, getUserPreferences"
    ],
    "components": [
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/dashboard-page.tsx - Main dashboard with customization",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/enhanced-dashboard-page.tsx - Gold standard implementation",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/widget-grid.tsx - react-grid-layout drag-drop",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/widget-catalog.tsx - Add widget dialog",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/widget-registry.tsx - Widget type mapping",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/role-defaults.ts - Role-based default layouts",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/dashboard-context.tsx - Filter context with URL sync",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/store/dashboard-store.ts - Zustand state management",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/dashboard-settings.tsx - Settings panel",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/widgets/ - 10+ widget implementations (KPI, charts, tables)"
    ],
    "routes": [
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/routes/index.tsx - Dashboard route with EnhancedDashboardPage"
    ],
    "existing_features": {
      "widget_customization": {
        "drag_drop_reordering": "IMPLEMENTED - react-grid-layout with isDraggable in edit mode",
        "show_hide_widgets": "IMPLEMENTED - widgetVisibility state with toggle panel",
        "widget_size_options": "IMPLEMENTED - resize handles, minW/maxW/minH/maxH constraints",
        "layout_saved_per_user": "IMPLEMENTED - saveDashboardLayout server function, user_preferences.dashboardLayout",
        "reset_to_role_default": "IMPLEMENTED - handleResetLayout function, getRoleDefaultLayout()",
        "widget_catalog": "IMPLEMENTED - WidgetCatalog component with tabs (KPIs, Charts, Tables)"
      },
      "date_ranges": {
        "date_range_selector": "PARTIAL - DashboardContext has dateRange but no visible selector UI in header",
        "presets": "PARTIAL - DashboardFilters type has preset (today/week/month/quarter/year/custom) but UI not exposed",
        "custom_date_picker": "NOT IMPLEMENTED - Type exists but no date picker component",
        "applies_to_all_widgets": "PARTIAL - Context broadcasts filters but widgets dont all consume them",
        "default_per_user_preference": "NOT IMPLEMENTED",
        "session_persistence": "PARTIAL - URL sync implemented via useNavigate"
      },
      "comparison_periods": {
        "trend_indicators": "IMPLEMENTED - KPIWidget shows trend with ArrowUp/Down icons and percentage",
        "revenue_trend_calculation": "IMPLEMENTED - server calculates current vs previous month revenue"
      },
      "responsive": {
        "breakpoints": "IMPLEMENTED - widget-grid.tsx has BREAKPOINTS (lg:1200, md:996, sm:768, xs:480, xxs:0)",
        "media_queries": "IMPLEMENTED - widget-grid.css has @media (max-width: 768px)"
      }
    }
  },
  "stories_status": {
    "DOM-DASH-001": {
      "name": "Add Widget Customization",
      "status": "invalid",
      "change": "remove",
      "reason": "Already fully implemented: drag-drop reordering, show/hide toggle, widget sizes with constraints, layout saved in user_preferences.dashboardLayout, reset to role defaults, widget catalog with add functionality.",
      "layers": [],
      "estimated_iterations": 0,
      "evidence": [
        "widget-grid.tsx: isDraggable={isEditMode}, isResizable={isEditMode}",
        "dashboard-page.tsx: widgetVisibility state with toggle panel",
        "widget-catalog.tsx: full catalog with KPI/Chart/Table tabs",
        "user-preferences.ts: saveDashboardLayout server function",
        "role-defaults.ts: getRoleDefaultLayout for admin/sales/warehouse/viewer"
      ]
    },
    "DOM-DASH-002": {
      "name": "Add Custom Date Ranges",
      "status": "valid",
      "change": "atomize",
      "reason": "Infrastructure exists (DashboardContext, DashboardFilters type with presets) but UI components not exposed. Need date range selector component in dashboard header.",
      "layers": ["UI"],
      "estimated_iterations": 3,
      "atomization_needed": true,
      "sub_stories": [
        {
          "id": "DOM-DASH-002A",
          "name": "Add Date Range Selector UI",
          "description": "Add visible date range selector to dashboard header with preset buttons and custom picker",
          "layers": ["UI"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "Date range selector visible in dashboard header",
            "Preset buttons: Today, This Week, This Month, This Quarter, YTD",
            "Custom date range picker with calendar",
            "Selected range displayed clearly",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-002B",
          "name": "Wire Date Range to Widgets",
          "description": "Update widget components to consume date range from context",
          "layers": ["UI"],
          "estimated_iterations": 1,
          "acceptance_criteria": [
            "All applicable widgets respect dateRange from DashboardContext",
            "Date range change triggers widget refresh",
            "TypeScript compiles without errors"
          ]
        }
      ]
    },
    "DOM-DASH-003": {
      "name": "Add Goal/Target Tracking",
      "status": "valid",
      "change": "atomize",
      "reason": "No targets table or tracking exists. Full stack implementation needed: schema, server functions, settings UI, and widget integration.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": 8,
      "atomization_needed": true,
      "sub_stories": [
        {
          "id": "DOM-DASH-003A",
          "name": "Create Targets Schema",
          "description": "Add targets table with metric type, period, value, orgId",
          "layers": ["schema"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "targets table created (id, metric, period, targetValue, actualValue, orgId, createdAt, updatedAt)",
            "Migration runs successfully",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-003B",
          "name": "Add Target Server Functions",
          "description": "CRUD operations for targets plus progress calculation",
          "layers": ["server"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "createTarget, getTargets, updateTarget, deleteTarget server functions",
            "getTargetProgress function calculates actual vs target",
            "RLS enforced for organization scope",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-003C",
          "name": "Add Target Settings UI",
          "description": "Settings page for managing targets",
          "layers": ["UI"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "Target setting form in settings area",
            "Target types: revenue, orders, pipeline, customer acquisition",
            "Period selection: weekly, monthly, quarterly, yearly",
            "List/edit/delete existing targets",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-003D",
          "name": "Add Target Progress to KPI Widgets",
          "description": "Show progress indicators on metric widgets",
          "layers": ["UI"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "KPIWidget shows progress bar when target exists",
            "Progress percentage displayed",
            "Color coding: green (>90%), yellow (70-90%), red (<70%)",
            "TypeScript compiles without errors"
          ]
        }
      ]
    },
    "DOM-DASH-004": {
      "name": "Add Widget Drill-Down",
      "status": "valid",
      "change": "atomize",
      "reason": "Widgets currently static. Need onClick handlers that open detail views or navigate to filtered list views.",
      "layers": ["UI"],
      "estimated_iterations": 5,
      "atomization_needed": true,
      "sub_stories": [
        {
          "id": "DOM-DASH-004A",
          "name": "Add KPI Widget Click Handlers",
          "description": "Make KPI widgets clickable to navigate to relevant list pages",
          "layers": ["UI"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "KPI widgets have onClick prop and cursor-pointer style",
            "Revenue KPI navigates to orders with delivered status",
            "Orders KPI navigates to orders with pending status",
            "Issues KPI navigates to issues list",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-004B",
          "name": "Add Chart Drill-Down Modal",
          "description": "Click chart segments to see detail breakdown",
          "layers": ["UI"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "Chart segments clickable",
            "Modal shows underlying data table",
            "Filter by clicked segment",
            "Export to CSV option",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-004C",
          "name": "Preserve Context in Drill-Down",
          "description": "Pass date range and filters to drill-down views",
          "layers": ["UI"],
          "estimated_iterations": 1,
          "acceptance_criteria": [
            "Date range from dashboard passed to drill-down",
            "URL params include filter context",
            "Back button returns to dashboard with filters intact",
            "TypeScript compiles without errors"
          ]
        }
      ]
    },
    "DOM-DASH-005": {
      "name": "Add Comparison Periods",
      "status": "valid",
      "change": "none",
      "reason": "Basic trend indicators exist (current vs previous month) but no toggle or flexible comparison options. Valid enhancement.",
      "layers": ["server", "UI"],
      "estimated_iterations": 4,
      "acceptance_criteria_review": {
        "toggle_vs_previous_period": "NOT IMPLEMENTED - no UI toggle",
        "comparison_options": "PARTIAL - only current vs previous month hardcoded",
        "change_indicators": "IMPLEMENTED - ArrowUp/Down with percentage in KPIWidget",
        "color_coding": "IMPLEMENTED - green/red based on trend direction",
        "comparison_on_widgets": "PARTIAL - only KPIs show trend, charts dont",
        "charts_show_both_periods": "NOT IMPLEMENTED - AdvancedChartWidget has secondary prop but not wired"
      }
    },
    "DOM-DASH-006": {
      "name": "Add Scheduled Reports",
      "status": "valid",
      "change": "atomize",
      "reason": "No scheduled reports functionality exists. Requires schema, server functions, settings UI, and background job (Trigger.dev).",
      "layers": ["schema", "server", "UI", "background-job"],
      "estimated_iterations": 10,
      "atomization_needed": true,
      "note": "Large scope - consider deferring or splitting across multiple sprints",
      "sub_stories": [
        {
          "id": "DOM-DASH-006A",
          "name": "Create Scheduled Reports Schema",
          "description": "Add scheduled_reports table",
          "layers": ["schema"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "scheduled_reports table (id, name, frequency, recipients, metrics, format, orgId, createdBy)",
            "Migration runs successfully",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-006B",
          "name": "Add Report Server Functions",
          "description": "CRUD for scheduled reports plus report generation",
          "layers": ["server"],
          "estimated_iterations": 3,
          "acceptance_criteria": [
            "createScheduledReport, getScheduledReports, updateScheduledReport, deleteScheduledReport",
            "generateReport function creates HTML/PDF summary",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-006C",
          "name": "Add Report Management UI",
          "description": "Settings page for creating/managing scheduled reports",
          "layers": ["UI"],
          "estimated_iterations": 3,
          "acceptance_criteria": [
            "Report creation form with frequency selection",
            "Recipient email input (comma-separated)",
            "Metric/widget selection checkboxes",
            "Format selection: HTML email, PDF attachment",
            "List of scheduled reports with edit/delete",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-006D",
          "name": "Add Trigger.dev Scheduled Job",
          "description": "Background job to execute scheduled reports",
          "layers": ["background-job"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "Trigger.dev cron job checks for due reports",
            "Job generates report and sends email",
            "Logging and error handling",
            "TypeScript compiles without errors"
          ]
        }
      ]
    },
    "DOM-DASH-007": {
      "name": "Create Mobile Dashboard",
      "status": "valid",
      "change": "none",
      "reason": "Basic responsive breakpoints exist but no true mobile-optimized view with swipe, offline caching, or pull-to-refresh.",
      "layers": ["UI"],
      "estimated_iterations": 5,
      "acceptance_criteria_review": {
        "responsive_single_column": "PARTIAL - breakpoints exist (sm:6, xs:4, xxs:2 columns) but not true single-column",
        "swipe_between_widgets": "NOT IMPLEMENTED",
        "priority_metrics_first": "NOT IMPLEMENTED",
        "touch_friendly": "PARTIAL - resize handles larger on mobile per CSS",
        "offline_caching": "NOT IMPLEMENTED",
        "pull_to_refresh": "NOT IMPLEMENTED"
      }
    },
    "DOM-DASH-008": {
      "name": "Add AI Insights Widget",
      "status": "valid",
      "change": "atomize",
      "reason": "No AI insights widget exists. Requires integration with existing AI infrastructure (lib/ai/) and new dashboard widget.",
      "layers": ["server", "UI"],
      "estimated_iterations": 6,
      "atomization_needed": true,
      "sub_stories": [
        {
          "id": "DOM-DASH-008A",
          "name": "Create AI Insights Server Function",
          "description": "Server function to analyze dashboard data and generate insights",
          "layers": ["server"],
          "estimated_iterations": 3,
          "acceptance_criteria": [
            "getDashboardInsights server function",
            "Analyzes metrics for patterns and anomalies",
            "Returns structured insights with type, message, severity",
            "Integrates with existing AI chat infrastructure",
            "Caching to avoid expensive calls",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "DOM-DASH-008B",
          "name": "Create AI Insights Widget Component",
          "description": "Dashboard widget displaying AI-generated insights",
          "layers": ["UI"],
          "estimated_iterations": 3,
          "acceptance_criteria": [
            "AIInsightsWidget component",
            "Displays insights as cards/bullets",
            "Severity indicators (info, warning, success)",
            "Refresh button to regenerate insights",
            "Link to AI chat for deeper analysis",
            "Add to widget catalog and registry",
            "TypeScript compiles without errors"
          ]
        }
      ]
    }
  },
  "recommended_stories": [
    {
      "id": "DOM-DASH-002A",
      "name": "Add Date Range Selector UI",
      "priority": 1,
      "rationale": "High value, low effort. Infrastructure exists, just needs UI exposure."
    },
    {
      "id": "DOM-DASH-004A",
      "name": "Add KPI Widget Click Handlers",
      "priority": 2,
      "rationale": "Quick win for usability - widgets already have onClick prop structure."
    },
    {
      "id": "DOM-DASH-005",
      "name": "Add Comparison Periods",
      "priority": 3,
      "rationale": "Extends existing trend functionality. Server partially ready."
    },
    {
      "id": "DOM-DASH-003A",
      "name": "Create Targets Schema",
      "priority": 4,
      "rationale": "Foundation for goal tracking. Schema first enables future work."
    },
    {
      "id": "DOM-DASH-008B",
      "name": "Create AI Insights Widget Component",
      "priority": 5,
      "rationale": "High differentiation value if AI infrastructure is solid."
    }
  ],
  "atomization_notes": {
    "DOM-DASH-002": "Split into 2 sub-stories: UI selector + widget wiring",
    "DOM-DASH-003": "Split into 4 sub-stories: schema + server + settings UI + widget integration. Large scope, 8+ iterations total.",
    "DOM-DASH-004": "Split into 3 sub-stories: KPI clicks + chart drill-down + context preservation",
    "DOM-DASH-006": "Split into 4 sub-stories: schema + server + UI + Trigger.dev job. Very large scope (10+ iterations), consider deferring.",
    "DOM-DASH-008": "Split into 2 sub-stories: server function + widget component"
  },
  "risk_assessment": {
    "high_complexity_stories": [
      "DOM-DASH-006 (Scheduled Reports) - Crosses all layers including background jobs",
      "DOM-DASH-003 (Goal Tracking) - Full stack with new schema"
    ],
    "dependencies_to_verify": [
      "DOM-DASH-004 depends on DOM-DASH-002 - needs date range context",
      "DOM-DASH-005 depends on DOM-DASH-002 - needs date range selector",
      "DOM-DASH-006 depends on DOM-DASH-002 and DOM-DASH-005 - needs comparison data"
    ],
    "technical_debt": [
      "debug logging statements in dashboard.ts and dashboard-page.tsx should be removed",
      "DashboardProvider and useDashboardFilters exist in both context and store - potential conflict"
    ]
  }
}
