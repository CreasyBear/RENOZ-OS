{
  "prd_id": "DOM-WARRANTY",
  "audit_date": "2026-01-09",
  "auditor": "Claude Opus 4.5",
  "summary": {
    "total_stories": 8,
    "verified_gaps": 5,
    "invalidated_gaps": 2,
    "needs_atomization": 4,
    "implementation_status": "Core warranty functionality exists: CRUD, list with filters, transfer, void, bulk registration from orders, basic expiry alerts (daily job), warranty reports. Gaps exist for: warranty policies, certificate generation, formal claim workflow with approval, extensions. Auto-registration from order and basic expiry alerts are partially implemented."
  },
  "codebase_findings": {
    "schema_files": [
      "renoz-v2/lib/schema/warranties.ts - warranties table with full schema"
    ],
    "validation_schemas": [
      "renoz-v2/lib/schemas/warranties.ts - CreateWarrantySchema, UpdateWarrantySchema, ListWarrantiesSchema, TransferWarrantySchema, VoidWarrantySchema, BulkRegisterWarrantiesSchema"
    ],
    "server_functions": [
      "renoz-v2/src/server/functions/warranties.ts - listWarranties, getWarranty, createWarranty, updateWarranty, transferWarranty, voidWarranty, getOrderItemsForWarrantyRegistration, bulkRegisterWarranties, calculateWarrantyExpiry"
    ],
    "components": [
      "renoz-v2/src/components/domain/support/warranty-form.tsx - Full warranty form with expiry calculation",
      "renoz-v2/src/components/domain/support/warranty-columns.tsx - DataTable columns",
      "renoz-v2/src/components/domain/support/bulk-warranty-register.tsx - Bulk registration dialog from orders",
      "renoz-v2/src/components/shared/warranty-combobox.tsx - Warranty selector"
    ],
    "routes": [
      "renoz-v2/src/routes/support/warranties/index.tsx - Warranty list with search, status filter, expiring soon filter, metrics",
      "renoz-v2/src/routes/support/warranties/$warrantyId.tsx - Warranty detail with overview, related issues, transfer/void actions",
      "renoz-v2/src/routes/reports/warranties.tsx - Warranty report with summary cards"
    ],
    "trigger_jobs": [
      "renoz-v2/trigger/warranty-jobs.ts - autoRegisterWarranties (on order delivery), checkExpiringWarranties (daily cron at 9 AM)"
    ],
    "email_templates": [
      "renoz-v2/src/components/email-templates/warranty-notification.tsx",
      "renoz-v2/emails/templates/WarrantyRegistered.tsx"
    ],
    "notification_handlers": [
      "renoz-v2/lib/notifications/handlers/warranty-registered.ts"
    ],
    "existing_schema_columns": {
      "warranties": [
        "id", "organizationId", "warrantyNumber", "customerId", "orderId", "orderItemId",
        "productId", "inventoryItemId", "serialNumber", "installationDate", "expiryDate",
        "installerName", "installerCompany", "siteAddress", "status", "originalCustomerId",
        "transferredAt", "transferReason", "notes", "createdByUserId", "updatedByUserId",
        "createdAt", "updatedAt", "version"
      ]
    },
    "missing_tables": [
      "warranty_policies - for configurable terms per product/category",
      "warranty_extensions - for tracking warranty extensions",
      "warranty_claims - for formal claim workflow (currently uses issues table)"
    ],
    "missing_columns": [
      "warranties.policyId - link to warranty policy",
      "products.warrantyPolicyId - default warranty policy for product",
      "categories.defaultWarrantyPolicyId - default policy for category"
    ],
    "related_schema": {
      "issues": "Has warrantyId FK - used for warranty claims. Columns: type (claim, question, return, other), resolutionType (closed, replaced, refunded, repaired)"
    }
  },
  "prd_claims_verified": [
    "Warranty registration - VERIFIED (createWarranty with auto expiry calculation)",
    "Warranty lookup by serial number - VERIFIED (listWarranties with search on warrantyNumber and serialNumber)",
    "Basic warranty claims via issues - VERIFIED (issues.warrantyId FK, issue type 'claim' with resolutionType)",
    "Warranty transfer between owners - VERIFIED (transferWarranty with originalCustomerId tracking)",
    "Warranty list with filters - VERIFIED (status, expiringSoon, search, customerId filters)"
  ],
  "prd_claims_invalid": [
    "DOM-WAR-002: Add Auto-Registration from Order - PARTIALLY IMPLEMENTED. autoRegisterWarranties trigger job exists in warranty-jobs.ts and runs on order delivery. However, customer notification is not fully wired up.",
    "DOM-WAR-003: Add Warranty Expiry Alerts - PARTIALLY IMPLEMENTED. checkExpiringWarranties cron job runs daily at 9 AM and finds expiring warranties. However, it only logs to console - does not create notification records, send emails, or show dashboard widget."
  ],
  "actual_features_not_in_prd": [
    "Warranty confirmation email triggered on registration",
    "Warranty metrics on list page (active warranties, expiring soon, open issues, resolved issues)",
    "Batch defect tracking (batchDefectCount, batchWarrantyCount in list query)",
    "Warranty report with date range filtering",
    "Email history dialog on warranty detail",
    "CSV export of warranties",
    "Floating action button for quick registration",
    "Concurrency conflict handling on update"
  ],
  "stories_status": {
    "DOM-WAR-001": {
      "name": "Add Warranty Policies",
      "status": "valid",
      "change": "atomize",
      "reason": "Story spans 3 layers: new schema table + server functions + UI in settings and product forms. Must create warranty_policies table, link to products/categories, and build management UI.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": {
        "original": 3,
        "recommended_total": 12,
        "breakdown": {
          "schema": 3,
          "server": 4,
          "ui": 5
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "missing_files": [
          "lib/schema/warranty-policies.ts",
          "lib/schemas/warranty-policies.ts",
          "src/server/functions/warranty-policies.ts",
          "src/components/domain/settings/warranty-policy-manager.tsx"
        ]
      }
    },
    "DOM-WAR-002": {
      "name": "Add Auto-Registration from Order",
      "status": "partial",
      "change": "reduce_scope",
      "reason": "PARTIALLY IMPLEMENTED. autoRegisterWarranties trigger job exists and runs on order delivery. It registers warranties using delivery date, serial numbers from allocated inventory, and order customer. Missing: customer notification email. Recommend story focuses only on completing the notification piece.",
      "layers": ["server", "notification"],
      "estimated_iterations": {
        "original": 4,
        "recommended_total": 2,
        "breakdown": {
          "notification_completion": 2
        }
      },
      "existing_implementation": {
        "trigger_job": "autoRegisterWarranties in warranty-jobs.ts",
        "features": [
          "Triggers on order status change to delivered",
          "Uses order customerId as warranty owner",
          "Extracts serial numbers from allocatedSerials",
          "Uses deliveredDate as installation date",
          "Skips if warranty already exists",
          "Race condition prevention"
        ]
      },
      "remaining_work": [
        "Wire up customer notification email after auto-registration",
        "Ensure warranty confirmation email template is sent"
      ]
    },
    "DOM-WAR-003": {
      "name": "Add Warranty Expiry Alerts",
      "status": "partial",
      "change": "reduce_scope",
      "reason": "PARTIALLY IMPLEMENTED. checkExpiringWarranties scheduled job runs daily and finds warranties expiring in 30 days. However, it only logs to console. Missing: notification records, customer emails, internal alerts, dashboard widget, expiring warranties report, opt-out. Recommend atomizing into separate stories.",
      "layers": ["server", "notification", "UI"],
      "estimated_iterations": {
        "original": 4,
        "recommended_total": 10,
        "breakdown": {
          "notification_creation": 3,
          "dashboard_widget": 3,
          "report_page": 2,
          "opt_out": 2
        }
      },
      "existing_implementation": {
        "trigger_job": "checkExpiringWarranties in warranty-jobs.ts",
        "features": [
          "Daily cron at 9 AM",
          "Finds active warranties expiring in next 30 days",
          "Groups by organization",
          "Calculates days until expiry"
        ]
      },
      "remaining_work": [
        "Create notification records (internal + email)",
        "Dashboard widget for expiring warranties",
        "Dedicated expiring warranties report page",
        "Opt-out setting per warranty/customer"
      ]
    },
    "DOM-WAR-004": {
      "name": "Add Warranty Certificate",
      "status": "valid",
      "change": "atomize",
      "reason": "New feature requiring PDF generation, template design, QR code, and email integration. Depends on DOM-WAR-001 for policy terms display.",
      "layers": ["server", "pdf-generation", "UI"],
      "estimated_iterations": {
        "original": 4,
        "recommended_total": 12,
        "breakdown": {
          "pdf_template": 4,
          "server_generation": 3,
          "ui_download_email": 3,
          "qr_code": 2
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "missing_files": [
          "lib/pdf/warranty-certificate.ts",
          "src/server/functions/warranty-certificate.ts",
          "src/components/domain/support/warranty-certificate-preview.tsx"
        ]
      },
      "technical_notes": "Consider using @react-pdf/renderer or similar for PDF generation. QR code should link to /warranty-lookup?number=WRR-XXXX-XXXX"
    },
    "DOM-WAR-005": {
      "name": "Enhance Bulk Warranty Registration",
      "status": "partial",
      "change": "adjust_scope",
      "reason": "PARTIALLY IMPLEMENTED. BulkWarrantyRegister component exists for registering from orders. Missing: standalone bulk registration dialog with CSV upload for ad-hoc registration (not tied to orders).",
      "layers": ["server", "UI"],
      "estimated_iterations": {
        "original": 4,
        "recommended_total": 6,
        "breakdown": {
          "csv_upload_server": 3,
          "ui_dialog": 3
        }
      },
      "existing_implementation": {
        "component": "BulkWarrantyRegister",
        "features": [
          "Register warranties from order items",
          "Shows items already registered vs items to register",
          "Installation date and installer info",
          "Progress feedback"
        ]
      },
      "remaining_work": [
        "CSV file upload for bulk registration",
        "Serial number validation against inventory",
        "Single customer assignment for batch",
        "Progress indicator for large batches",
        "Summary of registered vs errors"
      ]
    },
    "DOM-WAR-006": {
      "name": "Add Warranty Claim Workflow",
      "status": "valid",
      "change": "atomize",
      "reason": "Currently warranty claims go through issues table. This story adds formal claim workflow with approval for high value, claim impact on warranty (restart period), and claim history. Significant complexity.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": {
        "original": 5,
        "recommended_total": 15,
        "breakdown": {
          "schema": 3,
          "server_workflow": 5,
          "ui_claim_creation": 3,
          "ui_approval": 2,
          "ui_history": 2
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "missing_files": [
          "lib/schema/warranty-claims.ts",
          "lib/schemas/warranty-claims.ts",
          "src/server/functions/warranty-claims.ts",
          "src/components/domain/support/warranty-claim-form.tsx",
          "src/components/domain/support/claim-approval-dialog.tsx"
        ]
      },
      "technical_notes": "Consider whether to create new warranty_claims table or enhance issues table with claim-specific fields. Approval workflow needs role-based permission check."
    },
    "DOM-WAR-007": {
      "name": "Add Warranty Extensions",
      "status": "valid",
      "change": "atomize",
      "reason": "New feature requiring schema for extension tracking, approval workflow, and UI components. Depends on DOM-WAR-001 for policy-based extension rules.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": {
        "original": 3,
        "recommended_total": 9,
        "breakdown": {
          "schema": 2,
          "server": 3,
          "ui": 4
        }
      },
      "acceptance_criteria_review": {
        "testable": true,
        "file_referenced": false,
        "missing_files": [
          "lib/schema/warranty-extensions.ts",
          "lib/schemas/warranty-extensions.ts",
          "src/server/functions/warranty-extensions.ts",
          "src/components/domain/support/extend-warranty-dialog.tsx"
        ]
      }
    },
    "DOM-WAR-008": {
      "name": "Create Warranty Analytics",
      "status": "valid",
      "change": "adjust_scope",
      "reason": "Basic warranty report exists at /reports/warranties. This story adds deeper analytics: claims rate by product, trend analysis, cost tracking. Depends on DOM-WAR-006 for accurate claim cost data.",
      "layers": ["server", "UI"],
      "estimated_iterations": {
        "original": 4,
        "recommended_total": 8,
        "breakdown": {
          "server_analytics": 4,
          "ui_charts": 4
        }
      },
      "existing_implementation": {
        "route": "/reports/warranties",
        "features": [
          "Summary cards: total, active, expiring soon, claim rate",
          "Table of warranties with date filtering",
          "CSV export"
        ]
      },
      "remaining_work": [
        "Claims by product for quality insights",
        "Trend analysis charts over time",
        "Warranty revenue vs claims cost (if extended warranties sold)",
        "Export data for further analysis"
      ]
    }
  },
  "recommended_stories": [
    {
      "id": "DOM-WAR-001a",
      "name": "Warranty Policies Schema",
      "description": "Create warranty_policies table and add FK columns to products and categories",
      "layers": ["schema"],
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "warranty_policies table created with (id, organizationId, name, durationMonths, terms JSONB, isDefault, createdAt, updatedAt)",
        "products.warrantyPolicyId FK added (nullable)",
        "categories.defaultWarrantyPolicyId FK added (nullable)",
        "Indexes on organizationId, isDefault",
        "Types exported from lib/schema/index.ts",
        "Migration file created",
        "TypeScript compiles without errors"
      ]
    },
    {
      "id": "DOM-WAR-001b",
      "name": "Warranty Policies Server Functions",
      "description": "Implement warranty policy CRUD and resolution logic",
      "dependencies": ["DOM-WAR-001a"],
      "layers": ["server"],
      "estimated_iterations": 4,
      "acceptance_criteria": [
        "createWarrantyPolicy, updateWarrantyPolicy, deleteWarrantyPolicy functions",
        "listWarrantyPolicies function with organizationId filter",
        "getDefaultPolicy function - returns org default policy",
        "resolveWarrantyPolicy(productId) returns: product > category > org default policy",
        "calculateWarrantyExpiry updated to use policy duration",
        "Validation schemas in lib/schemas/warranty-policies.ts",
        "TypeScript compiles without errors"
      ]
    },
    {
      "id": "DOM-WAR-001c",
      "name": "Warranty Policies UI",
      "description": "Add warranty policy management in settings and display on warranty detail",
      "dependencies": ["DOM-WAR-001b"],
      "layers": ["UI"],
      "estimated_iterations": 5,
      "acceptance_criteria": [
        "Warranty Policy management page in Settings",
        "Create/edit/delete policy with name, duration, terms",
        "Set default policy toggle",
        "Product form shows warranty policy selector",
        "Category form shows default warranty policy selector",
        "Warranty detail page displays policy terms",
        "Warranty form auto-calculates expiry from policy",
        "TypeScript compiles without errors"
      ]
    },
    {
      "id": "DOM-WAR-002a",
      "name": "Complete Auto-Registration Notifications",
      "description": "Wire up customer notification after auto-registration from order delivery",
      "layers": ["notification"],
      "estimated_iterations": 2,
      "acceptance_criteria": [
        "autoRegisterWarranties job sends warranty confirmation email to customer",
        "Email uses WarrantyRegistered template with warranty details",
        "Notification record created for each registered warranty",
        "Skip notification if customer has no primary contact email",
        "TypeScript compiles without errors"
      ]
    },
    {
      "id": "DOM-WAR-003a",
      "name": "Expiry Alerts - Notification Creation",
      "description": "Create notification records when expiring warranties are found",
      "layers": ["server", "notification"],
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "checkExpiringWarranties creates internal notification records",
        "Email sent to customer at 30/60/90 day intervals (configurable)",
        "Internal alert created for assigned sales rep or account manager",
        "Renewal option link included in notification",
        "TypeScript compiles without errors"
      ]
    },
    {
      "id": "DOM-WAR-003b",
      "name": "Expiry Alerts - Dashboard Widget",
      "description": "Add expiring warranties widget to dashboard",
      "dependencies": ["DOM-WAR-003a"],
      "layers": ["UI"],
      "estimated_iterations": 3,
      "acceptance_criteria": [
        "Dashboard widget showing warranties expiring in next 30 days",
        "Click through to warranty detail",
        "Shows warranty number, customer, expiry date",
        "Sorted by expiry date ascending",
        "TypeScript compiles without errors"
      ]
    },
    {
      "id": "DOM-WAR-003c",
      "name": "Expiry Alerts - Report Page",
      "description": "Dedicated report page for expiring warranties",
      "layers": ["UI"],
      "estimated_iterations": 2,
      "acceptance_criteria": [
        "Route at /reports/expiring-warranties",
        "Filters: expiry range (7/30/60/90 days), customer, product",
        "Table with warranty details and days until expiry",
        "CSV export",
        "TypeScript compiles without errors"
      ]
    },
    {
      "id": "DOM-WAR-003d",
      "name": "Expiry Alerts - Opt-Out Setting",
      "description": "Allow opt-out of expiry notifications per warranty or customer",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": 2,
      "acceptance_criteria": [
        "warranties.expiryAlertOptOut boolean column",
        "customers.warrantyExpiryAlertOptOut boolean column",
        "Opt-out toggle on warranty detail page",
        "Opt-out toggle on customer settings",
        "checkExpiringWarranties respects opt-out",
        "TypeScript compiles without errors"
      ]
    }
  ],
  "atomization_notes": {
    "DOM-WAR-001": "Split into 3 stories: schema (3 iterations), server (4), UI (5) = 12 total",
    "DOM-WAR-002": "Reduce to 1 story (2 iterations) - only notification completion needed",
    "DOM-WAR-003": "Split into 4 stories: notification creation (3), dashboard widget (3), report page (2), opt-out (2) = 10 total",
    "DOM-WAR-004": "Split into 4 stories: PDF template (4), server generation (3), UI (3), QR code (2) = 12 total",
    "DOM-WAR-005": "Adjust scope - only CSV upload needed (6 iterations)",
    "DOM-WAR-006": "Split into 5 stories: schema (3), server workflow (5), claim creation UI (3), approval UI (2), history UI (2) = 15 total",
    "DOM-WAR-007": "Split into 3 stories: schema (2), server (3), UI (4) = 9 total",
    "DOM-WAR-008": "Adjust scope - keep as single story with reduced scope (8 iterations)"
  },
  "priority_recommendation": [
    {
      "priority": 1,
      "story": "DOM-WAR-002a",
      "reason": "Low effort (2 iterations) to complete existing auto-registration feature. Quick win."
    },
    {
      "priority": 2,
      "story": "DOM-WAR-001",
      "reason": "Warranty policies are foundational - many other features depend on policy terms (certificates, extensions, claim rules)."
    },
    {
      "priority": 3,
      "story": "DOM-WAR-003",
      "reason": "Expiry alerts enable proactive customer engagement and renewal opportunities. High business value."
    },
    {
      "priority": 4,
      "story": "DOM-WAR-006",
      "reason": "Formal claim workflow improves support quality and tracking. Currently claims go through generic issues."
    },
    {
      "priority": 5,
      "story": "DOM-WAR-004",
      "reason": "Certificates provide professional documentation for customers. Depends on policies."
    },
    {
      "priority": 6,
      "story": "DOM-WAR-007",
      "reason": "Extensions provide upsell opportunity. Depends on policies."
    },
    {
      "priority": 7,
      "story": "DOM-WAR-005",
      "reason": "CSV bulk upload is enhancement - order-based bulk registration already works."
    },
    {
      "priority": 8,
      "story": "DOM-WAR-008",
      "reason": "Analytics enhancement - basic report already exists. Defer until claim workflow complete for accurate cost data."
    }
  ],
  "dependencies_graph": {
    "DOM-WAR-001": {
      "depends_on": [],
      "required_by": ["DOM-WAR-002", "DOM-WAR-004", "DOM-WAR-007"]
    },
    "DOM-WAR-002": {
      "depends_on": ["DOM-WAR-001"],
      "required_by": []
    },
    "DOM-WAR-003": {
      "depends_on": [],
      "required_by": []
    },
    "DOM-WAR-004": {
      "depends_on": ["DOM-WAR-001"],
      "required_by": []
    },
    "DOM-WAR-005": {
      "depends_on": [],
      "required_by": []
    },
    "DOM-WAR-006": {
      "depends_on": [],
      "required_by": ["DOM-WAR-008"]
    },
    "DOM-WAR-007": {
      "depends_on": ["DOM-WAR-001"],
      "required_by": []
    },
    "DOM-WAR-008": {
      "depends_on": ["DOM-WAR-006"],
      "required_by": []
    }
  },
  "execution_order_recommendation": [
    "DOM-WAR-002a (Complete auto-registration notifications) - 2 iterations",
    "DOM-WAR-001a (Warranty Policies Schema) - 3 iterations",
    "DOM-WAR-001b (Warranty Policies Server) - 4 iterations",
    "DOM-WAR-001c (Warranty Policies UI) - 5 iterations",
    "DOM-WAR-003a (Expiry Alerts - Notification Creation) - 3 iterations",
    "DOM-WAR-003b (Expiry Alerts - Dashboard Widget) - 3 iterations",
    "DOM-WAR-003c (Expiry Alerts - Report Page) - 2 iterations",
    "DOM-WAR-003d (Expiry Alerts - Opt-Out) - 2 iterations",
    "DOM-WAR-006 (Warranty Claim Workflow) - 15 iterations across 5 substories",
    "DOM-WAR-004 (Warranty Certificate) - 12 iterations across 4 substories",
    "DOM-WAR-007 (Warranty Extensions) - 9 iterations across 3 substories",
    "DOM-WAR-005 (CSV Bulk Registration) - 6 iterations across 2 substories",
    "DOM-WAR-008 (Warranty Analytics) - 8 iterations"
  ]
}
