{
  "prd_id": "DOM-FINANCIAL",
  "audit_date": "2026-01-09",
  "auditor": "Claude Opus 4.5",
  "summary": {
    "total_stories": 8,
    "verified_gaps": 6,
    "invalidated_gaps": 0,
    "partially_implemented": 2,
    "implementation_status": "Foundation exists with invoice management, payment recording, and basic Xero sync. Missing credit notes, payment plans, AR aging, statements, automated reminders, and revenue recognition."
  },
  "codebase_findings": {
    "schema_files": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/orders.ts",
        "description": "Orders table with invoice fields (invoiceStatus, invoiceNumber, issueDate, dueDate, invoiceNotes, pdfPath). Includes orderMilestones table for milestone billing.",
        "key_fields": ["invoiceStatus", "invoiceNumber", "paymentStatus", "xeroInvoiceId", "xeroSyncedAt"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/index.ts",
        "description": "Schema index - no dedicated credit_notes, payment_schedules, or statements tables exist"
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schemas/financial.ts",
        "description": "Validation schemas for financial operations including invoices, payments, reconciliation, and reports. Has GetFinancialReportsSchema with 'aging' report type stub."
      }
    ],
    "server_functions": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/invoices.ts",
        "description": "Invoice generation, status updates, PDF creation. INVOICE_STATUSES enum (draft, sent, overdue, paid, cancelled).",
        "exports": ["generateInvoice", "updateInvoiceStatus", "getInvoice", "listInvoices", "sendInvoice"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/financial.ts",
        "description": "Financial overview metrics, invoice listing with filters, invoice details. listPayments and recordPayment functions are TODO commented out.",
        "exports": ["getFinancialOverview", "listInvoices", "getInvoiceDetails"],
        "todos": ["listPayments (commented)", "recordPayment (commented)", "recordStandalonePayment (commented)"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/xero.ts",
        "description": "Xero OAuth, customer/product sync, invoice creation/sync triggers.",
        "exports": ["getXeroConnectionStatus", "buildXeroAuthUrl", "connectXero", "disconnectXero", "syncCustomerToXero", "syncProductToXero", "createInvoiceFromOrder", "syncInvoiceStatus"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/xero-tasks.ts",
        "description": "Trigger.dev task wrappers for async Xero operations.",
        "exports": ["triggerSyncCustomerToXero", "triggerSyncAllCustomersToXero", "triggerSyncProductToXero", "triggerSyncAllProductsToXero", "triggerCreateInvoiceFromOrder", "triggerSyncInvoiceStatus"]
      }
    ],
    "components": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/financial/financial-dashboard.tsx",
        "description": "Main financial dashboard with tabs: Invoices, Payments, Reconciliation, Reports. Has metrics summary (outstanding, overdue, paid this month, avg collection days)."
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/financial/invoices-tab.tsx",
        "description": "Invoice list with filters (search, status), bulk actions, pagination. Has 'Send Reminders' button (not implemented)."
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/financial/invoice-detail-sidebar.tsx",
        "description": "Invoice detail view with customer info, line items, totals. Has Send Reminder, Download PDF, Process Payment buttons."
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/financial/payments-tab.tsx",
        "description": "Payment recording UI with form. Uses mock data - recordPayment mutation is placeholder."
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/financial/reconciliation-tab.tsx",
        "description": "Placeholder - not implemented"
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/financial/reports-tab.tsx",
        "description": "Placeholder - shows 'Coming Soon'"
      }
    ],
    "routes": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/routes/financial/index.tsx",
        "description": "Financial page with tab-based navigation. Loads overview metrics and invoice data. Payments tab uses mock data."
      }
    ],
    "missing_schemas": [
      "credit_notes table - Not found",
      "payment_schedules table - Not found (orderMilestones exists for milestone billing)",
      "payment_reminders/reminder_history table - Not found",
      "statements table - Not found",
      "revenue_recognition table - Not found"
    ]
  },
  "stories_status": {
    "DOM-FIN-001": {
      "name": "Add Credit Notes",
      "status": "valid",
      "change": "atomize",
      "reason": "No credit_notes table exists. No credit note functionality found anywhere. Full implementation needed.",
      "layers": ["schema", "server", "ui"],
      "estimated_iterations": {
        "schema": 2,
        "server": 3,
        "ui": 4
      },
      "total_estimated_iterations": 9,
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "All criteria are testable. Xero sync for credit notes should be separate story or optional."
    },
    "DOM-FIN-002": {
      "name": "Add Payment Plans",
      "status": "valid",
      "change": "atomize",
      "reason": "orderMilestones table exists for milestone billing but no payment_schedules table. No preset plans (50/50, thirds, monthly) implementation. Needs new schema and full UI.",
      "layers": ["schema", "server", "ui"],
      "estimated_iterations": {
        "schema": 2,
        "server": 3,
        "ui": 4
      },
      "total_estimated_iterations": 9,
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "Consider leveraging orderMilestones or creating dedicated payment_schedules table."
    },
    "DOM-FIN-003": {
      "name": "Add Accounts Receivable Aging",
      "status": "valid",
      "change": "atomize",
      "reason": "GetFinancialReportsSchema has 'aging' type stub but no implementation. ReportsTab is placeholder. getFinancialOverview has basic overdue amount but no aging buckets.",
      "layers": ["server", "ui"],
      "estimated_iterations": {
        "server": 3,
        "ui": 4
      },
      "total_estimated_iterations": 7,
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "No schema changes needed - can compute from existing orders/invoices data."
    },
    "DOM-FIN-004": {
      "name": "Add Customer Statements",
      "status": "valid",
      "change": "atomize",
      "reason": "No statement generation functionality exists. No statement history table. Would need PDF generation extension.",
      "layers": ["schema", "server", "ui"],
      "estimated_iterations": {
        "schema": 1,
        "server": 4,
        "ui": 3
      },
      "total_estimated_iterations": 8,
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "Statement PDF could reuse invoice PDF generation patterns."
    },
    "DOM-FIN-005": {
      "name": "Complete Xero Invoice Sync",
      "status": "partially_implemented",
      "change": "refine",
      "reason": "createInvoiceFromOrder and syncInvoiceStatus exist via Trigger.dev. xeroInvoiceId and xeroSyncedAt fields exist on orders. Missing: automatic push on creation, pull payment updates, error handling UI, manual re-sync button.",
      "layers": ["server", "ui"],
      "estimated_iterations": {
        "server": 3,
        "ui": 2
      },
      "total_estimated_iterations": 5,
      "existing_implementation": {
        "functions": ["createInvoiceFromOrder", "syncInvoiceStatus", "triggerCreateInvoiceFromOrder", "triggerSyncInvoiceStatus"],
        "schema_fields": ["xeroInvoiceId", "xeroSyncedAt"],
        "ui": "Invoice detail shows Xero Invoice ID if present"
      },
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "Focus on gaps: auto-push, error handling, UI indicators."
    },
    "DOM-FIN-006": {
      "name": "Add Payment Reminders",
      "status": "valid",
      "change": "atomize",
      "reason": "No reminder templates, reminder history, or Trigger.dev jobs for reminders. SendInvoiceReminderSchema exists but no implementation. UI has 'Send Reminder' button without functionality.",
      "layers": ["schema", "server", "ui"],
      "estimated_iterations": {
        "schema": 2,
        "server": 4,
        "ui": 3
      },
      "total_estimated_iterations": 9,
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "Leverage existing email infrastructure. 'Escalation to phone call' may be out of scope for v1."
    },
    "DOM-FIN-007": {
      "name": "Create Financial Dashboard",
      "status": "partially_implemented",
      "change": "refine",
      "reason": "FinancialDashboard exists with metrics summary (outstanding, overdue, paid, avg collection days). Missing: revenue chart by period, top customers by revenue, outstanding invoices widget, quick actions.",
      "layers": ["server", "ui"],
      "estimated_iterations": {
        "server": 2,
        "ui": 4
      },
      "total_estimated_iterations": 6,
      "existing_implementation": {
        "component": "financial-dashboard.tsx with MetricsSummary",
        "metrics": ["outstandingInvoices", "overdueAmount", "paidThisMonth", "avgCollectionDays"],
        "tabs": ["Invoices", "Payments", "Reconciliation", "Reports"]
      },
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "Dashboard structure exists. Enhance with charts and widgets. Depends on DOM-FIN-003 for AR widget."
    },
    "DOM-FIN-008": {
      "name": "Add Revenue Recognition",
      "status": "valid",
      "change": "atomize",
      "reason": "No revenue recognition schema, logic, or UI exists. Would need new tables for deferred revenue, recognition schedules.",
      "layers": ["schema", "server", "ui"],
      "estimated_iterations": {
        "schema": 3,
        "server": 4,
        "ui": 4
      },
      "total_estimated_iterations": 11,
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "Complex accounting feature. Consider breaking into smaller stories. Xero account sync adds dependency complexity."
    }
  },
  "recommended_stories": [
    "DOM-FIN-005",
    "DOM-FIN-007",
    "DOM-FIN-003",
    "DOM-FIN-006",
    "DOM-FIN-001",
    "DOM-FIN-002",
    "DOM-FIN-004",
    "DOM-FIN-008"
  ],
  "recommended_stories_rationale": "Prioritize completing partially implemented features (Xero sync, Dashboard) first for quick wins. Then AR aging as it's pure computation. Reminders add immediate business value. Credit notes, payment plans, statements are full features. Revenue recognition is most complex.",
  "atomization_notes": {
    "DOM-FIN-001": {
      "suggested_split": [
        {
          "id": "DOM-FIN-001-A",
          "name": "Credit Notes Schema",
          "layers": ["schema"],
          "iterations": 2,
          "scope": "credit_notes table, relations, migration"
        },
        {
          "id": "DOM-FIN-001-B",
          "name": "Credit Notes Server Functions",
          "layers": ["server"],
          "iterations": 3,
          "scope": "CRUD operations, apply to invoice balance, history"
        },
        {
          "id": "DOM-FIN-001-C",
          "name": "Credit Notes UI",
          "layers": ["ui"],
          "iterations": 4,
          "scope": "Create form, list view, detail view, PDF generation"
        }
      ]
    },
    "DOM-FIN-002": {
      "suggested_split": [
        {
          "id": "DOM-FIN-002-A",
          "name": "Payment Plans Schema",
          "layers": ["schema"],
          "iterations": 2,
          "scope": "payment_schedules table or extend orderMilestones"
        },
        {
          "id": "DOM-FIN-002-B",
          "name": "Payment Plans Server Functions",
          "layers": ["server"],
          "iterations": 3,
          "scope": "Create plan, preset templates, track payments"
        },
        {
          "id": "DOM-FIN-002-C",
          "name": "Payment Plans UI",
          "layers": ["ui"],
          "iterations": 4,
          "scope": "Plan creation wizard, invoice integration, alerts"
        }
      ]
    },
    "DOM-FIN-003": {
      "suggested_split": [
        {
          "id": "DOM-FIN-003-A",
          "name": "AR Aging Server Function",
          "layers": ["server"],
          "iterations": 3,
          "scope": "Compute aging buckets, customer summary, drill-down data"
        },
        {
          "id": "DOM-FIN-003-B",
          "name": "AR Aging Report UI",
          "layers": ["ui"],
          "iterations": 4,
          "scope": "Report page, table with buckets, CSV/PDF export, dashboard widget"
        }
      ]
    },
    "DOM-FIN-006": {
      "suggested_split": [
        {
          "id": "DOM-FIN-006-A",
          "name": "Reminder Templates Schema",
          "layers": ["schema"],
          "iterations": 2,
          "scope": "reminder_templates, reminder_history tables"
        },
        {
          "id": "DOM-FIN-006-B",
          "name": "Auto Reminders Backend",
          "layers": ["server"],
          "iterations": 4,
          "scope": "Trigger.dev job, template logic, opt-out handling"
        },
        {
          "id": "DOM-FIN-006-C",
          "name": "Reminders UI",
          "layers": ["ui"],
          "iterations": 3,
          "scope": "Template management, reminder history, manual send"
        }
      ]
    },
    "DOM-FIN-008": {
      "suggested_split": [
        {
          "id": "DOM-FIN-008-A",
          "name": "Revenue Recognition Schema",
          "layers": ["schema"],
          "iterations": 3,
          "scope": "revenue_recognition, deferred_revenue tables"
        },
        {
          "id": "DOM-FIN-008-B",
          "name": "Recognition Engine",
          "layers": ["server"],
          "iterations": 4,
          "scope": "Recognition logic, milestone triggers, schedules"
        },
        {
          "id": "DOM-FIN-008-C",
          "name": "Revenue Reports UI",
          "layers": ["ui"],
          "iterations": 4,
          "scope": "Recognition report, deferred revenue report, period views"
        }
      ]
    }
  },
  "implementation_gaps_detail": {
    "payment_recording": {
      "status": "incomplete",
      "ui_exists": true,
      "server_function": "commented out (recordPayment, recordStandalonePayment)",
      "notes": "PaymentsTab has UI but uses mock data. Server functions are TODO commented."
    },
    "reports_tab": {
      "status": "placeholder",
      "notes": "ReportsTab shows 'Coming Soon'. No actual report implementation."
    },
    "reconciliation_tab": {
      "status": "placeholder",
      "notes": "ReconciliationTab placeholder exists. No implementation."
    },
    "xero_credit_notes": {
      "status": "not_started",
      "notes": "Xero sync exists for invoices but credit notes would need additional API integration."
    }
  },
  "prd_corrections": {
    "references": {
      "current": [
        "lib/schema/invoices.ts - Invoice schema",
        "lib/schemas/financial.ts - Validation schemas",
        "src/server/functions/financial.ts - Server functions"
      ],
      "corrected": [
        "lib/schema/orders.ts - Order/Invoice schema (no separate invoices schema)",
        "lib/schemas/financial.ts - Validation schemas (exists)",
        "src/server/functions/invoices.ts - Invoice generation functions",
        "src/server/functions/financial.ts - Financial overview/listing functions",
        "src/server/functions/xero.ts - Xero integration functions",
        "src/components/domain/financial/ - UI components"
      ]
    },
    "current_state_adjustments": {
      "implemented": {
        "accurate": [
          "Invoice generation from orders",
          "Invoice PDF generation",
          "Basic Xero contact sync",
          "Invoice list with filters"
        ],
        "needs_clarification": [
          "Payment recording - UI exists but server function commented out"
        ]
      }
    }
  }
}
