{
  "prd_id": "ROLE-SALES",
  "audit_date": "2026-01-09",
  "auditor": "Claude Opus 4.5",
  "summary": {
    "total_stories": 8,
    "verified_gaps": 4,
    "invalidated_gaps": 3,
    "partially_implemented": 1,
    "implementation_status": "Several sales-specific features already exist: Global search with Cmd+K (command-palette.tsx), pipeline Kanban view (pipeline/index.tsx), customer hover preview cards (entity-preview-card.tsx), follow-up dialog for opportunities (follow-up-dialog.tsx), and sales-focused dashboard defaults (role-defaults.ts). Key gaps: No guided quote wizard with timer, no dedicated sales dashboard with forecasting, no quote templates library, no quote expiry alerts widget."
  },
  "codebase_findings": {
    "schema_files": [
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/opportunities.ts - Opportunity schema with quoteExpiresAt field exists",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/customers.ts - Customer schema for 360 view data"
    ],
    "server_functions": [
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/pipeline.ts - listOpportunities, createOpportunity, updateOpportunity, sendOpportunityQuoteEmail",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/search.ts - Global search across entities",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/entity-preview.ts - getEntityPreview for hover cards",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/customers.ts - getCustomer, getCustomerSummary with lifetime value"
    ],
    "components": [
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/layout/command-palette.tsx - Full Cmd+K global search with recent searches, favorites, quick actions",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/shared/entity-preview-card.tsx - HoverCard for customer/order/product previews with stats",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/pipeline/follow-up-dialog.tsx - Send follow-up emails with templates",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/pipeline/opportunity-panel.tsx - Quote builder with line items",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/pipeline/quote-builder.tsx - Build quotes with products",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/pipeline/opportunity-card.tsx - Shows quote expiry status on cards",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/dashboard/role-defaults.ts - Sales role default dashboard layout",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/ai/canvas/sales-dashboard-canvas.tsx - AI-generated sales dashboard canvas"
    ],
    "routes": [
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/routes/pipeline/index.tsx - Full pipeline Kanban with drag-drop, filters, metrics",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/routes/reports/sales.tsx - Sales report page with revenue, orders, margin",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/routes/customers/$customerId.tsx - Customer detail with tabs",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/routes/settings/templates.tsx - Document templates for quotes/orders"
    ],
    "existing_features": {
      "global_search": {
        "cmd_k_shortcut": "IMPLEMENTED - command-palette.tsx line 134: e.key === 'k' && (e.metaKey || e.ctrlKey)",
        "search_entities": "IMPLEMENTED - searches customers, orders, products, opportunities, warranties",
        "search_speed": "IMPLEMENTED - React Query with debounce, results render immediately",
        "recent_searches": "IMPLEMENTED - localStorage COMMAND_HISTORY_KEY stores last 5 searches",
        "keyboard_navigation": "IMPLEMENTED - CommandItem components with keyboard nav built-in",
        "direct_navigation": "IMPLEMENTED - handleSelect navigates directly to entity detail"
      },
      "customer_360": {
        "hover_preview": "IMPLEMENTED - EntityPreviewCard shows stats on hover with 300ms delay",
        "customer_stats": "IMPLEMENTED - CustomerPreviewContent shows: totalRevenue, openOrdersCount, activeWarrantiesCount",
        "quick_actions": "PARTIAL - Preview shows email/phone links but no New Quote quick action",
        "full_360_view": "PARTIAL - Customer detail has tabs but no metrics dashboard (see DOM-CUST-004a)"
      },
      "pipeline": {
        "kanban_view": "IMPLEMENTED - Full drag-drop Kanban with dnd-kit",
        "pipeline_metrics": "IMPLEMENTED - pipeline-metrics.tsx shows totals",
        "follow_up_dialog": "IMPLEMENTED - follow-up-dialog.tsx with email templates",
        "quote_expiry": "PARTIAL - quoteExpiresAt field exists, shown on cards, no expiry alerts widget"
      },
      "quote_creation": {
        "quote_builder": "IMPLEMENTED - quote-builder.tsx with line items, products, pricing",
        "gst_calculation": "IMPLEMENTED - Auto-calculates GST on totals",
        "quote_wizard": "NOT IMPLEMENTED - No step-by-step wizard with timer",
        "quote_templates": "NOT IMPLEMENTED - No template library (document templates exist but not quote product templates)"
      }
    }
  },
  "stories_status": {
    "ROLE-SALES-001": {
      "name": "Quote Creation Wizard (<5 min)",
      "status": "valid",
      "change": "modify",
      "reason": "Quote builder exists (quote-builder.tsx) but is not a step-by-step wizard. No timer visible during creation. Requires new wizard component wrapping existing functionality.",
      "layers": ["UI"],
      "estimated_iterations": 6,
      "dependencies_met": true,
      "acceptance_criteria_review": {
        "wizard_flow": "NOT IMPLEMENTED - Current flow is single-panel form, not step wizard",
        "steps_customer_products_pricing_review": "PARTIAL - All data captured but not in sequential steps",
        "customer_search_create_inline": "IMPLEMENTED - Customer selector exists in opportunity form",
        "product_quick_add": "IMPLEMENTED - quote-builder.tsx has product search with qty",
        "auto_calculate_gst": "IMPLEMENTED - GST calculated in quote builder",
        "preview_before_send": "PARTIAL - PDF preview exists but not in wizard flow",
        "timer_visible": "NOT IMPLEMENTED"
      },
      "recommendation": "Build wizard wrapper around existing quote-builder.tsx, add timer component, structure as multi-step flow"
    },
    "ROLE-SALES-002": {
      "name": "Global Quick Search",
      "status": "invalid",
      "change": "remove",
      "reason": "Already fully implemented. command-palette.tsx provides Cmd+K search across all entities with recent searches, favorites, keyboard navigation, and direct navigation.",
      "layers": [],
      "estimated_iterations": 0,
      "evidence": [
        "command-palette.tsx: Cmd+K opens CommandDialog",
        "Searches: customers, orders, products, opportunities, warranties",
        "React Query integration ensures <300ms response",
        "localStorage stores recent searches (COMMAND_HISTORY_KEY)",
        "CommandItem components provide keyboard navigation",
        "handleSelect navigates directly to result"
      ]
    },
    "ROLE-SALES-003": {
      "name": "Customer 360 Quick Access",
      "status": "partially_valid",
      "change": "reduce",
      "reason": "Hover card exists (entity-preview-card.tsx) and shows key stats. Missing: Quick actions (Call, Email, New Quote) and dependency on DOM-CUST-005 (customer 360 view with metrics dashboard).",
      "layers": ["UI"],
      "estimated_iterations": 2,
      "dependencies_met": false,
      "dependency_status": {
        "DOM-CUST-005": "NOT MET - Full 360 view with metrics dashboard not implemented (pending in customers.prd.json)"
      },
      "acceptance_criteria_review": {
        "hover_card_key_stats": "IMPLEMENTED - Shows totalRevenue, openOrdersCount, activeWarrantiesCount",
        "quick_actions": "NOT IMPLEMENTED - No Call/Email/New Quote buttons in hover card",
        "click_to_360": "IMPLEMENTED - Links to customer detail page",
        "360_load_time": "UNKNOWN - Depends on DOM-CUST-004a implementation"
      },
      "recommendation": "Add quick action buttons to EntityPreviewCard. Defer full 360 optimization until DOM-CUST-004a is complete."
    },
    "ROLE-SALES-004": {
      "name": "Pipeline Dashboard with Forecasting",
      "status": "valid",
      "change": "atomize",
      "reason": "Basic pipeline view exists but no weighted forecasting, no win probability, no dedicated sales landing page with forecasting visuals.",
      "layers": ["server", "UI"],
      "estimated_iterations": 5,
      "dependencies_met": false,
      "dependency_status": {
        "DOM-PIPE-001": "NOT MET - Probability field for weighted pipeline not implemented (pending in pipeline.prd.json)"
      },
      "acceptance_criteria_review": {
        "pipeline_as_landing": "NOT IMPLEMENTED - Dashboard is landing page, not pipeline",
        "value_by_stage": "IMPLEMENTED - pipeline-metrics.tsx shows totals by stage",
        "weighted_forecast": "NOT IMPLEMENTED - No probability field (depends on DOM-PIPE-001)",
        "aging_indicators": "NOT IMPLEMENTED - No time-in-stage display",
        "quick_filters": "IMPLEMENTED - PipelineFilters has assignedToUserId filter",
        "trend_comparison": "NOT IMPLEMENTED - No period comparison"
      },
      "recommendation": "Block on DOM-PIPE-001a/b (forecasting fields). Then build sales dashboard as separate route /sales that shows forecast-focused view.",
      "sub_stories": [
        {
          "id": "ROLE-SALES-004A",
          "name": "Sales Dashboard Route",
          "description": "Create /sales route as sales role landing page with pipeline focus",
          "layers": ["UI"],
          "estimated_iterations": 2,
          "acceptance_criteria": [
            "New route /sales created",
            "Sales role users land on this page by default",
            "Shows pipeline summary widgets",
            "TypeScript compiles without errors"
          ]
        },
        {
          "id": "ROLE-SALES-004B",
          "name": "Forecasting Widgets",
          "description": "Add weighted pipeline widgets (after DOM-PIPE-001 complete)",
          "layers": ["UI"],
          "estimated_iterations": 3,
          "dependencies": ["DOM-PIPE-001b"],
          "acceptance_criteria": [
            "Weighted pipeline total widget",
            "Forecast by month chart",
            "Aging opportunities highlight",
            "TypeScript compiles without errors"
          ]
        }
      ]
    },
    "ROLE-SALES-005": {
      "name": "Follow-up Reminders and Tasks",
      "status": "partially_valid",
      "change": "reduce",
      "reason": "Follow-up dialog exists for sending emails but no today's follow-ups widget, no follow-up date field on opportunities, no notification when due.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": 4,
      "acceptance_criteria_review": {
        "todays_followups_widget": "NOT IMPLEMENTED - No dashboard widget",
        "followup_date_field": "NOT IMPLEMENTED - No followUpDate on opportunities schema",
        "notification_when_due": "NOT IMPLEMENTED",
        "snooze_complete_actions": "NOT IMPLEMENTED",
        "overdue_highlighted": "NOT IMPLEMENTED",
        "log_followup_outcome": "PARTIAL - logOpportunityCall exists but not follow-up specific"
      },
      "recommendation": "This is a cross-layer story requiring schema changes. Consider splitting into: Schema (add followUpDate), Server (follow-up queries), UI (widget + form updates)."
    },
    "ROLE-SALES-006": {
      "name": "Quote Templates Library",
      "status": "valid",
      "change": "none",
      "reason": "No quote templates exist. Document templates (settings/templates.tsx) are for PDF header/footer customization, not product/pricing templates for quotes.",
      "layers": ["schema", "server", "UI"],
      "estimated_iterations": 4,
      "dependencies_met": true,
      "dependency_status": {
        "ROLE-SALES-001": "Can build templates independently but wizard integration depends on ROLE-SALES-001"
      },
      "acceptance_criteria_review": {
        "template_library_in_wizard": "NOT IMPLEMENTED",
        "templates_include_products": "NOT IMPLEMENTED",
        "create_template_from_quote": "NOT IMPLEMENTED",
        "apply_template": "NOT IMPLEMENTED",
        "templates_by_category": "NOT IMPLEMENTED"
      },
      "recommendation": "Full stack implementation needed: quote_templates schema, server CRUD, template selector UI in quote builder"
    },
    "ROLE-SALES-007": {
      "name": "Quote Expiry Alerts",
      "status": "valid",
      "change": "reduce",
      "reason": "quoteExpiresAt field exists and is shown on opportunity cards. Missing: dashboard widget, notification before expiry, quick extend action, bulk extend.",
      "layers": ["server", "UI"],
      "estimated_iterations": 3,
      "acceptance_criteria_review": {
        "dashboard_widget": "NOT IMPLEMENTED - No expiring quotes widget",
        "notification_3_days": "NOT IMPLEMENTED - No scheduled notification",
        "extend_quick_action": "NOT IMPLEMENTED - extendQuoteValidity function planned in DOM-PIPE-004a",
        "expired_auto_flagged": "PARTIAL - Cards show expired status via getExpiryBadgeVariant",
        "bulk_extend": "NOT IMPLEMENTED"
      },
      "recommendation": "Leverage DOM-PIPE-004a/b (Quote Validity Enforcement) from pipeline.prd.json for extend functionality. Add expiring quotes dashboard widget."
    },
    "ROLE-SALES-008": {
      "name": "Win/Loss Analysis View",
      "status": "valid",
      "change": "reduce",
      "reason": "No win/loss analysis exists. Depends on DOM-PIPE-005 (Win/Loss Reasons) for structured data.",
      "layers": ["server", "UI"],
      "estimated_iterations": 4,
      "dependencies_met": false,
      "dependency_status": {
        "DOM-PIPE-001": "NOT MET - No probability for calculating true win rates",
        "DOM-PIPE-005": "NOT MET - No winLossReasonId for structured analysis"
      },
      "acceptance_criteria_review": {
        "win_loss_report_page": "NOT IMPLEMENTED",
        "win_rate_by_dimensions": "NOT IMPLEMENTED",
        "loss_reasons_breakdown": "NOT IMPLEMENTED - Requires DOM-PIPE-005",
        "average_sales_cycle": "NOT IMPLEMENTED",
        "period_comparison": "NOT IMPLEMENTED"
      },
      "recommendation": "Block on DOM-PIPE-005 (Win/Loss Reasons schema and server). This story becomes a reports/analytics view once structured data exists."
    }
  },
  "recommended_stories": [
    {
      "id": "ROLE-SALES-001",
      "name": "Quote Creation Wizard",
      "priority": 1,
      "rationale": "Core sales productivity feature. Foundation (quote-builder) exists, needs wizard wrapper and timer. No external dependencies."
    },
    {
      "id": "ROLE-SALES-003",
      "name": "Customer 360 Quick Actions (Reduced)",
      "priority": 2,
      "rationale": "Quick win - just add action buttons to existing EntityPreviewCard. Low effort, high sales user value."
    },
    {
      "id": "ROLE-SALES-007",
      "name": "Quote Expiry Widget",
      "priority": 3,
      "rationale": "Visible value for sales users. Can build dashboard widget immediately, extend actions can follow DOM-PIPE-004."
    },
    {
      "id": "ROLE-SALES-006",
      "name": "Quote Templates Library",
      "priority": 4,
      "rationale": "Enables faster quote creation. Full stack but standalone - no domain dependencies."
    },
    {
      "id": "ROLE-SALES-004A",
      "name": "Sales Dashboard Route",
      "priority": 5,
      "rationale": "Foundation for sales landing page. Can start without forecasting, add weighted metrics when DOM-PIPE-001 complete."
    }
  ],
  "atomization_notes": {
    "ROLE-SALES-001": "Keep as single story - wizard is UI-only wrapping existing components. 6 iterations appropriate for multi-step flow with timer.",
    "ROLE-SALES-002": "REMOVE - Already fully implemented in command-palette.tsx",
    "ROLE-SALES-003": "REDUCE to 2 iterations - Just add quick action buttons to EntityPreviewCard. Full 360 depends on DOM-CUST-004a.",
    "ROLE-SALES-004": "SPLIT into 2 sub-stories: Route setup (2 iterations) + Forecasting widgets (3 iterations, blocked on DOM-PIPE-001)",
    "ROLE-SALES-005": "SPLIT into 3 sub-stories: Schema (2), Server (2), UI widget (2). Cross-layer story needs atomization.",
    "ROLE-SALES-006": "Keep as-is - 4 iterations for full stack template implementation",
    "ROLE-SALES-007": "REDUCE to 3 iterations - Widget only. Extend actions via DOM-PIPE-004.",
    "ROLE-SALES-008": "BLOCK on DOM-PIPE-005 - Cannot build meaningful win/loss analysis without structured reasons data"
  },
  "risk_assessment": {
    "invalid_stories": [
      "ROLE-SALES-002 (Global Quick Search) - Already implemented, remove from PRD"
    ],
    "blocked_stories": [
      "ROLE-SALES-004B (Forecasting Widgets) - Blocked on DOM-PIPE-001 (probability field)",
      "ROLE-SALES-008 (Win/Loss Analysis) - Blocked on DOM-PIPE-005 (win/loss reasons schema)"
    ],
    "cross_layer_stories": [
      "ROLE-SALES-005 (Follow-up Reminders) - Requires schema + server + UI",
      "ROLE-SALES-006 (Quote Templates) - Requires schema + server + UI"
    ],
    "dependencies_to_resolve": [
      "DOM-PIPE-001a/b/c (Forecasting Fields) - Required for ROLE-SALES-004B and ROLE-SALES-008",
      "DOM-PIPE-004a/b (Quote Validity Enforcement) - Required for ROLE-SALES-007 extend actions",
      "DOM-PIPE-005a/b/c (Win/Loss Reasons) - Required for ROLE-SALES-008",
      "DOM-CUST-004a (Enhanced 360 View) - Required for full ROLE-SALES-003"
    ],
    "technical_debt": [
      "command-palette.tsx: Some type assertions for favorites/recentlyViewed arrays",
      "follow-up-dialog.tsx: Email functionality commented out with TODO for server function migration"
    ]
  },
  "revised_story_count": {
    "remove": 1,
    "keep_as_is": 2,
    "reduce_scope": 3,
    "split_atomize": 2,
    "total_recommended": 10
  }
}
