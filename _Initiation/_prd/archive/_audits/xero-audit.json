{
  "prd_id": "INT-XERO",
  "audit_date": "2026-01-09",
  "auditor": "Claude Opus 4.5",
  "summary": {
    "total_stories": 8,
    "verified_gaps": 4,
    "invalidated_gaps": 0,
    "partially_implemented": 4,
    "implementation_status": "Solid foundation with OAuth 2.0 connection, bi-directional customer/product sync (push), invoice creation, webhook handling, and payment status sync. Missing: contact pull from Xero, credit note sync, sync error UI, sync history/logs, and dashboard widget."
  },
  "codebase_findings": {
    "schema_files": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/organizations.ts",
        "description": "Organizations table with Xero connection fields",
        "key_fields": ["xeroTenantId", "xeroConnectedAt", "settings.xero.tokens", "settings.xero.tenantName", "settings.xero.lastSyncAt"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/customers.ts",
        "description": "Customers table with Xero contact ID",
        "key_fields": ["xeroContactId"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/products.ts",
        "description": "Products table with Xero item ID",
        "key_fields": ["xeroItemId", "taxType"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/orders.ts",
        "description": "Orders table with Xero invoice sync fields",
        "key_fields": ["xeroInvoiceId", "xeroSyncedAt", "paymentStatus"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/suppliers.ts",
        "description": "Suppliers table with Xero contact ID (not actively synced)",
        "key_fields": ["xeroContactId"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/schema/purchase-orders.ts",
        "description": "Purchase orders table with Xero PO ID field (not actively synced)",
        "key_fields": ["xeroPoId"]
      }
    ],
    "server_functions": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/xero.ts",
        "description": "Main Xero server functions for OAuth, connection, and sync triggers",
        "exports": ["getXeroConnectionStatus", "buildXeroAuthUrl", "connectXero", "disconnectXero", "syncCustomerToXero", "syncAllCustomersToXero", "syncProductToXero", "syncAllProductsToXero", "createInvoiceFromOrder", "syncInvoiceStatus", "getXeroTokens"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/xero-tasks.ts",
        "description": "Trigger.dev task wrappers for async operations (avoids TanStack plugin issues)",
        "exports": ["triggerSyncCustomerToXero", "triggerSyncAllCustomersToXero", "triggerSyncProductToXero", "triggerSyncAllProductsToXero", "triggerCreateInvoiceFromOrder", "triggerSyncInvoiceStatus"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/server/functions/xero-webhook.ts",
        "description": "Xero webhook handler with signature verification",
        "exports": ["handleXeroWebhook"]
      }
    ],
    "trigger_tasks": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/trigger/xero-sync.ts",
        "description": "Trigger.dev tasks for Xero sync operations",
        "tasks": [
          {"id": "sync-customer-to-xero", "description": "Push customer to Xero as contact with addresses"},
          {"id": "sync-all-customers-to-xero", "description": "Bulk push all customers"},
          {"id": "sync-product-to-xero", "description": "Push product to Xero as item"},
          {"id": "sync-all-products-to-xero", "description": "Bulk push all products"},
          {"id": "create-invoice-from-order", "description": "Create Xero invoice from order with line items"},
          {"id": "sync-invoice-status", "description": "Pull invoice status from Xero"},
          {"id": "process-xero-webhook", "description": "Process webhook events (invoice updates, contact updates)"},
          {"id": "sync-all-invoice-statuses", "description": "Scheduled hourly task to sync all invoice statuses"}
        ]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/trigger/xero-token-refresh.ts",
        "description": "Scheduled task for token refresh"
      }
    ],
    "lib_integrations": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/integrations/xero/client.ts",
        "description": "XeroApiClient wrapper with token management, rate limiting, auto-refresh. Uses xero-node SDK via dynamic import.",
        "methods": ["createOrUpdateContact", "createOrUpdateItem", "createInvoice", "getInvoiceStatus", "getTenantName", "buildAuthUrl", "refreshTokens"]
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/integrations/xero/encryption.ts",
        "description": "Token encryption/decryption for secure storage"
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/integrations/xero/helpers.ts",
        "description": "Helper functions: checkXeroConnection, getXeroAccountCodes"
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/lib/integrations/xero/types.ts",
        "description": "TypeScript types: XeroTokens, XeroConnectionStatus, SyncResult"
      }
    ],
    "components": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/settings/xero-status.tsx",
        "description": "Connection status display with tenant info, expiry warning, health indicators"
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/shared/xero-sync-badge.tsx",
        "description": "Compact sync status badge for list views (Synced/Not Synced/Sync Error)"
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/customers/xero-sync-status.tsx",
        "description": "Customer-specific sync status with manual sync button and Xero link"
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/products/xero-sync-status.tsx",
        "description": "Product-specific sync status with manual sync button and Xero link"
      },
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/components/domain/orders/xero-invoice-status.tsx",
        "description": "Order invoice status with create/sync buttons and Xero link"
      }
    ],
    "routes": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/src/routes/settings/xero.tsx",
        "description": "Xero settings page with connection status, connect/disconnect buttons, bulk sync options"
      }
    ],
    "api_routes": [
      {
        "path": "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/server/api/webhooks/xero.post.ts",
        "description": "Nitro API route for receiving Xero webhooks with signature verification"
      }
    ],
    "missing_schemas": [
      "xero_sync_logs table - Not found (no sync history tracking)",
      "xero_sync_errors table - Not found (errors not persisted)",
      "credit_notes table - Not found (no credit note entity)"
    ]
  },
  "stories_status": {
    "INT-XERO-001": {
      "name": "Add Bi-Directional Contact Sync",
      "status": "partially_implemented",
      "change": "refine",
      "reason": "Push sync is fully implemented (syncCustomerToXero, syncAllCustomersToXero). Customer -> Xero Contact works with addresses and primary contact. Missing: Pull from Xero (no getContacts or pullContact method). ABN matching not implemented. Xero validation errors are thrown but not persisted/surfaced in UI.",
      "existing_implementation": {
        "push": ["syncCustomerToXero task", "syncAllCustomersToXero task", "XeroApiClient.createOrUpdateContact"],
        "schema": "xeroContactId on customers table",
        "ui": ["XeroSyncStatus component", "manual sync button", "bulk sync on settings page"]
      },
      "gaps": [
        "No pull from Xero (cannot import existing Xero contacts)",
        "No email/ABN matching for duplicate prevention",
        "Validation errors logged but not persisted"
      ],
      "layers": ["server", "ui"],
      "estimated_iterations": 4,
      "acceptance_criteria_testable": true
    },
    "INT-XERO-002": {
      "name": "Add Complete Invoice Sync",
      "status": "partially_implemented",
      "change": "refine",
      "reason": "Invoice creation (createInvoiceFromOrder) and status sync (syncInvoiceStatus) exist via Trigger.dev. Payment status updates from Xero work. Missing: automatic push on order status change (currently manual trigger), partial payment handling (only full PAID detection), Xero invoice link in order detail (component exists but may not be wired).",
      "existing_implementation": {
        "push": ["createInvoiceFromOrder task", "XeroApiClient.createInvoice"],
        "pull": ["syncInvoiceStatus task", "XeroApiClient.getInvoiceStatus", "processXeroWebhook for INVOICE.UPDATE events"],
        "schema": ["xeroInvoiceId", "xeroSyncedAt", "paymentStatus on orders"],
        "ui": "XeroInvoiceStatus component with create/sync buttons"
      },
      "gaps": [
        "No automatic invoice push on ship/deliver status",
        "Partial payment detection basic (sets pending, not partial)",
        "Line item sync may miss product updates"
      ],
      "layers": ["server", "ui"],
      "estimated_iterations": 4,
      "acceptance_criteria_testable": true
    },
    "INT-XERO-003": {
      "name": "Add Credit Note Sync",
      "status": "valid",
      "change": "atomize",
      "reason": "No credit note schema, server function, or UI exists in codebase. Full implementation required including schema, Xero API integration, and UI.",
      "layers": ["schema", "server", "ui"],
      "estimated_iterations": {
        "schema": 2,
        "server": 4,
        "ui": 3
      },
      "total_estimated_iterations": 9,
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "Depends on DOM-FIN-001 (Credit Notes) being implemented first. Max integration iterations is 10, so this is at limit."
    },
    "INT-XERO-004": {
      "name": "Add Xero Webhooks",
      "status": "partially_implemented",
      "change": "refine",
      "reason": "Webhook endpoint exists at /server/api/webhooks/xero.post.ts with signature verification. processXeroWebhook task handles INVOICE.UPDATE and CONTACT.UPDATE events. Missing: more event types (invoice voided), webhook log table, retry UI.",
      "existing_implementation": {
        "endpoint": "server/api/webhooks/xero.post.ts",
        "verification": "HMAC SHA256 signature verification",
        "task": "processXeroWebhook handles events, triggers syncInvoiceStatus",
        "events": ["INVOICE.UPDATE", "INVOICE.CREATE", "CONTACT.UPDATE", "CONTACT.CREATE"]
      },
      "gaps": [
        "No webhook_logs table for debugging",
        "INVOICE.VOIDED not explicitly handled (falls through)",
        "No retry UI for failed webhook processing",
        "Queue processing exists but no visibility into queue"
      ],
      "layers": ["schema", "server", "ui"],
      "estimated_iterations": 4,
      "acceptance_criteria_testable": true
    },
    "INT-XERO-005": {
      "name": "Add Sync Error Handling UI",
      "status": "valid",
      "change": "atomize",
      "reason": "No sync errors page exists. XeroSyncBadge component can show 'Sync Error' but errors are not persisted or viewable. No retry mechanism in UI. Need xero_sync_errors table and dedicated settings page.",
      "layers": ["schema", "server", "ui"],
      "estimated_iterations": {
        "schema": 1,
        "server": 2,
        "ui": 3
      },
      "total_estimated_iterations": 6,
      "acceptance_criteria_testable": true
    },
    "INT-XERO-006": {
      "name": "Add Sync History and Logs",
      "status": "valid",
      "change": "atomize",
      "reason": "No xero_sync_logs table exists. No sync history UI. Trigger.dev tasks log to console but not to database. Need schema, log capture in tasks, and UI page.",
      "layers": ["schema", "server", "ui"],
      "estimated_iterations": {
        "schema": 1,
        "server": 2,
        "ui": 3
      },
      "total_estimated_iterations": 6,
      "acceptance_criteria_testable": true,
      "acceptance_criteria_notes": "Consider using Trigger.dev's built-in run history instead of custom table for v1."
    },
    "INT-XERO-007": {
      "name": "Add Bulk Sync Operations",
      "status": "partially_implemented",
      "change": "refine",
      "reason": "syncAllCustomersToXero and syncAllProductsToXero tasks exist and are exposed in settings page. Missing: progress indicator (fires and forgets), summary report, individual retry for failed items, explicit rate limit handling.",
      "existing_implementation": {
        "tasks": ["syncAllCustomersToXero", "syncAllProductsToXero"],
        "ui": "Bulk sync buttons on /settings/xero page",
        "rate_limiting": "XeroApiClient has 429 handling with retryAfter"
      },
      "gaps": [
        "No progress indicator (toast says 'started' but no completion tracking)",
        "No summary of synced/skipped/failed counts in UI",
        "Rate limiting handled per-request but no batch throttling"
      ],
      "layers": ["server", "ui"],
      "estimated_iterations": 4,
      "acceptance_criteria_testable": true
    },
    "INT-XERO-008": {
      "name": "Add Xero Dashboard Widget",
      "status": "valid",
      "change": "new",
      "reason": "No Xero-specific dashboard widget exists. Dashboard has background sync hook but no Xero status widget. Need new component and integration into main dashboard.",
      "layers": ["ui"],
      "estimated_iterations": 3,
      "acceptance_criteria_testable": true,
      "dependencies_notes": "Depends on INT-XERO-005 and INT-XERO-006 for error count and sync status data."
    }
  },
  "recommended_stories": [
    "INT-XERO-002",
    "INT-XERO-001",
    "INT-XERO-007",
    "INT-XERO-004",
    "INT-XERO-005",
    "INT-XERO-006",
    "INT-XERO-008",
    "INT-XERO-003"
  ],
  "recommended_stories_rationale": "Start with completing partially implemented features (invoice sync, contact sync, bulk operations, webhooks) as they provide immediate value with less effort. Then add observability (errors, history) for better debugging. Dashboard widget depends on error/history data. Credit note sync is lowest priority as it requires the most work and depends on separate credit notes feature.",
  "atomization_notes": {
    "INT-XERO-001": {
      "current_iterations": 5,
      "adjusted_iterations": 4,
      "rationale": "Push sync complete. Only need pull and matching logic.",
      "suggested_scope": [
        {
          "id": "INT-XERO-001-A",
          "name": "Pull Contacts from Xero",
          "layers": ["server"],
          "iterations": 2,
          "scope": "Add getContacts/searchContacts to XeroApiClient. Create pullContactsFromXero task."
        },
        {
          "id": "INT-XERO-001-B",
          "name": "Contact Matching and UI",
          "layers": ["server", "ui"],
          "iterations": 2,
          "scope": "Email/ABN matching logic. Import existing contacts UI. Match suggestions."
        }
      ]
    },
    "INT-XERO-002": {
      "current_iterations": 5,
      "adjusted_iterations": 4,
      "rationale": "Core sync exists. Need automation and polish.",
      "suggested_scope": [
        {
          "id": "INT-XERO-002-A",
          "name": "Automatic Invoice Push",
          "layers": ["server"],
          "iterations": 2,
          "scope": "Hook into order status change. Auto-trigger createInvoiceFromOrder on ship/deliver."
        },
        {
          "id": "INT-XERO-002-B",
          "name": "Partial Payment and UI Polish",
          "layers": ["server", "ui"],
          "iterations": 2,
          "scope": "Detect partial payments. Wire XeroInvoiceStatus into order detail. Show payment amount."
        }
      ]
    },
    "INT-XERO-003": {
      "current_iterations": 4,
      "adjusted_iterations": 9,
      "rationale": "Full feature build. Should be atomized.",
      "suggested_scope": [
        {
          "id": "INT-XERO-003-A",
          "name": "Credit Notes Schema",
          "layers": ["schema"],
          "iterations": 2,
          "scope": "credit_notes table with Xero ID field"
        },
        {
          "id": "INT-XERO-003-B",
          "name": "Credit Note Xero Sync",
          "layers": ["server"],
          "iterations": 4,
          "scope": "XeroApiClient.createCreditNote. syncCreditNoteToXero task. Link to invoice."
        },
        {
          "id": "INT-XERO-003-C",
          "name": "Credit Note Sync UI",
          "layers": ["ui"],
          "iterations": 3,
          "scope": "Sync status on credit note detail. Manual sync button."
        }
      ]
    },
    "INT-XERO-005": {
      "current_iterations": 4,
      "adjusted_iterations": 6,
      "rationale": "Need schema + server + UI",
      "suggested_scope": [
        {
          "id": "INT-XERO-005-A",
          "name": "Sync Errors Schema and Capture",
          "layers": ["schema", "server"],
          "iterations": 3,
          "scope": "xero_sync_errors table. Capture errors in Trigger.dev tasks. CRUD functions."
        },
        {
          "id": "INT-XERO-005-B",
          "name": "Sync Errors UI",
          "layers": ["ui"],
          "iterations": 3,
          "scope": "Errors page in /settings/xero/errors. List with filters. Retry/dismiss actions. Badge count."
        }
      ]
    },
    "INT-XERO-006": {
      "current_iterations": 4,
      "adjusted_iterations": 6,
      "rationale": "Need schema + server + UI for history",
      "suggested_scope": [
        {
          "id": "INT-XERO-006-A",
          "name": "Sync Logs Schema and Capture",
          "layers": ["schema", "server"],
          "iterations": 3,
          "scope": "xero_sync_logs table. Log every sync operation with entity, action, status, request/response."
        },
        {
          "id": "INT-XERO-006-B",
          "name": "Sync History UI",
          "layers": ["ui"],
          "iterations": 3,
          "scope": "History page in /settings/xero/history. Filterable list. Detail view. Export."
        }
      ]
    }
  },
  "implementation_gaps_detail": {
    "contact_pull": {
      "status": "not_implemented",
      "notes": "XeroApiClient has no getContacts method. Cannot import existing Xero contacts. Only push direction works."
    },
    "credit_notes": {
      "status": "not_implemented",
      "notes": "No credit_notes table in schema. No Xero credit note API methods. Depends on DOM-FIN-001."
    },
    "sync_observability": {
      "status": "minimal",
      "notes": "Console logs only. No persisted errors or history. Trigger.dev has run history but not exposed in UI."
    },
    "dashboard_widget": {
      "status": "not_implemented",
      "notes": "No Xero widget on dashboard. Background sync hook exists but is for general data, not Xero status."
    },
    "supplier_sync": {
      "status": "schema_only",
      "notes": "xeroContactId field exists on suppliers table but no sync logic implemented."
    },
    "purchase_order_sync": {
      "status": "schema_only",
      "notes": "xeroPoId field exists on purchase_orders table but no sync logic implemented."
    }
  },
  "prd_corrections": {
    "current_state_adjustments": {
      "implemented": {
        "accurate": [
          "OAuth 2.0 connection setup - fully implemented with connect/disconnect flow",
          "Basic contact sync (push) - full implementation with addresses, contacts, bulk sync",
          "Invoice creation (push) - full implementation with line items, tax handling",
          "Payment recording - partial payment status sync from Xero"
        ],
        "additional_found": [
          "Product sync to Xero Items (xeroItemId tracking)",
          "Webhook endpoint with signature verification",
          "Scheduled hourly invoice status sync",
          "Token encryption for secure storage",
          "Token refresh logic (manual and auto)"
        ]
      },
      "gaps": {
        "accurate": [
          "No contact sync (pull) - confirmed",
          "No credit note sync - confirmed",
          "No sync error handling UI - confirmed",
          "No sync history/logs - confirmed"
        ],
        "needs_clarification": [
          "Invoice status sync exists but is manual/hourly, not real-time from webhooks only",
          "Bank feed reconciliation is out of scope per PRD",
          "Webhook support partially exists (endpoint + processing, no logs/retry UI)"
        ]
      }
    }
  },
  "test_coverage": {
    "existing_tests": [
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/integrations/xero-client.test.ts",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/integrations/xero-webhook.test.ts",
      "/Users/joelchan/Documents/Coding/App-Dev/live/renoz-crm-tanstack/renoz-v2/tests/quarantine/broken/xero.test.ts"
    ],
    "notes": "xero.test.ts is in quarantine (broken). Client and webhook tests exist but status unknown."
  }
}
