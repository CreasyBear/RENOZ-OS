{
  "id": "phase-0-financial",
  "name": "Financial Operations Page",
  "description": "Create /financial route for invoice management, payments, and reconciliation",
  "phase": 0,
  "priority": "P0",
  "domain": "financial",
  "wireframe": "memory-bank/ADR/audit/wireframes/financial-operations.md",
  "efficiency_impact": "90%",
  "dependencies": [],
  "completion_promise": "FINANCIAL_PAGE_COMPLETE",
  "max_iterations": 30,

  "stories": [
    {
      "id": "FIN-001",
      "name": "Create Financial Route Structure",
      "description": "Create the /financial route with tab-based navigation (Invoices, Payments, Reconciliation, Reports)",
      "status": "pending",
      "priority": "P0",
      "acceptance_criteria": [
        "Route /financial exists and renders without errors",
        "Four tabs visible: Invoices, Payments, Reconciliation, Reports",
        "Tab navigation works with URL persistence (?tab=invoices)",
        "Page title and breadcrumb show correctly",
        "Pending state shows skeleton loader"
      ],
      "technical_requirements": [
        "Create src/routes/financial/index.tsx using TanStack Router",
        "Use ui/tabs.tsx for tab navigation",
        "Use nuqs for URL state management",
        "Follow existing route patterns from /customers or /orders"
      ],
      "completion_promise": "<promise>FIN-001-ROUTE-STRUCTURE-COMPLETE</promise>",
      "estimated_iterations": 3
    },
    {
      "id": "FIN-002",
      "name": "Financial Metrics Dashboard",
      "description": "Add metrics row showing outstanding invoices, overdue amount, paid this month, avg collection days",
      "status": "pending",
      "priority": "P0",
      "dependencies": ["FIN-001"],
      "acceptance_criteria": [
        "Four MetricCard components display in a row",
        "Outstanding Invoices shows sum with trend indicator",
        "Overdue Amount shows sum with negative trend styling",
        "Paid This Month shows sum with positive trend",
        "Avg Collection Days shows calculated average",
        "All metrics fetch real data from server function"
      ],
      "technical_requirements": [
        "Create getFinancialMetrics server function in src/server/functions/financial.ts",
        "Use shared/metrics/ components (MetricCard, MetricTrend)",
        "Calculate metrics from orders, invoices tables",
        "Use TanStack Query for data fetching"
      ],
      "completion_promise": "<promise>FIN-002-METRICS-COMPLETE</promise>",
      "estimated_iterations": 4
    },
    {
      "id": "FIN-003",
      "name": "Invoices Tab with DataTable",
      "description": "Implement the Invoices tab with filterable data table showing all invoices",
      "status": "pending",
      "priority": "P0",
      "dependencies": ["FIN-001"],
      "acceptance_criteria": [
        "DataTable displays invoices with columns: Invoice #, Customer, Amount, Status, Due Date, Age",
        "Status filter dropdown works (Draft, Sent, Paid, Overdue)",
        "Date range filter works",
        "Search by invoice number or customer name works",
        "Row selection checkboxes work",
        "Clicking row opens detail sidebar"
      ],
      "technical_requirements": [
        "Create src/components/domain/financial/invoice-columns.tsx",
        "Use shared/data-table/ with column definitions",
        "Create listInvoices server function with filtering",
        "Use useUrlFilters hook for filter state",
        "Calculate 'Age' as days since due date"
      ],
      "completion_promise": "<promise>FIN-003-INVOICES-TAB-COMPLETE</promise>",
      "estimated_iterations": 5
    },
    {
      "id": "FIN-004",
      "name": "Invoice Detail Sidebar",
      "description": "Create sidebar showing full invoice details with line items and action buttons",
      "status": "pending",
      "priority": "P0",
      "dependencies": ["FIN-003"],
      "acceptance_criteria": [
        "Sidebar opens when invoice row is clicked",
        "Shows invoice header (number, status, customer)",
        "Shows due date and payment terms",
        "Shows line items with quantities and prices",
        "Shows subtotal, tax, total",
        "Action buttons: Send Reminder, Process Payment, Download PDF, Edit",
        "Send Reminder opens email composer",
        "Process Payment opens payment recording dialog"
      ],
      "technical_requirements": [
        "Create src/components/domain/financial/invoice-detail-sidebar.tsx",
        "Use shared/detail-sidebar.tsx pattern",
        "Use ui/sheet.tsx for sidebar container",
        "Create getInvoiceDetails server function"
      ],
      "completion_promise": "<promise>FIN-004-INVOICE-DETAIL-COMPLETE</promise>",
      "estimated_iterations": 4
    },
    {
      "id": "FIN-005",
      "name": "Payment Recording Dialog",
      "description": "Create dialog for recording payments against invoices",
      "status": "pending",
      "priority": "P0",
      "dependencies": ["FIN-004"],
      "acceptance_criteria": [
        "Dialog opens from invoice detail or bulk action",
        "Shows invoice amount and outstanding balance",
        "Payment amount input with validation",
        "Payment method selection (Bank Transfer, Card, Cash, Check)",
        "Payment date picker",
        "Reference/notes field",
        "Submit records payment and updates invoice status",
        "Partial payments supported"
      ],
      "technical_requirements": [
        "Create src/components/domain/financial/payment-recording-dialog.tsx",
        "Use TanStack Form for form handling",
        "Create recordPayment server function",
        "Update invoice paymentStatus based on amount",
        "Create payment audit log entry"
      ],
      "completion_promise": "<promise>FIN-005-PAYMENT-RECORDING-COMPLETE</promise>",
      "estimated_iterations": 4
    },
    {
      "id": "FIN-006",
      "name": "Bulk Invoice Operations",
      "description": "Add bulk action bar for multi-invoice operations",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["FIN-003"],
      "acceptance_criteria": [
        "Bulk action bar appears when invoices selected",
        "Bulk Send Reminders action works",
        "Bulk Export to CSV action works",
        "Bulk Mark as Sent action works",
        "Selection count displayed",
        "Clear selection button works"
      ],
      "technical_requirements": [
        "Use shared/bulk-action-bar.tsx",
        "Create bulkSendReminders server function",
        "Create exportInvoicesToCsv server function",
        "Create bulkUpdateInvoiceStatus server function"
      ],
      "completion_promise": "<promise>FIN-006-BULK-OPERATIONS-COMPLETE</promise>",
      "estimated_iterations": 3
    },
    {
      "id": "FIN-007",
      "name": "Payments Tab",
      "description": "Implement the Payments tab showing payment history",
      "status": "pending",
      "priority": "P1",
      "dependencies": ["FIN-001", "FIN-005"],
      "acceptance_criteria": [
        "DataTable displays payments with columns: Date, Invoice, Customer, Amount, Method, Status",
        "Date range filter works",
        "Customer filter works",
        "Method filter works",
        "Totals row shows sum of displayed payments"
      ],
      "technical_requirements": [
        "Create src/components/domain/financial/payment-columns.tsx",
        "Create listPayments server function",
        "Use shared/data-table/ with aggregation support"
      ],
      "completion_promise": "<promise>FIN-007-PAYMENTS-TAB-COMPLETE</promise>",
      "estimated_iterations": 3
    },
    {
      "id": "FIN-008",
      "name": "Xero Sync Status Integration",
      "description": "Show Xero sync status for invoices and enable manual sync",
      "status": "pending",
      "priority": "P2",
      "dependencies": ["FIN-003"],
      "acceptance_criteria": [
        "Xero sync status indicator in invoice table",
        "Sync button triggers manual Xero sync",
        "Last synced timestamp displayed",
        "Sync errors displayed with retry option"
      ],
      "technical_requirements": [
        "Use existing Xero integration patterns from orders",
        "Add xeroSyncedAt column display",
        "Create triggerXeroSync server function"
      ],
      "completion_promise": "<promise>FIN-008-XERO-SYNC-COMPLETE</promise>",
      "estimated_iterations": 2
    }
  ],

  "success_metrics": {
    "route_renders": "Page loads without errors",
    "data_displayed": "Real invoice/payment data from database",
    "actions_work": "CRUD operations complete successfully",
    "efficiency_gain": "Users can complete financial tasks 90% faster"
  },

  "existing_components_to_use": [
    "shared/data-table/",
    "shared/metrics/",
    "shared/bulk-action-bar.tsx",
    "shared/detail-sidebar.tsx",
    "ui/tabs.tsx",
    "ui/sheet.tsx",
    "domain/pipeline/ (for financial patterns)"
  ],

  "server_functions_to_create": [
    "getFinancialMetrics",
    "listInvoices",
    "getInvoiceDetails",
    "recordPayment",
    "bulkSendReminders",
    "bulkUpdateInvoiceStatus",
    "listPayments",
    "triggerXeroSync"
  ]
}
