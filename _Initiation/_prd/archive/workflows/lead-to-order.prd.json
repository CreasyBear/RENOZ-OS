{
  "id": "WF-LEAD-ORDER",
  "name": "Lead-to-Order Workflow",
  "description": "End-to-end sales process from initial opportunity through quote creation, customer approval, and order conversion. The primary revenue-generating workflow.",
  "created": "2026-01-09",
  "priority": 1,
  "phase": "workflow",
  "dependencies": {
    "phase": "Workflow",
    "executionOrder": 1,
    "schemaRequired": [
      {
        "table": "opportunities",
        "status": "EXISTS"
      },
      {
        "table": "orders",
        "status": "EXISTS"
      },
      {
        "table": "customers",
        "status": "EXISTS"
      },
      {
        "table": "contacts",
        "status": "EXISTS"
      },
      {
        "table": "products",
        "status": "EXISTS"
      },
      {
        "table": "notifications",
        "status": "EXISTS"
      },
      {
        "table": "email-history",
        "status": "EXISTS"
      }
    ],
    "schemaCreates": [
      {
        "table": "follow_up_sequences",
        "story": "WF-LTO-003a"
      }
    ],
    "serverFunctionsRequired": [
      {
        "function": "createOpportunity",
        "status": "EXISTS",
        "domain": "DOM-PIPELINE"
      },
      {
        "function": "updateOpportunity",
        "status": "EXISTS",
        "domain": "DOM-PIPELINE"
      },
      {
        "function": "getOpportunity",
        "status": "EXISTS",
        "domain": "DOM-PIPELINE"
      },
      {
        "function": "sendOpportunityQuoteEmail",
        "status": "EXISTS",
        "domain": "DOM-PIPELINE"
      },
      {
        "function": "convertToOrder",
        "status": "EXISTS",
        "domain": "DOM-ORDERS"
      },
      {
        "function": "getQuoteByToken",
        "status": "EXISTS",
        "domain": "DOM-PIPELINE"
      },
      {
        "function": "listCustomers",
        "status": "EXISTS",
        "domain": "DOM-CUSTOMERS"
      },
      {
        "function": "listProducts",
        "status": "EXISTS",
        "domain": "DOM-PRODUCTS"
      }
    ],
    "serverFunctionsCreates": [
      {
        "function": "trackQuoteView",
        "story": "WF-LTO-002b"
      },
      {
        "function": "approveQuote",
        "story": "WF-LTO-002b"
      },
      {
        "function": "createFollowUpSequence",
        "story": "WF-LTO-003b"
      },
      {
        "function": "pauseFollowUpSequence",
        "story": "WF-LTO-003b"
      },
      {
        "function": "sendFollowUp",
        "story": "WF-LTO-003b"
      },
      {
        "function": "checkStockAvailability",
        "story": "WF-LTO-004a"
      },
      {
        "function": "convertWithStockCheck",
        "story": "WF-LTO-004a"
      },
      {
        "function": "getConversionAnalytics",
        "story": "WF-LTO-005a"
      },
      {
        "function": "calculateWinProbability",
        "story": "WF-LTO-006a"
      },
      {
        "function": "overrideWinProbability",
        "story": "WF-LTO-006a"
      },
      {
        "function": "convertQuoteToJob",
        "story": "WF-LTO-007a"
      },
      {
        "function": "transferBOMToJob",
        "story": "WF-LTO-007b"
      },
      {
        "function": "getQuoteToJobConversionRate",
        "story": "WF-LTO-007c"
      }
    ],
    "prdDependencies": [
      {
        "prdId": "DOM-CUSTOMERS",
        "status": "REQUIRED",
        "reason": "Needs customer selection and data"
      },
      {
        "prdId": "DOM-PIPELINE",
        "status": "REQUIRED",
        "reason": "Core opportunity/quote management"
      },
      {
        "prdId": "DOM-ORDERS",
        "status": "REQUIRED",
        "reason": "Order conversion target"
      },
      {
        "prdId": "DOM-PRODUCTS",
        "status": "REQUIRED",
        "reason": "Product selection for quotes"
      },
      {
        "prdId": "DOM-INVENTORY",
        "status": "OPTIONAL",
        "reason": "Stock check on conversion"
      },
      {
        "prdId": "DOM-JOBS",
        "status": "OPTIONAL",
        "reason": "Quote to job conversion for service/installation work"
      }
    ],
    "enables": []
  },
  "domains_involved": [
    "pipeline",
    "customers",
    "products",
    "orders",
    "jobs"
  ],
  "references": {
    "internal": [
      "memory-bank/prd/domain/pipeline.prd.json",
      "memory-bank/prd/domain/customers.prd.json",
      "memory-bank/prd/domain/orders.prd.json",
      "_Initiation/_prd/2-domains/jobs/jobs.prd.json"
    ]
  },
  "workflow_stages": [
    "Create Opportunity -> Build Quote -> Send Quote -> Customer Response -> Convert to Order",
    "Create Opportunity -> Build Quote -> Send Quote -> Customer Accepts -> Convert to Job (for service/installation)"
  ],
  "current_state": {
    "implemented": [
      "Create opportunity from customer",
      "Add products to quote snapshot",
      "Basic quote sending",
      "Manual order conversion",
      "Quote builder with pricing",
      "Quote acceptance via token"
    ],
    "gaps": [
      "No guided workflow UI (wizard)",
      "No quote view tracking or notifications",
      "No automated follow-up sequences",
      "No one-click conversion with stock check",
      "No conversion analytics",
      "No win probability automation",
      "No quote-to-job conversion for service/installation work"
    ]
  },
  "stories": [
    {
      "id": "WF-LTO-001a",
      "name": "Sales Wizard Shell and Navigation",
      "description": "Wizard UI shell with stage progress indicator and step navigation",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Wizard UI with stage progress indicator",
        "Step navigation between steps",
        "Auto-save on each step to localStorage",
        "Can navigate between steps",
        "Unsaved changes warning",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_001A_COMPLETE"
    },
    {
      "id": "WF-LTO-001b",
      "name": "Sales Wizard Step Components",
      "description": "Individual step content components for the sales wizard",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Step 1: Select/create customer and contact",
        "Step 2: Add products, set quantities and pricing",
        "Step 3: Review quote details, add notes",
        "Step 4: Send quote or save as draft",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-001a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_001B_COMPLETE"
    },
    {
      "id": "WF-LTO-002a",
      "name": "Quote View Tracking Schema",
      "description": "Add quoteViewedAt and tracking fields to opportunities",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Add quoteViewedAt column to opportunities",
        "Add quoteApprovedAt timestamp column",
        "Add approvalIp for logging",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "WF_LTO_002A_COMPLETE"
    },
    {
      "id": "WF-LTO-002b",
      "name": "Quote View Tracking Server",
      "description": "Track quote views and trigger notifications",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Track view on getQuoteByToken call",
        "Quote view tracking when customer opens",
        "Notification when customer views quote",
        "Approval timestamp and IP logged",
        "Status update: sent -> viewed -> approved",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-002a",
        "DOM-PIPE-002"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_002B_COMPLETE"
    },
    {
      "id": "WF-LTO-002c",
      "name": "Quote Approval Tracking UI",
      "description": "Display quote view/approval status in opportunity panel",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Quote approval button on public quote page",
        "Notification when customer approves",
        "View/approval status display in opportunity panel",
        "Step indicator showing quote lifecycle: Draft -> Sent -> Viewed -> Approved",
        "Toast notification on successful approval action",
        "Confirmation dialog before quote approval with summary",
        "Loading spinner during approval submission",
        "Error recovery with retry option on failure",
        "Responsive layout: stacked on mobile, side-by-side on desktop",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-002b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_002C_COMPLETE",
      "ui_spec": {
        "component_type": "StatusTimeline",
        "workflow_visualization": "Horizontal step indicator showing quote lifecycle stages with current state highlighted",
        "accessibility": {
          "aria_live_regions": "Status changes announced to screen readers",
          "focus_management": "Focus moves to confirmation dialog when opened",
          "keyboard_navigation": "All actions accessible via keyboard",
          "color_contrast": "Status indicators use icons in addition to color"
        }
      }
    },
    {
      "id": "WF-LTO-003a",
      "name": "Follow-Up Sequence Schema",
      "description": "Create follow_up_sequences table for automation state",
      "priority": 6,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "follow_up_sequences table (id, opportunityId, status, currentStep, nextSendAt)",
        "Follow-up template storage",
        "Sequence status: active, paused, completed, cancelled",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "WF_LTO_003A_COMPLETE"
    },
    {
      "id": "WF-LTO-003b",
      "name": "Follow-Up Sequence Server and Scheduler",
      "description": "Automated scheduling with Trigger.dev for follow-up sequences",
      "priority": 7,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Follow-up sequence: 3 days, 7 days, 14 days after send",
        "Customizable follow-up templates",
        "Auto-pause if customer responds",
        "Skip if quote approved or lost",
        "Manual trigger for immediate follow-up",
        "Trigger.dev job for automated sending",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-003a",
        "WF-LTO-002b"
      ],
      "estimated_iterations": 4,
      "completion_promise": "WF_LTO_003B_COMPLETE"
    },
    {
      "id": "WF-LTO-003c",
      "name": "Follow-Up History UI",
      "description": "Follow-up history display and manual trigger UI",
      "priority": 8,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Follow-up history on opportunity",
        "Manual trigger button for immediate follow-up",
        "Sequence status display",
        "Timeline visualization of follow-up sequence with sent/pending states",
        "Progress indicator showing current step in sequence (e.g., 2 of 3)",
        "Toast notification on manual follow-up trigger success/failure",
        "Confirmation dialog before pausing or cancelling sequence",
        "Loading state while follow-up is being sent",
        "Error state with retry option if send fails",
        "Responsive: timeline collapses to vertical list on mobile",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-003b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_003C_COMPLETE",
      "ui_spec": {
        "component_type": "Timeline",
        "workflow_visualization": "Vertical timeline showing follow-up events with status badges and timestamps",
        "accessibility": {
          "aria_live_regions": "New follow-up events announced",
          "focus_management": "Focus returns to trigger button after action",
          "keyboard_navigation": "Timeline items navigable via arrow keys",
          "screen_reader": "Timeline events include full context (date, status, action)"
        }
      }
    },
    {
      "id": "WF-LTO-004a",
      "name": "Order Conversion Server Functions",
      "description": "Stock check and conversion logic enhancements",
      "priority": 9,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Stock availability check before conversion",
        "Pre-fill order from quote data",
        "Handle partial stock with options",
        "Opportunity marked as 'won' automatically",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-002c"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_004A_COMPLETE"
    },
    {
      "id": "WF-LTO-004b",
      "name": "One-Click Conversion UI",
      "description": "Convert to order button and UI flow on approved opportunities",
      "priority": 10,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Convert to order button on approved opportunities",
        "Stock availability warning dialog",
        "Partial stock options UI",
        "Success confirmation with order link",
        "Multi-step conversion wizard: Review Quote -> Check Stock -> Confirm -> Success",
        "Step progress indicator at top of wizard",
        "Confirmation dialog showing order summary before final conversion",
        "Toast notification on successful conversion with link to new order",
        "Loading overlay during conversion with progress message",
        "Error recovery: clear error message with retry or cancel options",
        "Partial stock modal with options: wait for stock, partial fulfill, substitute",
        "Responsive: full-width wizard on mobile, modal on desktop",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-004a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_004B_COMPLETE",
      "ui_spec": {
        "component_type": "Wizard",
        "workflow_visualization": "4-step horizontal stepper with icons: Review, Stock, Confirm, Complete",
        "accessibility": {
          "aria_live_regions": "Step changes and stock warnings announced",
          "focus_management": "Focus trapped in modal, moves to first interactive element of each step",
          "keyboard_navigation": "Next/Previous via keyboard, Escape closes modal",
          "error_handling": "Errors announced immediately with suggested action"
        }
      }
    },
    {
      "id": "WF-LTO-005a",
      "name": "Conversion Analytics Server Functions",
      "description": "Server functions for conversion metrics calculation",
      "priority": 11,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Conversion funnel calculation",
        "Metrics: quote -> view -> approve -> order rates",
        "Average time between stages",
        "Comparison by sales rep, product, customer segment",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-004b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_005A_COMPLETE"
    },
    {
      "id": "WF-LTO-005b",
      "name": "Conversion Analytics UI",
      "description": "Conversion funnel visualization and analytics dashboard",
      "priority": 12,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Conversion funnel visualization",
        "Drop-off analysis by stage",
        "Recommendations for improvement",
        "Conversion report page",
        "Funnel chart showing quote -> view -> approve -> order progression",
        "Step-by-step conversion rates displayed between stages",
        "Toast notification when report export completes",
        "Loading skeleton while analytics data loads",
        "Error state with refresh option if data fails to load",
        "Responsive: charts stack vertically on mobile, grid on desktop",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "Date range picker with presets (7d, 30d, 90d, custom)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-005a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_005B_COMPLETE",
      "ui_spec": {
        "component_type": "Dashboard",
        "workflow_visualization": "Funnel chart with stage counts, percentages, and drop-off indicators",
        "accessibility": {
          "chart_alternatives": "Data table alternative for funnel visualization",
          "aria_labels": "Charts include descriptive aria-labels with key metrics",
          "keyboard_navigation": "All filters and controls keyboard accessible",
          "screen_reader": "Key metrics announced on page load"
        }
      }
    },
    {
      "id": "WF-LTO-006a",
      "name": "Win Probability Server Logic",
      "description": "Probability calculation based on engagement signals",
      "priority": 13,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Probability factors: engagement, time in stage, customer history",
        "Auto-update probability as signals change",
        "Historical accuracy tracking",
        "Probability feeds pipeline forecasting",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "DOM-PIPE-001"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_006A_COMPLETE"
    },
    {
      "id": "WF-LTO-006b",
      "name": "Win Probability UI",
      "description": "Visual indicator and manual override for probability",
      "priority": 14,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Visual indicator on opportunity",
        "Override with manual probability",
        "Probability history display",
        "Circular gauge or progress bar showing probability percentage",
        "Color coding: red (<30%), yellow (30-70%), green (>70%)",
        "Toast notification when probability is manually updated",
        "Confirmation dialog before manual override with reason field",
        "Loading indicator while probability recalculates",
        "Timeline showing probability changes over time",
        "Responsive: gauge resizes for mobile, history collapses to accordion",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-LTO-006a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_LTO_006B_COMPLETE",
      "ui_spec": {
        "component_type": "Gauge",
        "workflow_visualization": "Circular gauge with percentage and trend indicator, expandable history timeline",
        "accessibility": {
          "aria_labels": "Probability value and trend announced",
          "keyboard_navigation": "Override control accessible via keyboard",
          "color_contrast": "Colors supplemented with patterns/icons",
          "screen_reader": "Full probability context including contributing factors"
        }
      }
    },
    {
      "id": "WF-LTO-007a",
      "name": "Quote Acceptance Handler",
      "description": "When quote is marked 'accepted', offer to create job from quote data. Enables quote-to-job conversion for service/installation work.",
      "priority": 15,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Accept Quote button on quote detail page",
        "Confirmation dialog: 'Create job from this quote?'",
        "Option to just mark won without creating job",
        "Customer, products, quantities, pricing copied to new job",
        "Site address defaults from customer",
        "Job status: 'scheduled' with TBD date",
        "TypeScript compiles without errors"
      ],
      "layers": ["server", "ui"],
      "dependencies": [
        "WF-LTO-002c"
      ],
      "estimated_iterations": 2,
      "completion_promise": "WF_LTO_007A_COMPLETE"
    },
    {
      "id": "WF-LTO-007b",
      "name": "BOM Transfer",
      "description": "Copy quote line items to job BOM (Bill of Materials). Links job materials back to original quote for traceability.",
      "priority": 16,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Quote line items become job materials",
        "Preserve product, quantity, unit price",
        "Allow modifications before job start",
        "Link job materials back to original quote",
        "TypeScript compiles without errors"
      ],
      "layers": ["server"],
      "dependencies": [
        "WF-LTO-007a",
        "DOM-JOBS-002b"
      ],
      "estimated_iterations": 2,
      "completion_promise": "WF_LTO_007B_COMPLETE"
    },
    {
      "id": "WF-LTO-007c",
      "name": "Conversion Status Tracking",
      "description": "Track quote to job conversion for analytics. Enables dashboard metrics for quote-to-job conversion rate.",
      "priority": 17,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Quote record stores: converted_to_job_id, converted_at",
        "Job record stores: created_from_quote_id",
        "Dashboard metric: 'Quote to Job Conversion Rate'",
        "TypeScript compiles without errors"
      ],
      "layers": ["schema", "server"],
      "dependencies": [
        "WF-LTO-007a"
      ],
      "estimated_iterations": 1,
      "completion_promise": "WF_LTO_007C_COMPLETE"
    }
  ],
  "success_criteria": [
    "Guided workflow reduces sales cycle time",
    "Quote viewing tracked for engagement insight",
    "Automated follow-ups increase conversion",
    "One-click conversion reduces manual work",
    "Analytics enable data-driven improvement",
    "Quote-to-job conversion streamlines service/installation scheduling",
    "BOM transfer eliminates manual material re-entry"
  ],
  "out_of_scope": [
    "CPQ engine",
    "E-signature integration",
    "Automated pricing rules"
  ]
}
