{
  "id": "WF-ONBOARDING",
  "name": "Customer Onboarding Workflow",
  "description": "Structured onboarding process for new customers including data capture, communication setup, and initial engagement.",
  "created": "2026-01-09",
  "priority": 8,
  "phase": "workflow",
  "dependencies": {
    "phase": "Workflow",
    "executionOrder": 8,
    "schemaRequired": [
      {
        "table": "customers",
        "status": "EXISTS"
      },
      {
        "table": "contacts",
        "status": "EXISTS"
      },
      {
        "table": "addresses",
        "status": "EXISTS"
      },
      {
        "table": "customer-activities",
        "status": "EXISTS"
      },
      {
        "table": "opportunities",
        "status": "EXISTS"
      },
      {
        "table": "users",
        "status": "EXISTS"
      },
      {
        "table": "email-history",
        "status": "EXISTS"
      },
      {
        "table": "notifications",
        "status": "EXISTS"
      }
    ],
    "schemaCreates": [
      {
        "table": "onboarding_checklist_items",
        "story": "WF-ONB-001a"
      }
    ],
    "serverFunctionsRequired": [
      {
        "function": "getCustomer",
        "status": "EXISTS",
        "domain": "DOM-CUSTOMERS"
      },
      {
        "function": "createCustomer",
        "status": "EXISTS",
        "domain": "DOM-CUSTOMERS"
      },
      {
        "function": "updateCustomer",
        "status": "EXISTS",
        "domain": "DOM-CUSTOMERS"
      },
      {
        "function": "listCustomers",
        "status": "EXISTS",
        "domain": "DOM-CUSTOMERS"
      },
      {
        "function": "getCustomerSummary",
        "status": "EXISTS",
        "domain": "DOM-CUSTOMERS"
      },
      {
        "function": "createOpportunity",
        "status": "EXISTS",
        "domain": "DOM-PIPELINE"
      },
      {
        "function": "logCustomerActivity",
        "status": "EXISTS",
        "domain": "DOM-CUSTOMERS"
      }
    ],
    "serverFunctionsCreates": [
      {
        "function": "getOnboardingChecklist",
        "story": "WF-ONB-001b"
      },
      {
        "function": "updateOnboardingProgress",
        "story": "WF-ONB-001b"
      },
      {
        "function": "calculateOnboardingProgress",
        "story": "WF-ONB-001b"
      },
      {
        "function": "calculateProfileCompleteness",
        "story": "WF-ONB-002a"
      },
      {
        "function": "sendWelcomeEmail",
        "story": "WF-ONB-003b"
      },
      {
        "function": "detectFirstQuoteMilestone",
        "story": "WF-ONB-004b"
      },
      {
        "function": "getOnboardingMetrics",
        "story": "WF-ONB-005a"
      },
      {
        "function": "completeOnboarding",
        "story": "WF-ONB-006b"
      },
      {
        "function": "sendOnboardingCompleteEmail",
        "story": "WF-ONB-006c"
      }
    ],
    "prdDependencies": [
      {
        "prdId": "DOM-CUSTOMERS",
        "status": "REQUIRED",
        "reason": "Core customer management"
      },
      {
        "prdId": "DOM-COMMS",
        "status": "REQUIRED",
        "reason": "Welcome and completion emails"
      },
      {
        "prdId": "DOM-PIPELINE",
        "status": "OPTIONAL",
        "reason": "First quote milestone tracking"
      }
    ],
    "enables": []
  },
  "domains_involved": [
    "customers",
    "communications",
    "pipeline"
  ],
  "references": {
    "internal": [
      "memory-bank/prd/domain/customers.prd.json",
      "memory-bank/prd/domain/communications.prd.json"
    ]
  },
  "workflow_stages": [
    "Customer Created -> Profile Complete -> Welcome Email -> First Quote -> Active Customer"
  ],
  "current_state": {
    "implemented": [
      "Basic customer creation",
      "Customer CRUD with contacts and addresses",
      "Email infrastructure via Resend",
      "Activity logging"
    ],
    "gaps": [
      "No onboarding status field",
      "No checklist infrastructure",
      "No welcome email template",
      "No profile completeness calculation",
      "No milestone tracking"
    ]
  },
  "stories": [
    {
      "id": "WF-ONB-001a",
      "name": "Add Onboarding Schema",
      "description": "Add onboarding fields to customers table and create checklist configuration table",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "customers table: onboardingStatus enum ('not_started', 'in_progress', 'completed') with default 'not_started'",
        "customers table: onboardingCompletedAt timestamp nullable",
        "customers table: onboardingChecklistProgress jsonb for tracking completed steps",
        "onboarding_checklist_items table (id, organizationId, name, description, isRequired, sortOrder, autoDetectType)",
        "Migration runs successfully",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "WF_ONB_001A_COMPLETE"
    },
    {
      "id": "WF-ONB-001b",
      "name": "Add Onboarding Server Functions",
      "description": "Create server functions for checklist CRUD and progress tracking",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "getOnboardingChecklist returns checklist items with completion status for customer",
        "updateOnboardingProgress updates specific checklist item as complete/incomplete",
        "calculateOnboardingProgress computes percentage from completed items",
        "Auto-detect completions (has contact, has address, has quote) on customer load",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-001a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_001B_COMPLETE"
    },
    {
      "id": "WF-ONB-001c",
      "name": "Add Onboarding Checklist UI",
      "description": "Display onboarding checklist on customer detail and list views",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "OnboardingChecklist component shows steps with check/uncheck state",
        "Progress bar shows percentage complete",
        "Checklist displayed on customer detail overview tab",
        "Customer list has 'Onboarding' status column with progress indicator",
        "Incomplete onboarding customers highlighted with amber/warning style",
        "Filter customers by onboarding status (not_started, in_progress, completed)",
        "Step-by-step checklist with visual completion indicators",
        "Progress stepper: Not Started -> In Progress -> Completed",
        "Toast notification when checklist item completed",
        "Confirmation dialog when marking onboarding complete",
        "Loading state while checklist data loads",
        "Error handling with retry for failed updates",
        "Responsive: checklist collapses to accordion on mobile",
        "Breakpoints: mobile (<640px accordion), tablet (640-1024px list), desktop (>1024px card)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-001b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_001C_COMPLETE",
      "ui_spec": {
        "component_type": "Checklist",
        "workflow_visualization": "Vertical checklist with progress bar and completion status per item",
        "accessibility": {
          "aria_labels": "Checklist items and completion status labeled",
          "focus_management": "Focus moves to next item after completion",
          "keyboard_navigation": "Space to toggle, Tab to navigate",
          "screen_reader": "Progress percentage and item status announced"
        }
      }
    },
    {
      "id": "WF-ONB-002a",
      "name": "Add Profile Completeness Server Function",
      "description": "Create server function to calculate profile completeness score",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "calculateProfileCompleteness server function returns 0-100 score",
        "Required fields: companyName (20%), primaryContact (20%), phone (15%), email (15%), address (15%), ABN (15%)",
        "Optional fields boost: website, industry classification",
        "Function used by getCustomerSummary to include in response",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_002A_COMPLETE"
    },
    {
      "id": "WF-ONB-002b",
      "name": "Add Profile Completeness UI",
      "description": "Display profile completeness score with prompts to complete missing data",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "ProfileCompleteness component shows circular progress gauge (0-100%)",
        "Color coding: red (<50%), yellow (50-80%), green (>80%)",
        "Hover/expand shows which fields are missing",
        "Quick links to complete missing data (e.g., 'Add primary contact')",
        "Score visible on customer summary card",
        "Customer list column for completeness score with filter",
        "Circular gauge with percentage and color indicator",
        "Expandable panel showing missing field details",
        "Toast notification when profile reaches 100%",
        "Loading state while completeness calculates",
        "Error handling with fallback display",
        "Responsive: gauge scales for mobile, panel stacks",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-002a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_002B_COMPLETE",
      "ui_spec": {
        "component_type": "Gauge",
        "workflow_visualization": "Circular progress gauge with expandable missing fields panel",
        "accessibility": {
          "aria_labels": "Completeness percentage and status announced",
          "focus_management": "Focus moves to first missing field link",
          "keyboard_navigation": "Expand/collapse via Enter, links via Tab",
          "color_alternatives": "Icons supplement color coding"
        }
      }
    },
    {
      "id": "WF-ONB-003a",
      "name": "Create Welcome Email Template",
      "description": "Create React Email template for welcome email",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "WelcomeEmail.tsx template in emails/templates/",
        "Template includes: company intro, key contacts, what to expect next",
        "Personalized with customer name placeholder",
        "Consistent styling with existing email templates",
        "Preview renders correctly",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 4,
      "completion_promise": "WF_ONB_003A_COMPLETE"
    },
    {
      "id": "WF-ONB-003b",
      "name": "Add Welcome Email Trigger Job",
      "description": "Create Trigger.dev task to send welcome email on customer creation",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "sendWelcomeEmail task in trigger/email-jobs.ts",
        "Triggered from createCustomer server function (optional, configurable)",
        "Skips if customer has no valid email (checks primary contact email)",
        "Records in email_history table",
        "Organization setting to enable/disable welcome email automation",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-003a"
      ],
      "estimated_iterations": 4,
      "completion_promise": "WF_ONB_003B_COMPLETE"
    },
    {
      "id": "WF-ONB-003c",
      "name": "Add Welcome Email Configuration UI",
      "description": "Add settings UI to configure welcome email automation",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Settings page has 'Customer Onboarding' section",
        "Toggle for 'Send welcome email on customer creation'",
        "Preview welcome email button",
        "Manual 'Send Welcome Email' action on customer detail (if not sent yet)",
        "Indicator in activity log when welcome email was sent",
        "Settings form with toggle and preview",
        "Toast notification when settings saved",
        "Confirmation dialog before manual send",
        "Loading state during preview generation",
        "Error handling for email preview failures",
        "Responsive: full-width form on mobile",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-003b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_003C_COMPLETE",
      "ui_spec": {
        "component_type": "SettingsForm",
        "workflow_visualization": "Settings panel with toggle, preview button, and email preview modal",
        "accessibility": {
          "aria_labels": "Toggle and preview controls labeled",
          "focus_management": "Focus on toggle after save",
          "keyboard_navigation": "Full form keyboard support",
          "screen_reader": "Toggle state and preview availability announced"
        }
      }
    },
    {
      "id": "WF-ONB-004a",
      "name": "Add First Quote Milestone Schema",
      "description": "Add milestone fields to customers table",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "customers table: firstQuoteAt timestamp nullable",
        "customers table: firstOrderAt timestamp nullable (future use)",
        "Migration runs successfully",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "WF_ONB_004A_COMPLETE"
    },
    {
      "id": "WF-ONB-004b",
      "name": "Add First Quote Milestone Detection",
      "description": "Detect and record first quote milestone when opportunity created",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "createOpportunity server function checks if customer.firstQuoteAt is null",
        "If first quote, sets firstQuoteAt timestamp on customer",
        "Creates milestone customer_activity record",
        "Updates onboarding checklist if WF-ONB-001 implemented",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-004a"
      ],
      "estimated_iterations": 4,
      "completion_promise": "WF_ONB_004B_COMPLETE"
    },
    {
      "id": "WF-ONB-004c",
      "name": "Add First Quote Milestone Reminders and Celebration",
      "description": "Add reminder for customers without first quote and celebration notification",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Trigger.dev job runs daily to check customers without quote after X days (configurable)",
        "Creates task for sales rep for overdue customers",
        "Toast/notification when first quote milestone is reached",
        "Milestone date visible on customer summary card",
        "Milestone celebration toast with confetti animation (optional)",
        "Progress indicator showing days since customer created without quote",
        "Toast notification when milestone reached",
        "Loading state while checking milestones",
        "Error handling for reminder job failures",
        "Responsive: milestone badge adapts to card size",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-004b"
      ],
      "estimated_iterations": 4,
      "completion_promise": "WF_ONB_004C_COMPLETE",
      "ui_spec": {
        "component_type": "MilestoneBadge",
        "workflow_visualization": "Badge/card showing milestone achievement with optional celebration animation",
        "accessibility": {
          "aria_live_regions": "Milestone achievements announced",
          "focus_management": "Focus on milestone card when achieved",
          "animations": "Respect prefers-reduced-motion",
          "screen_reader": "Full milestone context announced"
        }
      }
    },
    {
      "id": "WF-ONB-005a",
      "name": "Add Onboarding Metrics Server Function",
      "description": "Create server function to aggregate onboarding metrics",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "getOnboardingMetrics returns: customersInOnboarding, avgTimeToComplete, completionRate, stuckCustomersCount",
        "Stuck = no progress in 7+ days",
        "Metrics filtered by date range",
        "Returns list of customers in onboarding with progress percentage",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-001b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_005A_COMPLETE"
    },
    {
      "id": "WF-ONB-005b",
      "name": "Add Onboarding Dashboard Widget",
      "description": "Create onboarding status widget for main dashboard",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "OnboardingStatusWidget component shows key metrics at a glance",
        "Count of customers in onboarding with progress breakdown",
        "Stuck customers highlighted with warning",
        "Click through to full onboarding dashboard",
        "Widget available in dashboard settings for placement",
        "KPI cards: in onboarding, completed this period, stuck, avg time",
        "Mini progress bars per onboarding stage",
        "Toast notification when widget data refreshes",
        "Loading skeleton while metrics load",
        "Error state with refresh option",
        "Responsive: widget adapts to dashboard grid",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-005a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_005B_COMPLETE",
      "ui_spec": {
        "component_type": "Widget",
        "workflow_visualization": "Compact dashboard widget with KPI cards and progress indicators",
        "accessibility": {
          "aria_labels": "All metrics labeled with context",
          "focus_management": "Click-through link keyboard accessible",
          "keyboard_navigation": "Widget controls keyboard accessible",
          "screen_reader": "Key metrics announced on focus"
        }
      }
    },
    {
      "id": "WF-ONB-005c",
      "name": "Add Onboarding Dashboard Page",
      "description": "Create dedicated onboarding dashboard page with detailed view",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Route /reports/onboarding",
        "Table of customers in onboarding with columns: customer, created date, progress %, last activity, assigned to",
        "Filters: stuck only, by assignee, by date range",
        "Quick actions: view customer, send reminder, mark complete",
        "Charts: completion rate trend, avg time to complete",
        "Data table with sortable columns and filters",
        "Onboarding funnel: Created -> In Progress -> Completed",
        "Toast notifications on quick actions",
        "Confirmation dialog before marking complete",
        "Loading skeleton while data loads",
        "Error state with refresh option",
        "Responsive: table scrolls on mobile, full on desktop",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-005a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_005C_COMPLETE",
      "ui_spec": {
        "component_type": "Dashboard",
        "workflow_visualization": "Full dashboard with data table, funnel chart, and trend graphs",
        "accessibility": {
          "chart_alternatives": "Data tables for all visualizations",
          "aria_labels": "All controls and metrics labeled",
          "keyboard_navigation": "Full table and filter keyboard support",
          "screen_reader": "Dashboard summary announced on load"
        }
      }
    },
    {
      "id": "WF-ONB-006a",
      "name": "Add Customer Handoff Schema",
      "description": "Add account manager field to customers table",
      "priority": 6,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "customers table: accountManagerId uuid nullable FK to users",
        "Migration runs successfully",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "WF_ONB_006A_COMPLETE"
    },
    {
      "id": "WF-ONB-006b",
      "name": "Add Customer Handoff Server Function",
      "description": "Create server function to complete onboarding and handoff customer",
      "priority": 6,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "completeOnboarding server function validates checklist is complete",
        "Sets onboardingStatus to 'completed' and onboardingCompletedAt timestamp",
        "Sets accountManagerId from input",
        "Changes status to 'active' if not already",
        "Creates customer_activity record for handoff event",
        "Returns success with customer data",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-006a",
        "WF-ONB-001b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_006B_COMPLETE"
    },
    {
      "id": "WF-ONB-006c",
      "name": "Add Customer Handoff Notifications",
      "description": "Send notifications on customer handoff completion",
      "priority": 6,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Internal notification to account manager on handoff assignment",
        "OnboardingComplete email template to customer (if enabled)",
        "Trigger.dev task for sending graduation email",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-006b"
      ],
      "estimated_iterations": 4,
      "completion_promise": "WF_ONB_006C_COMPLETE"
    },
    {
      "id": "WF-ONB-006d",
      "name": "Add Customer Handoff UI",
      "description": "Create UI for completing onboarding and handoff",
      "priority": 6,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "CompleteOnboarding dialog accessible from customer detail when in_progress",
        "Review checklist completion status",
        "Account manager selector dropdown",
        "Send graduation email toggle",
        "Confirmation before completion",
        "Success toast with next steps",
        "Handoff wizard: Review Checklist -> Select Manager -> Confirm -> Complete",
        "Step progress indicator",
        "Toast notification on successful handoff with next steps",
        "Confirmation dialog with handoff summary",
        "Loading state during handoff processing",
        "Error handling with clear messaging",
        "Responsive: full-screen modal on mobile, dialog on desktop",
        "Breakpoints: mobile (<640px), tablet (640-1024px), desktop (>1024px)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "WF-ONB-006b",
        "WF-ONB-006c"
      ],
      "estimated_iterations": 3,
      "completion_promise": "WF_ONB_006D_COMPLETE",
      "ui_spec": {
        "component_type": "Wizard",
        "workflow_visualization": "4-step handoff wizard with checklist review and manager assignment",
        "accessibility": {
          "aria_live_regions": "Step completion announced",
          "focus_management": "Focus follows wizard progression",
          "keyboard_navigation": "Full wizard keyboard support",
          "form_labels": "All form fields properly labeled"
        }
      }
    }
  ],
  "success_criteria": [
    "New customers have clear path to active",
    "Profile data quality improves",
    "Welcome automation creates good impression",
    "First quote milestone drives engagement",
    "Dashboard provides visibility into funnel"
  ],
  "out_of_scope": [
    "Customer self-registration",
    "Complex onboarding workflows",
    "Customer training portal"
  ]
}
