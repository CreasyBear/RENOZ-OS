{
  "id": "REF-COMPONENTS",
  "name": "Component Architecture Refactoring",
  "description": "Extract large components, consolidate duplicates, create shared layout wrappers. Reduces component complexity and establishes reusable patterns.",
  "created": "2026-01-09",
  "updated": "2026-01-09",
  "priority": 2,
  "phase": "refactoring",
  "dependencies": {
    "phase": "Refactoring",
    "executionOrder": 7,
    "schemaRequired": [],
    "prdDependencies": [
      {
        "prdId": "shared-components-foundation",
        "status": "OPTIONAL",
        "reason": "Builds on existing shared component patterns"
      },
      {
        "prdId": "REF-HOOKS",
        "status": "OPTIONAL",
        "reason": "Refactored hooks may be used by refactored components"
      }
    ],
    "enables": [
      {
        "prdId": "ROLE-*",
        "reason": "Shared layouts enable consistent role-specific dashboards"
      },
      {
        "prdId": "DOM-*",
        "reason": "Shared layouts enable consistent domain pages"
      }
    ]
  },
  "audit": {
    "date": "2026-01-09",
    "implementation_percentage": 0,
    "audit_file": "memory-bank/prd/_audits/components-audit.json"
  },
  "references": {
    "internal": [
      "memory-bank/_meta/conventions.md - Component patterns section",
      "memory-bank/_meta/assumptions.md - UX assumptions",
      "memory-bank/VISION.md - UI/UX principles"
    ],
    "external": [
      "TanStack Form docs: useForm patterns",
      "TanStack Table docs: column definitions",
      "React patterns: composition over inheritance"
    ]
  },
  "current_state": {
    "issues": [
      "prompt-input.tsx: 1413 lines - handles attachments, context, shortcuts",
      "order-creation-dialog.tsx: 656 lines - three modes mixed",
      "order-panel.tsx: 574 lines - tabs, actions, PDF generation",
      "advanced-chart-widget.tsx: 671 lines - complex dashboard widget",
      "Two log-call-dialog implementations: 186 vs 305 lines",
      "Two bulk-import-dialog implementations: products 515, customers 509",
      "No shared ListPageLayout - each domain builds differently",
      "No shared DetailPageLayout - sidebar+tabs duplicated",
      "Heavy prop drilling: 9-10 props common in forms"
    ],
    "max_component_size": 1413,
    "duplicate_components": 4,
    "components_over_300_lines": 30
  },
  "target_state": {
    "max_component_size": 300,
    "duplicate_components": 0,
    "shared_layouts": [
      "ListPageLayout",
      "DetailPageLayout"
    ],
    "prop_drilling_max": 5
  },
  "stories": [
    {
      "id": "REF-COMP-001a",
      "name": "Extract PromptInput: Core Orchestrator",
      "description": "Create the main PromptInput orchestrator component",
      "priority": 1,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/ai/prompt-input/PromptInput.tsx created",
        "Main orchestrator component < 150 lines",
        "Composes: AttachmentManager, ContextDisplay, MessageInput, ShortcutHandler",
        "Maintains existing API surface for consumers",
        "All AI chat functionality works as before",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/ai/prompt-input/PromptInput.tsx (create)",
        "src/components/ai/prompt-input.tsx (rename to old or delete after)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_001A_COMPLETE"
    },
    {
      "id": "REF-COMP-001b",
      "name": "Extract PromptInput: AttachmentManager",
      "description": "Extract file attachment handling into separate component",
      "priority": 1,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/ai/prompt-input/AttachmentManager.tsx created",
        "Handles: file selection, preview, upload, removal",
        "Component < 200 lines",
        "Uses useCallback for handlers to prevent rerenders",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/ai/prompt-input/AttachmentManager.tsx (create)"
      ],
      "dependencies": [
        "REF-COMP-001a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_001B_COMPLETE"
    },
    {
      "id": "REF-COMP-001c",
      "name": "Extract PromptInput: ContextDisplay",
      "description": "Extract page context display into separate component",
      "priority": 1,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/ai/prompt-input/ContextDisplay.tsx created",
        "Shows current page context badges/chips",
        "Handles context clearing",
        "Component < 100 lines",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/ai/prompt-input/ContextDisplay.tsx (create)"
      ],
      "dependencies": [
        "REF-COMP-001a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_001C_COMPLETE"
    },
    {
      "id": "REF-COMP-001d",
      "name": "Extract PromptInput: KeyboardShortcuts",
      "description": "Extract keyboard shortcut handling into hook and component",
      "priority": 1,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/ai/prompt-input/usePromptShortcuts.ts hook created",
        "Handles: submit shortcut, history navigation, mention trigger",
        "Hook < 80 lines",
        "Shortcut hints component shows available shortcuts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/ai/prompt-input/usePromptShortcuts.ts (create)",
        "src/components/ai/prompt-input/ShortcutHints.tsx (create)"
      ],
      "dependencies": [
        "REF-COMP-001a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_001D_COMPLETE"
    },
    {
      "id": "REF-COMP-001e",
      "name": "Extract PromptInput: Create Barrel Export",
      "description": "Create index.ts and finalize prompt-input refactor",
      "priority": 1,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/ai/prompt-input/index.ts created",
        "Exports PromptInput as default and named export",
        "Original prompt-input.tsx updated to re-export from new location",
        "All consumers continue to work",
        "Total prompt-input directory files combined < 600 lines",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/ai/prompt-input/index.ts (create)",
        "src/components/ai/prompt-input.tsx (modify to re-export)"
      ],
      "dependencies": [
        "REF-COMP-001b",
        "REF-COMP-001c",
        "REF-COMP-001d"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_001E_COMPLETE"
    },
    {
      "id": "REF-COMP-002",
      "name": "Consolidate log-call-dialog Implementations",
      "description": "Merge two different log-call-dialog implementations into single reusable component",
      "priority": 2,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/shared/dialogs/LogCallDialog.tsx created",
        "Supports both customer and pipeline contexts via props",
        "Props: entityType ('customer' | 'opportunity'), entityId, onSuccess callback",
        "Uses UI from pipeline version (305 lines) - gradient headers, icons",
        "Component < 250 lines",
        "File src/components/domain/customers/log-call-dialog.tsx deleted",
        "File src/components/domain/pipeline/log-call-dialog.tsx deleted",
        "Both customer and pipeline pages import from shared location",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/shared/dialogs/LogCallDialog.tsx (create)",
        "src/components/domain/customers/log-call-dialog.tsx (delete)",
        "src/components/domain/pipeline/log-call-dialog.tsx (delete)",
        "src/routes/_authed/customers/$customerId.tsx (modify import)",
        "src/routes/_authed/pipeline/index.tsx (modify import)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_002_COMPLETE"
    },
    {
      "id": "REF-COMP-003a",
      "name": "Create ListPageLayout Component",
      "description": "Create reusable list page layout component",
      "priority": 3,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/shared/layouts/ListPageLayout.tsx created",
        "Props: title, subtitle?, metrics?, filters?, actions?, children (table)",
        "Handles: header with title/actions, optional metrics bar, filter section, content area",
        "Component < 200 lines",
        "Consistent spacing matches existing pages",
        "Responsive on mobile",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/shared/layouts/ListPageLayout.tsx (create)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_003A_COMPLETE"
    },
    {
      "id": "REF-COMP-003b",
      "name": "Apply ListPageLayout to Customers",
      "description": "Refactor customers list page to use ListPageLayout",
      "priority": 3,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/routes/_authed/customers/index.tsx uses ListPageLayout",
        "Page renders identically to before",
        "Code reduced by using shared layout",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/routes/_authed/customers/index.tsx (modify)"
      ],
      "dependencies": [
        "REF-COMP-003a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_003B_COMPLETE"
    },
    {
      "id": "REF-COMP-003c",
      "name": "Apply ListPageLayout to Orders",
      "description": "Refactor orders list page to use ListPageLayout",
      "priority": 3,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/routes/_authed/orders/index.tsx uses ListPageLayout",
        "Page renders identically to before",
        "Code reduced by using shared layout",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/routes/_authed/orders/index.tsx (modify)"
      ],
      "dependencies": [
        "REF-COMP-003a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_003C_COMPLETE"
    },
    {
      "id": "REF-COMP-004a",
      "name": "Create DetailPageLayout Component",
      "description": "Create reusable detail/sidebar layout component",
      "priority": 4,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/shared/layouts/DetailPageLayout.tsx created",
        "Props: header, tabs, sidebar?, actions?, children",
        "Handles: sidebar structure (if provided), tab navigation, action buttons",
        "Consistent sidebar width (320px as per existing)",
        "Component < 200 lines",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/shared/layouts/DetailPageLayout.tsx (create)"
      ],
      "dependencies": [
        "REF-COMP-003a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_004A_COMPLETE"
    },
    {
      "id": "REF-COMP-004b",
      "name": "Apply DetailPageLayout to Customer Detail",
      "description": "Refactor customer detail to use DetailPageLayout",
      "priority": 4,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/routes/_authed/customers/$customerId.tsx uses DetailPageLayout",
        "Page renders identically to before",
        "Code reduced by using shared layout",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/routes/_authed/customers/$customerId.tsx (modify)"
      ],
      "dependencies": [
        "REF-COMP-004a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_004B_COMPLETE"
    },
    {
      "id": "REF-COMP-005a",
      "name": "Extract OrderCreationDialog: Orchestrator",
      "description": "Create orchestrator for order creation dialog modes",
      "priority": 5,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/domain/orders/order-creation/OrderCreationDialog.tsx created",
        "Orchestrator handles mode switching: 'quick' | 'full' | 'from-opportunity'",
        "Component < 150 lines",
        "Renders appropriate form based on mode",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/domain/orders/order-creation/OrderCreationDialog.tsx (create)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_005A_COMPLETE"
    },
    {
      "id": "REF-COMP-005b",
      "name": "Extract OrderCreationDialog: QuickOrderForm",
      "description": "Extract quick order form as separate component",
      "priority": 5,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/domain/orders/order-creation/QuickOrderForm.tsx created",
        "Handles minimal fields for quick order creation",
        "Component < 200 lines",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/domain/orders/order-creation/QuickOrderForm.tsx (create)"
      ],
      "dependencies": [
        "REF-COMP-005a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_005B_COMPLETE"
    },
    {
      "id": "REF-COMP-005c",
      "name": "Extract OrderCreationDialog: FullOrderForm",
      "description": "Extract full order form as separate component",
      "priority": 5,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/domain/orders/order-creation/FullOrderForm.tsx created",
        "Handles all fields for detailed order creation",
        "Component < 300 lines",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/domain/orders/order-creation/FullOrderForm.tsx (create)"
      ],
      "dependencies": [
        "REF-COMP-005a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_005C_COMPLETE"
    },
    {
      "id": "REF-COMP-005d",
      "name": "Extract OrderCreationDialog: PipelineConversion",
      "description": "Extract pipeline conversion form as separate component",
      "priority": 5,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/domain/orders/order-creation/PipelineConversionForm.tsx created",
        "Handles converting opportunity to order with prefilled data",
        "Component < 200 lines",
        "Original order-creation-dialog.tsx deleted or redirects",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/domain/orders/order-creation/PipelineConversionForm.tsx (create)",
        "src/components/domain/orders/order-creation/index.ts (create)",
        "src/components/domain/orders/order-creation-dialog.tsx (delete or re-export)"
      ],
      "dependencies": [
        "REF-COMP-005b",
        "REF-COMP-005c"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_005D_COMPLETE"
    },
    {
      "id": "REF-COMP-006a",
      "name": "Extract OrderPanel: Tab Components",
      "description": "Extract order panel tabs into separate components",
      "priority": 6,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/domain/orders/order-panel/OrderDetailsTab.tsx created (< 150 lines)",
        "File src/components/domain/orders/order-panel/OrderItemsTab.tsx created (< 150 lines)",
        "File src/components/domain/orders/order-panel/OrderFulfillmentTab.tsx created (< 150 lines)",
        "Each tab handles its own data loading and display",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/domain/orders/order-panel/OrderDetailsTab.tsx (create)",
        "src/components/domain/orders/order-panel/OrderItemsTab.tsx (create)",
        "src/components/domain/orders/order-panel/OrderFulfillmentTab.tsx (create)"
      ],
      "dependencies": [
        "REF-COMP-004a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_006A_COMPLETE"
    },
    {
      "id": "REF-COMP-006b",
      "name": "Refactor OrderPanel to Use DetailPageLayout",
      "description": "Refactor order panel to use shared layout and extracted tabs",
      "priority": 6,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/domain/orders/order-panel/OrderPanel.tsx created using DetailPageLayout",
        "Component < 150 lines as orchestrator",
        "File src/components/domain/orders/order-panel/OrderActionsMenu.tsx created (< 100 lines)",
        "Original order-panel.tsx deleted or redirects",
        "All order panel functionality works as before",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/domain/orders/order-panel/OrderPanel.tsx (create)",
        "src/components/domain/orders/order-panel/OrderActionsMenu.tsx (create)",
        "src/components/domain/orders/order-panel/index.ts (create)",
        "src/components/domain/orders/order-panel.tsx (delete or re-export)"
      ],
      "dependencies": [
        "REF-COMP-006a",
        "REF-COMP-004a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_006B_COMPLETE"
    },
    {
      "id": "REF-COMP-007",
      "name": "Consolidate bulk-import-dialog Implementations",
      "description": "Merge customer and product bulk import dialogs into shared component",
      "priority": 7,
      "status": "pending",
      "type": "ui-component",
      "passes": false,
      "acceptance_criteria": [
        "File src/components/shared/dialogs/BulkImportDialog.tsx created",
        "Generic component accepting: entityType, fieldMapping, previewFn, importFn",
        "Component < 400 lines (shared complexity)",
        "Both customers and products use shared component",
        "Original domain-specific dialogs deleted",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/components/shared/dialogs/BulkImportDialog.tsx (create)",
        "src/components/domain/customers/bulk-import-dialog.tsx (delete)",
        "src/components/domain/products/bulk-import-dialog.tsx (delete)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_007_COMPLETE"
    },
    {
      "id": "REF-COMP-008",
      "name": "Create Component Size Lint Rule",
      "description": "Add ESLint rule to prevent future component bloat",
      "priority": 8,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "ESLint config updated with max-lines rule for components",
        "Rule: max 300 lines for .tsx files in components/",
        "Existing violations listed in .eslintrc exceptions (to fix later)",
        "New components will fail lint if >300 lines",
        "npm run lint passes",
        "Rule documented in memory-bank/_meta/conventions.md"
      ],
      "files_to_modify": [
        "eslint.config.js (modify)",
        "memory-bank/_meta/conventions.md (modify)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "REF_COMP_008_COMPLETE"
    }
  ],
  "success_criteria": [
    "No component > 300 lines (except documented exceptions)",
    "Zero duplicate component implementations",
    "ListPageLayout and DetailPageLayout exist and are used",
    "At least 4 domain pages use shared layouts",
    "prompt-input.tsx split into < 600 lines total across directory",
    "log-call-dialog consolidated to single implementation",
    "bulk-import-dialog consolidated to single implementation",
    "ESLint rule prevents future bloat",
    "npm run typecheck passes",
    "No functionality regressions"
  ],
  "out_of_scope": [
    "New UI features",
    "Styling changes beyond consistency",
    "New domain components",
    "Mobile-specific layouts",
    "Splitting other large components (forms, wizards) - future PRD"
  ]
}
