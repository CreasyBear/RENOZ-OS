{
  "id": "REF-AI",
  "name": "AI Architecture Enhancement",
  "description": "Evolve AI integration from single-turn tools to multi-turn agent patterns using Vercel AI SDK and agent-sdk patterns. Adds structured output validation and domain-specific agents.",
  "created": "2026-01-09",
  "updated": "2026-01-09",
  "priority": 4,
  "phase": "refactoring",
  "dependencies": {
    "phase": "Refactoring",
    "executionOrder": 7,
    "schemaRequired": [
      {
        "table": "ai-conversations",
        "status": "EXISTS"
      }
    ],
    "prdDependencies": [
      {
        "prdId": "REF-SERVER",
        "status": "OPTIONAL",
        "reason": "AI tools may call refactored server functions"
      },
      {
        "prdId": "REF-HOOKS",
        "status": "OPTIONAL",
        "reason": "AI components may use refactored hooks"
      }
    ],
    "enables": [
      {
        "prdId": "ROLE-*",
        "reason": "Domain-specific agents enhance role-based AI assistance"
      },
      {
        "prdId": "DOM-*",
        "reason": "Improved AI tools benefit domain implementations"
      }
    ]
  },
  "audit": {
    "date": "2026-01-09",
    "implementation_percentage": 40,
    "audit_file": "memory-bank/prd/_audits/ai-architecture-audit.json"
  },
  "references": {
    "internal": [
      "memory-bank/_meta/conventions.md - AI integration patterns",
      "memory-bank/_meta/assumptions.md - Claude API assumptions",
      "memory-bank/VISION.md - AI vision section"
    ],
    "external": [
      "Vercel AI SDK docs: streamText, tools, generateObject",
      "AI SDK Agents docs: Multi-Step Tool Pattern",
      "Claude Agent SDK docs: multi-turn conversations, sessions, subagents",
      "Anthropic docs: tool use best practices"
    ]
  },
  "current_state": {
    "pattern": "Single-turn tool calls",
    "ai_library_location": "lib/ai/",
    "existing_structure": {
      "core_files": [
        "client.ts (55 lines) - AI client setup",
        "context.ts (250 lines) - Page context extraction",
        "prompts.ts (145 lines) - System prompt generation",
        "safety.ts (130 lines) - Content safety checks",
        "token-store.ts (145 lines) - Token usage tracking"
      ],
      "tools_directory": [
        "queries.ts (979 lines) - Query tools (largest)",
        "artifacts.ts (815 lines) - Artifact generation",
        "mutations.ts (432 lines) - Mutation tools",
        "actions.ts (175 lines) - Action tools"
      ],
      "existing_directories": [
        "cache/ - Chat context caching",
        "memory/ - Basic memory store",
        "tools/utils/ - Tool helper functions"
      ]
    },
    "issues": [
      "No multi-turn reasoning - each request is isolated",
      "No structured output validation on AI responses",
      "Entity extraction uses regex, not semantic",
      "Tool selection is manual, not context-aware (context.ts exists but doesn't filter)",
      "No parallel tool execution",
      "No domain-specific agent specialization",
      "queries.ts at 979 lines is very large"
    ]
  },
  "target_state": {
    "pattern": "Multi-turn agents with tool chaining",
    "structured_output": "Zod-validated responses",
    "agents": [
      "SalesAgent",
      "OperationsAgent",
      "AnalyticsAgent"
    ],
    "new_directories": [
      "lib/ai/schemas/ - Response validation schemas",
      "lib/ai/chains/ - Multi-step tool chains",
      "lib/ai/agents/ - Domain-specific agents"
    ],
    "capabilities": [
      "Multi-step reasoning for complex queries",
      "Automatic tool chaining",
      "Context-aware tool filtering",
      "Parallel execution where applicable"
    ]
  },
  "stories": [
    {
      "id": "REF-AI-000",
      "name": "Triage Agent with Forced Handoff",
      "description": "Create main triage agent that routes all requests to domain specialists. Uses forced toolChoice to NEVER respond directly - only routes to appropriate agent. Based on Midday architecture pattern.",
      "priority": 0,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/agents/triage.ts created with mainAgent export",
        "Uses claude-3-5-haiku model for fast, cheap routing",
        "Temperature set to 0.1 for deterministic routing",
        "modelSettings.toolChoice forced to { type: 'tool', toolName: 'handoff_to_agent' }",
        "handoffs array includes 3+ domain agents (customers, orders, analytics)",
        "maxTurns: 1 (route only, no conversation)",
        "Agent never responds directly - always hands off",
        "File lib/ai/agents/index.ts exports mainAgent as default entry point",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/agents/triage.ts (create)",
        "lib/ai/agents/index.ts (modify)"
      ],
      "dependencies": ["REF-AI-004a"],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_000_COMPLETE",
      "reference": "_reference/.midday-reference/apps/api/src/ai/agents/main.ts",
      "blindspot_source": "Midday triage agent pattern - forced handoff routing"
    },
    {
      "id": "REF-AI-001a",
      "name": "Create AI Response Schemas Directory",
      "description": "Set up schema directory and initial response schemas",
      "priority": 1,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "Directory lib/ai/schemas/ created",
        "File lib/ai/schemas/index.ts exports all schemas",
        "File lib/ai/schemas/base.ts defines base response types",
        "Base types include: AIResponse, AIError, AIToolCall",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/schemas/index.ts (create)",
        "lib/ai/schemas/base.ts (create)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_001A_COMPLETE"
    },
    {
      "id": "REF-AI-001b",
      "name": "Add Domain Response Schemas",
      "description": "Create Zod schemas for domain-specific AI responses",
      "priority": 1,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/schemas/customer-summary.ts created with CustomerSummarySchema",
        "File lib/ai/schemas/quote-response.ts created with QuoteResponseSchema",
        "File lib/ai/schemas/analytics-response.ts created with AnalyticsResponseSchema",
        "Each schema validates: required fields, optional fields, nested objects",
        "Schemas exported from lib/ai/schemas/index.ts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/schemas/customer-summary.ts (create)",
        "lib/ai/schemas/quote-response.ts (create)",
        "lib/ai/schemas/analytics-response.ts (create)",
        "lib/ai/schemas/index.ts (modify)"
      ],
      "dependencies": [
        "REF-AI-001a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_001B_COMPLETE"
    },
    {
      "id": "REF-AI-001c",
      "name": "Apply Schema Validation to AI Tools",
      "description": "Implement validation for at least 2 AI tool responses",
      "priority": 1,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "At least 2 AI tool responses validated with Zod schemas",
        "Validation applied in lib/ai/tools/queries.ts",
        "Invalid responses trigger graceful fallback (not crash)",
        "Fallback returns: { error: true, message: string, partial?: data }",
        "Pattern documented in lib/ai/README.md",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/tools/queries.ts (modify)",
        "lib/ai/README.md (create)"
      ],
      "dependencies": [
        "REF-AI-001b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_001C_COMPLETE"
    },
    {
      "id": "REF-AI-001d",
      "name": "Redis Memory Provider for Working Memory",
      "description": "Implement Redis-based memory provider for fast context access, user preferences, and cross-session persistence. Based on Midday RedisProvider pattern.",
      "priority": 1,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "Install @ai-sdk-tools/memory and redis client packages",
        "File lib/ai/agents/config/shared.ts created with RedisProvider setup",
        "Working memory template defined (user profile, preferences, recent actions)",
        "History limit configured: 10 turns retained",
        "Memory scoped by userId:teamId for multi-tenant isolation",
        "titleModel configured for auto-generating chat titles (gpt-4.1-nano equivalent)",
        "suggestionsModel configured for 5 follow-up suggestions",
        "Falls back to in-memory provider in development when Redis unavailable",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/agents/config/shared.ts (create)",
        "lib/ai/memory/working-memory-template.ts (create)"
      ],
      "dependencies": ["REF-AI-001c"],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_001D_COMPLETE",
      "reference": "_reference/.midday-reference/apps/api/src/ai/agents/config/shared.ts",
      "blindspot_source": "Midday RedisProvider pattern for working memory"
    },
    {
      "id": "REF-AI-002a",
      "name": "Create Chains Directory Structure",
      "description": "Set up multi-step chain infrastructure",
      "priority": 2,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "Directory lib/ai/chains/ created",
        "File lib/ai/chains/base-chain.ts defines ChainStep, ChainResult types",
        "File lib/ai/chains/chain-executor.ts handles step execution with logging",
        "Chain timeout configurable (default 30 seconds)",
        "Error in any step returns partial result + explanation",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/chains/base-chain.ts (create)",
        "lib/ai/chains/chain-executor.ts (create)",
        "lib/ai/chains/index.ts (create)"
      ],
      "dependencies": [
        "REF-AI-001c"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_002A_COMPLETE"
    },
    {
      "id": "REF-AI-002b",
      "name": "Implement Analytics Chain",
      "description": "Create first multi-step chain for analytics queries",
      "priority": 2,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/chains/analytics-chain.ts created",
        "Chain handles: 'How are we doing this quarter?'",
        "Steps: query orders -> query pipeline -> compare periods -> generate insight",
        "Each step is logged with duration",
        "Chain uses chain-executor for execution",
        "Result includes step breakdown for debugging",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/chains/analytics-chain.ts (create)",
        "lib/ai/chains/index.ts (modify)"
      ],
      "dependencies": [
        "REF-AI-002a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_002B_COMPLETE"
    },
    {
      "id": "REF-AI-002c",
      "name": "Streaming Artifacts with Progressive Stages",
      "description": "Implement artifact streaming with progressive loading stages (loading → data_ready → analysis_ready). Uses @ai-sdk-tools/artifacts for visual, streaming UI feedback.",
      "priority": 2,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "Install @ai-sdk-tools/artifacts package",
        "File lib/ai/artifacts/index.ts created with artifact registry",
        "Implement 1 artifact with stages: e.g., quote-breakdown or customer-360",
        "Use getWriter() for streaming artifacts to client",
        "Stages implemented: 'loading' → 'data_ready' → 'analysis_ready'",
        "Loading stage shows message like 'Fetching customer data...'",
        "Data stage yields raw data for immediate display",
        "Analysis stage yields computed insights",
        "Artifact types include: chart, metrics, table",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/artifacts/index.ts (create)",
        "lib/ai/artifacts/quote-breakdown.ts (create)",
        "lib/ai/artifacts/customer-360.ts (create)"
      ],
      "dependencies": ["REF-AI-002b"],
      "estimated_iterations": 4,
      "completion_promise": "REF_AI_002C_COMPLETE",
      "reference": "_reference/.midday-reference/apps/api/src/ai/tools/get-business-health-score.ts",
      "blindspot_source": "Midday streaming artifacts pattern for progressive loading"
    },
    {
      "id": "REF-AI-003a",
      "name": "Enhance Context Tool Filtering: Setup",
      "description": "Add tool filtering capability to existing context system",
      "priority": 3,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/context.ts enhanced with getFilteredTools function",
        "Function accepts: currentPage, availableTools -> filteredTools",
        "Tool categories defined: customer, order, pipeline, inventory, analytics",
        "Each tool tagged with relevant categories in lib/ai/tools/*.ts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/context.ts (modify)",
        "lib/ai/tools/queries.ts (modify - add category tags)",
        "lib/ai/tools/mutations.ts (modify - add category tags)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_003A_COMPLETE"
    },
    {
      "id": "REF-AI-003b",
      "name": "Implement Context-Aware Tool Filtering",
      "description": "Apply tool filtering based on current page",
      "priority": 3,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "On /customers page: customer tools prioritized (shown first)",
        "On /orders page: order tools prioritized",
        "On /pipeline page: opportunity tools prioritized",
        "Irrelevant tools moved to 'other' category (still available)",
        "Tool filtering logged for debugging",
        "AI chat functionality works as before with better focus",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/context.ts (modify)",
        "lib/ai/prompts.ts (modify - use filtered tools)"
      ],
      "dependencies": [
        "REF-AI-003a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_003B_COMPLETE"
    },
    {
      "id": "REF-AI-004a",
      "name": "Create Agents Directory Structure",
      "description": "Set up domain-specific agent infrastructure",
      "priority": 4,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "Directory lib/ai/agents/ created",
        "File lib/ai/agents/base-agent.ts defines Agent interface",
        "Interface includes: name, description, tools, systemPrompt, canHandle(query)",
        "File lib/ai/agents/agent-router.ts routes queries to appropriate agent",
        "Router uses keyword matching and context for selection",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/agents/base-agent.ts (create)",
        "lib/ai/agents/agent-router.ts (create)",
        "lib/ai/agents/index.ts (create)"
      ],
      "dependencies": [
        "REF-AI-002b",
        "REF-AI-003b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_004A_COMPLETE"
    },
    {
      "id": "REF-AI-004b",
      "name": "Implement SalesAgent",
      "description": "Create sales domain agent for customer and pipeline queries",
      "priority": 4,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/agents/sales-agent.ts created",
        "Handles: customer queries, opportunity queries, quote queries",
        "Specialized system prompt for sales context",
        "Tools filtered to sales-relevant only",
        "Agent exported from lib/ai/agents/index.ts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/agents/sales-agent.ts (create)",
        "lib/ai/agents/index.ts (modify)"
      ],
      "dependencies": [
        "REF-AI-004a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_004B_COMPLETE"
    },
    {
      "id": "REF-AI-004c",
      "name": "Implement OperationsAgent",
      "description": "Create operations domain agent for orders and inventory",
      "priority": 4,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/agents/operations-agent.ts created",
        "Handles: order queries, inventory queries, fulfillment queries",
        "Specialized system prompt for operations context",
        "Tools filtered to operations-relevant only",
        "Agent exported from lib/ai/agents/index.ts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/agents/operations-agent.ts (create)",
        "lib/ai/agents/index.ts (modify)"
      ],
      "dependencies": [
        "REF-AI-004b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_004C_COMPLETE"
    },
    {
      "id": "REF-AI-004d",
      "name": "Implement AnalyticsAgent",
      "description": "Create analytics domain agent for metrics and reports",
      "priority": 4,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/agents/analytics-agent.ts created",
        "Handles: metrics queries, report generation, dashboard queries",
        "Uses analytics-chain for complex queries",
        "Specialized system prompt for analytics context",
        "Agent exported from lib/ai/agents/index.ts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/agents/analytics-agent.ts (create)",
        "lib/ai/agents/index.ts (modify)"
      ],
      "dependencies": [
        "REF-AI-004c",
        "REF-AI-002b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_004D_COMPLETE"
    },
    {
      "id": "REF-AI-005a",
      "name": "Enhance Session Memory",
      "description": "Enhance existing memory system for multi-turn context",
      "priority": 5,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/memory/index.ts enhanced (exists, enhance not replace)",
        "Session maintains conversation context across turns",
        "AI can reference previous queries: 'What about for last month?'",
        "Session timeout after 30 minutes of inactivity",
        "Memory includes: last 5 queries, results summary, active entity context",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/memory/index.ts (modify)",
        "lib/ai/memory/session-context.ts (create)"
      ],
      "dependencies": [
        "REF-AI-004d"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_005A_COMPLETE"
    },
    {
      "id": "REF-AI-005b",
      "name": "Implement Context Window Management",
      "description": "Add context summarization when approaching token limit",
      "priority": 5,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/memory/context-manager.ts created",
        "Monitors context size against token limit",
        "Summarizes old context when approaching limit (80%)",
        "Keeps recent context intact, summarizes older",
        "No memory leaks from orphaned sessions",
        "Session state visible in UI (optional indicator)",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/memory/context-manager.ts (create)",
        "lib/ai/memory/index.ts (modify)"
      ],
      "dependencies": [
        "REF-AI-005a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_005B_COMPLETE"
    },
    {
      "id": "REF-AI-006",
      "name": "Implement Parallel Tool Execution",
      "description": "Execute independent tools concurrently for faster responses",
      "priority": 6,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/chains/parallel-executor.ts created",
        "Analyzes tool dependency graph at runtime",
        "Independent tools executed with Promise.all",
        "Dependent tools wait for predecessors",
        "Example: 'Compare orders and pipeline' -> parallel queries, then compare",
        "Execution plan logged for debugging",
        "Graceful degradation if parallel execution fails",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/chains/parallel-executor.ts (create)",
        "lib/ai/chains/index.ts (modify)"
      ],
      "dependencies": [
        "REF-AI-002b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_006_COMPLETE"
    },
    {
      "id": "REF-AI-007",
      "name": "Create AI Architecture ADR",
      "description": "Document architectural decisions for AI integration",
      "priority": 7,
      "status": "pending",
      "type": "documentation",
      "passes": false,
      "acceptance_criteria": [
        "File memory-bank/adr/ADR-011-ai-architecture.md created",
        "Documents: agent patterns, tool organization, session management",
        "Explains trade-offs: single-turn vs multi-turn",
        "Defines when to use each agent type",
        "References external docs (AI SDK, agent-sdk)",
        "File memory-bank/_meta/conventions.md updated to reference ADR"
      ],
      "files_to_modify": [
        "memory-bank/adr/ADR-011-ai-architecture.md (create)",
        "memory-bank/_meta/conventions.md (modify)"
      ],
      "dependencies": [
        "REF-AI-004d"
      ],
      "estimated_iterations": 2,
      "completion_promise": "REF_AI_007_COMPLETE"
    },
    {
      "id": "REF-AI-008",
      "name": "Add AI Usage Analytics",
      "description": "Track AI tool usage for optimization",
      "priority": 8,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File lib/ai/analytics.ts created",
        "Tracks: tool calls, response times, error rates, token usage",
        "Data aggregated (no individual queries stored for privacy)",
        "Identifies most/least used tools",
        "Integrates with existing token-store.ts",
        "Basic metrics accessible via admin endpoint",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "lib/ai/analytics.ts (create)",
        "lib/ai/token-store.ts (modify - integrate)"
      ],
      "dependencies": [
        "REF-AI-004d"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_AI_008_COMPLETE"
    }
  ],
  "success_criteria": [
    "Multi-step tool chains work for complex queries",
    "Domain-specific agents handle specialized queries",
    "Context-aware tool filtering reduces irrelevant suggestions",
    "Zod validates all structured AI responses",
    "Multi-turn conversations maintain context",
    "Parallel execution improves response times",
    "ADR documents all patterns",
    "npm run typecheck passes",
    "No AI functionality regressions"
  ],
  "out_of_scope": [
    "New AI features beyond architecture",
    "UI changes to AI chat",
    "New tool implementations",
    "Fine-tuning or model changes",
    "Splitting queries.ts (979 lines) - consider in future"
  ]
}
