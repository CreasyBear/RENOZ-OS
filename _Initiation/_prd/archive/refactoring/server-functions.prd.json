{
  "id": "REF-SERVER",
  "name": "Server Functions Refactoring",
  "description": "Standardize server function patterns, split large files, document intentional deviations. Establishes consistent patterns per _meta/conventions.md before domain work begins.",
  "created": "2026-01-09",
  "updated": "2026-01-09",
  "priority": 1,
  "phase": "refactoring",
  "dependencies": {
    "phase": "Refactoring",
    "executionOrder": 7,
    "schemaRequired": [],
    "prdDependencies": [],
    "enables": [
      {
        "prdId": "DOM-*",
        "reason": "Consistent server function patterns benefit all domain implementations"
      },
      {
        "prdId": "REF-HOOKS",
        "reason": "Refactored server functions provide cleaner integration with hooks"
      },
      {
        "prdId": "ROLE-*",
        "reason": "Role-specific server functions follow established patterns"
      }
    ]
  },
  "audit": {
    "date": "2026-01-09",
    "implementation_percentage": 58,
    "audit_file": "memory-bank/prd/_audits/server-functions-audit.json"
  },
  "references": {
    "internal": [
      "memory-bank/_meta/conventions.md - Server function patterns",
      "memory-bank/_meta/assumptions.md - Architecture patterns section",
      "memory-bank/_meta/glossary.md - Entity terminology"
    ],
    "external": [
      "TanStack Start docs: createServerFn with inputValidator and middleware",
      "Supabase docs: RLS performance - use (select auth.uid()) pattern"
    ]
  },
  "current_state": {
    "total_files": 46,
    "pattern_adherence": "58%",
    "files_over_limit": 19,
    "issues": [
      "orders.ts: 2885 lines - largest file, multiple concerns",
      "products.ts: 1238 lines - needs splitting",
      "dashboard.ts: 1186 lines - metrics complexity",
      "customers.ts: 1116 lines - over limit",
      "inventory.ts: 1043 lines - over limit",
      "issues.ts: 1034 lines - over limit",
      "warranties.ts: 990 lines - over limit",
      "ai-chat.ts: bypasses Zod validation (uses .inputValidator((data) => data))",
      "pipeline.ts: inconsistent handler signature (missing destructuring)",
      "Mixed error message patterns across files",
      "Mixed return types: flat, paginated, metrics-wrapped"
    ]
  },
  "target_state": {
    "max_file_size": "400 lines",
    "pattern_adherence": "100%",
    "documented_deviations": true,
    "consistent_error_format": true,
    "return_type_conventions": "documented"
  },
  "stories": [
    {
      "id": "REF-SERVER-001",
      "name": "Create Server Functions README",
      "description": "Document the standard server function pattern and allowed deviations",
      "priority": 1,
      "status": "pending",
      "type": "documentation",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/README.md exists",
        "Documents standard pattern: createServerFn -> inputValidator -> handler -> requireAuth -> withRLSContext",
        "Lists allowed deviations with rationale (jobs-public.ts, auth.ts, notifications internal)",
        "Documents return type conventions: when to use flat vs paginated vs metrics",
        "Documents error handling pattern with standard error codes",
        "References _meta/conventions.md for full pattern details"
      ],
      "files_to_modify": [
        "src/server/functions/README.md (create)"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "REF_SERVER_001_COMPLETE"
    },
    {
      "id": "REF-SERVER-002a",
      "name": "Split orders.ts: CRUD Operations",
      "description": "Extract order CRUD operations into focused file",
      "priority": 2,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/orders/order-crud.ts created",
        "Contains: createOrder, updateOrder, deleteOrder, getOrder, getOrderSummary",
        "File < 400 lines",
        "All functions use withRLSContext pattern",
        "All imports updated in consumers",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/orders/order-crud.ts (create)",
        "src/server/functions/orders.ts (modify - extract)"
      ],
      "dependencies": [
        "REF-SERVER-001"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_002A_COMPLETE"
    },
    {
      "id": "REF-SERVER-002b",
      "name": "Split orders.ts: Query Operations",
      "description": "Extract order list and search operations into focused file",
      "priority": 2,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/orders/order-queries.ts created",
        "Contains: listOrders, searchOrders, getOrdersByCustomer, getOrdersByStatus",
        "File < 400 lines",
        "All functions use withRLSContext pattern",
        "All imports updated in consumers",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/orders/order-queries.ts (create)",
        "src/server/functions/orders.ts (modify - extract)"
      ],
      "dependencies": [
        "REF-SERVER-002a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_002B_COMPLETE"
    },
    {
      "id": "REF-SERVER-002c",
      "name": "Split orders.ts: Fulfillment Operations",
      "description": "Extract order fulfillment and status operations",
      "priority": 2,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/orders/order-fulfillment.ts created",
        "Contains: updateOrderStatus, markAsShipped, markAsDelivered, generatePackingSlip, generatePickList",
        "File < 400 lines",
        "All functions use withRLSContext pattern",
        "All imports updated in consumers",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/orders/order-fulfillment.ts (create)",
        "src/server/functions/orders.ts (modify - extract)"
      ],
      "dependencies": [
        "REF-SERVER-002b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_002C_COMPLETE"
    },
    {
      "id": "REF-SERVER-002d",
      "name": "Split orders.ts: Invoicing Operations",
      "description": "Extract order invoicing and payment operations",
      "priority": 2,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/orders/order-invoicing.ts created",
        "Contains: createInvoice, recordPayment, getOrderBalance, generateInvoicePdf",
        "File < 400 lines",
        "All functions use withRLSContext pattern",
        "All imports updated in consumers",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/orders/order-invoicing.ts (create)",
        "src/server/functions/orders.ts (modify - extract)"
      ],
      "dependencies": [
        "REF-SERVER-002c"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_002D_COMPLETE"
    },
    {
      "id": "REF-SERVER-002e",
      "name": "Create orders/index.ts Barrel Export",
      "description": "Create barrel export for orders module",
      "priority": 2,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/orders/index.ts created",
        "Exports all functions from order-crud, order-queries, order-fulfillment, order-invoicing",
        "Original orders.ts deleted or redirects to barrel",
        "All imports throughout codebase work unchanged",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/orders/index.ts (create)",
        "src/server/functions/orders.ts (delete or modify to re-export)"
      ],
      "dependencies": [
        "REF-SERVER-002d"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_002E_COMPLETE"
    },
    {
      "id": "REF-SERVER-003a",
      "name": "Split dashboard.ts: Metrics Functions",
      "description": "Extract dashboard metric calculations",
      "priority": 3,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/dashboard/dashboard-metrics.ts created",
        "Contains: getDashboardMetrics, getRevenueMetrics, getOrderMetrics, getPipelineMetrics",
        "File < 400 lines",
        "All functions use withRLSContext pattern",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/dashboard/dashboard-metrics.ts (create)",
        "src/server/functions/dashboard.ts (modify - extract)"
      ],
      "dependencies": [
        "REF-SERVER-001"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_003A_COMPLETE"
    },
    {
      "id": "REF-SERVER-003b",
      "name": "Split dashboard.ts: Chart Data Functions",
      "description": "Extract dashboard chart data generation",
      "priority": 3,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/dashboard/dashboard-charts.ts created",
        "Contains: getRevenueChart, getOrdersChart, getPipelineChart, getInventoryChart",
        "File < 400 lines",
        "All functions use withRLSContext pattern",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/dashboard/dashboard-charts.ts (create)",
        "src/server/functions/dashboard.ts (modify - extract)"
      ],
      "dependencies": [
        "REF-SERVER-003a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_003B_COMPLETE"
    },
    {
      "id": "REF-SERVER-003c",
      "name": "Create dashboard/index.ts Barrel Export",
      "description": "Create barrel export for dashboard module",
      "priority": 3,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/dashboard/index.ts created",
        "Exports all functions from dashboard-metrics, dashboard-charts",
        "Original dashboard.ts deleted or redirects to barrel",
        "All imports throughout codebase work unchanged",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/dashboard/index.ts (create)",
        "src/server/functions/dashboard.ts (delete or modify)"
      ],
      "dependencies": [
        "REF-SERVER-003b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_003C_COMPLETE"
    },
    {
      "id": "REF-SERVER-004",
      "name": "Fix ai-chat.ts Validation Pattern",
      "description": "Replace custom validator with standard Zod inputValidator pattern",
      "priority": 4,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/ai-chat.ts uses .inputValidator(ChatMessageSchema) not custom function",
        "Removes manual z.parse() inside handler at line 36",
        "Handler receives pre-validated data via destructuring: async ({ data })",
        "Follows exact pattern from _meta/conventions.md",
        "All AI chat functionality works as before",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/ai-chat.ts (modify)"
      ],
      "dependencies": [
        "REF-SERVER-001"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_004_COMPLETE"
    },
    {
      "id": "REF-SERVER-005",
      "name": "Fix pipeline.ts Handler Signatures",
      "description": "Standardize handler signature to match conventions",
      "priority": 5,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/pipeline.ts modified",
        "All handlers use ({ data }: { data: TypeName }) destructuring pattern",
        "Specifically fix line 79: .handler(async (data: ListOpportunitiesInput)) to .handler(async ({ data }: { data: ListOpportunitiesInput }))",
        "All other handlers in file follow same pattern",
        "Matches pattern in _meta/conventions.md exactly",
        "All pipeline functionality works as before",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/pipeline.ts (modify)"
      ],
      "dependencies": [
        "REF-SERVER-001"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_005_COMPLETE"
    },
    {
      "id": "REF-SERVER-006a",
      "name": "Create Error Response Utility",
      "description": "Create unified error handling utility for consistent error responses",
      "priority": 6,
      "status": "pending",
      "type": "server-function",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/utils/error-response.ts created",
        "Exports createErrorResponse(error: AppError) function",
        "Standardizes error format: { code, message, details, statusCode }",
        "Exports AppError type with standard error codes",
        "Error codes include: VALIDATION_ERROR, NOT_FOUND, UNAUTHORIZED, FORBIDDEN, CONFLICT, INTERNAL_ERROR",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/utils/error-response.ts (create)"
      ],
      "dependencies": [
        "REF-SERVER-001"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_006A_COMPLETE"
    },
    {
      "id": "REF-SERVER-006b",
      "name": "Apply Error Response Utility",
      "description": "Update server functions to use standardized error utility",
      "priority": 6,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "At least 5 server function files updated to use createErrorResponse",
        "Files include: customers.ts, orders/, pipeline.ts, products.ts, inventory.ts",
        "Error responses consistent across updated files",
        "Documents error codes in _meta/conventions.md",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/customers.ts (modify)",
        "src/server/functions/orders/order-crud.ts (modify)",
        "src/server/functions/pipeline.ts (modify)",
        "src/server/functions/products.ts (modify)",
        "src/server/functions/inventory.ts (modify)",
        "memory-bank/_meta/conventions.md (modify)"
      ],
      "dependencies": [
        "REF-SERVER-006a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_006B_COMPLETE"
    },
    {
      "id": "REF-SERVER-007",
      "name": "Document Return Type Conventions ADR",
      "description": "Establish and document when to use each return type pattern",
      "priority": 7,
      "status": "pending",
      "type": "documentation",
      "passes": false,
      "acceptance_criteria": [
        "File memory-bank/adr/ADR-010-return-type-conventions.md created",
        "Documents three patterns: flat (single entity), paginated (lists), metrics (analytics)",
        "Provides decision tree for choosing pattern",
        "Lists all server functions and their return type category",
        "File memory-bank/_meta/conventions.md updated to reference ADR"
      ],
      "files_to_modify": [
        "memory-bank/adr/ADR-010-return-type-conventions.md (create)",
        "memory-bank/_meta/conventions.md (modify)"
      ],
      "dependencies": [
        "REF-SERVER-001"
      ],
      "estimated_iterations": 2,
      "completion_promise": "REF_SERVER_007_COMPLETE"
    },
    {
      "id": "REF-SERVER-008a",
      "name": "Create Server Function Test Template",
      "description": "Establish testing pattern for server functions",
      "priority": 8,
      "status": "pending",
      "type": "documentation",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/__tests__/template.test.ts created",
        "Documents how to test: validation, auth, RLS context, error cases",
        "Includes example test structure with setup/teardown",
        "Pattern documented in src/server/functions/README.md"
      ],
      "files_to_modify": [
        "src/server/functions/__tests__/template.test.ts (create)",
        "src/server/functions/README.md (modify)"
      ],
      "dependencies": [
        "REF-SERVER-001"
      ],
      "estimated_iterations": 2,
      "completion_promise": "REF_SERVER_008A_COMPLETE"
    },
    {
      "id": "REF-SERVER-008b",
      "name": "Create customers.test.ts Following Template",
      "description": "Create first real test file following the template",
      "priority": 8,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/__tests__/customers.test.ts created",
        "Tests: listCustomers, getCustomer, createCustomer, updateCustomer validation",
        "Tests auth rejection for unauthenticated requests",
        "Tests RLS context isolation",
        "Tests error cases return proper AppError format",
        "Tests pass: npm run test src/server/functions/__tests__/customers.test.ts"
      ],
      "files_to_modify": [
        "src/server/functions/__tests__/customers.test.ts (create)"
      ],
      "dependencies": [
        "REF-SERVER-008a",
        "REF-SERVER-006a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_008B_COMPLETE"
    },
    {
      "id": "REF-SERVER-009a",
      "name": "Split products.ts: CRUD and Queries",
      "description": "Extract product CRUD and query operations (file is 1238 lines)",
      "priority": 9,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/products/product-crud.ts created with CRUD operations",
        "File src/server/functions/products/product-queries.ts created with list/search",
        "Each file < 400 lines",
        "All functions use withRLSContext pattern",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/products/product-crud.ts (create)",
        "src/server/functions/products/product-queries.ts (create)",
        "src/server/functions/products.ts (modify - extract)"
      ],
      "dependencies": [
        "REF-SERVER-002e"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_009A_COMPLETE"
    },
    {
      "id": "REF-SERVER-009b",
      "name": "Create products/index.ts Barrel Export",
      "description": "Create barrel export for products module",
      "priority": 9,
      "status": "pending",
      "type": "refactoring",
      "passes": false,
      "acceptance_criteria": [
        "File src/server/functions/products/index.ts created",
        "Exports all functions from product-crud, product-queries",
        "Original products.ts deleted or redirects to barrel",
        "All imports throughout codebase work unchanged",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/products/index.ts (create)",
        "src/server/functions/products.ts (delete or modify)"
      ],
      "dependencies": [
        "REF-SERVER-009a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "REF_SERVER_009B_COMPLETE"
    }
  ],
  "success_criteria": [
    "All server function files < 400 lines",
    "100% pattern adherence (inputValidator, requireAuth, withRLSContext)",
    "README documents all patterns and deviations",
    "ADR documents return type conventions",
    "At least one test file exists following template",
    "Standardized error responses using AppError",
    "API response times: < 200ms for reads, < 500ms for writes (per assumptions.md)",
    "npm run typecheck passes",
    "No functionality regressions"
  ],
  "out_of_scope": [
    "Adding new server functions",
    "Changing business logic",
    "Database schema changes",
    "New features",
    "Splitting remaining large files (customers, inventory, issues, warranties) - future PRD"
  ]
}
