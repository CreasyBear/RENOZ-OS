{
  "id": "DOM-ORDERS",
  "name": "Order Management System",
  "description": "Complete order lifecycle management system from creation to delivery. End-to-end order processing with fulfillment tracking, shipping management, and customer communication.",
  "created": "2026-01-10",
  "updated": "2026-01-10",
  "priority": 1,
  "phase": "core-business",
  "version": "1.0",
  "business_value": {
    "revenue_critical": true,
    "customer_facing": true,
    "operational_core": true,
    "description": "Primary revenue generation and fulfillment system"
  },
  "system_requirements": {
    "database": {
      "orders": {
        "description": "Core order header information",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "orderNumber": "varchar(50) UNIQUE NOT NULL",
          "customerId": "uuid NOT NULL REFERENCES customers(id) ON DELETE RESTRICT",
          "status": "enum('draft', 'confirmed', 'picking', 'picked', 'shipped', 'delivered', 'cancelled')",
          "orderDate": "timestamp NOT NULL DEFAULT NOW()",
          "promisedShipDate": "date",
          "actualShipDate": "date",
          "totalAmount": "decimal(10,2) NOT NULL",
          "taxAmount": "decimal(10,2) NOT NULL DEFAULT 0",
          "shippingAmount": "decimal(10,2) NOT NULL DEFAULT 0",
          "discountAmount": "decimal(10,2) NOT NULL DEFAULT 0",
          "notes": "text",
          "version": "integer NOT NULL DEFAULT 1",
          "createdBy": "uuid NOT NULL REFERENCES users(id) ON DELETE SET NULL",
          "updatedBy": "uuid NOT NULL REFERENCES users(id) ON DELETE SET NULL",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": {
          "idx_orders_org_status": "CREATE INDEX idx_orders_org_status ON orders(organization_id, status)",
          "idx_orders_org_created": "CREATE INDEX idx_orders_org_created ON orders(organization_id, created_at DESC)",
          "idx_orders_org_customer": "CREATE INDEX idx_orders_org_customer ON orders(organization_id, customer_id)",
          "idx_orders_order_number": "CREATE INDEX idx_orders_order_number ON orders(order_number)"
        },
        "constraints": [
          "totalAmount >= 0",
          "taxAmount >= 0",
          "shippingAmount >= 0"
        ]
      },
      "orderItems": {
        "description": "Individual line items on orders",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "orderId": "uuid NOT NULL REFERENCES orders(id) ON DELETE CASCADE",
          "productId": "uuid NOT NULL REFERENCES products(id) ON DELETE RESTRICT",
          "productNameSnapshot": "varchar(255) NOT NULL",
          "productSkuSnapshot": "varchar(100)",
          "productDescriptionSnapshot": "text",
          "unitPriceSnapshot": "numeric(12,2) NOT NULL",
          "quantity": "integer NOT NULL CHECK (quantity > 0)",
          "unitPrice": "decimal(10,2) NOT NULL CHECK (unitPrice >= 0)",
          "lineTotal": "decimal(10,2) NOT NULL",
          "notes": "text",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": {
          "idx_orderitems_org_status": "CREATE INDEX idx_orderitems_org_status ON orderItems(organization_id, order_id)",
          "idx_orderitems_org_created": "CREATE INDEX idx_orderitems_org_created ON orderItems(organization_id, created_at DESC)",
          "idx_orderitems_org_order": "CREATE INDEX idx_orderitems_org_order ON orderItems(organization_id, order_id)",
          "idx_orderitems_org_product": "CREATE INDEX idx_orderitems_org_product ON orderItems(organization_id, product_id)"
        },
        "constraints": [
          "lineTotal = quantity * unitPrice"
        ]
      },
      "orderShipments": {
        "description": "Shipment tracking information",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "orderId": "uuid NOT NULL REFERENCES orders(id) ON DELETE CASCADE",
          "carrier": "varchar(50) NOT NULL",
          "trackingNumber": "varchar(100) UNIQUE",
          "shippedAt": "timestamp NOT NULL DEFAULT NOW()",
          "estimatedDelivery": "date",
          "deliveredAt": "timestamp",
          "recipientName": "varchar(100)",
          "deliveryNotes": "text",
          "signatureUrl": "text",
          "photoUrl": "text",
          "createdBy": "uuid NOT NULL REFERENCES users(id) ON DELETE SET NULL",
          "updatedBy": "uuid NOT NULL REFERENCES users(id) ON DELETE SET NULL",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": {
          "idx_ordershipments_org_status": "CREATE INDEX idx_ordershipments_org_status ON orderShipments(organization_id, order_id)",
          "idx_ordershipments_org_created": "CREATE INDEX idx_ordershipments_org_created ON orderShipments(organization_id, created_at DESC)",
          "idx_ordershipments_org_order": "CREATE INDEX idx_ordershipments_org_order ON orderShipments(organization_id, order_id)",
          "idx_ordershipments_org_tracking": "CREATE INDEX idx_ordershipments_org_tracking ON orderShipments(organization_id, tracking_number)",
          "idx_ordershipments_org_delivered": "CREATE INDEX idx_ordershipments_org_delivered ON orderShipments(organization_id, delivered_at DESC)"
        }
      },
      "shipmentItems": {
        "description": "Quantity shipped per item per shipment",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "shipmentId": "uuid NOT NULL REFERENCES orderShipments(id) ON DELETE CASCADE",
          "orderItemId": "uuid NOT NULL REFERENCES orderItems(id) ON DELETE CASCADE",
          "quantityShipped": "integer NOT NULL CHECK (quantityShipped > 0)",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": {
          "idx_shipmentitems_org_status": "CREATE INDEX idx_shipmentitems_org_status ON shipmentItems(organization_id, shipment_id)",
          "idx_shipmentitems_org_created": "CREATE INDEX idx_shipmentitems_org_created ON shipmentItems(organization_id, created_at DESC)",
          "idx_shipmentitems_org_shipment": "CREATE INDEX idx_shipmentitems_org_shipment ON shipmentItems(organization_id, shipment_id)",
          "idx_shipmentitems_org_orderitem": "CREATE INDEX idx_shipmentitems_org_orderitem ON shipmentItems(organization_id, order_item_id)"
        },
        "constraints": [
          "quantityShipped <= (SELECT quantity FROM orderItems WHERE id = orderItemId)"
        ]
      },
      "orderAmendments": {
        "description": "Order change requests and approvals",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "orderId": "uuid NOT NULL REFERENCES orders(id) ON DELETE CASCADE",
          "requestedAt": "timestamp NOT NULL DEFAULT NOW()",
          "requestedBy": "uuid NOT NULL REFERENCES users(id) ON DELETE SET NULL",
          "status": "enum('pending', 'approved', 'rejected', 'applied') DEFAULT 'pending'",
          "approvedAt": "timestamp",
          "approvedBy": "uuid REFERENCES users(id) ON DELETE SET NULL",
          "reason": "text NOT NULL",
          "changes": "jsonb NOT NULL",
          "appliedAt": "timestamp",
          "version": "integer NOT NULL DEFAULT 1",
          "createdBy": "uuid NOT NULL REFERENCES users(id) ON DELETE SET NULL",
          "updatedBy": "uuid NOT NULL REFERENCES users(id) ON DELETE SET NULL",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": {
          "idx_orderamendments_org_status": "CREATE INDEX idx_orderamendments_org_status ON orderAmendments(organization_id, status)",
          "idx_orderamendments_org_created": "CREATE INDEX idx_orderamendments_org_created ON orderAmendments(organization_id, created_at DESC)",
          "idx_orderamendments_org_order": "CREATE INDEX idx_orderamendments_org_order ON orderAmendments(organization_id, order_id)",
          "idx_orderamendments_org_requested": "CREATE INDEX idx_orderamendments_org_requested ON orderAmendments(organization_id, requested_at DESC)"
        }
      },
      "orderTemplates": {
        "description": "Reusable order configurations",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "name": "varchar(100) NOT NULL",
          "description": "text",
          "version": "integer NOT NULL DEFAULT 1",
          "createdBy": "uuid NOT NULL REFERENCES users(id)",
          "updatedBy": "uuid NOT NULL REFERENCES users(id) ON DELETE SET NULL",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": {
          "idx_ordertemplates_org_status": "CREATE INDEX idx_ordertemplates_org_status ON orderTemplates(organization_id, name)",
          "idx_ordertemplates_org_created": "CREATE INDEX idx_ordertemplates_org_created ON orderTemplates(organization_id, created_at DESC)"
        }
      },
      "orderTemplateItems": {
        "description": "Items within order templates",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "templateId": "uuid NOT NULL REFERENCES orderTemplates(id)",
          "productId": "uuid NOT NULL REFERENCES products(id)",
          "quantity": "integer NOT NULL CHECK (quantity > 0)",
          "notes": "text",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": {
          "idx_ordertemplateitems_org_status": "CREATE INDEX idx_ordertemplateitems_org_status ON orderTemplateItems(organization_id, template_id)",
          "idx_ordertemplateitems_org_created": "CREATE INDEX idx_ordertemplateitems_org_created ON orderTemplateItems(organization_id, created_at DESC)",
          "idx_ordertemplateitems_org_template": "CREATE INDEX idx_ordertemplateitems_org_template ON orderTemplateItems(organization_id, template_id)",
          "idx_ordertemplateitems_org_product": "CREATE INDEX idx_ordertemplateitems_org_product ON orderTemplateItems(organization_id, product_id)"
        }
      }
    },
    "api_endpoints": {
      "orders": {
        "list": {
          "method": "GET",
          "path": "/api/orders",
          "query_params": [
            "page",
            "limit",
            "status",
            "customerId",
            "dateFrom",
            "dateTo",
            "search"
          ],
          "response": {
            "orders": "Order[]",
            "total": "number",
            "page": "number",
            "limit": "number"
          },
          "description": "List orders with filtering and pagination"
        },
        "get": {
          "method": "GET",
          "path": "/api/orders/:id",
          "response": {
            "order": "Order",
            "items": "OrderItem[]",
            "shipments": "OrderShipment[]",
            "activities": "Activity[]",
            "amendments": "OrderAmendment[]"
          },
          "description": "Get complete order details"
        },
        "create": {
          "method": "POST",
          "path": "/api/orders",
          "body": {
            "customerId": "uuid",
            "items": "OrderItemInput[]",
            "notes": "string?",
            "promisedShipDate": "date?"
          },
          "response": {
            "order": "Order",
            "items": "OrderItem[]"
          },
          "description": "Create new order with items"
        },
        "update": {
          "method": "PUT",
          "path": "/api/orders/:id",
          "body": {
            "status": "OrderStatus?",
            "notes": "string?",
            "promisedShipDate": "date?"
          },
          "response": {
            "order": "Order"
          },
          "description": "Update order header information"
        },
        "addItem": {
          "method": "POST",
          "path": "/api/orders/:id/items",
          "body": {
            "productId": "uuid",
            "quantity": "number",
            "unitPrice": "number",
            "notes": "string?"
          },
          "response": {
            "item": "OrderItem"
          },
          "description": "Add item to existing order"
        },
        "updateItem": {
          "method": "PUT",
          "path": "/api/orders/:id/items/:itemId",
          "body": {
            "quantity": "number?",
            "unitPrice": "number?",
            "notes": "string?"
          },
          "response": {
            "item": "OrderItem"
          },
          "description": "Update order item"
        },
        "deleteItem": {
          "method": "DELETE",
          "path": "/api/orders/:id/items/:itemId",
          "response": {
            "success": "boolean"
          },
          "description": "Remove item from order"
        },
        "duplicate": {
          "method": "POST",
          "path": "/api/orders/:id/duplicate",
          "response": {
            "order": "Order",
            "items": "OrderItem[]"
          },
          "description": "Create duplicate order"
        }
      },
      "shipments": {
        "create": {
          "method": "POST",
          "path": "/api/orders/:orderId/shipments",
          "body": {
            "carrier": "string",
            "trackingNumber": "string?",
            "items": "ShipmentItemInput[]",
            "estimatedDelivery": "date?"
          },
          "response": {
            "shipment": "OrderShipment",
            "items": "ShipmentItem[]"
          },
          "description": "Create shipment for order items"
        },
        "confirmDelivery": {
          "method": "POST",
          "path": "/api/shipments/:id/confirm-delivery",
          "body": {
            "recipientName": "string",
            "signature": "file?",
            "photo": "file?",
            "notes": "string?"
          },
          "response": {
            "shipment": "OrderShipment"
          },
          "description": "Confirm delivery with proof"
        }
      },
      "templates": {
        "list": {
          "method": "GET",
          "path": "/api/order-templates",
          "response": {
            "templates": "OrderTemplate[]"
          },
          "description": "List available order templates"
        },
        "createFromOrder": {
          "method": "POST",
          "path": "/api/orders/:id/save-as-template",
          "body": {
            "name": "string",
            "description": "string?"
          },
          "response": {
            "template": "OrderTemplate"
          },
          "description": "Save order as template"
        },
        "createOrderFromTemplate": {
          "method": "POST",
          "path": "/api/order-templates/:id/create-order",
          "body": {
            "customerId": "uuid"
          },
          "response": {
            "order": "Order",
            "items": "OrderItem[]"
          },
          "description": "Create order from template"
        }
      },
      "amendments": {
        "request": {
          "method": "POST",
          "path": "/api/orders/:id/amendments",
          "body": {
            "reason": "string",
            "changes": "AmendmentChanges"
          },
          "response": {
            "amendment": "OrderAmendment"
          },
          "description": "Request order amendment"
        },
        "approve": {
          "method": "POST",
          "path": "/api/amendments/:id/approve",
          "response": {
            "amendment": "OrderAmendment"
          },
          "description": "Approve amendment (manager only)"
        },
        "apply": {
          "method": "POST",
          "path": "/api/amendments/:id/apply",
          "response": {
            "order": "Order"
          },
          "description": "Apply approved amendment"
        }
      }
    },
    "ui_components": {
      "orderList": {
        "description": "Order list with filtering and bulk actions",
        "layout": {
          "mobile": "Card list with key info",
          "tablet": "Compact table with pagination",
          "desktop": "Full table with advanced filtering"
        },
        "features": [
          "Status filtering",
          "Date range filtering",
          "Customer search",
          "Bulk status updates",
          "Export to CSV",
          "Sort by date, amount, status"
        ],
        "columns": [
          "Order #",
          "Customer",
          "Date",
          "Status",
          "Total",
          "Actions"
        ]
      },
      "orderDetail": {
        "description": "Complete order view with tabs",
        "tabs": [
          "Overview",
          "Items",
          "Fulfillment",
          "Shipments",
          "Amendments",
          "Activity"
        ],
        "overview": {
          "customerInfo": "Name, contact, ABN",
          "orderSummary": "Number, date, status, totals",
          "shippingInfo": "Address, promised date",
          "quickActions": [
            "Edit",
            "Duplicate",
            "Print",
            "Ship"
          ]
        },
        "items": {
          "table": [
            "Product",
            "SKU",
            "Qty",
            "Price",
            "Total",
            "Status"
          ],
          "actions": [
            "Add Item",
            "Edit Qty",
            "Remove Item"
          ],
          "features": [
            "Inline editing",
            "Stock checking",
            "Price updates"
          ]
        },
        "fulfillment": {
          "status": "Current fulfillment stage",
          "pickList": "Generate printable pick list",
          "packingSlip": "Generate packing documentation",
          "shippingLabels": "Bulk shipping label generation"
        }
      },
      "orderCreation": {
        "description": "Multi-step order creation wizard",
        "steps": [
          "Select Customer",
          "Add Items",
          "Configure Shipping",
          "Review & Confirm"
        ],
        "features": [
          "Customer search/selection",
          "Product catalog integration",
          "Quantity and pricing",
          "Shipping calculator",
          "Tax calculation (GST)",
          "Order templates",
          "Bulk item import"
        ]
      },
      "shipmentManagement": {
        "description": "Shipment creation and tracking",
        "features": [
          "Carrier selection (AusPost, StarTrack, TNT, DHL)",
          "Tracking number entry",
          "Partial shipments",
          "Delivery confirmation",
          "Signature/photo capture",
          "Carrier tracking links"
        ]
      },
      "fulfillmentDashboard": {
        "description": "Operations dashboard for warehouse team",
        "layout": "Kanban board with stages",
        "columns": [
          "To Allocate",
          "To Pick",
          "Picking",
          "To Ship",
          "Shipped"
        ],
        "features": [
          "Drag-drop status updates",
          "Bulk operations",
          "Real-time metrics",
          "Priority indicators",
          "Filter by customer/date"
        ]
      }
    },
    "business_rules": {
      "order_status_workflow": {
        "draft": "Initial state, editable",
        "confirmed": "Customer confirmed, ready for fulfillment",
        "picking": "Items being picked from warehouse",
        "picked": "All items picked, ready for packing",
        "shipped": "Order shipped, tracking available",
        "delivered": "Delivery confirmed",
        "cancelled": "Order cancelled"
      },
      "shipping_logic": {
        "partial_shipments": "Allow shipping items as they become available",
        "backorder_handling": "Track backordered items with expected dates",
        "carrier_tracking": "Support major Australian carriers",
        "delivery_proof": "Signature and photo required for delivery confirmation"
      },
      "amendment_process": {
        "request": "Any user can request changes with reason",
        "approval": "Manager approval required for changes affecting totals",
        "tracking": "All changes tracked with audit trail",
        "application": "Approved changes applied atomically"
      },
      "pricing_and_tax": {
        "currency": "AUD (Australian Dollars)",
        "tax": "GST 10% on all items and shipping",
        "discounts": "Percentage or fixed amount discounts",
        "rounding": "Round to 2 decimal places"
      }
    },
    "integrations": {
      "xero": {
        "invoice_sync": "Orders sync to Xero as invoices",
        "payment_tracking": "Payment status updates from Xero",
        "contact_sync": "Customer data syncs to Xero contacts"
      },
      "inventory": {
        "stock_checking": "Real-time stock validation on order creation",
        "allocation": "Reserve stock when order confirmed",
        "backorder_creation": "Auto-create backorders for insufficient stock"
      },
      "products": {
        "catalog_integration": "Real-time product data and pricing",
        "variant_support": "Product variants with different pricing",
        "serial_tracking": "Serialized item tracking"
      }
    }
  },
  "stories": [
    {
      "id": "ORD-CORE-SCHEMA",
      "name": "Order Core Schema",
      "description": "Create orders, orderItems tables with relationships and constraints",
      "type": "schema",
      "acceptance_criteria": [
        "orders table with all required fields and indexes",
        "orderItems table with foreign keys and calculations",
        "NOT NULL on required columns, CHECK constraints on status transitions, UNIQUE on orderNumber per organization",
        "Migration scripts generated and tested",
        "TypeScript types exported",
        "RLS policies implemented"
      ],
      "files_to_modify": [
        "src/lib/schema/orders.ts",
        "src/lib/schema/index.ts",
        "drizzle/migrations/001_orders.ts"
      ],
      "completion_promise": "ORD_CORE_SCHEMA_COMPLETE",
      "estimated_iterations": 2,
      "status": "pending"
    },
    {
      "id": "ORD-CORE-API",
      "name": "Order Core API",
      "description": "Implement CRUD operations for orders and items",
      "type": "server-function",
      "acceptance_criteria": [
        "listOrders endpoint with filtering and pagination",
        "getOrder endpoint with full details",
        "createOrder with items and validation",
        "updateOrder with status workflow",
        "add/update/delete order items",
        "duplicateOrder functionality",
        "Zod validation on inputs; try-catch with 400/404/500 responses; RLS restricts to organization's data",
        "Zod schemas for validation"
      ],
      "files_to_modify": [
        "src/server/functions/orders.ts",
        "src/lib/schemas/orders.ts"
      ],
      "dependencies": [
        "ORD-CORE-SCHEMA"
      ],
      "completion_promise": "ORD_CORE_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-LIST-UI",
      "name": "Order List Interface",
      "description": "Responsive order list with filtering, sorting, and bulk actions",
      "type": "ui-component",
      "acceptance_criteria": [
        "Mobile: Card-based list with key information",
        "Tablet: Compact table with pagination",
        "Desktop: Full table with advanced filtering",
        "Status filtering and search",
        "Bulk status updates",
        "Export functionality",
        "Skeleton loader from @/components/ui/skeleton during fetch; error boundary with retry button on failure",
        "Accessibility compliant"
      ],
      "files_to_modify": [
        "src/routes/_authed/orders/index.tsx",
        "src/components/domain/orders/order-list.tsx",
        "src/components/domain/orders/order-filters.tsx"
      ],
      "dependencies": [
        "ORD-CORE-API"
      ],
      "completion_promise": "ORD_LIST_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-DETAIL-UI",
      "name": "Order Detail Interface",
      "description": "Complete order view with overview, items, fulfillment, and activity tabs",
      "type": "ui-component",
      "acceptance_criteria": [
        "Tabbed interface: Overview, Items, Fulfillment, Shipments, Amendments, Activity",
        "Overview tab with customer info and quick actions",
        "Items tab with inline editing and stock checking",
        "Fulfillment tab with status tracking and actions",
        "Print capabilities (pick lists, packing slips)",
        "Responsive design across all breakpoints",
        "React Query invalidation on mutations; 30-second polling for status changes when order is in_progress"
      ],
      "files_to_modify": [
        "src/routes/_authed/orders/$orderId.tsx",
        "src/components/domain/orders/order-detail.tsx",
        "src/components/domain/orders/order-tabs.tsx"
      ],
      "dependencies": [
        "ORD-CORE-API"
      ],
      "completion_promise": "ORD_DETAIL_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-CREATION-UI",
      "name": "Order Creation Wizard",
      "description": "Multi-step order creation with customer selection, item adding, and confirmation",
      "type": "ui-component",
      "acceptance_criteria": [
        "Step 1: Customer selection with search",
        "Step 2: Item selection from product catalog",
        "Step 3: Quantity and pricing configuration",
        "Step 4: Shipping and tax calculation",
        "Step 5: Review and confirmation",
        "Integration with order templates",
        "Validation at each step",
        "Progress indicator and breadcrumbs"
      ],
      "files_to_modify": [
        "src/components/domain/orders/order-creation-wizard.tsx",
        "src/components/domain/orders/customer-selector.tsx",
        "src/components/domain/orders/product-selector.tsx"
      ],
      "dependencies": [
        "ORD-CORE-API"
      ],
      "completion_promise": "ORD_CREATION_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-SHIPPING-SCHEMA",
      "name": "Shipping Schema",
      "description": "Create orderShipments and shipmentItems tables",
      "type": "schema",
      "acceptance_criteria": [
        "orderShipments table with carrier and tracking",
        "shipmentItems table for partial shipments",
        "Foreign keys to orders(id) and users(id) with ON DELETE CASCADE, indexes on orderId and status",
        "Indexes for performance",
        "Delivery confirmation fields"
      ],
      "files_to_modify": [
        "src/lib/schema/order-shipments.ts",
        "src/lib/schema/shipment-items.ts",
        "drizzle/migrations/002_shipping.ts"
      ],
      "completion_promise": "ORD_SHIPPING_SCHEMA_COMPLETE",
      "estimated_iterations": 2,
      "status": "pending"
    },
    {
      "id": "ORD-SHIPPING-API",
      "name": "Shipping API",
      "description": "Implement shipment creation, tracking, and delivery confirmation",
      "type": "server-function",
      "acceptance_criteria": [
        "createShipment with item selection",
        "updateShipment for tracking updates",
        "confirmDelivery with signature/photo upload",
        "Carrier tracking URL generation",
        "File upload to Supabase Storage"
      ],
      "files_to_modify": [
        "src/server/functions/order-shipments.ts",
        "src/lib/schemas/order-shipments.ts"
      ],
      "dependencies": [
        "ORD-SHIPPING-SCHEMA"
      ],
      "completion_promise": "ORD_SHIPPING_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-SHIPPING-UI",
      "name": "Shipping Interface",
      "description": "Shipment creation, tracking display, and delivery confirmation",
      "type": "ui-component",
      "acceptance_criteria": [
        "Ship order dialog with item selection",
        "Shipment list with tracking links",
        "Delivery confirmation modal with signature pad",
        "Photo upload for delivery proof",
        "Carrier-specific tracking URL generation",
        "Status indicators for shipment progress"
      ],
      "files_to_modify": [
        "src/components/domain/orders/ship-order-dialog.tsx",
        "src/components/domain/orders/shipment-list.tsx",
        "src/components/domain/orders/confirm-delivery-dialog.tsx"
      ],
      "dependencies": [
        "ORD-SHIPPING-API"
      ],
      "completion_promise": "ORD_SHIPPING_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-TEMPLATES-SCHEMA",
      "name": "Order Templates Schema",
      "description": "Create orderTemplates and orderTemplateItems tables",
      "type": "schema",
      "acceptance_criteria": [
        "orderTemplates table with name and description",
        "orderTemplateItems table with product references",
        "Organization isolation with RLS"
      ],
      "files_to_modify": [
        "src/lib/schema/order-templates.ts",
        "drizzle/migrations/003_templates.ts"
      ],
      "completion_promise": "ORD_TEMPLATES_SCHEMA_COMPLETE",
      "estimated_iterations": 2,
      "status": "pending"
    },
    {
      "id": "ORD-TEMPLATES-API",
      "name": "Order Templates API",
      "description": "Implement template CRUD and order creation from templates",
      "type": "server-function",
      "acceptance_criteria": [
        "listTemplates for organization",
        "saveOrderAsTemplate functionality",
        "createOrderFromTemplate with current pricing",
        "Template item management"
      ],
      "files_to_modify": [
        "src/server/functions/order-templates.ts",
        "src/lib/schemas/order-templates.ts"
      ],
      "dependencies": [
        "ORD-TEMPLATES-SCHEMA"
      ],
      "completion_promise": "ORD_TEMPLATES_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-TEMPLATES-UI",
      "name": "Order Templates Interface",
      "description": "Template library and template-based order creation",
      "type": "ui-component",
      "acceptance_criteria": [
        "Template library grid with search",
        "Template preview on hover/select",
        "Save order as template action",
        "Create order from template option",
        "Template editor for customization"
      ],
      "files_to_modify": [
        "src/components/domain/orders/template-library.tsx",
        "src/components/domain/orders/template-selector.tsx",
        "src/components/domain/orders/template-editor.tsx"
      ],
      "dependencies": [
        "ORD-TEMPLATES-API"
      ],
      "completion_promise": "ORD_TEMPLATES_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-AMENDMENTS-SCHEMA",
      "name": "Order Amendments Schema",
      "description": "Create orderAmendments table for change tracking",
      "type": "schema",
      "acceptance_criteria": [
        "orderAmendments table with change tracking",
        "JSONB field for structured change storage",
        "Approval workflow fields"
      ],
      "files_to_modify": [
        "src/lib/schema/order-amendments.ts",
        "drizzle/migrations/004_amendments.ts"
      ],
      "completion_promise": "ORD_AMENDMENTS_SCHEMA_COMPLETE",
      "estimated_iterations": 2,
      "status": "pending"
    },
    {
      "id": "ORD-AMENDMENTS-API",
      "name": "Order Amendments API",
      "description": "Implement amendment request, approval, and application",
      "type": "server-function",
      "acceptance_criteria": [
        "requestAmendment with change specification",
        "approveAmendment and rejectAmendment",
        "applyAmendment with atomic updates",
        "Amendment history retrieval"
      ],
      "files_to_modify": [
        "src/server/functions/order-amendments.ts",
        "src/lib/schemas/order-amendments.ts"
      ],
      "dependencies": [
        "ORD-AMENDMENTS-SCHEMA"
      ],
      "completion_promise": "ORD_AMENDMENTS_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-AMENDMENTS-UI",
      "name": "Order Amendments Interface",
      "description": "Amendment request dialog and history display",
      "type": "ui-component",
      "acceptance_criteria": [
        "Request amendment dialog with change specification",
        "Before/after comparison display",
        "Amendment history timeline",
        "Approve/reject actions for managers",
        "Amendment application confirmation"
      ],
      "files_to_modify": [
        "src/components/domain/orders/request-amendment-dialog.tsx",
        "src/components/domain/orders/amendment-history.tsx",
        "src/components/domain/orders/amendment-diff-view.tsx"
      ],
      "dependencies": [
        "ORD-AMENDMENTS-API"
      ],
      "completion_promise": "ORD_AMENDMENTS_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "ORD-FULFILLMENT-DASHBOARD",
      "name": "Fulfillment Operations Dashboard",
      "description": "Kanban-style dashboard for warehouse operations",
      "type": "full-page",
      "acceptance_criteria": [
        "Kanban board with fulfillment stages",
        "Drag-drop order status updates",
        "Bulk operations for efficiency",
        "Real-time metrics display",
        "Filter and search capabilities",
        "Mobile-responsive design"
      ],
      "files_to_modify": [
        "src/routes/_authed/fulfillment/index.tsx",
        "src/components/domain/orders/fulfillment-board.tsx",
        "src/components/domain/orders/fulfillment-card.tsx"
      ],
      "dependencies": [
        "ORD-CORE-API",
        "ORD-SHIPPING-API"
      ],
      "completion_promise": "ORD_FULFILLMENT_DASHBOARD_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    }
  ],
  "success_criteria": [
    "Complete order lifecycle from creation to delivery confirmation",
    "Real-time inventory integration with backorder handling",
    "Multi-carrier shipping with delivery proof capture",
    "Order amendment workflow with approval tracking",
    "Reusable order templates for efficiency",
    "Operations dashboard for warehouse productivity",
    "All order list operations complete in < 100ms",
    "Order detail loads in < 2 seconds",
    "Mobile-responsive across all interfaces",
    "Full accessibility compliance",
    "Integration with Xero for invoicing",
    "Complete audit trail for all order changes"
  ],
  "out_of_scope": [
    "Advanced carrier API integrations (manual tracking entry only)",
    "Third-party WMS integration",
    "Barcode scanning capabilities",
    "Recurring/subscription order automation",
    "Advanced reporting beyond basic fulfillment metrics"
  ],
  "migration_notes": {
    "existing_data": "If existing RENOZ v2 order data exists, migration scripts will be needed to transform data structures to new schema",
    "xero_integration": "Existing Xero invoice mappings will need to be preserved during migration",
    "customer_history": "Order history and customer relationships must be maintained"
  },
  "pattern_references": [
    {
      "file": "_Initiation/_meta/patterns/testing-standards.md",
      "applies_to": "all stories",
      "reason": "All stories must follow testing standards including TDD flow, coverage expectations (80% server functions, 90% utilities), and story-level testing requirements"
    },
    {
      "file": "_Initiation/_meta/patterns/error-recovery.md",
      "applies_to": "ORD-CORE-API, ORD-SHIPPING-API, ORD-AMENDMENTS-API, all server function stories",
      "reason": "Server stories must implement Pattern 3 (Saga Pattern) for order amendments requiring approval, Pattern 1 (Sync Failure Recovery) for Xero invoice sync"
    },
    {
      "file": "_Initiation/_meta/patterns/performance-benchmarks.md",
      "applies_to": "ORD-LIST-UI, ORD-DETAIL-UI, ORD-FULFILLMENT-DASHBOARD, all UI and API stories",
      "reason": "Order list operations <100ms (as specified), order detail <2s. Fulfillment dashboard must use materialized views for performance"
    },
    {
      "file": "_Initiation/_meta/patterns/ux-3-click-rule.md",
      "applies_to": "ORD-LIST-UI, ORD-CREATION-UI, ORD-SHIPPING-UI, all UI stories",
      "reason": "Operations role uses swipe-to-pick (1 action), one-click PO creation from alerts. Batch picking supports 3-action workflow"
    }
  ]
}