# Order Management System Progress
# PRD: orders.prd.json
# Started: 2026-01-17
# Updated: 2026-01-17

## Stories (15 total)

- [x] ORD-CORE-SCHEMA: Order Core Schema
- [x] ORD-CORE-API: Order Core API
- [x] ORD-LIST-UI: Order List Interface
- [x] ORD-DETAIL-UI: Order Detail Interface
- [x] ORD-CREATION-UI: Order Creation Wizard
- [x] ORD-SHIPPING-SCHEMA: Shipping Schema
- [x] ORD-SHIPPING-API: Shipping API
- [x] ORD-SHIPPING-UI: Shipping Interface
- [x] ORD-TEMPLATES-SCHEMA: Order Templates Schema
- [x] ORD-TEMPLATES-API: Order Templates API
- [x] ORD-TEMPLATES-UI: Order Templates Interface
- [x] ORD-AMENDMENTS-SCHEMA: Order Amendments Schema
- [x] ORD-AMENDMENTS-API: Order Amendments API
- [x] ORD-AMENDMENTS-UI: Order Amendments Interface
- [x] ORD-FULFILLMENT-DASHBOARD: Fulfillment Operations Dashboard

## Current Story
COMPLETE - All 15 stories done

## Iteration Count
Total: 15
Current Story: 0

## Blockers
None

## Notes
- Progress tracking initialized
- ORD-CORE-SCHEMA complete (2026-01-17):
  - orders table exists with all required fields (id, organizationId, orderNumber, customerId, status, dates, pricing, addresses, metadata)
  - orderLineItems table exists with foreign keys (orderId, productId) and fulfillment tracking (qtyPicked, qtyShipped, qtyDelivered)
  - Status enum: draft, confirmed, picking, picked, shipped, delivered, cancelled
  - Indexes: org+status, org+customer, org+date, unique orderNumber per org (with soft delete)
  - TypeScript types exported (Order, NewOrder, OrderLineItem, NewOrderLineItem)
  - Relations defined (orders <-> customers, orders <-> lineItems, lineItems <-> products)
  - RLS policies added in migration 0008_orders_rls_policies.sql
  - Schema existed from initial migration 0000_organic_frightful_four.sql
  - NOTE: CHECK constraints for status transitions are application-level (not DB-level) per Drizzle pattern
- ORD-CORE-API complete (2026-01-17):
  - src/lib/server/functions/orders.ts already had full implementation
  - listOrders: Offset pagination with filtering (status, customer, date range, search, amount range)
  - listOrdersCursor: Cursor pagination for large datasets
  - getOrder: Returns order with line items
  - getOrderWithCustomer: Returns order with customer and product details
  - createOrder: Creates order with line items, calculates GST (10%), validates customer
  - updateOrder: Updates header fields with validation
  - updateOrderStatus: Workflow validation (draft→confirmed→picking→picked→shipped→delivered)
  - deleteOrder: Soft delete, only draft orders
  - addOrderLineItem, updateOrderLineItem, deleteOrderLineItem: Line item CRUD
  - duplicateOrder: Clones order as new draft with new order number
  - recalculateOrderTotals: Helper to update order totals from line items
  - All functions use withAuth for authentication and filter by organizationId
- ORD-LIST-UI complete (2026-01-17):
  - src/components/domain/orders/order-list.tsx: Responsive table (desktop) + cards (mobile)
  - src/components/domain/orders/order-filters.tsx: Search, status, payment, date range, amount filters
  - src/routes/_authenticated/orders/index.tsx: Route page with duplicate/delete mutations
  - Status badges with icons, pagination, bulk selection, dropdown actions
- ORD-DETAIL-UI complete (2026-01-17):
  - src/components/domain/orders/order-detail.tsx: Tabbed view (Overview, Items, Fulfillment, Activity)
  - src/routes/_authenticated/orders/$orderId.tsx: Route page
  - Status workflow actions with confirmation dialogs
  - Fulfillment progress tracking per line item
  - 30-second polling for status updates
- ORD-CREATION-UI complete (2026-01-17):
  - src/components/domain/orders/order-creation-wizard.tsx: 5-step wizard (Customer→Products→Pricing→Shipping→Review)
  - src/components/domain/orders/customer-selector.tsx: Searchable customer selection with debounce
  - src/components/domain/orders/product-selector.tsx: Product catalog browser with quantity controls
  - src/routes/_authenticated/orders/create.tsx: Route page
  - Progress indicator with step icons and connector lines
  - Real-time totals calculation including GST (10%)
  - Customer address pre-fill for shipping
- ORD-SHIPPING-SCHEMA complete (2026-01-17):
  - drizzle/schema/order-shipments.ts: orderShipments and shipmentItems tables
  - drizzle/schema/enums.ts: Added shipmentStatusEnum (pending, in_transit, out_for_delivery, delivered, failed, returned)
  - src/lib/schemas/shipments.ts: Zod validation schemas for all shipment operations
  - Supports partial shipments via shipmentItems referencing orderLineItems
  - Delivery confirmation with signature and photo support
  - Tracking events history as JSONB array
- ORD-SHIPPING-API complete (2026-01-17):
  - src/lib/server/functions/order-shipments.ts: Full shipment lifecycle API
  - listShipments, getShipment: Query with filtering and pagination
  - createShipment: With item selection and quantity validation
  - markShipped: Transitions to in_transit, creates tracking event
  - updateShipmentStatus: Validates transitions, handles delivery confirmation
  - confirmDelivery: With signature/photo support, updates qtyDelivered
  - Auto-generates tracking URLs for major AU carriers (Auspost, StarTrack, TNT, etc.)
  - Updates order line item qtyShipped/qtyDelivered on status changes
- ORD-SHIPPING-UI complete (2026-01-17):
  - src/components/domain/orders/ship-order-dialog.tsx: Item selection, carrier details, ship now toggle
  - src/components/domain/orders/shipment-list.tsx: Tracking links, status badges, tracking history accordion
  - src/components/domain/orders/confirm-delivery-dialog.tsx: Signature pad with canvas, photo upload/URL support
  - Status indicators: pending, in_transit, out_for_delivery, delivered, failed, returned
  - Carrier dropdown with AU carriers (Auspost, StarTrack, TNT, DHL, FedEx, Sendle, Aramex, Toll)
- ORD-TEMPLATES-SCHEMA complete (2026-01-17):
  - drizzle/schema/order-templates.ts: orderTemplates and orderTemplateItems tables
  - src/lib/schemas/order-templates.ts: Zod validation schemas
  - Templates can have default customer and default values (discounts, shipping, payment terms)
  - Template items support fixed prices OR current product prices
  - Metadata includes category, tags, and usage tracking
- ORD-TEMPLATES-API complete (2026-01-17):
  - src/lib/server/functions/order-templates.ts: Full template lifecycle API
  - listTemplates, getTemplate: Query with search, category, and active filters
  - createTemplate, updateTemplate, deleteTemplate: CRUD operations
  - saveOrderAsTemplate: Converts existing order to reusable template
  - createOrderFromTemplate: Creates order with current pricing, updates usage count
  - addTemplateItem, deleteTemplateItem: Item management
- ORD-TEMPLATES-UI complete (2026-01-17):
  - src/components/domain/orders/template-library.tsx: Grid view with search, category badges, usage count
  - src/components/domain/orders/template-selector.tsx: Popover-based selection for order creation
  - src/components/domain/orders/template-editor.tsx: Form with item management, pricing options
  - Uses react-hook-form with zodResolver for validation
  - Supports both current pricing and fixed pricing modes
  - Delete confirmation with AlertDialog
  - Progressive disclosure for advanced settings (discounts, payment terms)
- ORD-AMENDMENTS-SCHEMA complete (2026-01-17):
  - drizzle/schema/order-amendments.ts: orderAmendments table with approval workflow
  - src/lib/schemas/order-amendments.ts: Zod validation schemas
  - Amendment types: quantity_change, item_add, item_remove, price_change, discount_change, shipping_change, address_change, date_change, cancel_order, other
  - Status workflow: pending → approved/rejected → applied
  - JSONB changes field with itemChanges and financialImpact structure
  - Version tracking for optimistic locking
- ORD-AMENDMENTS-API complete (2026-01-17):
  - src/lib/server/functions/order-amendments.ts: Full amendment lifecycle API
  - listAmendments, getAmendment: Query with filtering and pagination
  - requestAmendment: Creates amendment with changes and financial impact
  - approveAmendment, rejectAmendment: Approval workflow
  - applyAmendment: Applies approved changes to order
  - cancelAmendment: Cancels pending amendment
  - getOrderAmendments: Returns all amendments for an order
  - Status workflow validation (pending → approved/rejected → applied)
- ORD-AMENDMENTS-UI complete (2026-01-17):
  - src/components/domain/orders/amendment-request-dialog.tsx: Request form with type select, line item editor, financial impact preview
  - src/components/domain/orders/amendment-review-dialog.tsx: Original vs proposed diff, approve/reject with reason
  - src/components/domain/orders/amendment-list.tsx: Status badges, action buttons (Review, Apply, Cancel), financial summary
  - All components exported from index.ts
  - Type errors fixed with proper interface annotations
- ORD-FULFILLMENT-DASHBOARD complete (2026-01-17):
  - src/components/domain/orders/fulfillment-dashboard.tsx: Operations dashboard with summary cards
  - src/routes/_authenticated/orders/fulfillment.tsx: Route page at /orders/fulfillment
  - Summary cards: Orders to pick, Ready to ship, In transit, Overdue
  - Picking queue table: Orders in "confirmed" status with Pick/Done buttons
  - Shipping queue table: Orders in "picked" status with Ship button
  - Delivery tracking section: Active shipments with tracking links
  - 30s polling for live updates via react-query refetchInterval
  - Type errors fixed (total prop types, FormatAmount props)
