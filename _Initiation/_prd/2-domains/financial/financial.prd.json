{
  "id": "DOM-FINANCIAL",
  "name": "Financial Domain",
  "description": "Invoicing, payments, and Xero integration for Renoz Energy battery sales. Manages financial lifecycle from invoice creation through payment reconciliation and accounting sync. Handles AUD currency with 10% GST, supports residential ($5K-$20K) and commercial ($50K-$500K) battery equipment orders with standard 30-day payment terms and 50% deposit option for commercial projects.",
  "created": "2026-01-09",
  "priority": 7,
  "phase": "domain-v1",
  "version": "v1",
  "dependencies": {
    "phase": "Domain",
    "executionOrder": 7,
    "schemaRequired": [
      {
        "table": "organizations",
        "status": "EXISTS",
        "createdBy": "schema-foundation"
      },
      {
        "table": "users",
        "status": "EXISTS",
        "createdBy": "schema-foundation"
      },
      {
        "table": "customers",
        "status": "EXISTS",
        "createdBy": "schema-foundation"
      },
      {
        "table": "orders",
        "status": "EXISTS",
        "createdBy": "schema-foundation"
      }
    ],
    "schemaCreates": [
      {
        "table": "credit_notes",
        "story": "DOM-FIN-001a"
      },
      {
        "table": "payment_schedules",
        "story": "DOM-FIN-002a"
      },
      {
        "table": "statement_history",
        "story": "DOM-FIN-004a"
      },
      {
        "table": "reminder_templates",
        "story": "DOM-FIN-006a"
      },
      {
        "table": "reminder_history",
        "story": "DOM-FIN-006a"
      },
      {
        "table": "revenue_recognition",
        "story": "DOM-FIN-008a"
      },
      {
        "table": "deferred_revenue",
        "story": "DOM-FIN-008a"
      }
    ],
    "serverFunctionsRequired": [],
    "serverFunctionsCreates": [
      {
        "function": "createCreditNote",
        "story": "DOM-FIN-001b"
      },
      {
        "function": "getCreditNote",
        "story": "DOM-FIN-001b"
      },
      {
        "function": "listCreditNotes",
        "story": "DOM-FIN-001b"
      },
      {
        "function": "applyCreditNoteToInvoice",
        "story": "DOM-FIN-001b"
      },
      {
        "function": "createPaymentPlan",
        "story": "DOM-FIN-002b"
      },
      {
        "function": "getPaymentSchedule",
        "story": "DOM-FIN-002b"
      },
      {
        "function": "recordInstallmentPayment",
        "story": "DOM-FIN-002b"
      },
      {
        "function": "getOverdueInstallments",
        "story": "DOM-FIN-002b"
      },
      {
        "function": "getARAgingReport",
        "story": "DOM-FIN-003a"
      },
      {
        "function": "generateStatement",
        "story": "DOM-FIN-004b"
      },
      {
        "function": "saveStatementHistory",
        "story": "DOM-FIN-004b"
      },
      {
        "function": "getStatementHistory",
        "story": "DOM-FIN-004b"
      },
      {
        "function": "getFinancialDashboardMetrics",
        "story": "DOM-FIN-007a"
      },
      {
        "function": "recognizeRevenue",
        "story": "DOM-FIN-008b"
      },
      {
        "function": "calculateDeferredRevenue",
        "story": "DOM-FIN-008b"
      },
      {
        "function": "getDeferredRevenueReport",
        "story": "DOM-FIN-008b"
      },
      {
        "function": "getRevenueRecognitionReport",
        "story": "DOM-FIN-008b"
      }
    ],
    "prdDependencies": [
      {
        "prdId": "schema-foundation",
        "status": "REQUIRED",
        "reason": "Base schema must exist (organizations, users, customers, orders)"
      },
      {
        "prdId": "DOM-ORD",
        "status": "REQUIRED",
        "reason": "Financial depends on orders for invoicing and payment processing"
      },
      {
        "prdId": "INT-XERO",
        "status": "PARTIAL",
        "reason": "DOM-FIN-008b (Recognition Engine) depends on INT-XERO-011 (Job Queue) for Xero sync coordination. Other financial stories do not require Xero stories to be complete."
      }
    ],
    "enables": [
      {
        "prdId": "WF-INV",
        "reason": "Invoicing workflow uses financial domain credit notes and payment plans"
      },
      {
        "prdId": "DOM-REPORTS",
        "reason": "Reports domain uses financial metrics and AR aging data"
      }
    ]
  },
  "references": {
    "internal": [
      "src/lib/schema/orders.ts - Order/Invoice schema",
      "src/lib/schemas/financial.ts - Validation schemas",
      "src/server/functions/invoices.ts - Invoice generation functions",
      "src/server/functions/financial.ts - Financial overview/listing functions",
      "src/server/functions/xero.ts - Xero integration functions",
      "src/components/domain/financial/ - UI components"
    ],
    "external": [
      "Xero API docs - Invoice sync"
    ]
  },
  "current_state": {
    "implemented": [
      "Invoice generation from orders",
      "Invoice PDF generation",
      "Basic Xero contact sync",
      "Invoice list with filters",
      "Payment recording (UI exists, server function commented out)"
    ],
    "gaps": [
      "No credit notes/refunds",
      "No payment plans/installments",
      "No aging report (AR)",
      "No statement generation",
      "Xero invoice sync incomplete",
      "No payment reminders",
      "No revenue recognition",
      "No financial dashboard enhancements"
    ]
  },
  "stories": [
    {
      "id": "DOM-FIN-001a",
      "name": "Credit Notes Schema",
      "description": "Create credit_notes table for battery equipment returns and adjustments (AUD amounts with GST tracking)",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "credit_notes table created (id, invoiceId, amount, reason, status, organizationId, createdByUserId, createdAt, updatedAt)",
        "Amount stored in AUD cents (e.g., 150000 for $1,500 AUD)",
        "Reason examples: 'Battery equipment return', 'Commercial installation discount', 'Damaged unit credit'",
        "Status enum: draft, issued, applied, voided",
        "FK relation to orders/invoices",
        "Migration runs successfully",
        "Types exported from lib/schema/index.ts",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "DOM_FIN_001A_COMPLETE"
    },
    {
      "id": "DOM-FIN-001b",
      "name": "Credit Notes Server Functions",
      "description": "CRUD operations for credit notes and balance application",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "createCreditNote, getCreditNote, listCreditNotes server functions",
        "applyCreditNoteToInvoice function adjusts invoice balance",
        "Credit note history retrievable per customer",
        "Validation schemas in lib/schemas/credit-notes.ts",
        "RLS enforced for organization scope",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "DOM-FIN-001a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_FIN_001B_COMPLETE"
    },
    {
      "id": "DOM-FIN-001c",
      "name": "Credit Notes UI",
      "description": "Create form, list view, detail view, and PDF generation",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Create credit note from invoice action using ActionMenu pattern",
        "Credit note form with amount, reason fields using FormDialog pattern",
        "Credit note list view with filters using DataTable pattern",
        "Credit note PDF generation using existing PDF patterns",
        "Credit note history visible on customer detail using Timeline component",
        "Apply credit note action on invoice detail with confirmation dialog",
        "Loading skeleton (CreditNoteListSkeleton) during data fetch",
        "Empty state: 'No credit notes' with contextual message",
        "Error boundary with retry for credit note operations",
        "Keyboard navigation: Tab through form fields, Enter to submit",
        "ARIA labels for form controls and status indicators",
        "Responsive: Full-width form on mobile, modal on desktop",
        "TypeScript compiles without errors"
      ],
      "ui_spec": {
        "component_type": "FormDialog with DataTable list",
        "layout": {
          "mobile": "Full-screen form, stacked list cards",
          "tablet": "Modal dialog, table list",
          "desktop": "Side panel form, full DataTable"
        },
        "accessibility": {
          "aria_labels": [
            "credit-note-form",
            "credit-note-list",
            "apply-credit-button",
            "status-badge-{status}"
          ],
          "keyboard_nav": "Tab through fields, Enter to submit, Escape to close",
          "screen_reader": "Credit note amount and status announced",
          "focus_management": "Focus form on open, return to trigger after close"
        }
      },
      "uiPatterns": {
        "reui": [
          {
            "component": "Dialog",
            "path": "_reference/.reui-reference/registry/default/ui/dialog.tsx",
            "usage": "Credit note creation form modal with DialogHeader, DialogBody, DialogFooter"
          },
          {
            "component": "DataGrid",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Credit notes list with sorting, filtering, and pagination"
          },
          {
            "component": "Badge",
            "path": "_reference/.reui-reference/registry/default/ui/badge.tsx",
            "usage": "Status indicators (draft, issued, applied, voided) with variant='success|warning|secondary' and appearance='light'"
          },
          {
            "component": "Button",
            "path": "_reference/.reui-reference/registry/default/ui/button.tsx",
            "usage": "Action buttons for create, apply, cancel operations"
          },
          {
            "component": "Form",
            "path": "_reference/.reui-reference/registry/default/ui/form.tsx",
            "usage": "Credit note form with validation (amount, reason, invoice selection)"
          },
          {
            "component": "Input",
            "path": "_reference/.reui-reference/registry/default/ui/input.tsx",
            "usage": "Amount and reason text inputs with currency formatting"
          },
          {
            "component": "Select",
            "path": "_reference/.reui-reference/registry/default/ui/select.tsx",
            "usage": "Invoice selection dropdown"
          }
        ],
        "midday": [
          {
            "pattern": "Invoice Status Badge",
            "path": "_reference/.midday-reference/apps/dashboard/src/components/invoice-status.tsx",
            "usage": "Adapt status badge pattern for credit note status (draft/issued/applied/voided)"
          },
          {
            "pattern": "Invoice Toolbar",
            "path": "_reference/.midday-reference/apps/dashboard/src/components/invoice-toolbar.tsx",
            "usage": "Copy/download toolbar pattern for credit note PDF operations"
          }
        ]
      },
      "dependencies": [
        "DOM-FIN-001b"
      ],
      "estimated_iterations": 4,
      "completion_promise": "DOM_FIN_001C_COMPLETE"
    },
    {
      "id": "DOM-FIN-002a",
      "name": "Payment Plans Schema",
      "description": "Create payment_schedules table for battery equipment installment tracking (supports 50% deposit + 50% on completion for commercial projects)",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "payment_schedules table created (id, invoiceId/orderId, planType, installmentNo, dueDate, amount, status, paidAt)",
        "planType enum: fifty_fifty (commercial standard: 50% deposit, 50% on completion), thirds, monthly, custom",
        "Amount stored in AUD cents",
        "Status enum: pending, due, paid, overdue",
        "Default payment terms: 30 days from invoice date",
        "FK relation to orders",
        "Migration runs successfully",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "DOM_FIN_002A_COMPLETE"
    },
    {
      "id": "DOM-FIN-002b",
      "name": "Payment Plans Server Functions",
      "description": "Create plan, preset templates, track payments",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "createPaymentPlan server function with preset options",
        "Preset plans: 50/50 (commercial standard for $50K+ orders), thirds (33/33/34), monthly (configurable)",
        "Plans automatically apply 30-day terms unless overridden",
        "getPaymentSchedule function returns installments for invoice",
        "recordInstallmentPayment updates schedule status and amount in AUD",
        "getOverdueInstallments for alerting (respects 30-day terms)",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "DOM-FIN-002a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_FIN_002B_COMPLETE"
    },
    {
      "id": "DOM-FIN-002c",
      "name": "Payment Plans UI",
      "description": "Plan creation wizard and invoice integration",
      "priority": 6,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Create payment plan dialog from invoice detail using MultiStepDialog pattern",
        "Preset plan selection (50/50, thirds, monthly) with visual preview",
        "Custom plan with editable installments using inline editing",
        "Payment schedule visible on invoice detail using Timeline pattern",
        "Overdue installment highlighting with warning badge",
        "Record payment action per installment with PaymentDialog",
        "Loading skeleton (PaymentScheduleSkeleton) during data fetch",
        "Empty state: 'No payment plan' with 'Create Plan' CTA",
        "Error boundary with retry for plan operations",
        "Keyboard navigation: Tab through plan options, Arrow keys for dates",
        "ARIA labels for plan type selection and installment status",
        "Responsive: Vertical timeline on mobile, horizontal on desktop",
        "TypeScript compiles without errors"
      ],
      "ui_spec": {
        "component_type": "MultiStepDialog with Timeline display",
        "layout": {
          "mobile": "Full-screen wizard, vertical timeline",
          "tablet": "Modal wizard, horizontal timeline",
          "desktop": "Side panel wizard, schedule table view"
        },
        "accessibility": {
          "aria_labels": [
            "payment-plan-wizard",
            "plan-type-selector",
            "installment-{n}",
            "record-payment-{id}"
          ],
          "keyboard_nav": "Arrow keys for plan selection, Tab through installments",
          "screen_reader": "Plan type and total announced, installment status on focus",
          "focus_management": "Focus first option on open, advance focus through wizard steps"
        }
      },
      "uiPatterns": {
        "reui": [
          {
            "component": "Dialog",
            "path": "_reference/.reui-reference/registry/default/ui/dialog.tsx",
            "usage": "Multi-step wizard dialog for payment plan creation"
          },
          {
            "component": "Tabs",
            "path": "_reference/.reui-reference/registry/default/ui/base-tabs.tsx",
            "usage": "Preset plan selection tabs (50/50, thirds, monthly, custom)"
          },
          {
            "component": "DataGrid",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Installment schedule table with inline editing for custom plans"
          },
          {
            "component": "Badge",
            "path": "_reference/.reui-reference/registry/default/ui/badge.tsx",
            "usage": "Status badges for installments (pending, due, paid, overdue) with variant='warning' for overdue"
          },
          {
            "component": "DateField",
            "path": "_reference/.reui-reference/registry/default/ui/datefield.tsx",
            "usage": "Due date picker for custom installments"
          },
          {
            "component": "Progress",
            "path": "_reference/.reui-reference/registry/default/ui/progress.tsx",
            "usage": "Visual progress indicator showing paid vs remaining amount"
          },
          {
            "component": "Card",
            "path": "_reference/.reui-reference/registry/default/ui/card.tsx",
            "usage": "Preset plan preview cards with breakdown visualization"
          }
        ],
        "midday": []
      },
      "dependencies": [
        "DOM-FIN-002b"
      ],
      "estimated_iterations": 4,
      "completion_promise": "DOM_FIN_002C_COMPLETE"
    },
    {
      "id": "DOM-FIN-003a",
      "name": "AR Aging Server Function",
      "description": "Compute aging buckets and customer summary for battery equipment invoices (AUD balances, 30-day payment terms baseline)",
      "priority": 7,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "getARAgingReport server function",
        "Aging buckets: current (within 30-day terms), 1-30, 31-60, 61-90, 90+ days overdue",
        "Summary totals per bucket in AUD",
        "Customer summary with drill-down data showing battery equipment invoice details",
        "Highlights high-value commercial accounts ($50K+) in separate category",
        "Data computed from existing orders/invoices",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "DOM_FIN_003A_COMPLETE"
    },
    {
      "id": "DOM-FIN-003b",
      "name": "AR Aging Report UI",
      "description": "Report page with table, export, and dashboard widget",
      "priority": 8,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "AR aging report page at /financial/reports/aging using ReportPage pattern",
        "Table with aging buckets and customer breakdown using DataTable",
        "Drill-down to invoices when clicking customer row with LinkRow pattern",
        "Export to CSV and PDF using ExportMenu component",
        "Dashboard widget showing total AR by bucket using StackedBarChart",
        "Loading skeleton (AgingReportSkeleton) during data fetch",
        "Empty state: 'No outstanding invoices' with positive messaging",
        "Error boundary with retry for report generation",
        "Keyboard navigation: Tab through table, Enter to drill down",
        "ARIA table with bucket headers and customer row descriptions",
        "Responsive: Card summary on mobile, full table on desktop",
        "TypeScript compiles without errors"
      ],
      "ui_spec": {
        "component_type": "ReportPage with DataTable and Chart widget",
        "layout": {
          "mobile": "Summary cards by bucket, expandable customer list",
          "tablet": "Chart above table, horizontal scroll",
          "desktop": "Chart sidebar, full-width aging table"
        },
        "accessibility": {
          "aria_labels": [
            "aging-report",
            "bucket-{days}",
            "customer-row-{id}",
            "export-menu"
          ],
          "keyboard_nav": "Tab to rows, Enter to expand/drill-down, Arrow keys in chart",
          "screen_reader": "Bucket totals announced, customer balance on row focus",
          "focus_management": "Focus first row after load, maintain focus on drill-down return"
        }
      },
      "uiPatterns": {
        "reui": [
          {
            "component": "DataGrid",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "AR aging table with expandable rows for customer drill-down"
          },
          {
            "component": "Chart",
            "path": "_reference/.reui-reference/registry/default/ui/chart.tsx",
            "usage": "Stacked bar chart showing AR by aging bucket (current, 1-30, 31-60, 61-90, 90+)"
          },
          {
            "component": "Card",
            "path": "_reference/.reui-reference/registry/default/ui/card.tsx",
            "usage": "Summary cards for mobile view showing bucket totals"
          },
          {
            "component": "DropdownMenu",
            "path": "_reference/.reui-reference/registry/default/ui/dropdown-menu.tsx",
            "usage": "Export menu (CSV, PDF, Excel options)"
          },
          {
            "component": "Button",
            "path": "_reference/.reui-reference/registry/default/ui/button.tsx",
            "usage": "Export trigger and drill-down actions"
          },
          {
            "component": "Accordion",
            "path": "_reference/.reui-reference/registry/default/ui/accordion.tsx",
            "usage": "Collapsible customer detail rows showing invoice breakdown"
          }
        ],
        "midday": []
      },
      "dependencies": [
        "DOM-FIN-003a"
      ],
      "estimated_iterations": 4,
      "completion_promise": "DOM_FIN_003B_COMPLETE"
    },
    {
      "id": "DOM-FIN-004a",
      "name": "Customer Statements Schema",
      "description": "Create statement_history table for tracking generated battery equipment sales statements (AUD balances)",
      "priority": 9,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "statement_history table (id, customerId, startDate, endDate, openingBalance, closingBalance, pdfPath, sentAt, createdAt)",
        "Balance amounts stored in AUD cents",
        "FK relation to customers",
        "Migration runs successfully",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 1,
      "completion_promise": "DOM_FIN_004A_COMPLETE"
    },
    {
      "id": "DOM-FIN-004b",
      "name": "Customer Statements Server Functions",
      "description": "Statement generation and PDF creation",
      "priority": 10,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "generateStatement server function for date range",
        "Statement shows: opening balance, transactions (battery equipment invoices/payments/credit notes), closing balance in AUD",
        "Statement includes GST breakdown and payment terms reminder (30 days)",
        "Statement PDF generation using existing patterns with Renoz Energy branding",
        "Transaction descriptions reference battery equipment orders",
        "saveStatementHistory records generated statement",
        "getStatementHistory per customer",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "DOM-FIN-004a"
      ],
      "estimated_iterations": 4,
      "completion_promise": "DOM_FIN_004B_COMPLETE"
    },
    {
      "id": "DOM-FIN-004c",
      "name": "Customer Statements UI",
      "description": "Statement generation UI and email sending",
      "priority": 11,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Generate statement action on customer detail using ActionButton pattern",
        "Date range selector for statement period using DateRangePicker",
        "Statement preview before sending using PDFPreview component",
        "Email statement to customer action with EmailDialog",
        "Statement history visible on customer using DataTable",
        "Bulk statement generation option using BatchActionDialog",
        "Loading state during PDF generation with progress indicator",
        "Empty state: 'No statements generated' with 'Generate' CTA",
        "Error boundary with retry for statement generation",
        "Keyboard navigation: Tab through controls, Enter to generate",
        "ARIA labels for date controls and action buttons",
        "Responsive: Stacked controls on mobile, inline on desktop",
        "TypeScript compiles without errors"
      ],
      "ui_spec": {
        "component_type": "ActionPanel with PDFPreview",
        "layout": {
          "mobile": "Full-screen preview, bottom action bar",
          "tablet": "Split view: controls left, preview right",
          "desktop": "Modal with embedded PDF preview"
        },
        "accessibility": {
          "aria_labels": [
            "generate-statement-button",
            "date-range-selector",
            "email-statement-button",
            "statement-history"
          ],
          "keyboard_nav": "Tab to controls, Enter to generate, Arrow keys for date",
          "screen_reader": "Date range and balance announced, email status confirmed",
          "focus_management": "Focus preview on generate, return to customer detail after send"
        }
      },
      "uiPatterns": {
        "reui": [
          {
            "component": "Dialog",
            "path": "_reference/.reui-reference/registry/default/ui/dialog.tsx",
            "usage": "Statement generation dialog with preview and email options"
          },
          {
            "component": "Calendar",
            "path": "_reference/.reui-reference/registry/default/ui/calendar.tsx",
            "usage": "Date range picker for statement period (start/end dates)"
          },
          {
            "component": "Button",
            "path": "_reference/.reui-reference/registry/default/ui/button.tsx",
            "usage": "Generate, email, download statement actions"
          },
          {
            "component": "DataGrid",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Statement history table with date, balance, sent status"
          },
          {
            "component": "Progress",
            "path": "_reference/.reui-reference/registry/default/ui/progress.tsx",
            "usage": "PDF generation progress indicator"
          },
          {
            "component": "Checkbox",
            "path": "_reference/.reui-reference/registry/default/ui/checkbox.tsx",
            "usage": "Bulk selection for multi-customer statement generation"
          }
        ],
        "midday": [
          {
            "pattern": "Invoice Toolbar",
            "path": "_reference/.midday-reference/apps/dashboard/src/components/invoice-toolbar.tsx",
            "usage": "Adapt download/copy toolbar for statement PDF operations"
          }
        ]
      },
      "dependencies": [
        "DOM-FIN-004b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_FIN_004C_COMPLETE"
    },
    {
      "id": "DOM-FIN-005a",
      "name": "Complete Xero Invoice Sync - Server",
      "description": "Auto-push battery equipment invoices to Xero on creation and pull payment updates (AUD with GST)",
      "priority": 12,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Auto-push invoice to Xero on invoice creation/send with AUD currency and 10% GST tax rate",
        "Map battery equipment line items to Xero inventory codes",
        "Pull payment updates from Xero via webhook or polling",
        "Handle Xero validation errors gracefully with error messages",
        "Sync status tracking (pending, synced, error) on invoice",
        "Include payment terms (30 days) in Xero invoice metadata",
        "Manual re-sync server function",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "DOM_FIN_005A_COMPLETE"
    },
    {
      "id": "DOM-FIN-005b",
      "name": "Complete Xero Invoice Sync - UI",
      "description": "Sync status indicators and manual actions",
      "priority": 13,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Sync status badge on invoice list and detail using StatusBadge component",
        "Error message display when sync fails using AlertBanner",
        "Manual re-sync button on invoice detail using ActionButton",
        "Xero invoice link (deep link to Xero) using ExternalLink component",
        "Last synced timestamp display with relative time formatting",
        "Loading indicator during sync operation",
        "Error state with clear error message and retry action",
        "Keyboard: Tab to sync button, Enter to trigger",
        "ARIA live region for sync status announcements",
        "Responsive: Badge compact on mobile, detailed on desktop",
        "TypeScript compiles without errors"
      ],
      "ui_spec": {
        "component_type": "StatusBadge with ActionButton",
        "layout": {
          "mobile": "Compact sync icon with status color",
          "tablet": "Icon badge with tooltip details",
          "desktop": "Full status text with timestamp"
        },
        "accessibility": {
          "aria_labels": [
            "sync-status-badge",
            "resync-button",
            "xero-link",
            "sync-error-message"
          ],
          "keyboard_nav": "Tab to sync button, Enter to resync",
          "screen_reader": "Sync status announced, error details on focus",
          "focus_management": "Focus error message on sync failure"
        }
      },
      "uiPatterns": {
        "reui": [
          {
            "component": "Badge",
            "path": "_reference/.reui-reference/registry/default/ui/badge.tsx",
            "usage": "Sync status badge (pending: secondary, synced: success, error: destructive) with appearance='light'"
          },
          {
            "component": "Button",
            "path": "_reference/.reui-reference/registry/default/ui/button.tsx",
            "usage": "Manual re-sync action button with loading state"
          },
          {
            "component": "Alert",
            "path": "_reference/.reui-reference/registry/default/ui/alert.tsx",
            "usage": "Sync error alert with error message and retry action"
          },
          {
            "component": "Tooltip",
            "path": "_reference/.reui-reference/registry/default/ui/base-tooltip.tsx",
            "usage": "Hover details for sync status (timestamp, error details)"
          }
        ],
        "midday": [
          {
            "pattern": "Invoice Status",
            "path": "_reference/.midday-reference/apps/dashboard/src/components/invoice-status.tsx",
            "usage": "Adapt status badge pattern for Xero sync status display"
          }
        ]
      },
      "dependencies": [
        "DOM-FIN-005a"
      ],
      "estimated_iterations": 2,
      "completion_promise": "DOM_FIN_005B_COMPLETE"
    },
    {
      "id": "DOM-FIN-006a",
      "name": "Payment Reminders Schema",
      "description": "Create reminder templates and history tables",
      "priority": 14,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "reminder_templates table (id, name, daysOverdue, subject, body, organizationId)",
        "reminder_history table (id, invoiceId, templateId, sentAt, recipientEmail)",
        "Default templates: 7 days, 14 days, 30 days overdue (past 30-day payment terms)",
        "Template variables include: invoice amount (AUD), battery equipment description, payment terms",
        "Migration runs successfully",
        "TypeScript compiles without errors"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "DOM_FIN_006A_COMPLETE"
    },
    {
      "id": "DOM-FIN-006b",
      "name": "Auto Reminders Backend",
      "description": "Trigger.dev job and template logic",
      "priority": 15,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Trigger.dev daily job checks overdue invoices",
        "Matches invoices to reminder templates by days overdue",
        "Sends reminder email using template",
        "Respects customer opt-out setting",
        "Records reminder in history",
        "Manual send reminder server function",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "DOM-FIN-006a"
      ],
      "estimated_iterations": 4,
      "completion_promise": "DOM_FIN_006B_COMPLETE"
    },
    {
      "id": "DOM-FIN-006c",
      "name": "Reminders UI",
      "description": "Template management, history view, and manual send",
      "priority": 16,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Reminder template management in settings using DataTable pattern",
        "Edit template subject and body with variables using RichTextEditor",
        "Reminder history visible on invoice detail using Timeline",
        "Manual send reminder button on invoice using ActionButton",
        "Customer opt-out toggle on customer detail using Switch",
        "Variable insertion toolbar for template editing",
        "Loading skeleton (TemplateListSkeleton) during fetch",
        "Empty state: 'No reminder templates' with 'Create Template' CTA",
        "Error boundary with retry for template operations",
        "Keyboard navigation: Tab through template list and form",
        "ARIA labels for form controls and variable buttons",
        "Responsive: Full-width editor on mobile, side preview on desktop",
        "TypeScript compiles without errors"
      ],
      "ui_spec": {
        "component_type": "DataTable with RichTextEditor",
        "layout": {
          "mobile": "Full-width template cards, stacked editor",
          "tablet": "List with slide-out editor",
          "desktop": "Two-column: list left, editor right"
        },
        "accessibility": {
          "aria_labels": [
            "reminder-template-list",
            "template-editor",
            "variable-toolbar",
            "send-reminder-button"
          ],
          "keyboard_nav": "Tab to templates, Enter to edit, toolbar keyboard shortcuts",
          "screen_reader": "Template name and days overdue announced",
          "focus_management": "Focus editor on select, focus list after save"
        }
      },
      "uiPatterns": {
        "reui": [
          {
            "component": "DataGrid",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Reminder templates list with name, days overdue, last sent columns"
          },
          {
            "component": "Dialog",
            "path": "_reference/.reui-reference/registry/default/ui/dialog.tsx",
            "usage": "Template editor dialog with subject/body fields and variable toolbar"
          },
          {
            "component": "Input",
            "path": "_reference/.reui-reference/registry/default/ui/input.tsx",
            "usage": "Template subject line input"
          },
          {
            "component": "Textarea",
            "path": "_reference/.reui-reference/registry/default/ui/base-input.tsx",
            "usage": "Template body editor (may upgrade to rich text)"
          },
          {
            "component": "Switch",
            "path": "_reference/.reui-reference/registry/default/ui/base-switch.tsx",
            "usage": "Customer reminder opt-out toggle"
          },
          {
            "component": "Button",
            "path": "_reference/.reui-reference/registry/default/ui/button.tsx",
            "usage": "Variable insertion buttons, save/send actions"
          }
        ],
        "midday": []
      },
      "dependencies": [
        "DOM-FIN-006b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_FIN_006C_COMPLETE"
    },
    {
      "id": "DOM-FIN-007a",
      "name": "Financial Dashboard - Server",
      "description": "Dashboard metrics and chart data queries",
      "priority": 17,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "Enhanced getFinancialDashboardMetrics function",
        "Revenue MTD in AUD (battery equipment sales), AR balance, overdue amount, cash received",
        "Revenue by period data for charts (residential vs commercial breakdown)",
        "Top customers by revenue query (highlight $50K+ commercial accounts)",
        "Outstanding invoices summary with average invoice value by customer type",
        "GST collected MTD metric",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "DOM-FIN-003a"
      ],
      "estimated_iterations": 2,
      "completion_promise": "DOM_FIN_007A_COMPLETE"
    },
    {
      "id": "DOM-FIN-007b",
      "name": "Financial Dashboard - UI",
      "description": "Dashboard page with widgets and charts",
      "priority": 18,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Enhanced financial dashboard page using DashboardGrid pattern",
        "KPI widgets: revenue MTD (AUD), AR balance, overdue amount, cash received, GST collected using KPIWidget",
        "Revenue chart by period with residential vs commercial breakdown (line/bar chart) using ChartWidget",
        "Top customers by revenue table using MiniDataTable (flag commercial $50K+ accounts)",
        "Outstanding invoices list widget using ListWidget (show battery equipment details)",
        "Quick actions: create invoice, record payment using QuickActionBar",
        "All amounts displayed in AUD currency format",
        "Loading skeletons for all widgets (DashboardSkeleton)",
        "Empty states for widgets with no data",
        "Error boundaries per widget with independent retry",
        "Keyboard navigation: Tab through widgets, Enter to drill down",
        "ARIA landmarks for dashboard regions",
        "Responsive: Single column stacked widgets on mobile, grid on desktop",
        "TypeScript compiles without errors"
      ],
      "ui_spec": {
        "component_type": "DashboardGrid with KPIWidget and ChartWidget",
        "layout": {
          "mobile": "Single column, priority-ordered widgets",
          "tablet": "2-column grid, chart spans full width",
          "desktop": "4-column KPIs, 2-column body with chart and tables"
        },
        "accessibility": {
          "aria_labels": [
            "financial-dashboard",
            "kpi-revenue",
            "kpi-ar-balance",
            "revenue-chart",
            "top-customers"
          ],
          "keyboard_nav": "Tab through KPIs, Arrow keys in chart, Enter for drill-down",
          "screen_reader": "KPI values announced with labels, chart data summarized",
          "focus_management": "Focus first KPI on load"
        }
      },
      "uiPatterns": {
        "reui": [
          {
            "component": "Card",
            "path": "_reference/.reui-reference/registry/default/ui/card.tsx",
            "usage": "KPI widget cards with CardHeader, CardContent for metrics (revenue, AR, overdue, cash, GST)"
          },
          {
            "component": "Chart",
            "path": "_reference/.reui-reference/registry/default/ui/chart.tsx",
            "usage": "Revenue chart with residential vs commercial breakdown (bar/line chart)"
          },
          {
            "component": "DataGrid",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Top customers table and outstanding invoices list"
          },
          {
            "component": "Badge",
            "path": "_reference/.reui-reference/registry/default/ui/badge.tsx",
            "usage": "Commercial account flag badge ($50K+ indicator)"
          },
          {
            "component": "Button",
            "path": "_reference/.reui-reference/registry/default/ui/button.tsx",
            "usage": "Quick action buttons (create invoice, record payment)"
          },
          {
            "component": "CountingNumber",
            "path": "_reference/.reui-reference/registry/default/ui/counting-number.tsx",
            "usage": "Animated number display for KPI values"
          }
        ],
        "midday": [
          {
            "pattern": "Animated Number",
            "path": "_reference/.midday-reference/apps/dashboard/src/components/animated-number.tsx",
            "usage": "Animate KPI value changes for revenue, AR, overdue metrics"
          },
          {
            "pattern": "Metrics Grid",
            "path": "_reference/.midday-reference/apps/dashboard/src/components/metrics/components/metrics-grid.tsx",
            "usage": "Dashboard grid layout pattern for financial widgets"
          }
        ]
      },
      "dependencies": [
        "DOM-FIN-007a"
      ],
      "estimated_iterations": 4,
      "completion_promise": "DOM_FIN_007B_COMPLETE"
    },
    {
      "id": "DOM-FIN-008a",
      "name": "Revenue Recognition Schema",
      "description": "Create revenue recognition and deferred revenue tables for battery equipment sales (AUD amounts, milestone-based for commercial projects) with Xero sync state tracking",
      "priority": 19,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "revenue_recognition table (id, orderId, invoiceId, milestoneId, milestoneName, recognizedAmount, recognitionDate, state, xeroSyncAttempts, xeroSyncError, lastXeroSyncAt, createdAt, updatedAt)",
        "Recognition state enum: PENDING, RECOGNIZED, SYNCING, SYNCED, SYNC_FAILED, MANUAL_OVERRIDE",
        "deferred_revenue table (id, invoiceId, deferredAmount, period, status)",
        "Amounts stored in AUD cents",
        "Recognition schedule types: on_delivery (residential standard), milestone (commercial with 50% deposit), time_based",
        "Milestone examples: 'Battery delivery', 'Installation complete', 'System commissioned'",
        "Index on state for querying SYNC_FAILED and MANUAL_OVERRIDE records",
        "Migration runs successfully",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "DOM-FIN-005a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_FIN_008A_COMPLETE",
      "remediation_notes": {
        "source": "premortem-xero-integration",
        "added": "2026-01-17",
        "changes": [
          "Added state column for Xero sync coordination state machine",
          "Added xeroSyncAttempts, xeroSyncError, lastXeroSyncAt columns for sync tracking",
          "Added index on state column for querying failed syncs"
        ]
      }
    },
    {
      "id": "DOM-FIN-008b",
      "name": "Recognition Engine",
      "description": "Recognition logic and milestone triggers with Xero sync coordination. Implements state machine: PENDING -> RECOGNIZED -> SYNCING -> SYNCED (or MANUAL_OVERRIDE after 5 failures).",
      "priority": 20,
      "status": "pending",
      "passes": false,
      "acceptance_criteria": [
        "recognizeRevenue server function triggered by battery delivery/installation milestones",
        "calculateDeferredRevenue for advance payments (e.g., 50% commercial deposits)",
        "Recognition schedule creation based on billing type (residential immediate, commercial milestone-based)",
        "Handles partial recognition for phased battery installations",
        "getDeferredRevenueReport function showing AUD amounts by period",
        "getRevenueRecognitionReport function with milestone details",
        "State machine for recognition records: PENDING -> RECOGNIZED -> SYNCING -> SYNCED",
        "SYNC_FAILED state after Xero sync failure with retry tracking (xeroSyncAttempts)",
        "MANUAL_OVERRIDE state after 5 failed sync attempts with finance team notification",
        "Recognition creates local record first (RECOGNIZED), then queues Xero sync (LOW priority)",
        "handleRecognitionSyncResult() updates state based on Xero job result",
        "Xero webhook INVOICE.PAID event triggers recognition for milestone-based orders",
        "TypeScript compiles without errors"
      ],
      "dependencies": [
        "DOM-FIN-008a",
        "INT-XERO-011"
      ],
      "estimated_iterations": 5,
      "completion_promise": "DOM_FIN_008B_COMPLETE",
      "remediation_notes": {
        "source": "premortem-xero-integration",
        "added": "2026-01-17",
        "changes": [
          "Added state machine for Xero sync coordination",
          "Added dependency on INT-XERO-011 (Job Queue)",
          "Increased iterations from 4 to 5 for sync coordination complexity",
          "Added acceptance criteria for sync failure handling and MANUAL_OVERRIDE state"
        ]
      }
    },
    {
      "id": "DOM-FIN-008c",
      "name": "Revenue Reports UI",
      "description": "Recognition and deferred revenue report pages",
      "priority": 21,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Revenue recognition report page using ReportPage pattern",
        "Deferred revenue report page using ReportPage pattern",
        "Period views (monthly, quarterly, yearly) using PeriodSelector",
        "Filter by date range and recognition type using FilterBar",
        "Export to CSV using ExportButton",
        "DataTables for recognition and deferred revenue data",
        "Loading skeletons (ReportSkeleton) during data fetch",
        "Empty state: 'No recognition data' with period adjustment suggestion",
        "Error boundary with retry for report generation",
        "Keyboard navigation: Tab through filters, Arrow keys in tables",
        "ARIA tables with period and type headers",
        "Responsive: Card summary on mobile, full tables on desktop",
        "TypeScript compiles without errors"
      ],
      "ui_spec": {
        "component_type": "ReportPage with PeriodSelector and DataTable",
        "layout": {
          "mobile": "Period tabs, summary cards, expandable details",
          "tablet": "Period selector above, horizontal scroll table",
          "desktop": "Filter sidebar, full-width report table"
        },
        "accessibility": {
          "aria_labels": [
            "recognition-report",
            "deferred-report",
            "period-selector",
            "export-button"
          ],
          "keyboard_nav": "Tab through filters, Arrow keys for period, Enter to apply",
          "screen_reader": "Period and totals announced, row details on focus",
          "focus_management": "Focus table after filter change"
        }
      },
      "uiPatterns": {
        "reui": [
          {
            "component": "Tabs",
            "path": "_reference/.reui-reference/registry/default/ui/base-tabs.tsx",
            "usage": "Period selector tabs (monthly, quarterly, yearly)"
          },
          {
            "component": "DataGrid",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Revenue recognition and deferred revenue tables with period/amount columns"
          },
          {
            "component": "Card",
            "path": "_reference/.reui-reference/registry/default/ui/card.tsx",
            "usage": "Mobile summary cards showing totals by period"
          },
          {
            "component": "DropdownMenu",
            "path": "_reference/.reui-reference/registry/default/ui/dropdown-menu.tsx",
            "usage": "Export options menu (CSV, Excel)"
          },
          {
            "component": "Calendar",
            "path": "_reference/.reui-reference/registry/default/ui/calendar.tsx",
            "usage": "Date range filter for custom period selection"
          },
          {
            "component": "Select",
            "path": "_reference/.reui-reference/registry/default/ui/select.tsx",
            "usage": "Recognition type filter (on_delivery, milestone, time_based)"
          }
        ],
        "midday": []
      },
      "dependencies": [
        "DOM-FIN-008b"
      ],
      "estimated_iterations": 4,
      "completion_promise": "DOM_FIN_008C_COMPLETE"
    }
  ],
  "success_criteria": [
    "Credit notes handle battery equipment returns and adjustments in AUD",
    "Payment plans support 50% deposit structure for commercial projects",
    "AR aging report shows accurate aging based on 30-day terms with commercial account highlighting",
    "Statements communicate balances with GST breakdown and payment terms",
    "Xero sync reliably pushes invoices with AUD currency and 10% GST",
    "Reminders reduce overdue accounts past 30-day terms",
    "Financial dashboard displays residential vs commercial revenue breakdown",
    "Revenue recognition supports milestone-based recognition for commercial battery installations",
    "npm run typecheck passes",
    "No financial functionality regressions"
  ],
  "out_of_scope": [
    "Full accounting system (Xero integration provides this)",
    "Complex tax calculations beyond 10% GST",
    "Multi-currency support (AUD only for Australian market)",
    "Bank reconciliation (handled in Xero)",
    "Warranty tracking for battery equipment",
    "Inventory management for battery stock"
  ]
}
