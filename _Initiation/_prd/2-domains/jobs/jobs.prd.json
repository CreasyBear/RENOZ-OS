{
  "id": "DOM-JOBS",
  "name": "Jobs/Projects Domain",
  "description": "Battery installation and field work management. Jobs track work at customer sites including tasks, BOMs, time tracking, and commissioning checklists. Typical jobs: Residential (1-2 days), Commercial (3-5 days), Large commercial (1-2 weeks). Key for v1 field operations.",
  "created": "2026-01-09",
  "updated": "2026-01-10",
  "priority": 6,
  "phase": "domain-v1",
  "version": "v1",
  "dependencies": {
    "phase": "domain-v1",
    "executionOrder": 6,
    "schemaRequired": [
      {
        "table": "organizations",
        "status": "EXISTS"
      },
      {
        "table": "job_assignments",
        "status": "EXISTS"
      },
      {
        "table": "users",
        "status": "EXISTS"
      },
      {
        "table": "customers",
        "status": "EXISTS"
      },
      {
        "table": "orders",
        "status": "EXISTS"
      },
      {
        "table": "products",
        "status": "EXISTS"
      },
      {
        "table": "inventory_items",
        "status": "EXISTS"
      }
    ],
    "schemaCreates": [
      {
        "table": "job_tasks",
        "story": "DOM-JOBS-001a"
      },
      {
        "table": "job_materials",
        "story": "DOM-JOBS-002a"
      },
      {
        "table": "job_time_entries",
        "story": "DOM-JOBS-003a"
      },
      {
        "table": "checklist_templates",
        "story": "DOM-JOBS-004a"
      },
      {
        "table": "job_checklists",
        "story": "DOM-JOBS-004a"
      },
      {
        "table": "job_checklist_items",
        "story": "DOM-JOBS-004a"
      },
      {
        "table": "job_templates",
        "story": "DOM-JOBS-007a"
      }
    ],
    "serverFunctionsRequired": [
      {
        "function": "listJobs",
        "file": "jobs.ts",
        "status": "EXISTS"
      },
      {
        "function": "getJob",
        "file": "jobs.ts",
        "status": "EXISTS"
      },
      {
        "function": "createJobAssignment",
        "file": "jobs.ts",
        "status": "EXISTS"
      },
      {
        "function": "updateJob",
        "file": "jobs.ts",
        "status": "EXISTS"
      },
      {
        "function": "completeJob",
        "file": "jobs.ts",
        "status": "EXISTS"
      },
      {
        "function": "uploadJobPhoto",
        "file": "jobs.ts",
        "status": "EXISTS"
      },
      {
        "function": "getJobPhotos",
        "file": "jobs.ts",
        "status": "EXISTS"
      }
    ],
    "serverFunctionsCreates": [
      {
        "function": "listJobTasks",
        "file": "job-tasks.ts",
        "story": "DOM-JOBS-001b"
      },
      {
        "function": "createTask",
        "file": "job-tasks.ts",
        "story": "DOM-JOBS-001b"
      },
      {
        "function": "updateTask",
        "file": "job-tasks.ts",
        "story": "DOM-JOBS-001b"
      },
      {
        "function": "deleteTask",
        "file": "job-tasks.ts",
        "story": "DOM-JOBS-001b"
      },
      {
        "function": "reorderTasks",
        "file": "job-tasks.ts",
        "story": "DOM-JOBS-001b"
      },
      {
        "function": "listJobMaterials",
        "file": "job-materials.ts",
        "story": "DOM-JOBS-002b"
      },
      {
        "function": "addJobMaterial",
        "file": "job-materials.ts",
        "story": "DOM-JOBS-002b"
      },
      {
        "function": "updateJobMaterial",
        "file": "job-materials.ts",
        "story": "DOM-JOBS-002b"
      },
      {
        "function": "removeJobMaterial",
        "file": "job-materials.ts",
        "story": "DOM-JOBS-002b"
      },
      {
        "function": "reserveJobStock",
        "file": "job-materials.ts",
        "story": "DOM-JOBS-002b"
      },
      {
        "function": "calculateJobMaterialCost",
        "file": "job-materials.ts",
        "story": "DOM-JOBS-002b"
      },
      {
        "function": "startTimer",
        "file": "job-time.ts",
        "story": "DOM-JOBS-003b"
      },
      {
        "function": "stopTimer",
        "file": "job-time.ts",
        "story": "DOM-JOBS-003b"
      },
      {
        "function": "createManualEntry",
        "file": "job-time.ts",
        "story": "DOM-JOBS-003b"
      },
      {
        "function": "updateTimeEntry",
        "file": "job-time.ts",
        "story": "DOM-JOBS-003b"
      },
      {
        "function": "deleteTimeEntry",
        "file": "job-time.ts",
        "story": "DOM-JOBS-003b"
      },
      {
        "function": "getJobTimeEntries",
        "file": "job-time.ts",
        "story": "DOM-JOBS-003b"
      },
      {
        "function": "calculateJobLaborCost",
        "file": "job-time.ts",
        "story": "DOM-JOBS-003b"
      },
      {
        "function": "listChecklistTemplates",
        "file": "checklists.ts",
        "story": "DOM-JOBS-004b"
      },
      {
        "function": "createChecklistTemplate",
        "file": "checklists.ts",
        "story": "DOM-JOBS-004b"
      },
      {
        "function": "updateChecklistTemplate",
        "file": "checklists.ts",
        "story": "DOM-JOBS-004b"
      },
      {
        "function": "deleteChecklistTemplate",
        "file": "checklists.ts",
        "story": "DOM-JOBS-004b"
      },
      {
        "function": "applyChecklistToJob",
        "file": "checklists.ts",
        "story": "DOM-JOBS-004b"
      },
      {
        "function": "updateChecklistItem",
        "file": "checklists.ts",
        "story": "DOM-JOBS-004b"
      },
      {
        "function": "getJobChecklist",
        "file": "checklists.ts",
        "story": "DOM-JOBS-004b"
      },
      {
        "function": "rescheduleJob",
        "file": "jobs.ts",
        "story": "DOM-JOBS-005b"
      },
      {
        "function": "listJobTemplates",
        "file": "job-templates.ts",
        "story": "DOM-JOBS-007b"
      },
      {
        "function": "createJobTemplate",
        "file": "job-templates.ts",
        "story": "DOM-JOBS-007b"
      },
      {
        "function": "updateJobTemplate",
        "file": "job-templates.ts",
        "story": "DOM-JOBS-007b"
      },
      {
        "function": "deleteJobTemplate",
        "file": "job-templates.ts",
        "story": "DOM-JOBS-007b"
      },
      {
        "function": "createJobFromTemplate",
        "file": "job-templates.ts",
        "story": "DOM-JOBS-007b"
      },
      {
        "function": "calculateJobCost",
        "file": "job-costing.ts",
        "story": "DOM-JOBS-008a"
      },
      {
        "function": "getJobProfitability",
        "file": "job-costing.ts",
        "story": "DOM-JOBS-008a"
      },
      {
        "function": "getJobCostingReport",
        "file": "job-costing.ts",
        "story": "DOM-JOBS-008a"
      }
    ],
    "prdDependencies": [
      "schema-foundation",
      "DOM-CUSTOMERS",
      "DOM-ORDERS",
      "DOM-INVENTORY"
    ],
    "enables": [
      "DOM-FINANCIAL",
      "DOM-REPORTS"
    ]
  },
  "audit": {
    "date": "2026-01-09",
    "audit_file": "memory-bank/prd/_audits/jobs-audit.json"
  },
  "references": {
    "internal": [
      "memory-bank/_meta/glossary.md - Jobs terminology",
      "src/lib/schema/jobs.ts - Job schema",
      "src/server/functions/jobs.ts - Server functions",
      "memory-bank/prd/jobs-mvp.prd.json - MVP requirements"
    ],
    "external": [
      "No external dependencies"
    ]
  },
  "current_state": {
    "implemented": [
      "Job CRUD operations",
      "Job assignments to technicians",
      "Photo capture (before/during/after/issue)",
      "Public sign-off page with token",
      "Job status tracking",
      "Customer signature capture",
      "Serial number verification",
      "GPS location tracking",
      "Mobile-responsive installer views (installer/jobs/$jobId.tsx)",
      "Today's jobs dashboard for installers",
      "Weekly schedule view (list format)",
      "Issue reporting from field",
      "Installer to office messaging",
      "PWA infrastructure (manifest, service worker, offline sync)"
    ],
    "gaps": [
      "No task management within jobs",
      "No BOM (bill of materials) tracking",
      "No time tracking",
      "No punchlist/checklist",
      "No job scheduling calendar (drag-drop)",
      "No job templates",
      "No job costing reports"
    ]
  },
  "stories": [
    {
      "id": "DOM-JOBS-001a",
      "name": "Job Task Management: Schema",
      "description": "Create job_tasks table for battery installation task tracking. Tasks include: Site assessment, Electrical prep, Battery mounting, BMS configuration, Grid connection, Commissioning",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "type": "schema",
      "acceptance_criteria": [
        "File lib/schema/job-tasks.ts created",
        "jobTasks table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, jobId uuid NOT NULL REFERENCES job_assignments(id) ON DELETE CASCADE, title varchar NOT NULL, description text, status enum(pending, in_progress, completed, blocked) NOT NULL DEFAULT 'pending', assigneeId uuid REFERENCES users(id) ON DELETE SET NULL, dueDate date, position integer NOT NULL, createdAt timestamptz NOT NULL DEFAULT NOW(), updatedAt timestamptz NOT NULL DEFAULT NOW(), createdBy uuid REFERENCES users(id) ON DELETE SET NULL, updatedBy uuid REFERENCES users(id) ON DELETE SET NULL, version integer NOT NULL DEFAULT 1",
        "Indexes: orgJob (organization_id, job_id), orgStatus (organization_id, status), orgCreated (organization_id, created_at DESC)",
        "Types exported from lib/schema/index.ts",
        "Migration file created",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/lib/schema/job-tasks.ts (create)",
        "src/lib/schema/index.ts (export)",
        "drizzle/migrations/*.sql (generated)"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "DOM_JOBS_001A_COMPLETE"
    },
    {
      "id": "DOM-JOBS-001b",
      "name": "Job Task Management: Server Functions",
      "description": "Create CRUD functions for job tasks with reordering",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/job-tasks.ts created",
        "listJobTasks: returns tasks for a job sorted by position",
        "createTask: creates task with auto-increment position",
        "updateTask: updates task details and status",
        "deleteTask: removes task",
        "reorderTasks: updates positions for drag-drop reorder",
        "Validation schemas in lib/schemas/job-tasks.ts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/job-tasks.ts (create)",
        "src/lib/schemas/job-tasks.ts (create)"
      ],
      "dependencies": [
        "DOM-JOBS-001a"
      ],
      "estimated_iterations": 2,
      "completion_promise": "DOM_JOBS_001B_COMPLETE"
    },
    {
      "id": "DOM-JOBS-001c",
      "name": "Job Task Management: UI",
      "description": "Task list and management UI on job detail",
      "priority": 1,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Tasks tab on job detail page (installer/jobs/$jobId.tsx)",
        "Task list with status badges and drag-drop reorder using SortableList pattern",
        "Add/edit task dialog with title, description, assignee, due date using FormDialog pattern",
        "Quick task completion from mobile view (touch-friendly with minimum 44px tap targets)",
        "Task progress feeds job progress percentage display",
        "Loading skeleton shows while tasks are fetching (TaskListSkeleton component)",
        "Empty state with 'Add First Task' CTA when no tasks exist",
        "Error boundary wraps task list with retry action",
        "Keyboard navigation: Tab through tasks, Enter to toggle completion, Space to open edit",
        "ARIA labels on all interactive elements (aria-label on buttons, aria-live for status changes)",
        "Responsive layout: single column on mobile (<640px), two columns on tablet (640-1024px)",
        "npm run typecheck passes"
      ],
      "ui_spec": {
        "component_type": "SortableList with DetailPanel integration",
        "layout": {
          "mobile": "Single column, full-width task cards, bottom-fixed add button",
          "tablet": "Two-column grid, floating action button",
          "desktop": "List view within tab panel, inline add form option"
        },
        "accessibility": {
          "aria_labels": [
            "task-list",
            "task-item-{id}",
            "add-task-button",
            "task-status-{status}"
          ],
          "keyboard_nav": "Arrow keys to navigate list, Enter to toggle, Tab to actions",
          "screen_reader": "Announce task count, status changes via aria-live region",
          "focus_management": "Return focus to list after dialog close"
        }
      },
      "uiPatterns": {
        "primaryComponents": [
          {
            "name": "Kanban Board (Sortable)",
            "component": "kanban.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/kanban.tsx",
            "usage": "Drag-drop task reordering with status columns (Pending, In Progress, Completed, Blocked)",
            "features": [
              "Drag-drop between columns for status changes",
              "Inline task editing",
              "Position persistence",
              "Touch-friendly mobile interactions"
            ],
            "adaptation": "Use Kanban for desktop, fall back to vertical list with status badges on mobile"
          },
          {
            "name": "List Card",
            "component": "list-card-1.tsx",
            "path": "_reference/.reui-reference/registry/default/blocks/cards/list-cards/list-card-1.tsx",
            "usage": "Task card display with title, description, assignee, due date",
            "features": [
              "Badge for task status",
              "Avatar for assignee",
              "Due date indicator with color coding",
              "Action menu (Edit, Delete)"
            ]
          }
        ],
        "supportingComponents": [
          {
            "name": "Dialog (Form)",
            "component": "base-dialog.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-dialog.tsx",
            "usage": "Add/Edit task form dialog"
          },
          {
            "name": "Progress Bar",
            "component": "base-progress.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-progress.tsx",
            "usage": "Task completion percentage on job detail header"
          },
          {
            "name": "Badge",
            "component": "badge.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/badge.tsx",
            "usage": "Task status indicators (pending/in-progress/completed/blocked)"
          }
        ],
        "layoutPattern": "Tabs → Kanban (desktop) / List (mobile)",
        "emptyState": "Empty state card with 'Add First Task' illustration and CTA",
        "loadingState": "Skeleton with 3 task card placeholders"
      },
      "files_to_modify": [
        "src/components/domain/jobs/job-tasks-list.tsx (create)",
        "src/components/domain/jobs/task-dialog.tsx (create)",
        "src/routes/installer/jobs/$jobId.tsx (modify: add Tasks tab)"
      ],
      "dependencies": [
        "DOM-JOBS-001b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_001C_COMPLETE"
    },
    {
      "id": "DOM-JOBS-002a",
      "name": "Job BOM Tracking: Schema",
      "description": "Create job_materials table for battery system components (batteries, inverters, BMS units, mounting hardware, electrical components)",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "type": "schema",
      "acceptance_criteria": [
        "File lib/schema/job-materials.ts created",
        "jobMaterials table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, jobId uuid NOT NULL REFERENCES job_assignments(id) ON DELETE CASCADE, productId uuid NOT NULL REFERENCES products(id) ON DELETE RESTRICT, quantityRequired numeric(10,2) NOT NULL, quantityUsed numeric(10,2) NOT NULL DEFAULT 0, unitCost numeric(10,4) NOT NULL, notes text, createdAt timestamptz NOT NULL DEFAULT NOW(), updatedAt timestamptz NOT NULL DEFAULT NOW(), createdBy uuid REFERENCES users(id) ON DELETE SET NULL, updatedBy uuid REFERENCES users(id) ON DELETE SET NULL, version integer NOT NULL DEFAULT 1",
        "Indexes: orgJob (organization_id, job_id), orgProduct (organization_id, product_id), orgCreated (organization_id, created_at DESC)",
        "Types exported from lib/schema/index.ts",
        "Migration file created",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/lib/schema/job-materials.ts (create)",
        "src/lib/schema/index.ts (export)",
        "drizzle/migrations/*.sql (generated)"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "DOM_JOBS_002A_COMPLETE"
    },
    {
      "id": "DOM-JOBS-002b",
      "name": "Job BOM Tracking: Server Functions",
      "description": "Create material allocation and usage tracking functions",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/job-materials.ts created",
        "listJobMaterials: returns materials for a job with product details",
        "addJobMaterial: adds product to BOM with quantity",
        "updateJobMaterial: updates quantity required/used",
        "removeJobMaterial: removes from BOM",
        "reserveJobStock: reserves inventory items for job",
        "calculateJobMaterialCost: returns total material cost for job",
        "Validation schemas in lib/schemas/job-materials.ts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/job-materials.ts (create)",
        "src/lib/schemas/job-materials.ts (create)"
      ],
      "dependencies": [
        "DOM-JOBS-002a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_002B_COMPLETE"
    },
    {
      "id": "DOM-JOBS-002c",
      "name": "Job BOM Tracking: UI",
      "description": "BOM tab on job detail with product picker and usage tracking",
      "priority": 2,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "BOM tab on job detail page using TabPanel pattern",
        "Product search and add to BOM with ComboboxSearch component",
        "Quantity required vs used display with visual progress indicator",
        "Track actual usage during job with inline editable fields",
        "Cost calculation display from materials with currency formatting",
        "Reserve stock action for job with confirmation dialog",
        "DataTable component for material list with sortable columns",
        "Loading skeleton (MaterialsTableSkeleton) during data fetch",
        "Empty state: 'No materials added' with 'Add Material' primary CTA",
        "Error boundary with retry for failed material operations",
        "Keyboard navigation: Tab through rows, Enter to edit quantity",
        "ARIA labels for all actions and status indicators",
        "Responsive: Stacked cards on mobile, table on tablet+",
        "npm run typecheck passes"
      ],
      "ui_spec": {
        "component_type": "DataTable with inline editing",
        "layout": {
          "mobile": "Card stack layout, swipe actions for edit/delete",
          "tablet": "Compact table with horizontal scroll if needed",
          "desktop": "Full DataTable with all columns visible"
        },
        "accessibility": {
          "aria_labels": [
            "materials-table",
            "add-material-button",
            "quantity-input-{id}",
            "reserve-stock-button"
          ],
          "keyboard_nav": "Tab through cells, Enter to edit, Escape to cancel",
          "screen_reader": "Table caption, column headers announced, cost total announced",
          "focus_management": "Focus new row after add, maintain position after update"
        }
      },
      "uiPatterns": {
        "primaryComponents": [
          {
            "name": "Data Grid",
            "component": "data-grid.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Materials list with columns: Product, SKU, Qty Required, Qty Used, Unit Cost, Total Cost, Actions",
            "features": [
              "Sortable columns (by product, cost)",
              "Inline editing for Qty Used",
              "Progress indicator (used/required ratio)",
              "Row actions: Edit, Delete, Reserve Stock",
              "Sticky header on scroll"
            ],
            "adaptation": "Add custom cell renderer for quantity progress bar (used/required)"
          },
          {
            "name": "Statistic Card",
            "component": "statistic-card-1.tsx",
            "path": "_reference/.reui-reference/registry/default/blocks/cards/statistic-cards/statistic-card-1.tsx",
            "usage": "Total material cost summary card above table",
            "features": [
              "Currency formatting (AUD)",
              "Delta badge (vs estimated)",
              "Color coding: green if under budget, red if over"
            ]
          }
        ],
        "supportingComponents": [
          {
            "name": "Combobox (Product Search)",
            "component": "base-combobox.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-combobox.tsx",
            "usage": "Product picker in 'Add Material' dialog"
          },
          {
            "name": "Number Field",
            "component": "base-number-field.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-number-field.tsx",
            "usage": "Quantity input with stepper controls"
          },
          {
            "name": "Progress",
            "component": "base-progress.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-progress.tsx",
            "usage": "Visual indicator for quantity used/required ratio"
          }
        ],
        "layoutPattern": "Header card (cost summary) → Data Grid → Action buttons",
        "emptyState": "Illustration of materials with 'Add Material' CTA",
        "loadingState": "Table skeleton with 5 row placeholders"
      },
      "files_to_modify": [
        "src/components/domain/jobs/job-materials-tab.tsx (create)",
        "src/components/domain/jobs/add-material-dialog.tsx (create)",
        "src/routes/installer/jobs/$jobId.tsx (modify: add BOM tab)"
      ],
      "dependencies": [
        "DOM-JOBS-002b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_002C_COMPLETE"
    },
    {
      "id": "DOM-JOBS-003a",
      "name": "Time Tracking: Schema",
      "description": "Create job_time_entries table for labor tracking",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "type": "schema",
      "acceptance_criteria": [
        "File lib/schema/job-time-entries.ts created",
        "jobTimeEntries table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, jobId uuid NOT NULL REFERENCES job_assignments(id) ON DELETE CASCADE, userId uuid NOT NULL REFERENCES users(id) ON DELETE CASCADE, startTime timestamptz NOT NULL, endTime timestamptz, description text, isBillable boolean NOT NULL DEFAULT true, createdAt timestamptz NOT NULL DEFAULT NOW(), updatedAt timestamptz NOT NULL DEFAULT NOW(), createdBy uuid REFERENCES users(id) ON DELETE SET NULL, updatedBy uuid REFERENCES users(id) ON DELETE SET NULL, version integer NOT NULL DEFAULT 1",
        "Indexes: orgJob (organization_id, job_id), orgUser (organization_id, user_id), orgStartTime (organization_id, start_time DESC)",
        "Types exported from lib/schema/index.ts",
        "Migration file created",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/lib/schema/job-time-entries.ts (create)",
        "src/lib/schema/index.ts (export)",
        "drizzle/migrations/*.sql (generated)"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "DOM_JOBS_003A_COMPLETE"
    },
    {
      "id": "DOM-JOBS-003b",
      "name": "Time Tracking: Server Functions",
      "description": "Create timer start/stop and time entry functions",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/job-time.ts created",
        "startTimer: creates entry with startTime, no endTime",
        "stopTimer: updates entry with endTime",
        "createManualEntry: creates entry with both start and end times",
        "updateTimeEntry: updates description, billable flag",
        "deleteTimeEntry: removes entry",
        "getJobTimeEntries: returns entries for job with totals",
        "calculateJobLaborCost: returns total labor cost (hours * rate)",
        "Validation schemas in lib/schemas/job-time.ts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/job-time.ts (create)",
        "src/lib/schemas/job-time.ts (create)"
      ],
      "dependencies": [
        "DOM-JOBS-003a"
      ],
      "estimated_iterations": 2,
      "completion_promise": "DOM_JOBS_003B_COMPLETE"
    },
    {
      "id": "DOM-JOBS-003c",
      "name": "Time Tracking: UI",
      "description": "Timer and time entry UI on job detail",
      "priority": 3,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Time tab on job detail page using TabPanel pattern",
        "Start/stop timer button with active timer display (prominent, touch-friendly 48px minimum)",
        "Active timer shows elapsed time with live-updating display",
        "Manual time entry form with start/end time pickers using FormDialog pattern",
        "Time entries list with totals using DataTable pattern",
        "Billable toggle on entries with immediate visual feedback",
        "Time summary card showing total hours with KPIWidget pattern",
        "Loading skeleton (TimeEntriesSkeleton) during data fetch",
        "Empty state: 'No time tracked' with 'Start Timer' primary CTA",
        "Error boundary with retry for failed time operations",
        "Keyboard: Space to start/stop timer, Tab through entries",
        "ARIA live region announces timer status changes",
        "Responsive: Timer always visible, entries collapse on mobile",
        "npm run typecheck passes"
      ],
      "ui_spec": {
        "component_type": "Timer widget with DataTable",
        "layout": {
          "mobile": "Sticky timer header, scrollable entry list below",
          "tablet": "Timer card beside entry list",
          "desktop": "Timer in sidebar, full entry table in main area"
        },
        "accessibility": {
          "aria_labels": [
            "timer-display",
            "start-timer-button",
            "stop-timer-button",
            "time-entries-table",
            "billable-toggle-{id}"
          ],
          "keyboard_nav": "Space for timer, Tab through entries, Enter to edit",
          "screen_reader": "Timer state announced, entry durations read as 'X hours Y minutes'",
          "focus_management": "Focus timer button on tab open, return focus after dialog close"
        }
      },
      "uiPatterns": {
        "primaryComponents": [
          {
            "name": "Statistic Card (Timer Widget)",
            "component": "statistic-card-10.tsx",
            "path": "_reference/.reui-reference/registry/default/blocks/cards/statistic-cards/statistic-card-10.tsx",
            "usage": "Active timer display with start/stop button and elapsed time",
            "features": [
              "Large, prominent time display (HH:MM:SS)",
              "Start/Stop button (48px minimum touch target)",
              "Status badge (Running/Paused)",
              "Live update every second via useEffect"
            ],
            "adaptation": "Add pulse animation when timer is running, green accent color for active state"
          },
          {
            "name": "Data Grid",
            "component": "data-grid.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Time entries table with columns: Date, Start, End, Duration, Description, Billable, Actions",
            "features": [
              "Sortable by date/duration",
              "Inline toggle for billable status",
              "Row actions: Edit, Delete",
              "Total hours summary row"
            ]
          }
        ],
        "supportingComponents": [
          {
            "name": "Statistic Card (Summary)",
            "component": "statistic-card-1.tsx",
            "path": "_reference/.reui-reference/registry/default/blocks/cards/statistic-cards/statistic-card-1.tsx",
            "usage": "Total hours summary card (Total Hours, Billable Hours, Labor Cost)"
          },
          {
            "name": "Switch",
            "component": "base-switch.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-switch.tsx",
            "usage": "Billable toggle in time entry rows"
          },
          {
            "name": "DateField",
            "component": "datefield.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/datefield.tsx",
            "usage": "Start/end time pickers in manual entry form"
          }
        ],
        "layoutPattern": "Sticky timer card → Summary cards (3-col grid) → Data Grid",
        "emptyState": "Illustration with clock/timer and 'Start Timer' CTA",
        "loadingState": "Skeleton with timer card + 3 entry row placeholders",
        "realtime": "Timer updates every second, ARIA live region announces status changes"
      },
      "files_to_modify": [
        "src/components/domain/jobs/job-time-tab.tsx (create)",
        "src/components/domain/jobs/time-entry-dialog.tsx (create)",
        "src/components/domain/jobs/active-timer.tsx (create)",
        "src/routes/installer/jobs/$jobId.tsx (modify: add Time tab)"
      ],
      "dependencies": [
        "DOM-JOBS-003b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_003C_COMPLETE"
    },
    {
      "id": "DOM-JOBS-004a",
      "name": "Commissioning Checklist: Schema",
      "description": "Create checklist templates and job checklist tables for battery system commissioning and safety verification",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "type": "schema",
      "acceptance_criteria": [
        "File lib/schema/checklists.ts created",
        "checklistTemplates table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, name varchar NOT NULL, items jsonb NOT NULL, isActive boolean NOT NULL DEFAULT true, createdAt timestamptz NOT NULL DEFAULT NOW(), updatedAt timestamptz NOT NULL DEFAULT NOW(), createdBy uuid REFERENCES users(id) ON DELETE SET NULL, updatedBy uuid REFERENCES users(id) ON DELETE SET NULL, version integer NOT NULL DEFAULT 1",
        "jobChecklists table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, jobId uuid NOT NULL REFERENCES job_assignments(id) ON DELETE CASCADE, templateId uuid REFERENCES checklist_templates(id) ON DELETE SET NULL, createdAt timestamptz NOT NULL DEFAULT NOW(), updatedAt timestamptz NOT NULL DEFAULT NOW(), createdBy uuid REFERENCES users(id) ON DELETE SET NULL, updatedBy uuid REFERENCES users(id) ON DELETE SET NULL, version integer NOT NULL DEFAULT 1",
        "jobChecklistItems table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, checklistId uuid NOT NULL REFERENCES job_checklists(id) ON DELETE CASCADE, itemText varchar NOT NULL, isCompleted boolean NOT NULL DEFAULT false, completedAt timestamptz, completedBy uuid REFERENCES users(id) ON DELETE SET NULL, notes text, photoUrl text, createdAt timestamptz NOT NULL DEFAULT NOW(), updatedAt timestamptz NOT NULL DEFAULT NOW(), createdBy uuid REFERENCES users(id) ON DELETE SET NULL, updatedBy uuid REFERENCES users(id) ON DELETE SET NULL, version integer NOT NULL DEFAULT 1",
        "Indexes: checklistTemplates - orgName (organization_id, name), orgActive (organization_id, is_active); jobChecklists - orgJob (organization_id, job_id), orgTemplate (organization_id, template_id), orgCreated (organization_id, created_at DESC); jobChecklistItems - orgChecklist (organization_id, checklist_id), orgCompleted (organization_id, is_completed)",
        "Types exported from lib/schema/index.ts",
        "Migration file created",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/lib/schema/checklists.ts (create)",
        "src/lib/schema/index.ts (export)",
        "drizzle/migrations/*.sql (generated)"
      ],
      "dependencies": [],
      "estimated_iterations": 2,
      "completion_promise": "DOM_JOBS_004A_COMPLETE"
    },
    {
      "id": "DOM-JOBS-004b",
      "name": "Commissioning Checklist: Server Functions",
      "description": "Create commissioning checklist template CRUD and job checklist functions for battery system verification",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/checklists.ts created",
        "listChecklistTemplates: returns templates for org",
        "createChecklistTemplate: creates template with items",
        "updateChecklistTemplate: updates template",
        "deleteChecklistTemplate: removes template",
        "applyChecklistToJob: creates job checklist from template",
        "updateChecklistItem: marks item complete, adds notes/photo",
        "getJobChecklist: returns checklist with items for job",
        "Validation schemas in lib/schemas/checklists.ts",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/checklists.ts (create)",
        "src/lib/schemas/checklists.ts (create)"
      ],
      "dependencies": [
        "DOM-JOBS-004a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_004B_COMPLETE"
    },
    {
      "id": "DOM-JOBS-004c",
      "name": "Commissioning Checklist: UI",
      "description": "Commissioning template management and checklist UI on battery installation job detail",
      "priority": 4,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Checklist templates management page in settings using DataTable pattern",
        "Create/edit template with draggable items using SortableList pattern",
        "Checklist tab on job detail using TabPanel pattern",
        "Apply template to job action with SelectDialog pattern",
        "Check items from mobile view (touch-friendly with 44px tap targets, swipe to complete)",
        "Photo attachment per checklist item using ImageUpload component",
        "Progress bar showing completion percentage",
        "Loading skeleton (ChecklistSkeleton) during data fetch",
        "Empty state: 'No checklist applied' with 'Apply Template' primary CTA",
        "Error boundary with retry for failed checklist operations",
        "Keyboard: Space/Enter to toggle items, Tab to navigate",
        "ARIA checkboxes with proper checked state",
        "Responsive: Full-width checklist cards on mobile",
        "npm run typecheck passes"
      ],
      "ui_spec": {
        "component_type": "Checklist with photo attachments",
        "layout": {
          "mobile": "Full-width cards, large tap targets, swipe gestures",
          "tablet": "Two-column checklist grid",
          "desktop": "Single-column with inline photo preview"
        },
        "accessibility": {
          "aria_labels": [
            "checklist-progress",
            "checklist-item-{id}",
            "item-checkbox-{id}",
            "attach-photo-{id}"
          ],
          "keyboard_nav": "Tab through items, Space to toggle, Enter for photo",
          "screen_reader": "Progress announced as 'X of Y items complete'",
          "focus_management": "Focus first unchecked item on load"
        }
      },
      "uiPatterns": {
        "primaryComponents": [
          {
            "name": "List Card (Checklist Item)",
            "component": "list-card-1.tsx",
            "path": "_reference/.reui-reference/registry/default/blocks/cards/list-cards/list-card-1.tsx",
            "usage": "Checklist item card with checkbox, item text, photo attachment, notes",
            "features": [
              "Large checkbox (44px tap target)",
              "Strikethrough text when completed",
              "Photo thumbnail preview",
              "Expand for notes and completion details",
              "Swipe to complete on mobile"
            ],
            "adaptation": "Add photo upload button, completion timestamp, completed-by user avatar"
          },
          {
            "name": "Progress Bar",
            "component": "base-progress.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-progress.tsx",
            "usage": "Checklist completion progress at top of tab"
          }
        ],
        "supportingComponents": [
          {
            "name": "Checkbox",
            "component": "base-checkbox.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-checkbox.tsx",
            "usage": "Item completion toggle"
          },
          {
            "name": "Dialog",
            "component": "base-dialog.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-dialog.tsx",
            "usage": "Photo preview, notes editor"
          },
          {
            "name": "Data Grid (Template Management)",
            "component": "data-grid.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Checklist templates list in settings"
          },
          {
            "name": "Kanban (Template Editor)",
            "component": "kanban.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/kanban.tsx",
            "usage": "Drag-drop reordering of checklist items in template editor"
          }
        ],
        "layoutPattern": "Progress header → Checklist items (vertical list) → 'Apply Template' button if empty",
        "emptyState": "Illustration of clipboard with 'Apply Checklist Template' CTA",
        "loadingState": "Skeleton with progress bar + 5 checklist item placeholders",
        "mobileOptimization": "Swipe gestures, large tap targets (44px min), full-width cards"
      },
      "files_to_modify": [
        "src/routes/_authed/settings/checklist-templates.tsx (create)",
        "src/components/domain/jobs/job-checklist-tab.tsx (create)",
        "src/components/domain/jobs/checklist-item.tsx (create)",
        "src/routes/installer/jobs/$jobId.tsx (modify: add Checklist tab)"
      ],
      "dependencies": [
        "DOM-JOBS-004b"
      ],
      "estimated_iterations": 4,
      "completion_promise": "DOM_JOBS_004C_COMPLETE"
    },
    {
      "id": "DOM-JOBS-005a",
      "name": "Job Scheduling Calendar: Basic Calendar",
      "description": "Calendar visualization for battery installation job scheduling with technician workload view",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "File src/routes/_authed/jobs/calendar.tsx created",
        "Calendar component (FullCalendar or react-big-calendar) with proper ARIA roles",
        "Month and week view toggle with clear active state",
        "Jobs displayed on scheduled dates with status color coding",
        "Click job to navigate to detail using Link pattern",
        "Loading skeleton (CalendarSkeleton) during data fetch",
        "Empty state for days without jobs (subtle indicator)",
        "Error boundary with retry for calendar data fetch failures",
        "Keyboard navigation: Arrow keys to navigate dates, Enter to select day",
        "ARIA grid role with proper date cell labeling",
        "Responsive: Month view on desktop, week/day view on mobile",
        "npm run typecheck passes"
      ],
      "ui_spec": {
        "component_type": "Calendar with event display",
        "layout": {
          "mobile": "Day/3-day view default, swipe to navigate",
          "tablet": "Week view default with day detail panel",
          "desktop": "Month view with job preview on hover"
        },
        "accessibility": {
          "aria_labels": [
            "job-calendar",
            "calendar-nav-prev",
            "calendar-nav-next",
            "view-toggle"
          ],
          "keyboard_nav": "Arrow keys for date navigation, Enter to view day, Tab to events",
          "screen_reader": "Date announced with job count, job details on focus",
          "focus_management": "Focus today on load, maintain date focus after navigation"
        }
      },
      "uiPatterns": {
        "primaryComponents": [
          {
            "name": "Calendar (Third-party)",
            "component": "FullCalendar or react-big-calendar",
            "path": "npm package (not REUI)",
            "usage": "Calendar grid with job events",
            "features": [
              "Month/Week/Day views",
              "Event rendering with status colors",
              "Click to navigate to job detail",
              "Keyboard navigation support",
              "Mobile-responsive views"
            ],
            "note": "Use shadcn Calendar component for date picking, but FullCalendar for event display"
          },
          {
            "name": "Tabs (View Selector)",
            "component": "base-tabs.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-tabs.tsx",
            "usage": "Month/Week/Day view toggle"
          }
        ],
        "supportingComponents": [
          {
            "name": "Badge",
            "component": "badge.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/badge.tsx",
            "usage": "Job status indicators on calendar events (Scheduled/In Progress/Completed)"
          },
          {
            "name": "Popover",
            "component": "base-popover.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-popover.tsx",
            "usage": "Job preview on hover (desktop)"
          },
          {
            "name": "Button",
            "component": "button.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/button.tsx",
            "usage": "Navigation controls (prev/next/today)"
          }
        ],
        "colorCoding": {
          "scheduled": "Blue",
          "in_progress": "Orange",
          "completed": "Green",
          "cancelled": "Gray"
        },
        "layoutPattern": "Header (view toggle, navigation) → Calendar grid → Legend",
        "emptyState": "Subtle text on empty days: 'No jobs scheduled'",
        "loadingState": "Calendar skeleton with date grid placeholders"
      },
      "files_to_modify": [
        "src/routes/_authed/jobs/calendar.tsx (create)",
        "src/components/domain/jobs/job-calendar.tsx (create)"
      ],
      "dependencies": [],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_005A_COMPLETE"
    },
    {
      "id": "DOM-JOBS-005b",
      "name": "Job Scheduling Calendar: Drag-Drop & Filters",
      "description": "Drag-drop reschedule and technician filters",
      "priority": 5,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Drag job to different date to reschedule with visual feedback",
        "Server call to update scheduledDate on drop with optimistic update",
        "Technician filter dropdown using MultiSelect pattern",
        "Unscheduled jobs sidebar using SidePanel pattern",
        "Drag from sidebar to calendar to schedule with drop zone highlighting",
        "Loading state during reschedule operation",
        "Error toast on failed reschedule with undo option",
        "Keyboard alternative: Select job, use dialog to change date",
        "ARIA drag-and-drop announcements for screen readers",
        "Responsive: Sidebar becomes bottom sheet on mobile",
        "npm run typecheck passes"
      ],
      "ui_spec": {
        "component_type": "Calendar with drag-drop and filters",
        "layout": {
          "mobile": "Calendar full-width, unscheduled in bottom sheet, filter in header dropdown",
          "tablet": "Calendar with collapsible sidebar",
          "desktop": "Three-column: filters | calendar | unscheduled sidebar"
        },
        "accessibility": {
          "aria_labels": [
            "unscheduled-jobs-list",
            "technician-filter",
            "drag-handle-{jobId}"
          ],
          "keyboard_nav": "Tab to job, Enter to open reschedule dialog, Arrow keys in calendar",
          "screen_reader": "Drag operation announced, drop result confirmed",
          "focus_management": "Focus rescheduled job after drop"
        }
      },
      "uiPatterns": {
        "primaryComponents": [
          {
            "name": "Sheet (Unscheduled Jobs Sidebar)",
            "component": "base-sheet.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-sheet.tsx",
            "usage": "Side panel with unscheduled jobs list (desktop) or bottom sheet (mobile)",
            "features": [
              "Draggable job cards",
              "Search/filter within unscheduled jobs",
              "Job count badge",
              "Collapsible on desktop"
            ]
          },
          {
            "name": "Filters",
            "component": "filters.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/filters.tsx",
            "usage": "Technician multi-select, job type filter, date range"
          }
        ],
        "supportingComponents": [
          {
            "name": "List Card (Draggable Job)",
            "component": "list-card-1.tsx",
            "path": "_reference/.reui-reference/registry/default/blocks/cards/list-cards/list-card-1.tsx",
            "usage": "Job card in unscheduled sidebar with drag handle"
          },
          {
            "name": "Alert Dialog",
            "component": "base-alert-dialog.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-alert-dialog.tsx",
            "usage": "Confirmation for reschedule with conflict warning"
          },
          {
            "name": "Toast",
            "component": "base-toast.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-toast.tsx",
            "usage": "Success/error notifications with undo action"
          }
        ],
        "dragDropLibrary": "Use @dnd-kit/core for accessible drag-drop",
        "layoutPattern": "Filters bar → Calendar (with drop zones) → Unscheduled sidebar",
        "optimisticUpdate": "Job moves immediately on drop, reverts on error with toast",
        "loadingState": "Spinner overlay during reschedule API call"
      },
      "files_to_modify": [
        "src/routes/_authed/jobs/calendar.tsx (modify)",
        "src/components/domain/jobs/unscheduled-jobs-sidebar.tsx (create)",
        "src/server/functions/jobs.ts (modify: add rescheduleJob function)"
      ],
      "dependencies": [
        "DOM-JOBS-005a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_005B_COMPLETE"
    },
    {
      "id": "DOM-JOBS-007a",
      "name": "Job Templates: Schema (Optional SLA Integration)",
      "description": "Create job_templates table for pre-configured battery installation job types with optional SLA tracking for job completion targets",
      "priority": 7,
      "status": "pending",
      "passes": false,
      "type": "schema",
      "acceptance_criteria": [
        "File lib/schema/job-templates.ts created",
        "jobTemplates table: id uuid PRIMARY KEY DEFAULT gen_random_uuid(), organizationId uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE, name varchar NOT NULL, description text, defaultTasks jsonb NOT NULL, defaultBOM jsonb NOT NULL, checklistTemplateId uuid REFERENCES checklist_templates(id) ON DELETE SET NULL, estimatedDuration integer NOT NULL, slaConfigurationId uuid REFERENCES sla_configurations(id) ON DELETE SET NULL, isActive boolean NOT NULL DEFAULT true, createdAt timestamptz NOT NULL DEFAULT NOW(), updatedAt timestamptz NOT NULL DEFAULT NOW(), createdBy uuid REFERENCES users(id) ON DELETE SET NULL, updatedBy uuid REFERENCES users(id) ON DELETE SET NULL, version integer NOT NULL DEFAULT 1",
        "slaConfigurationId is OPTIONAL - jobs may or may not have SLA tracking",
        "job_assignments table: add sla_tracking_id uuid REFERENCES sla_tracking(id) ON DELETE SET NULL (OPTIONAL)",
        "Indexes: orgName (organization_id, name), orgActive (organization_id, is_active), orgCreated (organization_id, created_at DESC)",
        "Types exported from lib/schema/index.ts",
        "Migration file created",
        "npm run typecheck passes"
      ],
      "remediation_notes": {
        "source": "_meta/remediation-sla-engine.md",
        "key_changes": [
          "Job templates can optionally specify SLA configuration for job completion targets",
          "job_assignments.sla_tracking_id enables per-job SLA tracking (OPTIONAL)",
          "When job created from template with SLA config, start SLA tracking",
          "Job completion records SLA resolution"
        ],
        "sla_usage": "optional",
        "example_config": {
          "name": "Residential Install SLA",
          "domain": "jobs",
          "resolution_target": "2 days",
          "note": "Completion target, not response time"
        }
      },
      "files_to_modify": [
        "src/lib/schema/job-templates.ts (create)",
        "src/lib/schema/job-assignments.ts (modify - add sla_tracking_id)",
        "src/lib/schema/index.ts (export)",
        "drizzle/migrations/*.sql (generated)"
      ],
      "dependencies": [
        "DOM-JOBS-001c",
        "DOM-JOBS-002c",
        "DOM-JOBS-004c"
      ],
      "estimated_iterations": 2,
      "completion_promise": "DOM_JOBS_007A_COMPLETE"
    },
    {
      "id": "DOM-JOBS-007b",
      "name": "Job Templates: Server Functions (Optional SLA)",
      "description": "Create job template CRUD and battery installation job creation from template. If template has SLA config, start SLA tracking for job.",
      "priority": 7,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/job-templates.ts created",
        "listJobTemplates: returns templates for org",
        "createJobTemplate: creates template with tasks, BOM, checklist, optional slaConfigurationId",
        "updateJobTemplate: updates template",
        "deleteJobTemplate: removes template",
        "createJobFromTemplate: creates job assignment with tasks, materials, checklist from template",
        "IF template.slaConfigurationId exists, call SLA State Manager startTracking() with domain='jobs'",
        "Job completion (completeJob) calls SLA State Manager recordResolution() if sla_tracking_id exists",
        "Job reschedule adjusts SLA target if sla_tracking_id exists",
        "Validation schemas in lib/schemas/job-templates.ts",
        "npm run typecheck passes"
      ],
      "remediation_notes": {
        "source": "_meta/remediation-sla-engine.md",
        "key_changes": [
          "SLA tracking for jobs is OPTIONAL - only if template specifies slaConfigurationId",
          "Use SLA State Manager for all SLA operations",
          "Jobs only track resolution SLA (completion target), not response SLA"
        ]
      },
      "files_to_modify": [
        "src/server/functions/job-templates.ts (create)",
        "src/server/functions/jobs.ts (modify - integrate SLA on complete/reschedule)",
        "src/lib/schemas/job-templates.ts (create)"
      ],
      "dependencies": [
        "DOM-JOBS-007a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_007B_COMPLETE"
    },
    {
      "id": "DOM-JOBS-007c",
      "name": "Job Templates: UI",
      "description": "Template management page and template selection in job assignment",
      "priority": 7,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "Job templates management page in settings using DataTable pattern",
        "Create/edit template form with tasks, BOM, checklist selection using multi-step Form pattern",
        "Template selector in assign job dialog using SelectDialog pattern",
        "Preview template contents before applying with DetailPanel preview",
        "Loading skeleton (TemplateListSkeleton) during data fetch",
        "Empty state: 'No templates created' with 'Create Template' primary CTA",
        "Error boundary with retry for template operations",
        "Keyboard navigation through template list and form fields",
        "ARIA labels for all template actions and form controls",
        "Responsive: Form stacks on mobile, side-by-side on desktop",
        "npm run typecheck passes"
      ],
      "ui_spec": {
        "component_type": "DataTable with multi-step Form",
        "layout": {
          "mobile": "Full-width form, single-column fields",
          "tablet": "Two-column form layout",
          "desktop": "Template list with detail panel preview"
        },
        "accessibility": {
          "aria_labels": [
            "template-list",
            "create-template-button",
            "template-form",
            "preview-panel"
          ],
          "keyboard_nav": "Tab through list, Enter to edit, form field navigation",
          "screen_reader": "Template name and item counts announced",
          "focus_management": "Focus form on create, return to list after save"
        }
      },
      "uiPatterns": {
        "primaryComponents": [
          {
            "name": "Data Grid",
            "component": "data-grid.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Template list with columns: Name, Description, Tasks, Materials, Checklist, Duration, Actions",
            "features": [
              "Sortable by name, usage count",
              "Row actions: Edit, Duplicate, Delete",
              "Click row to preview template details",
              "Active/Inactive status badge"
            ]
          },
          {
            "name": "Tabs (Multi-step Form)",
            "component": "base-tabs.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-tabs.tsx",
            "usage": "Template form with tabs: Details, Tasks, Materials, Checklist",
            "adaptation": "Add step indicator (1 of 4), next/prev buttons, save on each step"
          }
        ],
        "supportingComponents": [
          {
            "name": "Dialog (Template Form)",
            "component": "base-dialog.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-dialog.tsx",
            "usage": "Full-screen dialog for template creation/editing"
          },
          {
            "name": "Kanban (Task Editor)",
            "component": "kanban.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/kanban.tsx",
            "usage": "Drag-drop ordering of default tasks in template"
          },
          {
            "name": "Combobox (Material/Checklist Picker)",
            "component": "base-combobox.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-combobox.tsx",
            "usage": "Select products for default BOM, checklist templates"
          },
          {
            "name": "Sheet (Preview Panel)",
            "component": "base-sheet.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/base-sheet.tsx",
            "usage": "Side panel showing template details when row clicked"
          }
        ],
        "layoutPattern": "Data Grid → Dialog (multi-step form) → Preview sheet",
        "emptyState": "Illustration with 'Create Your First Template' CTA",
        "loadingState": "Table skeleton with 5 row placeholders"
      },
      "files_to_modify": [
        "src/routes/_authed/settings/job-templates.tsx (create)",
        "src/components/domain/jobs/job-template-form.tsx (create)",
        "src/components/domain/orders/assign-job-dialog.tsx (modify: add template selector)"
      ],
      "dependencies": [
        "DOM-JOBS-007b"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_007C_COMPLETE"
    },
    {
      "id": "DOM-JOBS-008a",
      "name": "Job Costing Report: Server Functions",
      "description": "Create battery installation job cost calculation and profitability functions (materials + labor vs quoted price)",
      "priority": 8,
      "status": "pending",
      "passes": false,
      "type": "server-function",
      "acceptance_criteria": [
        "File src/server/functions/job-costing.ts created",
        "calculateJobCost: returns total cost (materials + labor)",
        "getJobProfitability: returns quoted amount, actual cost, profit margin",
        "getJobCostingReport: returns list of jobs with cost breakdown and margins",
        "Filter by date range, customer, job type",
        "npm run typecheck passes"
      ],
      "files_to_modify": [
        "src/server/functions/job-costing.ts (create)",
        "src/lib/schemas/job-costing.ts (create)"
      ],
      "dependencies": [
        "DOM-JOBS-002c",
        "DOM-JOBS-003c"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_008A_COMPLETE"
    },
    {
      "id": "DOM-JOBS-008b",
      "name": "Job Costing Report: UI",
      "description": "Create battery installation job costing report page with profitability analysis by job type",
      "priority": 8,
      "status": "pending",
      "passes": false,
      "type": "ui-component",
      "acceptance_criteria": [
        "File src/routes/_authed/reports/job-costing.tsx created",
        "Date range selector using DateRangePicker component",
        "Filter by customer, job type using FilterBar pattern",
        "DataTable showing: job, quoted, materials, labor, total cost, profit margin",
        "Highlight underperforming jobs (negative margin) with warning color",
        "Export to CSV using ExportButton component",
        "Loading skeleton (ReportTableSkeleton) during data fetch",
        "Empty state: 'No jobs in selected period' with filter adjustment suggestion",
        "Error boundary with retry for report generation failures",
        "Keyboard navigation: Tab through filters, Arrow keys in table",
        "ARIA table with proper headers and row descriptions",
        "Responsive: Horizontal scroll table on mobile with sticky first column",
        "npm run typecheck passes"
      ],
      "ui_spec": {
        "component_type": "Report DataTable with filters",
        "layout": {
          "mobile": "Stacked filters, horizontal scroll table, sticky job column",
          "tablet": "Inline filters, full table with wrap",
          "desktop": "Filter bar above full-width table"
        },
        "accessibility": {
          "aria_labels": [
            "costing-report-table",
            "date-range-picker",
            "export-csv-button",
            "customer-filter"
          ],
          "keyboard_nav": "Tab through filters, Enter to apply, Arrow keys in table",
          "screen_reader": "Column headers announced, margin status (profitable/loss) announced",
          "focus_management": "Focus table after filter apply"
        }
      },
      "uiPatterns": {
        "primaryComponents": [
          {
            "name": "Data Grid",
            "component": "data-grid.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/data-grid.tsx",
            "usage": "Costing report table with columns: Job, Customer, Type, Quoted, Materials, Labor, Total Cost, Profit, Margin %",
            "features": [
              "Sortable by all columns",
              "Color-coded margin column (green >10%, yellow 0-10%, red <0%)",
              "Sticky first column (Job) on mobile",
              "Row click to view job detail",
              "Summary row with totals"
            ]
          },
          {
            "name": "Statistic Cards",
            "component": "statistic-card-1.tsx",
            "path": "_reference/.reui-reference/registry/default/blocks/cards/statistic-cards/statistic-card-1.tsx",
            "usage": "Summary cards: Total Revenue, Total Cost, Total Profit, Avg Margin",
            "features": [
              "Currency formatting",
              "Delta indicators (vs previous period)",
              "Color coding by health (green/red)"
            ]
          }
        ],
        "supportingComponents": [
          {
            "name": "Filters",
            "component": "filters.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/filters.tsx",
            "usage": "Date range, customer, job type, status filters"
          },
          {
            "name": "Calendar (Date Range)",
            "component": "calendar.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/calendar.tsx",
            "usage": "Date range picker for report period"
          },
          {
            "name": "Button (Export)",
            "component": "button.tsx",
            "path": "_reference/.reui-reference/registry/default/ui/button.tsx",
            "usage": "Export to CSV button with download icon"
          }
        ],
        "chartReference": {
          "note": "Consider adding Midday chart components for visual profit analysis",
          "components": [
            "ProfitChart - Line chart showing profit trend over time",
            "CategoryExpenseDonutChart - Breakdown of costs by job type"
          ]
        },
        "layoutPattern": "Summary cards (4-col grid) → Filters bar → Data Grid → Export button",
        "emptyState": "Illustration with 'No jobs in selected period' and date filter suggestion",
        "loadingState": "Skeleton with 4 stat cards + table with 10 row placeholders"
      },
      "files_to_modify": [
        "src/routes/_authed/reports/job-costing.tsx (create)",
        "src/components/domain/jobs/job-costing-table.tsx (create)"
      ],
      "dependencies": [
        "DOM-JOBS-008a"
      ],
      "estimated_iterations": 3,
      "completion_promise": "DOM_JOBS_008B_COMPLETE"
    }
  ],
  "success_criteria": [
    "Tasks break down battery installation work (site assessment, electrical prep, mounting, BMS config, commissioning)",
    "BOM tracks battery system components and usage",
    "Time entries enable accurate job costing and billing",
    "Commissioning checklists ensure safety and quality standards",
    "Calendar aids technician scheduling and workload management",
    "Templates reduce setup time for standard job types (residential, commercial, warranty)",
    "Costing reveals profitability by installation type",
    "npm run typecheck passes",
    "No job functionality regressions"
  ],
  "out_of_scope": [
    "Gantt chart visualization",
    "Resource leveling",
    "Subcontractor management",
    "Native mobile app"
  ],
  "pattern_references": [
    {
      "file": "_Initiation/_meta/patterns/testing-standards.md",
      "applies_to": "all stories",
      "reason": "All stories must follow testing standards including TDD flow, coverage expectations (80% server functions, 90% utilities), and story-level testing requirements"
    },
    {
      "file": "_Initiation/_meta/patterns/error-recovery.md",
      "applies_to": "DOM-JOBS-001b (API), DOM-JOBS-003a/b (Time Tracking), DOM-JOBS-006a/b (Templates), all server function stories",
      "reason": "Pattern 2 (Offline Conflict Resolution) critical for field tech mobile time tracking. Pattern 3 (Saga) for job creation from templates"
    },
    {
      "file": "_Initiation/_meta/patterns/performance-benchmarks.md",
      "applies_to": "DOM-JOBS-005a/b (Calendar), DOM-JOBS-008a/b (Costing), all UI and API stories",
      "reason": "Calendar views must load <1s for week view. Job costing reports <3s. Time entry list <500ms for 100 items"
    },
    {
      "file": "_Initiation/_meta/patterns/ux-3-click-rule.md",
      "applies_to": "DOM-JOBS-001c (UI), DOM-JOBS-003a/b (Timer), DOM-JOBS-002a/b (Tasks/BOM), DOM-JOBS-004a/b (Checklists), all UI stories",
      "reason": "Field Tech role: FAB tap to start timer (1 action), swipe to complete task (1 action), 48px touch targets for checklists"
    }
  ]
}
