{
  "id": "DOM-PIPELINE",
  "name": "Sales Pipeline Management System",
  "description": "Complete sales opportunity lifecycle management from lead capture through quote creation, customer approval, and order conversion. Includes forecasting, analytics, and team collaboration features.",
  "created": "2026-01-10",
  "updated": "2026-01-10",
  "priority": 2,
  "phase": "core-business",
  "version": "1.0",
  "business_value": {
    "revenue_critical": true,
    "sales_velocity": true,
    "forecasting_essential": true,
    "description": "Primary sales engine and revenue forecasting system"
  },
  "system_requirements": {
    "database": {
      "opportunities": {
        "description": "Core sales opportunity tracking",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "title": "varchar(255) NOT NULL",
          "description": "text",
          "customerId": "uuid NOT NULL REFERENCES customers(id)",
          "contactId": "uuid REFERENCES contacts(id)",
          "assignedTo": "uuid REFERENCES users(id)",
          "stage": "enum('new', 'qualified', 'proposal', 'negotiation', 'won', 'lost') DEFAULT 'new'",
          "probability": "integer CHECK (probability >= 0 AND probability <= 100) DEFAULT 10",
          "value": "decimal(10,2) NOT NULL CHECK (value >= 0)",
          "expectedCloseDate": "date",
          "actualCloseDate": "date",
          "quoteExpiresAt": "timestamp",
          "quotePdfUrl": "text",
          "lostReason": "text",
          "lostNotes": "text",
          "competitorName": "varchar(100)",
          "winLossReasonId": "uuid REFERENCES winLossReasons(id)",
          "daysInStage": "integer DEFAULT 0",
          "version": "integer NOT NULL DEFAULT 1",
          "createdBy": "uuid NOT NULL REFERENCES users(id)",
          "updatedBy": "uuid NOT NULL REFERENCES users(id)",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": [
          "organizationId",
          "customerId",
          "contactId",
          "assignedTo",
          "stage",
          "expectedCloseDate",
          "probability",
          "CREATE INDEX idx_opportunities_org_status ON opportunities(organization_id, stage)",
          "CREATE INDEX idx_opportunities_org_created ON opportunities(organization_id, created_at DESC)"
        ],
        "constraints": [
          "actualCloseDate IS NOT NULL WHEN stage IN ('won', 'lost')"
        ]
      },
      "opportunityActivities": {
        "description": "Activity log for opportunities",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "opportunityId": "uuid NOT NULL REFERENCES opportunities(id)",
          "type": "enum('call', 'email', 'meeting', 'note', 'follow_up')",
          "description": "text NOT NULL",
          "outcome": "text",
          "scheduledAt": "timestamp",
          "completedAt": "timestamp",
          "createdBy": "uuid NOT NULL REFERENCES users(id)",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": [
          "organizationId",
          "opportunityId",
          "type",
          "scheduledAt",
          "completedAt",
          "CREATE INDEX idx_opportunityActivities_org_status ON opportunityActivities(organization_id, type)",
          "CREATE INDEX idx_opportunityActivities_org_created ON opportunityActivities(organization_id, created_at DESC)"
        ]
      },
      "quoteVersions": {
        "description": "Version control for quotes",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "organizationId": "uuid NOT NULL REFERENCES organizations(id) ON DELETE CASCADE",
          "opportunityId": "uuid NOT NULL REFERENCES opportunities(id)",
          "versionNumber": "integer NOT NULL",
          "items": "jsonb NOT NULL",
          "subtotal": "decimal(10,2) NOT NULL",
          "taxAmount": "decimal(10,2) NOT NULL DEFAULT 0",
          "total": "decimal(10,2) NOT NULL",
          "notes": "text",
          "version": "integer NOT NULL DEFAULT 1",
          "createdBy": "uuid NOT NULL REFERENCES users(id)",
          "updatedBy": "uuid REFERENCES users(id)",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": [
          "organizationId",
          "opportunityId",
          "versionNumber",
          "CREATE INDEX idx_quoteVersions_org_status ON quoteVersions(organization_id, version_number)",
          "CREATE INDEX idx_quoteVersions_org_created ON quoteVersions(organization_id, created_at DESC)"
        ],
        "constraints": [
          "versionNumber > 0",
          "subtotal >= 0",
          "taxAmount >= 0",
          "total >= 0"
        ]
      },
      "winLossReasons": {
        "description": "Reference table for win/loss reasons",
        "fields": {
          "id": "uuid PRIMARY KEY",
          "name": "varchar(100) NOT NULL",
          "type": "enum('win', 'loss') NOT NULL",
          "description": "text",
          "isActive": "boolean DEFAULT true",
          "sortOrder": "integer DEFAULT 0",
          "version": "integer NOT NULL DEFAULT 1",
          "orgId": "uuid NOT NULL REFERENCES organizations(id)",
          "createdBy": "uuid NOT NULL REFERENCES users(id)",
          "updatedBy": "uuid REFERENCES users(id)",
          "createdAt": "timestamp NOT NULL DEFAULT NOW()",
          "updatedAt": "timestamp NOT NULL DEFAULT NOW()"
        },
        "indexes": [
          "orgId",
          "type",
          "isActive",
          "sortOrder",
          "CREATE INDEX idx_winLossReasons_org_status ON winLossReasons(org_id, is_active)",
          "CREATE INDEX idx_winLossReasons_org_created ON winLossReasons(org_id, created_at DESC)"
        ]
      }
    },
    "api_endpoints": {
      "opportunities": {
        "list": {
          "method": "GET",
          "path": "/api/opportunities",
          "query_params": [
            "page",
            "limit",
            "stage",
            "assignedTo",
            "customerId",
            "probability",
            "search"
          ],
          "response": {
            "opportunities": "Opportunity[]",
            "total": "number",
            "metrics": {
              "totalValue": "number",
              "weightedValue": "number",
              "byStage": "Record<Stage, number>",
              "forecast": "ForecastData"
            }
          },
          "description": "List opportunities with filtering, pagination, and metrics"
        },
        "get": {
          "method": "GET",
          "path": "/api/opportunities/:id",
          "response": {
            "opportunity": "Opportunity",
            "activities": "OpportunityActivity[]",
            "versions": "QuoteVersion[]",
            "customer": "Customer",
            "contact": "Contact?"
          },
          "description": "Get complete opportunity details"
        },
        "create": {
          "method": "POST",
          "path": "/api/opportunities",
          "body": {
            "title": "string",
            "description": "string?",
            "customerId": "uuid",
            "contactId": "uuid?",
            "value": "number",
            "assignedTo": "uuid?"
          },
          "response": {
            "opportunity": "Opportunity"
          },
          "description": "Create new opportunity"
        },
        "update": {
          "method": "PUT",
          "path": "/api/opportunities/:id",
          "body": {
            "title": "string?",
            "description": "string?",
            "stage": "OpportunityStage?",
            "probability": "number?",
            "value": "number?",
            "expectedCloseDate": "date?",
            "assignedTo": "uuid?"
          },
          "response": {
            "opportunity": "Opportunity"
          },
          "description": "Update opportunity details"
        },
        "updateStage": {
          "method": "PUT",
          "path": "/api/opportunities/:id/stage",
          "body": {
            "stage": "OpportunityStage",
            "probability": "number?",
            "winLossReasonId": "uuid?",
            "lostNotes": "string?",
            "competitorName": "string?"
          },
          "response": {
            "opportunity": "Opportunity"
          },
          "description": "Update opportunity stage with validation"
        },
        "convertToOrder": {
          "method": "POST",
          "path": "/api/opportunities/:id/convert",
          "response": {
            "order": "Order"
          },
          "description": "Convert won opportunity to order"
        },
        "generateQuote": {
          "method": "POST",
          "path": "/api/opportunities/:id/generate-quote",
          "body": {
            "items": "QuoteItemInput[]",
            "notes": "string?",
            "expiresAt": "date?"
          },
          "response": {
            "quote": "QuoteVersion",
            "pdfUrl": "string"
          },
          "description": "Generate quote PDF and save version"
        },
        "sendQuote": {
          "method": "POST",
          "path": "/api/opportunities/:id/send-quote",
          "body": {
            "emailTemplateId": "uuid?",
            "customMessage": "string?",
            "expiresAt": "date?"
          },
          "response": {
            "success": "boolean"
          },
          "description": "Email quote to customer"
        }
      },
      "activities": {
        "logActivity": {
          "method": "POST",
          "path": "/api/opportunities/:id/activities",
          "body": {
            "type": "ActivityType",
            "description": "string",
            "outcome": "string?",
            "scheduledAt": "datetime?"
          },
          "response": {
            "activity": "OpportunityActivity"
          },
          "description": "Log activity on opportunity"
        },
        "getActivities": {
          "method": "GET",
          "path": "/api/opportunities/:id/activities",
          "response": {
            "activities": "OpportunityActivity[]"
          },
          "description": "Get activity history"
        }
      },
      "forecasting": {
        "getForecast": {
          "method": "GET",
          "path": "/api/pipeline/forecast",
          "query_params": [
            "startDate",
            "endDate",
            "groupBy",
            "includeWeighted"
          ],
          "response": {
            "forecast": "ForecastPeriod[]",
            "summary": {
              "totalValue": "number",
              "weightedValue": "number",
              "opportunityCount": "number"
            }
          },
          "description": "Get sales forecast by time period"
        },
        "getMetrics": {
          "method": "GET",
          "path": "/api/pipeline/metrics",
          "response": {
            "totalValue": "number",
            "weightedValue": "number",
            "byStage": "Record<Stage, number>",
            "byRep": "Record<UserId, number>",
            "conversionRate": "number",
            "avgDaysInStage": "Record<Stage, number>"
          },
          "description": "Get comprehensive pipeline metrics"
        }
      },
      "winLossReasons": {
        "list": {
          "method": "GET",
          "path": "/api/win-loss-reasons",
          "query_params": [
            "type"
          ],
          "response": {
            "reasons": "WinLossReason[]"
          },
          "description": "List available win/loss reasons"
        },
        "create": {
          "method": "POST",
          "path": "/api/win-loss-reasons",
          "body": {
            "name": "string",
            "type": "WinLossType",
            "description": "string?"
          },
          "response": {
            "reason": "WinLossReason"
          },
          "description": "Create new win/loss reason"
        },
        "getAnalysis": {
          "method": "GET",
          "path": "/api/win-loss-analysis",
          "query_params": [
            "startDate",
            "endDate"
          ],
          "response": {
            "analysis": "WinLossAnalysis[]"
          },
          "description": "Get win/loss analysis by reason"
        }
      }
    },
    "ui_components": {
      "pipelineBoard": {
        "description": "Kanban-style sales pipeline board",
        "layout": {
          "mobile": "Single column with swipe navigation",
          "tablet": "3 visible columns with horizontal scroll",
          "desktop": "All stages visible with drag-drop"
        },
        "columns": [
          "New",
          "Qualified",
          "Proposal",
          "Negotiation",
          "Won",
          "Lost"
        ],
        "features": [
          "Drag-drop stage changes",
          "Opportunity cards with key metrics",
          "Column totals (count, value, weighted)",
          "Stale opportunity highlighting",
          "Real-time updates",
          "Bulk operations"
        ]
      },
      "opportunityCard": {
        "description": "Compact opportunity display in pipeline",
        "shows": [
          "Title and customer name",
          "Value and probability",
          "Expected close date",
          "Days in current stage",
          "Activity indicators",
          "Quote status"
        ],
        "interactions": [
          "Click to open detail",
          "Hover for quick preview",
          "Drag to change stage",
          "Context menu for actions"
        ]
      },
      "opportunityDetail": {
        "description": "Complete opportunity management interface",
        "tabs": [
          "Overview",
          "Quote Builder",
          "Activities",
          "Versions",
          "Analytics"
        ],
        "overview": {
          "customerInfo": "Contact details and history",
          "currentStage": "Stage indicator with progress",
          "keyMetrics": "Value, probability, expected close",
          "quickActions": "Edit, Send Quote, Mark Won/Lost, Convert"
        },
        "quoteBuilder": {
          "productSearch": "Add products to quote",
          "lineItems": "Quantity, pricing, discounts",
          "calculations": "Subtotal, tax, total",
          "validity": "Expiration date management",
          "preview": "Live PDF preview"
        }
      },
      "forecastingReport": {
        "description": "Sales forecasting and analytics dashboard",
        "views": [
          "By Month",
          "By Quarter",
          "By Rep",
          "By Customer"
        ],
        "metrics": [
          "Raw pipeline value",
          "Weighted pipeline value (probability)",
          "Opportunity count and conversion rates",
          "Historical vs forecast comparison",
          "Target vs actual performance"
        ],
        "export": "CSV and PDF export capabilities"
      },
      "activityLogging": {
        "description": "Log and track sales activities",
        "activityTypes": [
          "Call",
          "Email",
          "Meeting",
          "Note",
          "Follow-up"
        ],
        "features": [
          "Quick logging from opportunity",
          "Scheduled follow-ups",
          "Activity timeline",
          "Contact outcome tracking",
          "Automated reminders"
        ]
      }
    },
    "business_rules": {
      "pipeline_stages": {
        "new": "Initial opportunity capture",
        "qualified": "Lead qualified with budget and authority confirmed",
        "proposal": "Quote sent to customer",
        "negotiation": "Quote sent, awaiting response",
        "won": "Customer accepted, ready for order conversion",
        "lost": "Opportunity lost with reason tracking"
      },
      "probability_defaults": {
        "new": 10,
        "qualified": 25,
        "proposal": 50,
        "negotiation": 75,
        "won": 100,
        "lost": 0
      },
      "quote_validity": {
        "default_days": 30,
        "warning_days": 7,
        "enforcement": "Block conversion of expired quotes unless overridden",
        "extension_allowed": "Sales can extend validity with reason"
      },
      "forecasting_logic": {
        "weighted_value": "value Ã— (probability / 100)",
        "forecast_periods": "Monthly, quarterly, annual",
        "confidence_intervals": "Based on historical conversion rates",
        "seasonal_adjustments": "Industry-specific patterns"
      },
      "activity_tracking": {
        "required_frequency": "At least one activity per week for active opportunities",
        "stale_threshold": "30 days without activity triggers warning",
        "follow_up_scheduling": "Automated reminders for pending tasks"
      }
    },
    "integrations": {
      "customers": {
        "customer_lookup": "Real-time customer search and selection",
        "contact_management": "Primary contact assignment and updates",
        "customer_history": "Previous opportunities and orders context",
        "account_health": "Customer health score integration"
      },
      "products": {
        "product_catalog": "Real-time product search and pricing",
        "inventory_check": "Stock availability validation",
        "pricing_rules": "Customer-specific pricing and discounts",
        "variant_support": "Product variants and options"
      },
      "orders": {
        "conversion_process": "Won opportunity to order creation",
        "quote_carryover": "Quote details transfer to order",
        "reference_tracking": "Opportunity reference on orders",
        "revenue_attribution": "Sales attribution and commission tracking"
      },
      "communications": {
        "email_integration": "Quote sending and follow-up automation",
        "template_support": "Email templates for different scenarios",
        "activity_logging": "Email activities automatically logged",
        "sequence_automation": "Automated follow-up sequences"
      },
      "calendar": {
        "meeting_scheduling": "Calendar integration for meetings",
        "follow_up_reminders": "Automated calendar reminders",
        "availability_checking": "Meeting conflict detection"
      }
    }
  },
  "stories": [
    {
      "id": "PIPE-CORE-SCHEMA",
      "name": "Pipeline Core Schema",
      "description": "Create opportunities, opportunityActivities, quoteVersions, winLossReasons tables",
      "type": "schema",
      "acceptance_criteria": [
        "Complete opportunities table with all required fields",
        "opportunityActivities table for activity tracking",
        "quoteVersions table for version control",
        "winLossReasons table for structured reasons",
        "Foreign keys to organizations(id), customers(id), users(id) with ON DELETE CASCADE/RESTRICT; indexes on organizationId, stage, assignedTo",
        "RLS policies for organization isolation",
        "TypeScript types exported"
      ],
      "files_to_modify": [
        "src/lib/schema/opportunities.ts",
        "src/lib/schema/opportunity-activities.ts",
        "src/lib/schema/quote-versions.ts",
        "src/lib/schema/win-loss-reasons.ts",
        "src/lib/schema/index.ts",
        "drizzle/migrations/005_pipeline.ts"
      ],
      "completion_promise": "PIPE_CORE_SCHEMA_COMPLETE",
      "estimated_iterations": 2,
      "status": "pending"
    },
    {
      "id": "PIPE-CORE-API",
      "name": "Pipeline Core API",
      "description": "Implement CRUD operations and metrics for opportunities",
      "type": "server-function",
      "acceptance_criteria": [
        "listOpportunities with filtering and metrics",
        "getOpportunity with full details",
        "createOpportunity with validation",
        "updateOpportunity and updateStage",
        "convertToOrder integration",
        "getPipelineMetrics with weighted calculations",
        "Zod validation on inputs; try-catch with 400/404/500 responses; RLS policies restrict access to organization's own data"
      ],
      "files_to_modify": [
        "src/server/functions/pipeline.ts",
        "src/lib/schemas/pipeline.ts"
      ],
      "dependencies": [
        "PIPE-CORE-SCHEMA"
      ],
      "completion_promise": "PIPE_CORE_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-BOARD-UI",
      "name": "Pipeline Board Interface",
      "description": "Kanban-style pipeline board with drag-drop functionality",
      "type": "ui-component",
      "acceptance_criteria": [
        "Responsive kanban layout (mobile swipe, desktop drag-drop)",
        "Stage columns with opportunity cards",
        "Column totals and metrics display",
        "Drag-drop stage transitions",
        "Real-time updates and filtering",
        "Accessibility compliant with keyboard navigation"
      ],
      "files_to_modify": [
        "src/routes/_authed/pipeline/index.tsx",
        "src/components/domain/pipeline/pipeline-board.tsx",
        "src/components/domain/pipeline/pipeline-column.tsx",
        "src/components/domain/pipeline/opportunity-card.tsx"
      ],
      "dependencies": [
        "PIPE-CORE-API"
      ],
      "completion_promise": "PIPE_BOARD_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-DETAIL-UI",
      "name": "Opportunity Detail Interface",
      "description": "Complete opportunity management with tabs and actions",
      "type": "ui-component",
      "acceptance_criteria": [
        "Tabbed interface: Overview, Quote, Activities, Versions",
        "Overview with customer info and key metrics",
        "Edit functionality for all opportunity fields",
        "Stage management with validation",
        "Quick actions: Send Quote, Mark Won/Lost, Convert to Order"
      ],
      "files_to_modify": [
        "src/routes/_authed/pipeline/$opportunityId.tsx",
        "src/components/domain/pipeline/opportunity-detail.tsx",
        "src/components/domain/pipeline/opportunity-form.tsx"
      ],
      "dependencies": [
        "PIPE-CORE-API"
      ],
      "completion_promise": "PIPE_DETAIL_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-ACTIVITIES-API",
      "name": "Activity Logging API",
      "description": "Implement activity tracking and management",
      "type": "server-function",
      "acceptance_criteria": [
        "logActivity with type validation",
        "getActivities with filtering",
        "Activity timeline queries",
        "Follow-up scheduling support",
        "Activity analytics endpoints"
      ],
      "files_to_modify": [
        "src/server/functions/pipeline.ts",
        "src/lib/schemas/activities.ts"
      ],
      "dependencies": [
        "PIPE-CORE-SCHEMA"
      ],
      "completion_promise": "PIPE_ACTIVITIES_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-ACTIVITIES-UI",
      "name": "Activity Logging Interface",
      "description": "Log activities, schedule follow-ups, view timeline",
      "type": "ui-component",
      "acceptance_criteria": [
        "Quick activity logging from opportunity",
        "Activity type selection (call, email, meeting, note)",
        "Follow-up scheduling with calendar integration",
        "Activity timeline with filtering",
        "Outcome tracking and notes",
        "Automated activity reminders"
      ],
      "files_to_modify": [
        "src/components/domain/pipeline/activity-logger.tsx",
        "src/components/domain/pipeline/activity-timeline.tsx",
        "src/components/domain/pipeline/follow-up-scheduler.tsx"
      ],
      "dependencies": [
        "PIPE-ACTIVITIES-API"
      ],
      "completion_promise": "PIPE_ACTIVITIES_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-QUOTE-BUILDER-API",
      "name": "Quote Builder API",
      "description": "Implement quote creation, versioning, and PDF generation",
      "type": "server-function",
      "acceptance_criteria": [
        "createQuoteVersion with line items",
        "generateQuotePdf with Supabase storage",
        "getQuoteVersions with history",
        "restoreQuoteVersion functionality",
        "Quote expiration management",
        "sendQuote with email integration"
      ],
      "files_to_modify": [
        "src/server/functions/quote-versions.ts",
        "src/server/functions/pipeline.ts",
        "src/lib/schemas/quotes.ts"
      ],
      "dependencies": [
        "PIPE-CORE-SCHEMA"
      ],
      "completion_promise": "PIPE_QUOTE_BUILDER_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-QUOTE-BUILDER-UI",
      "name": "Quote Builder Interface",
      "description": "Build quotes with products, pricing, and PDF generation",
      "type": "ui-component",
      "acceptance_criteria": [
        "Product search and selection",
        "Line item management with quantity and pricing",
        "Automatic tax calculations (GST 10%)",
        "Quote versioning with diff view",
        "PDF generation and preview",
        "Quote validity management",
        "Email sending integration"
      ],
      "files_to_modify": [
        "src/components/domain/pipeline/quote-builder.tsx",
        "src/components/domain/pipeline/quote-pdf.tsx",
        "src/components/domain/pipeline/quote-version-history.tsx"
      ],
      "dependencies": [
        "PIPE-QUOTE-BUILDER-API"
      ],
      "completion_promise": "PIPE_QUOTE_BUILDER_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-FORECASTING-API",
      "name": "Forecasting API",
      "description": "Implement sales forecasting and metrics calculations",
      "type": "server-function",
      "acceptance_criteria": [
        "getPipelineForecast by time periods",
        "Weighted value calculations (probability)",
        "Forecast accuracy tracking",
        "Pipeline velocity metrics",
        "Conversion rate analysis",
        "Revenue attribution calculations"
      ],
      "files_to_modify": [
        "src/server/functions/pipeline.ts",
        "src/lib/schemas/forecasting.ts"
      ],
      "dependencies": [
        "PIPE-CORE-API"
      ],
      "completion_promise": "PIPE_FORECASTING_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-FORECASTING-UI",
      "name": "Forecasting Report Interface",
      "description": "Sales forecasting dashboard with charts and analytics",
      "type": "full-page",
      "acceptance_criteria": [
        "Multiple forecast views (monthly, quarterly, by rep)",
        "Raw vs weighted value toggle",
        "Historical performance comparison",
        "Target vs actual tracking",
        "Interactive charts and drill-down",
        "CSV/PDF export capabilities"
      ],
      "files_to_modify": [
        "src/routes/_authed/reports/pipeline-forecast.tsx",
        "src/components/domain/reports/forecast-chart.tsx",
        "src/components/domain/reports/forecast-table.tsx"
      ],
      "dependencies": [
        "PIPE-FORECASTING-API"
      ],
      "completion_promise": "PIPE_FORECASTING_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-WINLOSS-API",
      "name": "Win/Loss Analysis API",
      "description": "Implement structured win/loss reason tracking",
      "type": "server-function",
      "acceptance_criteria": [
        "listWinLossReasons by type",
        "createWinLossReason (admin only)",
        "updateWinLossReason with validation",
        "markAsWon with reason selection",
        "markAsLost with required reason",
        "getWinLossAnalysis with trends"
      ],
      "files_to_modify": [
        "src/server/functions/win-loss-reasons.ts",
        "src/server/functions/pipeline.ts",
        "src/lib/schemas/win-loss-reasons.ts"
      ],
      "dependencies": [
        "PIPE-CORE-SCHEMA"
      ],
      "completion_promise": "PIPE_WINLOSS_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-WINLOSS-UI",
      "name": "Win/Loss Management Interface",
      "description": "Structured reason selection and analysis dashboard",
      "type": "ui-component",
      "acceptance_criteria": [
        "Win/loss reason dropdown in stage dialogs",
        "Competitor name field for losses",
        "Reason management in settings",
        "Win/loss analysis dashboard",
        "Trend charts and insights",
        "Reason effectiveness metrics"
      ],
      "files_to_modify": [
        "src/components/domain/pipeline/mark-won-dialog.tsx",
        "src/components/domain/pipeline/mark-lost-dialog.tsx",
        "src/components/domain/settings/win-loss-reasons-manager.tsx"
      ],
      "dependencies": [
        "PIPE-WINLOSS-API"
      ],
      "completion_promise": "PIPE_WINLOSS_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-VALIDITY-API",
      "name": "Quote Validity API",
      "description": "Implement quote expiration enforcement and extensions",
      "type": "server-function",
      "acceptance_criteria": [
        "getExpiringQuotes with configurable warning period",
        "getExpiredQuotes for cleanup",
        "extendQuoteValidity with audit trail",
        "Quote expiration validation on conversion",
        "Automated expiration notifications"
      ],
      "files_to_modify": [
        "src/server/functions/pipeline.ts",
        "src/lib/schemas/quotes.ts"
      ],
      "dependencies": [
        "PIPE-CORE-API"
      ],
      "completion_promise": "PIPE_VALIDITY_API_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-VALIDITY-UI",
      "name": "Quote Validity Interface",
      "description": "Expiration warnings, extension requests, and enforcement",
      "type": "ui-component",
      "acceptance_criteria": [
        "Expiration status badges on opportunities",
        "Warning notifications for expiring quotes",
        "Extend validity dialog with reason",
        "Expired quote blocking with override option",
        "Expiration dashboard for management",
        "Automated renewal suggestions"
      ],
      "files_to_modify": [
        "src/components/domain/pipeline/quote-validity-badge.tsx",
        "src/components/domain/pipeline/extend-validity-dialog.tsx",
        "src/components/domain/pipeline/expired-quotes-alert.tsx"
      ],
      "dependencies": [
        "PIPE-VALIDITY-API"
      ],
      "completion_promise": "PIPE_VALIDITY_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    },
    {
      "id": "PIPE-QUICK-QUOTE-UI",
      "name": "Quick Quote Creation",
      "description": "Streamlined quote creation from customer context",
      "type": "ui-component",
      "acceptance_criteria": [
        "Quick quote dialog from customer detail",
        "Pre-filled customer and contact information",
        "Product search with autocomplete",
        "Rapid item addition and pricing",
        "Auto-calculations and validations",
        "Save as draft or create opportunity"
      ],
      "files_to_modify": [
        "src/components/domain/customers/quick-quote-dialog.tsx",
        "src/components/domain/pipeline/product-search.tsx",
        "src/routes/_authed/customers/$customerId.tsx"
      ],
      "dependencies": [
        "PIPE-CORE-API"
      ],
      "completion_promise": "PIPE_QUICK_QUOTE_UI_COMPLETE",
      "estimated_iterations": 3,
      "status": "pending"
    }
  ],
  "success_criteria": [
    "Complete opportunity lifecycle from creation to order conversion",
    "Real-time sales forecasting with probability weighting",
    "Professional quote generation and version control",
    "Comprehensive activity tracking and follow-up automation",
    "Win/loss analysis with structured reason tracking",
    "Quote validity enforcement and management",
    "Mobile-responsive pipeline board with drag-drop",
    "Integration with customer, product, and order systems",
    "Pipeline board loads in < 2 seconds",
    "Forecast calculations complete in < 500ms",
    "All opportunity operations complete in < 1 second",
    "Full accessibility compliance for sales team use",
    "Complete audit trail for all sales activities",
    "Export capabilities for reporting and analysis"
  ],
  "out_of_scope": [
    "Advanced CPQ (configure-price-quote) functionality",
    "Third-party CRM integrations (Salesforce, HubSpot)",
    "Automated lead scoring and routing",
    "Multi-currency support",
    "Contract generation and e-signature",
    "Advanced territory management",
    "Predictive lead scoring with AI",
    "Social selling and LinkedIn integration"
  ],
  "migration_notes": {
    "existing_data": "If existing opportunity data exists, migration scripts needed to transform stage values, probability calculations, and activity history",
    "xero_integration": "Existing quote-to-invoice mappings must be preserved during transition",
    "user_assignments": "Sales rep assignments and permissions need careful mapping",
    "quote_history": "Existing quote PDFs and email history should be maintained"
  },
  "pattern_references": [
    {
      "file": "_Initiation/_meta/patterns/testing-standards.md",
      "applies_to": "all stories",
      "reason": "All stories must follow testing standards including TDD flow, coverage expectations (80% server functions, 90% utilities), and story-level testing requirements"
    },
    {
      "file": "_Initiation/_meta/patterns/error-recovery.md",
      "applies_to": "PIPE-CORE-API, PIPE-QUOTE-ENGINE, PIPE-CONVERSION-API, all server function stories",
      "reason": "Server stories must implement Pattern 3 (Saga Pattern) for quote-to-order conversion, and Pattern 1 (Sync Failure Recovery) for any external integrations"
    },
    {
      "file": "_Initiation/_meta/patterns/performance-benchmarks.md",
      "applies_to": "PIPE-BOARD-UI, PIPE-FORECASTING-UI, all UI and API stories",
      "reason": "Pipeline board must load <2s (as specified in scope), forecast calculations <500ms. List views <500ms for 100 items, all queries must use pagination"
    },
    {
      "file": "_Initiation/_meta/patterns/ux-3-click-rule.md",
      "applies_to": "PIPE-BOARD-UI, PIPE-QUICK-QUOTE-UI, PIPE-ACTIVITIES-UI, all UI stories",
      "reason": "Sales role uses Cmd+Q for quick quote (3 clicks), Cmd+L for call logging (2 clicks), pipeline is default landing (1 click). Drag-drop stage changes count as 1 action"
    }
  ]
}
