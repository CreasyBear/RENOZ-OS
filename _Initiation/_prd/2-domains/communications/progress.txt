# Communications Domain Progress
# PRD: communications.prd.json
# Started: 2026-01-17
# Updated: 2026-01-18

## Stories (20 total)

- [x] DOM-COMMS-001a: Add Email Tracking Schema
- [x] DOM-COMMS-001b: Implement Email Tracking Service
- [x] DOM-COMMS-001c: Add Email Tracking Stats UI
- [x] DOM-COMMS-002a: Add Scheduled Emails Schema
- [x] DOM-COMMS-002b: Implement Email Scheduling Service
- [x] DOM-COMMS-002c: Add Email Scheduling UI
- [x] DOM-COMMS-003a: Add Email Campaigns Schema
- [x] DOM-COMMS-003b: Implement Campaign Recipient Selection
- [x] DOM-COMMS-003c: Implement Campaign Batch Sending
- [x] DOM-COMMS-003d: Add Campaign Management UI
- [x] DOM-COMMS-004a: Add Scheduled Calls Schema
- [x] DOM-COMMS-004b: Implement Call Scheduling Service
- [x] DOM-COMMS-004c: Add Call Scheduling UI
- [x] DOM-COMMS-005: Add Communication Preferences
- [ ] DOM-COMMS-006: Add Email Signature Management
- [ ] DOM-COMMS-007: Add Custom Email Templates Management
- [ ] DOM-COMMS-008: Fix and Enhance Communications Timeline
- [ ] COMMS-AUTO-001: Email-to-Activity Bridge
- [ ] COMMS-AUTO-002: Activity Source Tracking
- [ ] COMMS-AUTO-003: Quick Log UI Enhancement

## Current Story
DOM-COMMS-006: Add Email Signature Management

## Iteration Count
Total: 14
Current Story: 0

## Blockers
None

## Notes
- Progress tracking initialized
- DOM-COMMS-001a: openedAt and clickedAt already existed in schema; added linkClicks JSONB column with interfaces (LinkClick, LinkClicks); created migration 0011_add_link_clicks_to_email_history.sql
- DOM-COMMS-001b: Created email-tracking.ts service with recordEmailOpen(), recordEmailClick(), wrapLinksInHtml(), insertTrackingPixel(), prepareEmailForTracking(); Created API routes at /api/track/open.$emailId.ts and /api/track/click.$emailId.$linkId.ts; Privacy-compliant (skips unsubscribe links, hashes IPs)
- DOM-COMMS-001c: Created EmailTrackingBadge (shows open/click/bounce status), EmailTrackingTimeline (chronological events), TemplateStatsCard (open/click rates with progress bars) in src/components/domain/communications/
- DOM-COMMS-002a: Created scheduled_emails table with id, organizationId, userId, recipientEmail, recipientName, subject, templateType, templateData, scheduledAt, timezone, status columns; Added scheduledEmailStatusEnum; Created migration 0012_add_scheduled_emails.sql
- DOM-COMMS-002b: Created src/lib/server/scheduled-emails.ts with server functions (scheduleEmail, getScheduledEmails, getScheduledEmailById, updateScheduledEmail, cancelScheduledEmail) + internal functions (getDueScheduledEmails, markScheduledEmailAsSent); Created Trigger.dev job src/trigger/jobs/process-scheduled-emails.ts with cron trigger (every minute), template rendering, email history creation, and tracking integration; Added job export to src/trigger/jobs/index.ts
- DOM-COMMS-002c: Created 5 UI components in src/components/domain/communications/: DateTimePicker (combined date/time with Calendar popover), TimezoneSelect (grouped timezone selector with getLocalTimezone/formatInTimezone helpers), ScheduledEmailBadge (status badge + dot variant for pending/sent/cancelled), ScheduledEmailsList (data table with skeleton, empty state using Empty composition, cancel confirmation dialog), ScheduleEmailDialog (full form for scheduling/editing with recipient, template, datetime, timezone); Updated index.ts exports
- DOM-COMMS-003a: Created drizzle/schema/email-campaigns.ts with email_campaigns table (id, organizationId, name, templateType, templateData, recipientCriteria, scheduledAt, startedAt, completedAt, status, recipientCount, sentCount, deliveredCount, openCount, clickCount, bounceCount, failedCount, unsubscribeCount, createdById) and campaign_recipients table (id, campaignId, contactId, email, name, recipientData, status, sentAt, deliveredAt, openedAt, clickedAt, bouncedAt, failedAt, unsubscribedAt, errorMessage, emailHistoryId); Added campaignStatusEnum (draft/scheduled/sending/sent/paused/cancelled/failed) and campaignRecipientStatusEnum (pending/sent/delivered/opened/clicked/bounced/failed/unsubscribed) to enums.ts; Created migration 0013_add_email_campaigns.sql with RLS policies; Updated schema/index.ts exports
- DOM-COMMS-003b: Created src/lib/server/email-campaigns.ts with server functions: createCampaign (creates campaign with recipient criteria), updateCampaign (draft/scheduled only), getCampaigns (with status filter), getCampaignById, getCampaignRecipients (filter by status), previewCampaignRecipients (returns count + sample without creating campaign, filters by tags/statuses/customerTypes/contactIds/customerIds/excludeContactIds), populateCampaignRecipients (populates recipients from criteria, dedupes by email), cancelCampaign, deleteCampaign (draft only); Uses JSONB criteria for flexible filtering
- DOM-COMMS-003c: Created src/trigger/jobs/send-campaign.ts with three Trigger.dev jobs: sendCampaignJob (event-triggered batch sender with configurable batchSize/batchDelayMs, uses io.wait for rate limiting, updates campaign stats after each batch, handles individual recipient failures), pauseCampaignJob (pauses running campaigns), processScheduledCampaignsJob (finds due scheduled campaigns and triggers sends); Added template types for newsletter/promotion/announcement; Updated jobs index exports and jobs array
- DOM-COMMS-003d: Created 6 UI components in src/components/domain/communications/: CampaignStatusBadge (status badge + dot variant for all campaign states), CampaignsList (DataTable with skeleton, empty state, cancel/delete dialogs), CampaignDetailPanel (campaign stats grid + recipient list + sending progress), RecipientFilterBuilder (dynamic filter builder with add/remove rows for tags/status/type), CampaignPreviewPanel (preview with recipient count + sample using previewCampaignRecipients API), CampaignWizard (4-step wizard: Details→Template→Recipients→Preview with Tabs navigation, scheduling options, AlertDialog confirmations); Updated index.ts exports
- DOM-COMMS-004a: Created drizzle/schema/scheduled-calls.ts with scheduled_calls table (id, organizationId, customerId, assigneeId, scheduledAt, reminderAt, purpose, notes, status, completedAt, cancelledAt, cancelReason, outcome, outcomeNotes, rescheduledToId); Added scheduledCallStatusEnum (pending/completed/cancelled/rescheduled) to enums.ts; Created migration 0014_add_scheduled_calls.sql with RLS policies and indexes on assigneeId, scheduledAt, status; Updated schema/index.ts exports
- DOM-COMMS-004b: Created src/lib/server/scheduled-calls.ts with server functions (scheduleCall, getScheduledCalls, getScheduledCallById, updateScheduledCall, cancelScheduledCall, rescheduleCall, completeCall) + internal functions (getCallsDueForReminder, getOverdueCalls, getUpcomingCallsForUser); Created src/trigger/jobs/process-scheduled-calls.ts with two Trigger.dev cron jobs: processScheduledCallsJob (every 5 min for reminders) and processOverdueCallsJob (every 15 min for overdue notifications); Added call_reminder and call_overdue to notificationTypeEnum; Created migration 0015_add_call_notification_types.sql; Updated jobs/index.ts exports
- DOM-COMMS-004c: Created 6 UI components in src/components/domain/communications/: ScheduledCallBadge (status badge with pending/completed/cancelled/rescheduled states), ScheduleCallDialog (FormDialog with datetime, purpose, notes, reminder toggle), CallOutcomeDialog (RadioGroup with outcome options + notes), ScheduledCallActionMenu (DropdownMenu with snooze/reschedule/cancel options), UpcomingCallsWidget (dashboard Card with overdue indicators using color AND icon), ScheduledCallsList (DataTable with status filter and action menu); Uses EmptyMedia pattern for empty states; All components pass TypeScript compilation
- DOM-COMMS-005: Added emailOptIn, smsOptIn, emailOptInAt, smsOptInAt columns to contacts table; Created migration 0016_add_communication_preferences.sql with partial indexes for opted-in contacts; Created src/lib/server/communication-preferences.ts with getContactPreferences, updateContactPreferences, getPreferenceHistory server functions + isEmailOptedIn, isSmsOptedIn, generateUnsubscribeToken, verifyUnsubscribeToken helpers; Created src/routes/api/unsubscribe.$token.ts endpoint with GET (confirmation page) and POST (process unsubscribe); Created CommunicationPreferences and PreferenceHistory UI components with Checkbox toggles, AlertDialog for opt-out confirmation, audit history table with tabular-nums dates; Logs all preference changes to customerActivities for GDPR/CAN-SPAM compliance
